<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck/TcSMonad.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP, TypeFamilies #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-- Type definitions for the constraint solver</span>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcSMonad</span> <span class='hs-layout'>(</span>
<a name="line-5"></a>
<a name="line-6"></a>    <span class='hs-comment'>-- The work list</span>
<a name="line-7"></a>    <span class='hs-conid'>WorkList</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    <span class='hs-varid'>extendWorkListNonEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListCt</span><span class='hs-layout'>,</span>
<a name="line-9"></a>    <span class='hs-varid'>extendWorkListCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListFunEq</span><span class='hs-layout'>,</span>
<a name="line-10"></a>    <span class='hs-varid'>appendWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendWorkListImplic</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>selectNextWorkItem</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-varid'>workListSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>workListWantedCount</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-varid'>getWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>updWorkListTcS</span><span class='hs-layout'>,</span>
<a name="line-14"></a>
<a name="line-15"></a>    <span class='hs-comment'>-- The TcS monad</span>
<a name="line-16"></a>    <span class='hs-conid'>TcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSDeriveds</span><span class='hs-layout'>,</span> <span class='hs-varid'>runTcSWithEvBinds</span><span class='hs-layout'>,</span>
<a name="line-17"></a>    <span class='hs-varid'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>addErrTcS</span><span class='hs-layout'>,</span>
<a name="line-18"></a>    <span class='hs-varid'>runTcSEqualities</span><span class='hs-layout'>,</span>
<a name="line-19"></a>    <span class='hs-varid'>nestTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>nestImplicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>setEvBindsTcS</span><span class='hs-layout'>,</span>
<a name="line-20"></a>    <span class='hs-varid'>checkConstraintsTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkTvConstraintsTcS</span><span class='hs-layout'>,</span>
<a name="line-21"></a>
<a name="line-22"></a>    <span class='hs-varid'>runTcPluginTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUsedGRE</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUsedGREs</span><span class='hs-layout'>,</span>
<a name="line-23"></a>
<a name="line-24"></a>    <span class='hs-conid'>QCInst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>    <span class='hs-comment'>-- Tracing etc</span>
<a name="line-27"></a>    <span class='hs-varid'>panicTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceTcS</span><span class='hs-layout'>,</span>
<a name="line-28"></a>    <span class='hs-varid'>traceFireTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>bumpStepCountTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>csTraceTcS</span><span class='hs-layout'>,</span>
<a name="line-29"></a>    <span class='hs-varid'>wrapErrTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>wrapWarnTcS</span><span class='hs-layout'>,</span>
<a name="line-30"></a>
<a name="line-31"></a>    <span class='hs-comment'>-- Evidence creation and transformation</span>
<a name="line-32"></a>    <span class='hs-conid'>MaybeNew</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>freshGoals</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFresh</span><span class='hs-layout'>,</span> <span class='hs-varid'>getEvExpr</span><span class='hs-layout'>,</span>
<a name="line-33"></a>
<a name="line-34"></a>    <span class='hs-varid'>newTcEvBinds</span><span class='hs-layout'>,</span> <span class='hs-varid'>newNoTcEvBinds</span><span class='hs-layout'>,</span>
<a name="line-35"></a>    <span class='hs-varid'>newWantedEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewWantedEq</span><span class='hs-layout'>,</span>
<a name="line-36"></a>    <span class='hs-varid'>newWanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>newWantedEvVarNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>newDerivedNC</span><span class='hs-layout'>,</span>
<a name="line-37"></a>    <span class='hs-varid'>newBoundEvVarId</span><span class='hs-layout'>,</span>
<a name="line-38"></a>    <span class='hs-varid'>unifyTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>unflattenFmv</span><span class='hs-layout'>,</span> <span class='hs-varid'>reportUnifications</span><span class='hs-layout'>,</span>
<a name="line-39"></a>    <span class='hs-varid'>setEvBind</span><span class='hs-layout'>,</span> <span class='hs-varid'>setWantedEq</span><span class='hs-layout'>,</span>
<a name="line-40"></a>    <span class='hs-varid'>setWantedEvTerm</span><span class='hs-layout'>,</span> <span class='hs-varid'>setEvBindIfWanted</span><span class='hs-layout'>,</span>
<a name="line-41"></a>    <span class='hs-varid'>newEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>newGivenEvVars</span><span class='hs-layout'>,</span>
<a name="line-42"></a>    <span class='hs-varid'>emitNewDeriveds</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitNewDerivedEq</span><span class='hs-layout'>,</span>
<a name="line-43"></a>    <span class='hs-varid'>checkReductionDepth</span><span class='hs-layout'>,</span>
<a name="line-44"></a>    <span class='hs-varid'>getSolvedDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>setSolvedDicts</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>    <span class='hs-varid'>getInstEnvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getFamInstEnvs</span><span class='hs-layout'>,</span>                <span class='hs-comment'>-- Getting the environments</span>
<a name="line-47"></a>    <span class='hs-varid'>getTopEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGblEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getLclEnv</span><span class='hs-layout'>,</span>
<a name="line-48"></a>    <span class='hs-varid'>getTcEvBindsVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcLevel</span><span class='hs-layout'>,</span>
<a name="line-49"></a>    <span class='hs-varid'>getTcEvTyCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTcEvBindsMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTcEvBindsMap</span><span class='hs-layout'>,</span>
<a name="line-50"></a>    <span class='hs-varid'>tcLookupClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupId</span><span class='hs-layout'>,</span>
<a name="line-51"></a>
<a name="line-52"></a>    <span class='hs-comment'>-- Inerts</span>
<a name="line-53"></a>    <span class='hs-conid'>InertSet</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-54"></a>    <span class='hs-varid'>updInertTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertIrreds</span><span class='hs-layout'>,</span>
<a name="line-55"></a>    <span class='hs-varid'>getNoGivenEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>setInertCans</span><span class='hs-layout'>,</span>
<a name="line-56"></a>    <span class='hs-varid'>getInertEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>,</span> <span class='hs-varid'>getInertGivens</span><span class='hs-layout'>,</span>
<a name="line-57"></a>    <span class='hs-varid'>getInertInsols</span><span class='hs-layout'>,</span>
<a name="line-58"></a>    <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>,</span> <span class='hs-varid'>setTcSInerts</span><span class='hs-layout'>,</span>
<a name="line-59"></a>    <span class='hs-varid'>matchableGivens</span><span class='hs-layout'>,</span> <span class='hs-varid'>prohibitedSuperClassSolve</span><span class='hs-layout'>,</span> <span class='hs-varid'>mightMatchLater</span><span class='hs-layout'>,</span>
<a name="line-60"></a>    <span class='hs-varid'>getUnsolvedInerts</span><span class='hs-layout'>,</span>
<a name="line-61"></a>    <span class='hs-varid'>removeInertCts</span><span class='hs-layout'>,</span> <span class='hs-varid'>getPendingGivenScs</span><span class='hs-layout'>,</span>
<a name="line-62"></a>    <span class='hs-varid'>addInertCan</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertFunEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>addInertForAll</span><span class='hs-layout'>,</span>
<a name="line-63"></a>    <span class='hs-varid'>emitWorkNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>emitWork</span><span class='hs-layout'>,</span>
<a name="line-64"></a>    <span class='hs-varid'>isImprovable</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>    <span class='hs-comment'>-- The Model</span>
<a name="line-67"></a>    <span class='hs-varid'>kickOutAfterUnification</span><span class='hs-layout'>,</span>
<a name="line-68"></a>
<a name="line-69"></a>    <span class='hs-comment'>-- Inert Safe Haskell safe-overlap failures</span>
<a name="line-70"></a>    <span class='hs-varid'>addInertSafehask</span><span class='hs-layout'>,</span> <span class='hs-varid'>insertSafeOverlapFailureTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>updInertSafehask</span><span class='hs-layout'>,</span>
<a name="line-71"></a>    <span class='hs-varid'>getSafeOverlapFailures</span><span class='hs-layout'>,</span>
<a name="line-72"></a>
<a name="line-73"></a>    <span class='hs-comment'>-- Inert CDictCans</span>
<a name="line-74"></a>    <span class='hs-conid'>DictMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDictMap</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInertDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>addDict</span><span class='hs-layout'>,</span>
<a name="line-75"></a>    <span class='hs-varid'>addDictsByClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>delDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>filterDicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>findDict</span><span class='hs-layout'>,</span>
<a name="line-76"></a>
<a name="line-77"></a>    <span class='hs-comment'>-- Inert CTyEqCans</span>
<a name="line-78"></a>    <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>,</span> <span class='hs-varid'>findTyEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldTyEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>isInInertEqs</span><span class='hs-layout'>,</span>
<a name="line-79"></a>    <span class='hs-varid'>lookupFlattenTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInertTyVar</span><span class='hs-layout'>,</span>
<a name="line-80"></a>
<a name="line-81"></a>    <span class='hs-comment'>-- Inert solved dictionaries</span>
<a name="line-82"></a>    <span class='hs-varid'>addSolvedDict</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupSolvedDict</span><span class='hs-layout'>,</span>
<a name="line-83"></a>
<a name="line-84"></a>    <span class='hs-comment'>-- Irreds</span>
<a name="line-85"></a>    <span class='hs-varid'>foldIrreds</span><span class='hs-layout'>,</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-comment'>-- The flattening cache</span>
<a name="line-88"></a>    <span class='hs-varid'>lookupFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendFlatCache</span><span class='hs-layout'>,</span> <span class='hs-varid'>newFlattenSkolem</span><span class='hs-layout'>,</span>            <span class='hs-comment'>-- Flatten skolems</span>
<a name="line-89"></a>    <span class='hs-varid'>dischargeFunEq</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprKicked</span><span class='hs-layout'>,</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-comment'>-- Inert CFunEqCans</span>
<a name="line-92"></a>    <span class='hs-varid'>updInertFunEqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>findFunEq</span><span class='hs-layout'>,</span>
<a name="line-93"></a>    <span class='hs-varid'>findFunEqsByTyCon</span><span class='hs-layout'>,</span>
<a name="line-94"></a>
<a name="line-95"></a>    <span class='hs-varid'>instDFunType</span><span class='hs-layout'>,</span>                              <span class='hs-comment'>-- Instantiation</span>
<a name="line-96"></a>
<a name="line-97"></a>    <span class='hs-comment'>-- MetaTyVars</span>
<a name="line-98"></a>    <span class='hs-varid'>newFlexiTcSTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexi</span><span class='hs-layout'>,</span> <span class='hs-varid'>instFlexiX</span><span class='hs-layout'>,</span>
<a name="line-99"></a>    <span class='hs-varid'>cloneMetaTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>demoteUnfilledFmv</span><span class='hs-layout'>,</span>
<a name="line-100"></a>    <span class='hs-varid'>tcInstType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstSkolTyVarsX</span><span class='hs-layout'>,</span>
<a name="line-101"></a>
<a name="line-102"></a>    <span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span>
<a name="line-103"></a>    <span class='hs-varid'>isFilledMetaTyVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isFilledMetaTyVar</span><span class='hs-layout'>,</span>
<a name="line-104"></a>    <span class='hs-varid'>zonkTyCoVarsAndFV</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcType</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkTcTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkCo</span><span class='hs-layout'>,</span>
<a name="line-105"></a>    <span class='hs-varid'>zonkTyCoVarsAndFVList</span><span class='hs-layout'>,</span>
<a name="line-106"></a>    <span class='hs-varid'>zonkSimples</span><span class='hs-layout'>,</span> <span class='hs-varid'>zonkWC</span><span class='hs-layout'>,</span>
<a name="line-107"></a>    <span class='hs-varid'>zonkTcTyCoVarBndr</span><span class='hs-layout'>,</span>
<a name="line-108"></a>
<a name="line-109"></a>    <span class='hs-comment'>-- References</span>
<a name="line-110"></a>    <span class='hs-varid'>newTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>readTcRef</span><span class='hs-layout'>,</span> <span class='hs-varid'>updTcRef</span><span class='hs-layout'>,</span>
<a name="line-111"></a>
<a name="line-112"></a>    <span class='hs-comment'>-- Misc</span>
<a name="line-113"></a>    <span class='hs-varid'>getDefaultInfo</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDynFlags</span><span class='hs-layout'>,</span> <span class='hs-varid'>getGlobalRdrEnvTcS</span><span class='hs-layout'>,</span>
<a name="line-114"></a>    <span class='hs-varid'>matchFam</span><span class='hs-layout'>,</span> <span class='hs-varid'>matchFamTcM</span><span class='hs-layout'>,</span>
<a name="line-115"></a>    <span class='hs-varid'>checkWellStagedDFun</span><span class='hs-layout'>,</span>
<a name="line-116"></a>    <span class='hs-varid'>pprEq</span>                                    <span class='hs-comment'>-- Smaller utils, re-exported from TcM</span>
<a name="line-117"></a>                                             <span class='hs-comment'>-- TODO (DV): these are only really used in the</span>
<a name="line-118"></a>                                             <span class='hs-comment'>-- instance matcher in TcSimplify. I am wondering</span>
<a name="line-119"></a>                                             <span class='hs-comment'>-- if the whole instance matcher simply belongs</span>
<a name="line-120"></a>                                             <span class='hs-comment'>-- here</span>
<a name="line-121"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-122"></a>
<a name="line-123"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-124"></a>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcPrelude</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>HscTypes</span>
<a name="line-128"></a>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Inst</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-131"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInst</span>
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FamInstEnv</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcRnMonad</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcMType</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>TcEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-137"></a>       <span class='hs-layout'>(</span> <span class='hs-varid'>checkWellStaged</span><span class='hs-layout'>,</span> <span class='hs-varid'>topIdLvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcGetDefaultTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupClass</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLookupId</span> <span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span><span class='hs-layout'>(</span> <span class='hs-varid'>heqTyConKey</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTyConKey</span> <span class='hs-layout'>)</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCoRep</span><span class='hs-layout'>(</span> <span class='hs-varid'>coHoleCoVar</span> <span class='hs-layout'>)</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Coercion</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcErrors</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>solverDepthErrorTcS</span> <span class='hs-layout'>)</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Module</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HasModule</span><span class='hs-layout'>,</span> <span class='hs-varid'>getModule</span> <span class='hs-layout'>)</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>RdrName</span> <span class='hs-layout'>(</span> <span class='hs-conid'>GlobalRdrEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-layout'>)</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>RnEnv</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>TcM</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnTypes</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unique</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-167"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqDFM</span>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-169"></a>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoreMap</span>
<a name="line-171"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-172"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Control.Monad.Fail</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>MonadFail</span>
<a name="line-173"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MonadUtils</span>
<a name="line-174"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.IORef</span>
<a name="line-175"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>foldl'</span><span class='hs-layout'>,</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
<a name="line-176"></a>
<a name="line-177"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-178"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Digraph</span>
<a name="line-179"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-180"></a><span class='hs-cpp'>#endif</span>
<a name="line-181"></a>
<a name="line-182"></a><span class='hs-comment'>{-
<a name="line-183"></a>************************************************************************
<a name="line-184"></a>*                                                                      *
<a name="line-185"></a>*                            Worklists                                *
<a name="line-186"></a>*  Canonical and non-canonical constraints that the simplifier has to  *
<a name="line-187"></a>*  work on. Including their simplification depths.                     *
<a name="line-188"></a>*                                                                      *
<a name="line-189"></a>*                                                                      *
<a name="line-190"></a>************************************************************************
<a name="line-191"></a>
<a name="line-192"></a>Note [WorkList priorities]
<a name="line-193"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-194"></a>A WorkList contains canonical and non-canonical items (of all flavors).
<a name="line-195"></a>Notice that each Ct now has a simplification depth. We may
<a name="line-196"></a>consider using this depth for prioritization as well in the future.
<a name="line-197"></a>
<a name="line-198"></a>As a simple form of priority queue, our worklist separates out
<a name="line-199"></a>
<a name="line-200"></a>* equalities (wl_eqs); see Note [Prioritise equalities]
<a name="line-201"></a>* type-function equalities (wl_funeqs)
<a name="line-202"></a>* all the rest (wl_rest)
<a name="line-203"></a>
<a name="line-204"></a>Note [Prioritise equalities]
<a name="line-205"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-206"></a>It's very important to process equalities /first/:
<a name="line-207"></a>
<a name="line-208"></a>* (Efficiency)  The general reason to do so is that if we process a
<a name="line-209"></a>  class constraint first, we may end up putting it into the inert set
<a name="line-210"></a>  and then kicking it out later.  That's extra work compared to just
<a name="line-211"></a>  doing the equality first.
<a name="line-212"></a>
<a name="line-213"></a>* (Avoiding fundep iteration) As Trac #14723 showed, it's possible to
<a name="line-214"></a>  get non-termination if we
<a name="line-215"></a>      - Emit the Derived fundep equalities for a class constraint,
<a name="line-216"></a>        generating some fresh unification variables.
<a name="line-217"></a>      - That leads to some unification
<a name="line-218"></a>      - Which kicks out the class constraint
<a name="line-219"></a>      - Which isn't solved (because there are still some more Derived
<a name="line-220"></a>        equalities in the work-list), but generates yet more fundeps
<a name="line-221"></a>  Solution: prioritise derived equalities over class constraints
<a name="line-222"></a>
<a name="line-223"></a>* (Class equalities) We need to prioritise equalities even if they
<a name="line-224"></a>  are hidden inside a class constraint;
<a name="line-225"></a>  see Note [Prioritise class equalities]
<a name="line-226"></a>
<a name="line-227"></a>* (Kick-out) We want to apply this priority scheme to kicked-out
<a name="line-228"></a>  constraints too (see the call to extendWorkListCt in kick_out_rewritable
<a name="line-229"></a>  E.g. a CIrredCan can be a hetero-kinded (t1 ~ t2), which may become
<a name="line-230"></a>  homo-kinded when kicked out, and hence we want to priotitise it.
<a name="line-231"></a>
<a name="line-232"></a>* (Derived equalities) Originally we tried to postpone processing
<a name="line-233"></a>  Derived equalities, in the hope that we might never need to deal
<a name="line-234"></a>  with them at all; but in fact we must process Derived equalities
<a name="line-235"></a>  eagerly, partly for the (Efficiency) reason, and more importantly
<a name="line-236"></a>  for (Avoiding fundep iteration).
<a name="line-237"></a>
<a name="line-238"></a>Note [Prioritise class equalities]
<a name="line-239"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-240"></a>We prioritise equalities in the solver (see selectWorkItem). But class
<a name="line-241"></a>constraints like (a ~ b) and (a ~~ b) are actually equalities too;
<a name="line-242"></a>see Note [The equality types story] in TysPrim.
<a name="line-243"></a>
<a name="line-244"></a>Failing to prioritise these is inefficient (more kick-outs etc).
<a name="line-245"></a>But, worse, it can prevent us spotting a "recursive knot" among
<a name="line-246"></a>Wanted constraints.  See comment:10 of Trac #12734 for a worked-out
<a name="line-247"></a>example.
<a name="line-248"></a>
<a name="line-249"></a>So we arrange to put these particular class constraints in the wl_eqs.
<a name="line-250"></a>
<a name="line-251"></a>  NB: since we do not currently apply the substitution to the
<a name="line-252"></a>  inert_solved_dicts, the knot-tying still seems a bit fragile.
<a name="line-253"></a>  But this makes it better.
<a name="line-254"></a>-}</span>
<a name="line-255"></a>
<a name="line-256"></a><a name="WorkList"></a><span class='hs-comment'>-- See Note [WorkList priorities]</span>
<a name="line-257"></a><a name="WorkList"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WorkList</span>
<a name="line-258"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- CTyEqCan, CDictCan, CIrredCan</span>
<a name="line-259"></a>                             <span class='hs-comment'>-- Given, Wanted, and Derived</span>
<a name="line-260"></a>                       <span class='hs-comment'>-- Contains both equality constraints and their</span>
<a name="line-261"></a>                       <span class='hs-comment'>-- class-level variants (a~b) and (a~~b);</span>
<a name="line-262"></a>                       <span class='hs-comment'>-- See Note [Prioritise equalities]</span>
<a name="line-263"></a>                       <span class='hs-comment'>-- See Note [Prioritise class equalities]</span>
<a name="line-264"></a>
<a name="line-265"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-266"></a>
<a name="line-267"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-268"></a>
<a name="line-269"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>  <span class='hs-comment'>-- See Note [Residual implications]</span>
<a name="line-270"></a>    <span class='hs-layout'>}</span>
<a name="line-271"></a>
<a name="line-272"></a><a name="appendWorkList"></a><span class='hs-definition'>appendWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-273"></a><span class='hs-definition'>appendWorkList</span>
<a name="line-274"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs1</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span>
<a name="line-275"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-276"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest2</span>
<a name="line-277"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-278"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs1</span>     <span class='hs-varop'>++</span> <span class='hs-varid'>eqs2</span>
<a name="line-279"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs1</span>  <span class='hs-varop'>++</span> <span class='hs-varid'>funeqs2</span>
<a name="line-280"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest1</span>    <span class='hs-varop'>++</span> <span class='hs-varid'>rest2</span>
<a name="line-281"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics1</span> <span class='hs-varop'>`unionBags`</span>   <span class='hs-varid'>implics2</span> <span class='hs-layout'>}</span>
<a name="line-282"></a>
<a name="line-283"></a><a name="workListSize"></a><span class='hs-definition'>workListSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-284"></a><span class='hs-definition'>workListSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-285"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>funeqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>rest</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="workListWantedCount"></a><span class='hs-definition'>workListWantedCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-288"></a><span class='hs-comment'>-- Count the things we need to solve</span>
<a name="line-289"></a><span class='hs-comment'>-- excluding the insolubles (c.f. inert_count)</span>
<a name="line-290"></a><span class='hs-definition'>workListWantedCount</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-291"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>+</span> <span class='hs-varid'>count</span> <span class='hs-varid'>is_wanted</span> <span class='hs-varid'>rest</span>
<a name="line-292"></a>  <span class='hs-keyword'>where</span>
<a name="line-293"></a>    <span class='hs-varid'>is_wanted</span> <span class='hs-varid'>ct</span>
<a name="line-294"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insol</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-295"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varid'>insol</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isWanted</span> <span class='hs-varid'>ev</span>
<a name="line-296"></a>     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-297"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span>
<a name="line-298"></a>
<a name="line-299"></a><a name="extendWorkListEq"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-300"></a><span class='hs-definition'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-301"></a>
<a name="line-302"></a><a name="extendWorkListFunEq"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-303"></a><span class='hs-definition'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="extendWorkListNonEq"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-306"></a><span class='hs-comment'>-- Extension by non equality</span>
<a name="line-307"></a><span class='hs-definition'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>wl_rest</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-308"></a>
<a name="line-309"></a><a name="extendWorkListDeriveds"></a><span class='hs-definition'>extendWorkListDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-310"></a><span class='hs-definition'>extendWorkListDeriveds</span> <span class='hs-varid'>evs</span> <span class='hs-varid'>wl</span>
<a name="line-311"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendWorkListCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-varid'>wl</span>
<a name="line-312"></a>
<a name="line-313"></a><a name="extendWorkListImplic"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-314"></a><span class='hs-definition'>extendWorkListImplic</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>}</span>
<a name="line-315"></a>
<a name="line-316"></a><a name="extendWorkListCt"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-317"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-318"></a><span class='hs-definition'>extendWorkListCt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-319"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-320"></a>     <span class='hs-conid'>EqPred</span> <span class='hs-conid'>NomEq</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span>
<a name="line-321"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTyConAppTyCon_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-322"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>isTypeFamilyTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-323"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListFunEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-324"></a>
<a name="line-325"></a>     <span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>
<a name="line-326"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-327"></a>
<a name="line-328"></a>     <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-keyword'>_</span>  <span class='hs-comment'>-- See Note [Prioritise class equalities]</span>
<a name="line-329"></a>       <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>heqTyConKey</span>
<a name="line-330"></a>       <span class='hs-varop'>||</span> <span class='hs-varid'>cls</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqTyConKey</span>
<a name="line-331"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-332"></a>
<a name="line-333"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendWorkListNonEq</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>wl</span>
<a name="line-334"></a>
<a name="line-335"></a><a name="extendWorkListCts"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span>
<a name="line-336"></a><span class='hs-comment'>-- Agnostic</span>
<a name="line-337"></a><span class='hs-definition'>extendWorkListCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>extendWorkListCt</span> <span class='hs-varid'>wl</span> <span class='hs-varid'>cts</span>
<a name="line-338"></a>
<a name="line-339"></a><a name="isEmptyWorkList"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-340"></a><span class='hs-definition'>isEmptyWorkList</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span>
<a name="line-341"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-342"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>rest</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>funeqs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span>
<a name="line-343"></a>
<a name="line-344"></a><a name="emptyWorkList"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-345"></a><span class='hs-definition'>emptyWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-346"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span> <span class='hs-layout'>}</span>
<a name="line-347"></a>
<a name="line-348"></a><a name="selectWorkItem"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-349"></a><span class='hs-comment'>-- See Note [Prioritise equalities]</span>
<a name="line-350"></a><span class='hs-definition'>selectWorkItem</span> <span class='hs-varid'>wl</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span>
<a name="line-351"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-352"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-353"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>fes</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>feqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fes</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-354"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_rest</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-355"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-356"></a>
<a name="line-357"></a><a name="getWorkList"></a><span class='hs-definition'>getWorkList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WorkList</span>
<a name="line-358"></a><span class='hs-definition'>getWorkList</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-359"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-360"></a>
<a name="line-361"></a><a name="selectNextWorkItem"></a><span class='hs-definition'>selectNextWorkItem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-362"></a><span class='hs-comment'>-- Pick which work item to do next</span>
<a name="line-363"></a><span class='hs-comment'>-- See Note [Prioritise equalities]</span>
<a name="line-364"></a><span class='hs-definition'>selectNextWorkItem</span>
<a name="line-365"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-366"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-367"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>selectWorkItem</span> <span class='hs-varid'>wl</span> <span class='hs-keyword'>of</span> <span class='hs-layout'>{</span>
<a name="line-368"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>;</span>
<a name="line-369"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_wl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-370"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkReductionDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-371"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>new_wl</span><span class='hs-layout'>)</span>
<a name="line-372"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-373"></a>
<a name="line-374"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-comment'>-- Pretty printing</span>
<a name="line-375"></a><a name="instance%20Outputable%20WorkList"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>WorkList</span> <span class='hs-keyword'>where</span>
<a name="line-376"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>WL</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs</span>
<a name="line-377"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>wl_rest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rest</span><span class='hs-layout'>,</span> <span class='hs-varid'>wl_implics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-378"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"WL"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>braces</span> <span class='hs-varop'>$</span>
<a name="line-379"></a>     <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-380"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-381"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-382"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Funeqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>feqs</span><span class='hs-layout'>)</span>
<a name="line-383"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-384"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Non-eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-385"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-386"></a>            <span class='hs-varid'>ifPprDebug</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Implics ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>implics</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-387"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"(Implics omitted)"</span><span class='hs-layout'>)</span>
<a name="line-388"></a>          <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-389"></a>
<a name="line-390"></a>
<a name="line-391"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-392"></a>*                                                                      *
<a name="line-393"></a>                InertSet: the inert set
<a name="line-394"></a>*                                                                      *
<a name="line-395"></a>*                                                                      *
<a name="line-396"></a>********************************************************************* -}</span>
<a name="line-397"></a>
<a name="line-398"></a><a name="InertSet"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertSet</span>
<a name="line-399"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span>
<a name="line-400"></a>              <span class='hs-comment'>-- Canonical Given, Wanted, Derived</span>
<a name="line-401"></a>              <span class='hs-comment'>-- Sometimes called "the inert set"</span>
<a name="line-402"></a>
<a name="line-403"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcTyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-404"></a>              <span class='hs-comment'>-- A list of (fsk, ty) pairs; we add one element when we flatten</span>
<a name="line-405"></a>              <span class='hs-comment'>-- a function application in a Given constraint, creating</span>
<a name="line-406"></a>              <span class='hs-comment'>-- a new fsk in newFlattenSkolem.  When leaving a nested scope,</span>
<a name="line-407"></a>              <span class='hs-comment'>-- unflattenGivens unifies fsk := ty</span>
<a name="line-408"></a>              <span class='hs-comment'>--</span>
<a name="line-409"></a>              <span class='hs-comment'>-- We could also get this info from inert_funeqs, filtered by</span>
<a name="line-410"></a>              <span class='hs-comment'>-- level, but it seems simpler and more direct to capture the</span>
<a name="line-411"></a>              <span class='hs-comment'>-- fsk as we generate them.</span>
<a name="line-412"></a>
<a name="line-413"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span>
<a name="line-414"></a>              <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-415"></a>              <span class='hs-comment'>-- If    F tys :-&gt; (co, rhs, flav),</span>
<a name="line-416"></a>              <span class='hs-comment'>-- then  co :: F tys ~ rhs</span>
<a name="line-417"></a>              <span class='hs-comment'>--       flav is [G] or [WD]</span>
<a name="line-418"></a>              <span class='hs-comment'>--</span>
<a name="line-419"></a>              <span class='hs-comment'>-- Just a hash-cons cache for use when flattening only</span>
<a name="line-420"></a>              <span class='hs-comment'>-- These include entirely un-processed goals, so don't use</span>
<a name="line-421"></a>              <span class='hs-comment'>-- them to solve a top-level goal, else you may end up solving</span>
<a name="line-422"></a>              <span class='hs-comment'>-- (w:F ty ~ a) by setting w:=w!  We just use the flat-cache</span>
<a name="line-423"></a>              <span class='hs-comment'>-- when allocating a new flatten-skolem.</span>
<a name="line-424"></a>              <span class='hs-comment'>-- Not necessarily inert wrt top-level equations (or inert_cans)</span>
<a name="line-425"></a>
<a name="line-426"></a>              <span class='hs-comment'>-- NB: An ExactFunEqMap -- this doesn't match via loose types!</span>
<a name="line-427"></a>
<a name="line-428"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-429"></a>              <span class='hs-comment'>-- All Wanteds, of form ev :: C t1 .. tn</span>
<a name="line-430"></a>              <span class='hs-comment'>-- See Note [Solved dictionaries]</span>
<a name="line-431"></a>              <span class='hs-comment'>-- and Note [Do not add superclasses of solved dictionaries]</span>
<a name="line-432"></a>       <span class='hs-layout'>}</span>
<a name="line-433"></a>
<a name="line-434"></a><a name="instance%20Outputable%20InertSet"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyword'>where</span>
<a name="line-435"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span>
<a name="line-436"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ifsks</span>
<a name="line-437"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-438"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics</span>
<a name="line-439"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Inert fsks ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ifsks</span>
<a name="line-440"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-441"></a>               <span class='hs-varid'>text</span> <span class='hs-str'>"Solved dicts ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-442"></a>         <span class='hs-keyword'>where</span>
<a name="line-443"></a>           <span class='hs-varid'>dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>solved_dicts</span><span class='hs-layout'>)</span>
<a name="line-444"></a>
<a name="line-445"></a><a name="emptyInertCans"></a><span class='hs-definition'>emptyInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span>
<a name="line-446"></a><span class='hs-definition'>emptyInertCans</span>
<a name="line-447"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-448"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDVarEnv</span>
<a name="line-449"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDicts</span>
<a name="line-450"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDicts</span>
<a name="line-451"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFunEqs</span>
<a name="line-452"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-453"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-454"></a>
<a name="line-455"></a><a name="emptyInert"></a><span class='hs-definition'>emptyInert</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span>
<a name="line-456"></a><span class='hs-definition'>emptyInert</span>
<a name="line-457"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInertCans</span>
<a name="line-458"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_fsks</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-459"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_flat_cache</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyExactFunEqs</span>
<a name="line-460"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyDictMap</span> <span class='hs-layout'>}</span>
<a name="line-461"></a>
<a name="line-462"></a>
<a name="line-463"></a><span class='hs-comment'>{- Note [Solved dictionaries]
<a name="line-464"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-465"></a>When we apply a top-level instance declaration, we add the "solved"
<a name="line-466"></a>dictionary to the inert_solved_dicts.  In general, we use it to avoid
<a name="line-467"></a>creating a new EvVar when we have a new goal that we have solved in
<a name="line-468"></a>the past.
<a name="line-469"></a>
<a name="line-470"></a>But in particular, we can use it to create *recursive* dictionaries.
<a name="line-471"></a>The simplest, degnerate case is
<a name="line-472"></a>    instance C [a] =&gt; C [a] where ...
<a name="line-473"></a>If we have
<a name="line-474"></a>    [W] d1 :: C [x]
<a name="line-475"></a>then we can apply the instance to get
<a name="line-476"></a>    d1 = $dfCList d
<a name="line-477"></a>    [W] d2 :: C [x]
<a name="line-478"></a>Now 'd1' goes in inert_solved_dicts, and we can solve d2 directly from d1.
<a name="line-479"></a>    d1 = $dfCList d
<a name="line-480"></a>    d2 = d1
<a name="line-481"></a>
<a name="line-482"></a>See Note [Example of recursive dictionaries]
<a name="line-483"></a>Other notes about solved dictionaries
<a name="line-484"></a>
<a name="line-485"></a>* See also Note [Do not add superclasses of solved dictionaries]
<a name="line-486"></a>
<a name="line-487"></a>* The inert_solved_dicts field is not rewritten by equalities,
<a name="line-488"></a>  so it may get out of date.
<a name="line-489"></a>
<a name="line-490"></a>* THe inert_solved_dicts are all Wanteds, never givens
<a name="line-491"></a>
<a name="line-492"></a>* We only cache dictionaries from top-level instances, not from
<a name="line-493"></a>  local quantified constraints.  Reason: if we cached the latter
<a name="line-494"></a>  we'd need to purge the cache when bringing new quantified
<a name="line-495"></a>  constraints into scope, because quantified constraints "shadow"
<a name="line-496"></a>  top-level instances.
<a name="line-497"></a>
<a name="line-498"></a>Note [Do not add superclasses of solved dictionaries]
<a name="line-499"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-500"></a>Every member of inert_solved_dicts is the result of applying a dictionary
<a name="line-501"></a>function, NOT of applying superclass selection to anything.
<a name="line-502"></a>Consider
<a name="line-503"></a>
<a name="line-504"></a>        class Ord a =&gt; C a where
<a name="line-505"></a>        instance Ord [a] =&gt; C [a] where ...
<a name="line-506"></a>
<a name="line-507"></a>Suppose we are trying to solve
<a name="line-508"></a>  [G] d1 : Ord a
<a name="line-509"></a>  [W] d2 : C [a]
<a name="line-510"></a>
<a name="line-511"></a>Then we'll use the instance decl to give
<a name="line-512"></a>
<a name="line-513"></a>  [G] d1 : Ord a     Solved: d2 : C [a] = $dfCList d3
<a name="line-514"></a>  [W] d3 : Ord [a]
<a name="line-515"></a>
<a name="line-516"></a>We must not add d4 : Ord [a] to the 'solved' set (by taking the
<a name="line-517"></a>superclass of d2), otherwise we'll use it to solve d3, without ever
<a name="line-518"></a>using d1, which would be a catastrophe.
<a name="line-519"></a>
<a name="line-520"></a>Solution: when extending the solved dictionaries, do not add superclasses.
<a name="line-521"></a>That's why each element of the inert_solved_dicts is the result of applying
<a name="line-522"></a>a dictionary function.
<a name="line-523"></a>
<a name="line-524"></a>Note [Example of recursive dictionaries]
<a name="line-525"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-526"></a>--- Example 1
<a name="line-527"></a>
<a name="line-528"></a>    data D r = ZeroD | SuccD (r (D r));
<a name="line-529"></a>
<a name="line-530"></a>    instance (Eq (r (D r))) =&gt; Eq (D r) where
<a name="line-531"></a>        ZeroD     == ZeroD     = True
<a name="line-532"></a>        (SuccD a) == (SuccD b) = a == b
<a name="line-533"></a>        _         == _         = False;
<a name="line-534"></a>
<a name="line-535"></a>    equalDC :: D [] -&gt; D [] -&gt; Bool;
<a name="line-536"></a>    equalDC = (==);
<a name="line-537"></a>
<a name="line-538"></a>We need to prove (Eq (D [])). Here's how we go:
<a name="line-539"></a>
<a name="line-540"></a>   [W] d1 : Eq (D [])
<a name="line-541"></a>By instance decl of Eq (D r):
<a name="line-542"></a>   [W] d2 : Eq [D []]      where   d1 = dfEqD d2
<a name="line-543"></a>By instance decl of Eq [a]:
<a name="line-544"></a>   [W] d3 : Eq (D [])      where   d2 = dfEqList d3
<a name="line-545"></a>                                   d1 = dfEqD d2
<a name="line-546"></a>Now this wanted can interact with our "solved" d1 to get:
<a name="line-547"></a>    d3 = d1
<a name="line-548"></a>
<a name="line-549"></a>-- Example 2:
<a name="line-550"></a>This code arises in the context of "Scrap Your Boilerplate with Class"
<a name="line-551"></a>
<a name="line-552"></a>    class Sat a
<a name="line-553"></a>    class Data ctx a
<a name="line-554"></a>    instance  Sat (ctx Char)             =&gt; Data ctx Char       -- dfunData1
<a name="line-555"></a>    instance (Sat (ctx [a]), Data ctx a) =&gt; Data ctx [a]        -- dfunData2
<a name="line-556"></a>
<a name="line-557"></a>    class Data Maybe a =&gt; Foo a
<a name="line-558"></a>
<a name="line-559"></a>    instance Foo t =&gt; Sat (Maybe t)                             -- dfunSat
<a name="line-560"></a>
<a name="line-561"></a>    instance Data Maybe a =&gt; Foo a                              -- dfunFoo1
<a name="line-562"></a>    instance Foo a        =&gt; Foo [a]                            -- dfunFoo2
<a name="line-563"></a>    instance                 Foo [Char]                         -- dfunFoo3
<a name="line-564"></a>
<a name="line-565"></a>Consider generating the superclasses of the instance declaration
<a name="line-566"></a>         instance Foo a =&gt; Foo [a]
<a name="line-567"></a>
<a name="line-568"></a>So our problem is this
<a name="line-569"></a>    [G] d0 : Foo t
<a name="line-570"></a>    [W] d1 : Data Maybe [t]   -- Desired superclass
<a name="line-571"></a>
<a name="line-572"></a>We may add the given in the inert set, along with its superclasses
<a name="line-573"></a>  Inert:
<a name="line-574"></a>    [G] d0 : Foo t
<a name="line-575"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-576"></a>  WorkList
<a name="line-577"></a>    [W] d1 : Data Maybe [t]
<a name="line-578"></a>
<a name="line-579"></a>Solve d1 using instance dfunData2; d1 := dfunData2 d2 d3
<a name="line-580"></a>  Inert:
<a name="line-581"></a>    [G] d0 : Foo t
<a name="line-582"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-583"></a>  Solved:
<a name="line-584"></a>        d1 : Data Maybe [t]
<a name="line-585"></a>  WorkList:
<a name="line-586"></a>    [W] d2 : Sat (Maybe [t])
<a name="line-587"></a>    [W] d3 : Data Maybe t
<a name="line-588"></a>
<a name="line-589"></a>Now, we may simplify d2 using dfunSat; d2 := dfunSat d4
<a name="line-590"></a>  Inert:
<a name="line-591"></a>    [G] d0 : Foo t
<a name="line-592"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-593"></a>  Solved:
<a name="line-594"></a>        d1 : Data Maybe [t]
<a name="line-595"></a>        d2 : Sat (Maybe [t])
<a name="line-596"></a>  WorkList:
<a name="line-597"></a>    [W] d3 : Data Maybe t
<a name="line-598"></a>    [W] d4 : Foo [t]
<a name="line-599"></a>
<a name="line-600"></a>Now, we can just solve d3 from d01; d3 := d01
<a name="line-601"></a>  Inert
<a name="line-602"></a>    [G] d0 : Foo t
<a name="line-603"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-604"></a>  Solved:
<a name="line-605"></a>        d1 : Data Maybe [t]
<a name="line-606"></a>        d2 : Sat (Maybe [t])
<a name="line-607"></a>  WorkList
<a name="line-608"></a>    [W] d4 : Foo [t]
<a name="line-609"></a>
<a name="line-610"></a>Now, solve d4 using dfunFoo2;  d4 := dfunFoo2 d5
<a name="line-611"></a>  Inert
<a name="line-612"></a>    [G] d0  : Foo t
<a name="line-613"></a>    [G] d01 : Data Maybe t   -- Superclass of d0
<a name="line-614"></a>  Solved:
<a name="line-615"></a>        d1 : Data Maybe [t]
<a name="line-616"></a>        d2 : Sat (Maybe [t])
<a name="line-617"></a>        d4 : Foo [t]
<a name="line-618"></a>  WorkList:
<a name="line-619"></a>    [W] d5 : Foo t
<a name="line-620"></a>
<a name="line-621"></a>Now, d5 can be solved! d5 := d0
<a name="line-622"></a>
<a name="line-623"></a>Result
<a name="line-624"></a>   d1 := dfunData2 d2 d3
<a name="line-625"></a>   d2 := dfunSat d4
<a name="line-626"></a>   d3 := d01
<a name="line-627"></a>   d4 := dfunFoo2 d5
<a name="line-628"></a>   d5 := d0
<a name="line-629"></a>-}</span>
<a name="line-630"></a>
<a name="line-631"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-632"></a>*                                                                      *
<a name="line-633"></a>                InertCans: the canonical inerts
<a name="line-634"></a>*                                                                      *
<a name="line-635"></a>*                                                                      *
<a name="line-636"></a>********************************************************************* -}</span>
<a name="line-637"></a>
<a name="line-638"></a><a name="InertCans"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InertCans</span>   <span class='hs-comment'>-- See Note [Detailed InertCans Invariants] for more</span>
<a name="line-639"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span>
<a name="line-640"></a>              <span class='hs-comment'>-- See Note [inert_eqs: the inert equalities]</span>
<a name="line-641"></a>              <span class='hs-comment'>-- All CTyEqCans; index is the LHS tyvar</span>
<a name="line-642"></a>              <span class='hs-comment'>-- Domain = skolems and untouchables; a touchable would be unified</span>
<a name="line-643"></a>
<a name="line-644"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span>
<a name="line-645"></a>              <span class='hs-comment'>-- All CFunEqCans; index is the whole family head type.</span>
<a name="line-646"></a>              <span class='hs-comment'>-- All Nominal (that's an invarint of all CFunEqCans)</span>
<a name="line-647"></a>              <span class='hs-comment'>-- LHS is fully rewritten (modulo eqCanRewrite constraints)</span>
<a name="line-648"></a>              <span class='hs-comment'>--     wrt inert_eqs</span>
<a name="line-649"></a>              <span class='hs-comment'>-- Can include all flavours, [G], [W], [WD], [D]</span>
<a name="line-650"></a>              <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-651"></a>
<a name="line-652"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-653"></a>              <span class='hs-comment'>-- Dictionaries only</span>
<a name="line-654"></a>              <span class='hs-comment'>-- All fully rewritten (modulo flavour constraints)</span>
<a name="line-655"></a>              <span class='hs-comment'>--     wrt inert_eqs</span>
<a name="line-656"></a>
<a name="line-657"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QCInst</span><span class='hs-keyglyph'>]</span>
<a name="line-658"></a>
<a name="line-659"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-660"></a>              <span class='hs-comment'>-- Failed dictionary resolution due to Safe Haskell overlapping</span>
<a name="line-661"></a>              <span class='hs-comment'>-- instances restriction. We keep this separate from inert_dicts</span>
<a name="line-662"></a>              <span class='hs-comment'>-- as it doesn't cause compilation failure, just safe inference</span>
<a name="line-663"></a>              <span class='hs-comment'>-- failure.</span>
<a name="line-664"></a>              <span class='hs-comment'>--</span>
<a name="line-665"></a>              <span class='hs-comment'>-- ^ See Note [Safe Haskell Overlapping Instances Implementation]</span>
<a name="line-666"></a>              <span class='hs-comment'>-- in TcSimplify</span>
<a name="line-667"></a>
<a name="line-668"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-669"></a>              <span class='hs-comment'>-- Irreducible predicates that cannot be made canonical,</span>
<a name="line-670"></a>              <span class='hs-comment'>--     and which don't interact with others (e.g.  (c a))</span>
<a name="line-671"></a>              <span class='hs-comment'>-- and insoluble predicates (e.g.  Int ~ Bool, or a ~ [a])</span>
<a name="line-672"></a>
<a name="line-673"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-674"></a>              <span class='hs-comment'>-- Number of Wanted goals in</span>
<a name="line-675"></a>              <span class='hs-comment'>--     inert_eqs, inert_dicts, inert_safehask, inert_irreds</span>
<a name="line-676"></a>              <span class='hs-comment'>-- Does not include insolubles</span>
<a name="line-677"></a>              <span class='hs-comment'>-- When non-zero, keep trying to solve</span>
<a name="line-678"></a>       <span class='hs-layout'>}</span>
<a name="line-679"></a>
<a name="line-680"></a><a name="InertEqs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>InertEqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-681"></a><a name="EqualCtList"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- See Note [EqualCtList invariants]</span>
<a name="line-682"></a>
<a name="line-683"></a><span class='hs-comment'>{- Note [Detailed InertCans Invariants]
<a name="line-684"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-685"></a>The InertCans represents a collection of constraints with the following properties:
<a name="line-686"></a>
<a name="line-687"></a>  * All canonical
<a name="line-688"></a>
<a name="line-689"></a>  * No two dictionaries with the same head
<a name="line-690"></a>  * No two CIrreds with the same type
<a name="line-691"></a>
<a name="line-692"></a>  * Family equations inert wrt top-level family axioms
<a name="line-693"></a>
<a name="line-694"></a>  * Dictionaries have no matching top-level instance
<a name="line-695"></a>
<a name="line-696"></a>  * Given family or dictionary constraints don't mention touchable
<a name="line-697"></a>    unification variables
<a name="line-698"></a>
<a name="line-699"></a>  * Non-CTyEqCan constraints are fully rewritten with respect
<a name="line-700"></a>    to the CTyEqCan equalities (modulo canRewrite of course;
<a name="line-701"></a>    eg a wanted cannot rewrite a given)
<a name="line-702"></a>
<a name="line-703"></a>  * CTyEqCan equalities: see Note [Applying the inert substitution]
<a name="line-704"></a>                         in TcFlatten
<a name="line-705"></a>
<a name="line-706"></a>Note [EqualCtList invariants]
<a name="line-707"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-708"></a>    * All are equalities
<a name="line-709"></a>    * All these equalities have the same LHS
<a name="line-710"></a>    * The list is never empty
<a name="line-711"></a>    * No element of the list can rewrite any other
<a name="line-712"></a>    * Derived before Wanted
<a name="line-713"></a>
<a name="line-714"></a>From the fourth invariant it follows that the list is
<a name="line-715"></a>   - A single [G], or
<a name="line-716"></a>   - Zero or one [D] or [WD], followd by any number of [W]
<a name="line-717"></a>
<a name="line-718"></a>The Wanteds can't rewrite anything which is why we put them last
<a name="line-719"></a>
<a name="line-720"></a>Note [Type family equations]
<a name="line-721"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-722"></a>Type-family equations, CFunEqCans, of form (ev : F tys ~ ty),
<a name="line-723"></a>live in three places
<a name="line-724"></a>
<a name="line-725"></a>  * The work-list, of course
<a name="line-726"></a>
<a name="line-727"></a>  * The inert_funeqs are un-solved but fully processed, and in
<a name="line-728"></a>    the InertCans. They can be [G], [W], [WD], or [D].
<a name="line-729"></a>
<a name="line-730"></a>  * The inert_flat_cache.  This is used when flattening, to get maximal
<a name="line-731"></a>    sharing. Everthing in the inert_flat_cache is [G] or [WD]
<a name="line-732"></a>
<a name="line-733"></a>    It contains lots of things that are still in the work-list.
<a name="line-734"></a>    E.g Suppose we have (w1: F (G a) ~ Int), and (w2: H (G a) ~ Int) in the
<a name="line-735"></a>        work list.  Then we flatten w1, dumping (w3: G a ~ f1) in the work
<a name="line-736"></a>        list.  Now if we flatten w2 before we get to w3, we still want to
<a name="line-737"></a>        share that (G a).
<a name="line-738"></a>    Because it contains work-list things, DO NOT use the flat cache to solve
<a name="line-739"></a>    a top-level goal.  Eg in the above example we don't want to solve w3
<a name="line-740"></a>    using w3 itself!
<a name="line-741"></a>
<a name="line-742"></a>The CFunEqCan Ownership Invariant:
<a name="line-743"></a>
<a name="line-744"></a>  * Each [G/W/WD] CFunEqCan has a distinct fsk or fmv
<a name="line-745"></a>    It "owns" that fsk/fmv, in the sense that:
<a name="line-746"></a>      - reducing a [W/WD] CFunEqCan fills in the fmv
<a name="line-747"></a>      - unflattening a [W/WD] CFunEqCan fills in the fmv
<a name="line-748"></a>      (in both cases unless an occurs-check would result)
<a name="line-749"></a>
<a name="line-750"></a>  * In contrast a [D] CFunEqCan does not "own" its fmv:
<a name="line-751"></a>      - reducing a [D] CFunEqCan does not fill in the fmv;
<a name="line-752"></a>        it just generates an equality
<a name="line-753"></a>      - unflattening ignores [D] CFunEqCans altogether
<a name="line-754"></a>
<a name="line-755"></a>
<a name="line-756"></a>Note [inert_eqs: the inert equalities]
<a name="line-757"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-758"></a>Definition [Can-rewrite relation]
<a name="line-759"></a>A "can-rewrite" relation between flavours, written f1 &gt;= f2, is a
<a name="line-760"></a>binary relation with the following properties
<a name="line-761"></a>
<a name="line-762"></a>  (R1) &gt;= is transitive
<a name="line-763"></a>  (R2) If f1 &gt;= f, and f2 &gt;= f,
<a name="line-764"></a>       then either f1 &gt;= f2 or f2 &gt;= f1
<a name="line-765"></a>
<a name="line-766"></a>Lemma.  If f1 &gt;= f then f1 &gt;= f1
<a name="line-767"></a>Proof.  By property (R2), with f1=f2
<a name="line-768"></a>
<a name="line-769"></a>Definition [Generalised substitution]
<a name="line-770"></a>A "generalised substitution" S is a set of triples (a -f-&gt; t), where
<a name="line-771"></a>  a is a type variable
<a name="line-772"></a>  t is a type
<a name="line-773"></a>  f is a flavour
<a name="line-774"></a>such that
<a name="line-775"></a>  (WF1) if (a -f1-&gt; t1) in S
<a name="line-776"></a>           (a -f2-&gt; t2) in S
<a name="line-777"></a>        then neither (f1 &gt;= f2) nor (f2 &gt;= f1) hold
<a name="line-778"></a>  (WF2) if (a -f-&gt; t) is in S, then t /= a
<a name="line-779"></a>
<a name="line-780"></a>Definition [Applying a generalised substitution]
<a name="line-781"></a>If S is a generalised substitution
<a name="line-782"></a>   S(f,a) = t,  if (a -fs-&gt; t) in S, and fs &gt;= f
<a name="line-783"></a>          = a,  otherwise
<a name="line-784"></a>Application extends naturally to types S(f,t), modulo roles.
<a name="line-785"></a>See Note [Flavours with roles].
<a name="line-786"></a>
<a name="line-787"></a>Theorem: S(f,a) is well defined as a function.
<a name="line-788"></a>Proof: Suppose (a -f1-&gt; t1) and (a -f2-&gt; t2) are both in S,
<a name="line-789"></a>               and  f1 &gt;= f and f2 &gt;= f
<a name="line-790"></a>       Then by (R2) f1 &gt;= f2 or f2 &gt;= f1, which contradicts (WF1)
<a name="line-791"></a>
<a name="line-792"></a>Notation: repeated application.
<a name="line-793"></a>  S^0(f,t)     = t
<a name="line-794"></a>  S^(n+1)(f,t) = S(f, S^n(t))
<a name="line-795"></a>
<a name="line-796"></a>Definition: inert generalised substitution
<a name="line-797"></a>A generalised substitution S is "inert" iff
<a name="line-798"></a>
<a name="line-799"></a>  (IG1) there is an n such that
<a name="line-800"></a>        for every f,t, S^n(f,t) = S^(n+1)(f,t)
<a name="line-801"></a>
<a name="line-802"></a>By (IG1) we define S*(f,t) to be the result of exahaustively
<a name="line-803"></a>applying S(f,_) to t.
<a name="line-804"></a>
<a name="line-805"></a>----------------------------------------------------------------
<a name="line-806"></a>Our main invariant:
<a name="line-807"></a>   the inert CTyEqCans should be an inert generalised substitution
<a name="line-808"></a>----------------------------------------------------------------
<a name="line-809"></a>
<a name="line-810"></a>Note that inertness is not the same as idempotence.  To apply S to a
<a name="line-811"></a>type, you may have to apply it recursive.  But inertness does
<a name="line-812"></a>guarantee that this recursive use will terminate.
<a name="line-813"></a>
<a name="line-814"></a>Note [Extending the inert equalities]
<a name="line-815"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-816"></a>Main Theorem [Stability under extension]
<a name="line-817"></a>   Suppose we have a "work item"
<a name="line-818"></a>       a -fw-&gt; t
<a name="line-819"></a>   and an inert generalised substitution S,
<a name="line-820"></a>   THEN the extended substitution T = S+(a -fw-&gt; t)
<a name="line-821"></a>        is an inert generalised substitution
<a name="line-822"></a>   PROVIDED
<a name="line-823"></a>      (T1) S(fw,a) = a     -- LHS of work-item is a fixpoint of S(fw,_)
<a name="line-824"></a>      (T2) S(fw,t) = t     -- RHS of work-item is a fixpoint of S(fw,_)
<a name="line-825"></a>      (T3) a not in t      -- No occurs check in the work item
<a name="line-826"></a>
<a name="line-827"></a>      AND, for every (b -fs-&gt; s) in S:
<a name="line-828"></a>           (K0) not (fw &gt;= fs)
<a name="line-829"></a>                Reason: suppose we kick out (a -fs-&gt; s),
<a name="line-830"></a>                        and add (a -fw-&gt; t) to the inert set.
<a name="line-831"></a>                        The latter can't rewrite the former,
<a name="line-832"></a>                        so the kick-out achieved nothing
<a name="line-833"></a>
<a name="line-834"></a>           OR { (K1) not (a = b)
<a name="line-835"></a>                     Reason: if fw &gt;= fs, WF1 says we can't have both
<a name="line-836"></a>                             a -fw-&gt; t  and  a -fs-&gt; s
<a name="line-837"></a>
<a name="line-838"></a>                AND (K2): guarantees inertness of the new substitution
<a name="line-839"></a>                    {  (K2a) not (fs &gt;= fs)
<a name="line-840"></a>                    OR (K2b) fs &gt;= fw
<a name="line-841"></a>                    OR (K2d) a not in s }
<a name="line-842"></a>
<a name="line-843"></a>                AND (K3) See Note [K3: completeness of solving]
<a name="line-844"></a>                    { (K3a) If the role of fs is nominal: s /= a
<a name="line-845"></a>                      (K3b) If the role of fs is representational:
<a name="line-846"></a>                            s is not of form (a t1 .. tn) } }
<a name="line-847"></a>
<a name="line-848"></a>
<a name="line-849"></a>Conditions (T1-T3) are established by the canonicaliser
<a name="line-850"></a>Conditions (K1-K3) are established by TcSMonad.kickOutRewritable
<a name="line-851"></a>
<a name="line-852"></a>The idea is that
<a name="line-853"></a>* (T1-2) are guaranteed by exhaustively rewriting the work-item
<a name="line-854"></a>  with S(fw,_).
<a name="line-855"></a>
<a name="line-856"></a>* T3 is guaranteed by a simple occurs-check on the work item.
<a name="line-857"></a>  This is done during canonicalisation, in canEqTyVar;
<a name="line-858"></a>  (invariant: a CTyEqCan never has an occurs check).
<a name="line-859"></a>
<a name="line-860"></a>* (K1-3) are the "kick-out" criteria.  (As stated, they are really the
<a name="line-861"></a>  "keep" criteria.) If the current inert S contains a triple that does
<a name="line-862"></a>  not satisfy (K1-3), then we remove it from S by "kicking it out",
<a name="line-863"></a>  and re-processing it.
<a name="line-864"></a>
<a name="line-865"></a>* Note that kicking out is a Bad Thing, because it means we have to
<a name="line-866"></a>  re-process a constraint.  The less we kick out, the better.
<a name="line-867"></a>  TODO: Make sure that kicking out really *is* a Bad Thing. We've assumed
<a name="line-868"></a>  this but haven't done the empirical study to check.
<a name="line-869"></a>
<a name="line-870"></a>* Assume we have  G&gt;=G, G&gt;=W and that's all.  Then, when performing
<a name="line-871"></a>  a unification we add a new given  a -G-&gt; ty.  But doing so does NOT require
<a name="line-872"></a>  us to kick out an inert wanted that mentions a, because of (K2a).  This
<a name="line-873"></a>  is a common case, hence good not to kick out.
<a name="line-874"></a>
<a name="line-875"></a>* Lemma (L2): if not (fw &gt;= fw), then K0 holds and we kick out nothing
<a name="line-876"></a>  Proof: using Definition [Can-rewrite relation], fw can't rewrite anything
<a name="line-877"></a>         and so K0 holds.  Intuitively, since fw can't rewrite anything,
<a name="line-878"></a>         adding it cannot cause any loops
<a name="line-879"></a>  This is a common case, because Wanteds cannot rewrite Wanteds.
<a name="line-880"></a>  It's used to avoid even looking for constraint to kick out.
<a name="line-881"></a>
<a name="line-882"></a>* Lemma (L1): The conditions of the Main Theorem imply that there is no
<a name="line-883"></a>              (a -fs-&gt; t) in S, s.t.  (fs &gt;= fw).
<a name="line-884"></a>  Proof. Suppose the contrary (fs &gt;= fw).  Then because of (T1),
<a name="line-885"></a>  S(fw,a)=a.  But since fs&gt;=fw, S(fw,a) = s, hence s=a.  But now we
<a name="line-886"></a>  have (a -fs-&gt; a) in S, which contradicts (WF2).
<a name="line-887"></a>
<a name="line-888"></a>* The extended substitution satisfies (WF1) and (WF2)
<a name="line-889"></a>  - (K1) plus (L1) guarantee that the extended substitution satisfies (WF1).
<a name="line-890"></a>  - (T3) guarantees (WF2).
<a name="line-891"></a>
<a name="line-892"></a>* (K2) is about inertness.  Intuitively, any infinite chain T^0(f,t),
<a name="line-893"></a>  T^1(f,t), T^2(f,T).... must pass through the new work item infinitely
<a name="line-894"></a>  often, since the substitution without the work item is inert; and must
<a name="line-895"></a>  pass through at least one of the triples in S infinitely often.
<a name="line-896"></a>
<a name="line-897"></a>  - (K2a): if not(fs&gt;=fs) then there is no f that fs can rewrite (fs&gt;=f),
<a name="line-898"></a>    and hence this triple never plays a role in application S(f,a).
<a name="line-899"></a>    It is always safe to extend S with such a triple.
<a name="line-900"></a>
<a name="line-901"></a>    (NB: we could strengten K1) in this way too, but see K3.
<a name="line-902"></a>
<a name="line-903"></a>  - (K2b): If this holds then, by (T2), b is not in t.  So applying the
<a name="line-904"></a>    work item does not generate any new opportunities for applying S
<a name="line-905"></a>
<a name="line-906"></a>  - (K2c): If this holds, we can't pass through this triple infinitely
<a name="line-907"></a>    often, because if we did then fs&gt;=f, fw&gt;=f, hence by (R2)
<a name="line-908"></a>      * either fw&gt;=fs, contradicting K2c
<a name="line-909"></a>      * or fs&gt;=fw; so by the argument in K2b we can't have a loop
<a name="line-910"></a>
<a name="line-911"></a>  - (K2d): if a not in s, we hae no further opportunity to apply the
<a name="line-912"></a>    work item, similar to (K2b)
<a name="line-913"></a>
<a name="line-914"></a>  NB: Dimitrios has a PDF that does this in more detail
<a name="line-915"></a>
<a name="line-916"></a>Key lemma to make it watertight.
<a name="line-917"></a>  Under the conditions of the Main Theorem,
<a name="line-918"></a>  forall f st fw &gt;= f, a is not in S^k(f,t), for any k
<a name="line-919"></a>
<a name="line-920"></a>Also, consider roles more carefully. See Note [Flavours with roles]
<a name="line-921"></a>
<a name="line-922"></a>Note [K3: completeness of solving]
<a name="line-923"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-924"></a>(K3) is not necessary for the extended substitution
<a name="line-925"></a>to be inert.  In fact K1 could be made stronger by saying
<a name="line-926"></a>   ... then (not (fw &gt;= fs) or not (fs &gt;= fs))
<a name="line-927"></a>But it's not enough for S to be inert; we also want completeness.
<a name="line-928"></a>That is, we want to be able to solve all soluble wanted equalities.
<a name="line-929"></a>Suppose we have
<a name="line-930"></a>
<a name="line-931"></a>   work-item   b -G-&gt; a
<a name="line-932"></a>   inert-item  a -W-&gt; b
<a name="line-933"></a>
<a name="line-934"></a>Assuming (G &gt;= W) but not (W &gt;= W), this fulfills all the conditions,
<a name="line-935"></a>so we could extend the inerts, thus:
<a name="line-936"></a>
<a name="line-937"></a>   inert-items   b -G-&gt; a
<a name="line-938"></a>                 a -W-&gt; b
<a name="line-939"></a>
<a name="line-940"></a>But if we kicked-out the inert item, we'd get
<a name="line-941"></a>
<a name="line-942"></a>   work-item     a -W-&gt; b
<a name="line-943"></a>   inert-item    b -G-&gt; a
<a name="line-944"></a>
<a name="line-945"></a>Then rewrite the work-item gives us (a -W-&gt; a), which is soluble via Refl.
<a name="line-946"></a>So we add one more clause to the kick-out criteria
<a name="line-947"></a>
<a name="line-948"></a>Another way to understand (K3) is that we treat an inert item
<a name="line-949"></a>        a -f-&gt; b
<a name="line-950"></a>in the same way as
<a name="line-951"></a>        b -f-&gt; a
<a name="line-952"></a>So if we kick out one, we should kick out the other.  The orientation
<a name="line-953"></a>is somewhat accidental.
<a name="line-954"></a>
<a name="line-955"></a>When considering roles, we also need the second clause (K3b). Consider
<a name="line-956"></a>
<a name="line-957"></a>  work-item    c -G/N-&gt; a
<a name="line-958"></a>  inert-item   a -W/R-&gt; b c
<a name="line-959"></a>
<a name="line-960"></a>The work-item doesn't get rewritten by the inert, because (&gt;=) doesn't hold.
<a name="line-961"></a>But we don't kick out the inert item because not (W/R &gt;= W/R).  So we just
<a name="line-962"></a>add the work item. But then, consider if we hit the following:
<a name="line-963"></a>
<a name="line-964"></a>  work-item    b -G/N-&gt; Id
<a name="line-965"></a>  inert-items  a -W/R-&gt; b c
<a name="line-966"></a>               c -G/N-&gt; a
<a name="line-967"></a>where
<a name="line-968"></a>  newtype Id x = Id x
<a name="line-969"></a>
<a name="line-970"></a>For similar reasons, if we only had (K3a), we wouldn't kick the
<a name="line-971"></a>representational inert out. And then, we'd miss solving the inert, which
<a name="line-972"></a>now reduced to reflexivity.
<a name="line-973"></a>
<a name="line-974"></a>The solution here is to kick out representational inerts whenever the
<a name="line-975"></a>tyvar of a work item is "exposed", where exposed means being at the
<a name="line-976"></a>head of the top-level application chain (a t1 .. tn).  See
<a name="line-977"></a>TcType.isTyVarHead. This is encoded in (K3b).
<a name="line-978"></a>
<a name="line-979"></a>Beware: if we make this test succeed too often, we kick out too much,
<a name="line-980"></a>and the solver might loop.  Consider (Trac #14363)
<a name="line-981"></a>  work item:   [G] a ~R f b
<a name="line-982"></a>  inert item:  [G] b ~R f a
<a name="line-983"></a>In GHC 8.2 the completeness tests more aggressive, and kicked out
<a name="line-984"></a>the inert item; but no rewriting happened and there was an infinite
<a name="line-985"></a>loop.  All we need is to have the tyvar at the head.
<a name="line-986"></a>
<a name="line-987"></a>Note [Flavours with roles]
<a name="line-988"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-989"></a>The system described in Note [inert_eqs: the inert equalities]
<a name="line-990"></a>discusses an abstract
<a name="line-991"></a>set of flavours. In GHC, flavours have two components: the flavour proper,
<a name="line-992"></a>taken from {Wanted, Derived, Given} and the equality relation (often called
<a name="line-993"></a>role), taken from {NomEq, ReprEq}.
<a name="line-994"></a>When substituting w.r.t. the inert set,
<a name="line-995"></a>as described in Note [inert_eqs: the inert equalities],
<a name="line-996"></a>we must be careful to respect all components of a flavour.
<a name="line-997"></a>For example, if we have
<a name="line-998"></a>
<a name="line-999"></a>  inert set: a -G/R-&gt; Int
<a name="line-1000"></a>             b -G/R-&gt; Bool
<a name="line-1001"></a>
<a name="line-1002"></a>  type role T nominal representational
<a name="line-1003"></a>
<a name="line-1004"></a>and we wish to compute S(W/R, T a b), the correct answer is T a Bool, NOT
<a name="line-1005"></a>T Int Bool. The reason is that T's first parameter has a nominal role, and
<a name="line-1006"></a>thus rewriting a to Int in T a b is wrong. Indeed, this non-congruence of
<a name="line-1007"></a>substitution means that the proof in Note [The inert equalities] may need
<a name="line-1008"></a>to be revisited, but we don't think that the end conclusion is wrong.
<a name="line-1009"></a>-}</span>
<a name="line-1010"></a>
<a name="line-1011"></a><a name="instance%20Outputable%20InertCans"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyword'>where</span>
<a name="line-1012"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqs</span>
<a name="line-1013"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-1014"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-1015"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span>
<a name="line-1016"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1017"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-1018"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyDVarEnv</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1019"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Equalities:"</span>
<a name="line-1020"></a>          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>eqs</span> <span class='hs-varid'>rest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>eqs</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyCts</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span>
<a name="line-1021"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1022"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Type-function equalities ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>funEqsToBag</span> <span class='hs-varid'>funeqs</span><span class='hs-layout'>)</span>
<a name="line-1023"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1024"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Dictionaries ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>)</span>
<a name="line-1025"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTcAppMap</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1026"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Safe Haskell unsafe overlap ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-layout'>(</span><span class='hs-varid'>dictsToBag</span> <span class='hs-varid'>safehask</span><span class='hs-layout'>)</span>
<a name="line-1027"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyCts</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1028"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Irreds ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprCts</span> <span class='hs-varid'>irreds</span>
<a name="line-1029"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>ppUnless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1030"></a>        <span class='hs-varid'>text</span> <span class='hs-str'>"Given instances ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span>
<a name="line-1031"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Unsolved goals ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span>
<a name="line-1032"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-1033"></a>
<a name="line-1034"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1035"></a>*                                                                      *
<a name="line-1036"></a>             Shadow constraints and improvement
<a name="line-1037"></a>*                                                                      *
<a name="line-1038"></a>************************************************************************
<a name="line-1039"></a>
<a name="line-1040"></a>Note [The improvement story and derived shadows]
<a name="line-1041"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1042"></a>Because Wanteds cannot rewrite Wanteds (see Note [Wanteds do not
<a name="line-1043"></a>rewrite Wanteds] in TcRnTypes), we may miss some opportunities for
<a name="line-1044"></a>solving.  Here's a classic example (indexed-types/should_fail/T4093a)
<a name="line-1045"></a>
<a name="line-1046"></a>    Ambiguity check for f: (Foo e ~ Maybe e) =&gt; Foo e
<a name="line-1047"></a>
<a name="line-1048"></a>    We get [G] Foo e ~ Maybe e
<a name="line-1049"></a>           [W] Foo e ~ Foo ee      -- ee is a unification variable
<a name="line-1050"></a>           [W] Foo ee ~ Maybe ee
<a name="line-1051"></a>
<a name="line-1052"></a>    Flatten: [G] Foo e ~ fsk
<a name="line-1053"></a>             [G] fsk ~ Maybe e   -- (A)
<a name="line-1054"></a>
<a name="line-1055"></a>             [W] Foo ee ~ fmv
<a name="line-1056"></a>             [W] fmv ~ fsk       -- (B) From Foo e ~ Foo ee
<a name="line-1057"></a>             [W] fmv ~ Maybe ee
<a name="line-1058"></a>
<a name="line-1059"></a>    --&gt; rewrite (B) with (A)
<a name="line-1060"></a>             [W] Foo ee ~ fmv
<a name="line-1061"></a>             [W] fmv ~ Maybe e
<a name="line-1062"></a>             [W] fmv ~ Maybe ee
<a name="line-1063"></a>
<a name="line-1064"></a>    But now we appear to be stuck, since we don't rewrite Wanteds with
<a name="line-1065"></a>    Wanteds.  This is silly because we can see that ee := e is the
<a name="line-1066"></a>    only solution.
<a name="line-1067"></a>
<a name="line-1068"></a>The basic plan is
<a name="line-1069"></a>  * generate Derived constraints that shadow Wanted constraints
<a name="line-1070"></a>  * allow Derived to rewrite Derived
<a name="line-1071"></a>  * in order to cause some unifications to take place
<a name="line-1072"></a>  * that in turn solve the original Wanteds
<a name="line-1073"></a>
<a name="line-1074"></a>The ONLY reason for all these Derived equalities is to tell us how to
<a name="line-1075"></a>unify a variable: that is, what Mark Jones calls "improvement".
<a name="line-1076"></a>
<a name="line-1077"></a>The same idea is sometimes also called "saturation"; find all the
<a name="line-1078"></a>equalities that must hold in any solution.
<a name="line-1079"></a>
<a name="line-1080"></a>Or, equivalently, you can think of the derived shadows as implementing
<a name="line-1081"></a>the "model": a non-idempotent but no-occurs-check substitution,
<a name="line-1082"></a>reflecting *all* *Nominal* equalities (a ~N ty) that are not
<a name="line-1083"></a>immediately soluble by unification.
<a name="line-1084"></a>
<a name="line-1085"></a>More specifically, here's how it works (Oct 16):
<a name="line-1086"></a>
<a name="line-1087"></a>* Wanted constraints are born as [WD]; this behaves like a
<a name="line-1088"></a>  [W] and a [D] paired together.
<a name="line-1089"></a>
<a name="line-1090"></a>* When we are about to add a [WD] to the inert set, if it can
<a name="line-1091"></a>  be rewritten by a [D] a ~ ty, then we split it into [W] and [D],
<a name="line-1092"></a>  putting the latter into the work list (see maybeEmitShadow).
<a name="line-1093"></a>
<a name="line-1094"></a>In the example above, we get to the point where we are stuck:
<a name="line-1095"></a>    [WD] Foo ee ~ fmv
<a name="line-1096"></a>    [WD] fmv ~ Maybe e
<a name="line-1097"></a>    [WD] fmv ~ Maybe ee
<a name="line-1098"></a>
<a name="line-1099"></a>But now when [WD] fmv ~ Maybe ee is about to be added, we'll
<a name="line-1100"></a>split it into [W] and [D], since the inert [WD] fmv ~ Maybe e
<a name="line-1101"></a>can rewrite it.  Then:
<a name="line-1102"></a>    work item: [D] fmv ~ Maybe ee
<a name="line-1103"></a>    inert:     [W] fmv ~ Maybe ee
<a name="line-1104"></a>               [WD] fmv ~ Maybe e   -- (C)
<a name="line-1105"></a>               [WD] Foo ee ~ fmv
<a name="line-1106"></a>
<a name="line-1107"></a>See Note [Splitting WD constraints].  Now the work item is rewritten
<a name="line-1108"></a>by (C) and we soon get ee := e.
<a name="line-1109"></a>
<a name="line-1110"></a>Additional notes:
<a name="line-1111"></a>
<a name="line-1112"></a>  * The derived shadow equalities live in inert_eqs, along with
<a name="line-1113"></a>    the Givens and Wanteds; see Note [EqualCtList invariants].
<a name="line-1114"></a>
<a name="line-1115"></a>  * We make Derived shadows only for Wanteds, not Givens.  So we
<a name="line-1116"></a>    have only [G], not [GD] and [G] plus splitting.  See
<a name="line-1117"></a>    Note [Add derived shadows only for Wanteds]
<a name="line-1118"></a>
<a name="line-1119"></a>  * We also get Derived equalities from functional dependencies
<a name="line-1120"></a>    and type-function injectivity; see calls to unifyDerived.
<a name="line-1121"></a>
<a name="line-1122"></a>  * This splitting business applies to CFunEqCans too; and then
<a name="line-1123"></a>    we do apply type-function reductions to the [D] CFunEqCan.
<a name="line-1124"></a>    See Note [Reduction for Derived CFunEqCans]
<a name="line-1125"></a>
<a name="line-1126"></a>  * It's worth having [WD] rather than just [W] and [D] because
<a name="line-1127"></a>    * efficiency: silly to process the same thing twice
<a name="line-1128"></a>    * inert_funeqs, inert_dicts is a finite map keyed by
<a name="line-1129"></a>      the type; it's inconvenient for it to map to TWO constraints
<a name="line-1130"></a>
<a name="line-1131"></a>Note [Splitting WD constraints]
<a name="line-1132"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1133"></a>We are about to add a [WD] constraint to the inert set; and we
<a name="line-1134"></a>know that the inert set has fully rewritten it.  Should we split
<a name="line-1135"></a>it into [W] and [D], and put the [D] in the work list for further
<a name="line-1136"></a>work?
<a name="line-1137"></a>
<a name="line-1138"></a>* CDictCan (C tys) or CFunEqCan (F tys ~ fsk):
<a name="line-1139"></a>  Yes if the inert set could rewrite tys to make the class constraint,
<a name="line-1140"></a>  or type family, fire.  That is, yes if the inert_eqs intersects
<a name="line-1141"></a>  with the free vars of tys.  For this test we use
<a name="line-1142"></a>  (anyRewritableTyVar True) which ignores casts and coercions in tys,
<a name="line-1143"></a>  because rewriting the casts or coercions won't make the thing fire
<a name="line-1144"></a>  more often.
<a name="line-1145"></a>
<a name="line-1146"></a>* CTyEqCan (a ~ ty): Yes if the inert set could rewrite 'a' or 'ty'.
<a name="line-1147"></a>  We need to check both 'a' and 'ty' against the inert set:
<a name="line-1148"></a>    - Inert set contains  [D] a ~ ty2
<a name="line-1149"></a>      Then we want to put [D] a ~ ty in the worklist, so we'll
<a name="line-1150"></a>      get [D] ty ~ ty2 with consequent good things
<a name="line-1151"></a>
<a name="line-1152"></a>    - Inert set contains [D] b ~ a, where b is in ty.
<a name="line-1153"></a>      We can't just add [WD] a ~ ty[b] to the inert set, because
<a name="line-1154"></a>      that breaks the inert-set invariants.  If we tried to
<a name="line-1155"></a>      canonicalise another [D] constraint mentioning 'a', we'd
<a name="line-1156"></a>      get an infinite loop
<a name="line-1157"></a>
<a name="line-1158"></a>  Moreover we must use (anyRewritableTyVar False) for the RHS,
<a name="line-1159"></a>  because even tyvars in the casts and coercions could give
<a name="line-1160"></a>  an infinite loop if we don't expose it
<a name="line-1161"></a>
<a name="line-1162"></a>* CIrredCan: Yes if the inert set can rewrite the constraint.
<a name="line-1163"></a>  We used to think splitting irreds was unnecessary, but
<a name="line-1164"></a>  see Note [Splitting Irred WD constraints]
<a name="line-1165"></a>
<a name="line-1166"></a>* Others: nothing is gained by splitting.
<a name="line-1167"></a>
<a name="line-1168"></a>Note [Splitting Irred WD constraints]
<a name="line-1169"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1170"></a>Splitting Irred constraints can make a difference. Here is the
<a name="line-1171"></a>scenario:
<a name="line-1172"></a>
<a name="line-1173"></a>  a[sk] :: F v     -- F is a type family
<a name="line-1174"></a>  beta :: alpha
<a name="line-1175"></a>
<a name="line-1176"></a>  work item: [WD] a ~ beta
<a name="line-1177"></a>
<a name="line-1178"></a>This is heterogeneous, so we try flattening the kinds.
<a name="line-1179"></a>
<a name="line-1180"></a>  co :: F v ~ fmv
<a name="line-1181"></a>  [WD] (a |&gt; co) ~ beta
<a name="line-1182"></a>
<a name="line-1183"></a>This is still hetero, so we emit a kind equality and make the work item an
<a name="line-1184"></a>inert Irred.
<a name="line-1185"></a>
<a name="line-1186"></a>  work item: [D] fmv ~ alpha
<a name="line-1187"></a>  inert: [WD] (a |&gt; co) ~ beta (CIrredCan)
<a name="line-1188"></a>
<a name="line-1189"></a>Can't make progress on the work item. Add to inert set. This kicks out the
<a name="line-1190"></a>old inert, because a [D] can rewrite a [WD].
<a name="line-1191"></a>
<a name="line-1192"></a>  work item: [WD] (a |&gt; co) ~ beta
<a name="line-1193"></a>  inert: [D] fmv ~ alpha (CTyEqCan)
<a name="line-1194"></a>
<a name="line-1195"></a>Can't make progress on this work item either (although GHC tries by
<a name="line-1196"></a>decomposing the cast and reflattening... but that doesn't make a difference),
<a name="line-1197"></a>which is still hetero. Emit a new kind equality and add to inert set. But,
<a name="line-1198"></a>critically, we split the Irred.
<a name="line-1199"></a>
<a name="line-1200"></a>  work list:
<a name="line-1201"></a>   [D] fmv ~ alpha (CTyEqCan)
<a name="line-1202"></a>   [D] (a |&gt; co) ~ beta (CIrred) -- this one was split off
<a name="line-1203"></a>  inert:
<a name="line-1204"></a>   [W] (a |&gt; co) ~ beta
<a name="line-1205"></a>   [D] fmv ~ alpha
<a name="line-1206"></a>
<a name="line-1207"></a>We quickly solve the first work item, as it's the same as an inert.
<a name="line-1208"></a>
<a name="line-1209"></a>  work item: [D] (a |&gt; co) ~ beta
<a name="line-1210"></a>  inert:
<a name="line-1211"></a>   [W] (a |&gt; co) ~ beta
<a name="line-1212"></a>   [D] fmv ~ alpha
<a name="line-1213"></a>
<a name="line-1214"></a>We decompose the cast, yielding
<a name="line-1215"></a>
<a name="line-1216"></a>  [D] a ~ beta
<a name="line-1217"></a>
<a name="line-1218"></a>We then flatten the kinds. The lhs kind is F v, which flattens to fmv which
<a name="line-1219"></a>then rewrites to alpha.
<a name="line-1220"></a>
<a name="line-1221"></a>  co' :: F v ~ alpha
<a name="line-1222"></a>  [D] (a |&gt; co') ~ beta
<a name="line-1223"></a>
<a name="line-1224"></a>Now this equality is homo-kinded. So we swizzle it around to
<a name="line-1225"></a>
<a name="line-1226"></a>  [D] beta ~ (a |&gt; co')
<a name="line-1227"></a>
<a name="line-1228"></a>and set beta := a |&gt; co', and go home happy.
<a name="line-1229"></a>
<a name="line-1230"></a>If we don't split the Irreds, we loop. This is all dangerously subtle.
<a name="line-1231"></a>
<a name="line-1232"></a>This is triggered by test case typecheck/should_compile/SplitWD.
<a name="line-1233"></a>
<a name="line-1234"></a>Note [Examples of how Derived shadows helps completeness]
<a name="line-1235"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1236"></a>Trac #10009, a very nasty example:
<a name="line-1237"></a>
<a name="line-1238"></a>    f :: (UnF (F b) ~ b) =&gt; F b -&gt; ()
<a name="line-1239"></a>
<a name="line-1240"></a>    g :: forall a. (UnF (F a) ~ a) =&gt; a -&gt; ()
<a name="line-1241"></a>    g _ = f (undefined :: F a)
<a name="line-1242"></a>
<a name="line-1243"></a>  For g we get [G] UnF (F a) ~ a
<a name="line-1244"></a>               [WD] UnF (F beta) ~ beta
<a name="line-1245"></a>               [WD] F a ~ F beta
<a name="line-1246"></a>  Flatten:
<a name="line-1247"></a>      [G] g1: F a ~ fsk1         fsk1 := F a
<a name="line-1248"></a>      [G] g2: UnF fsk1 ~ fsk2    fsk2 := UnF fsk1
<a name="line-1249"></a>      [G] g3: fsk2 ~ a
<a name="line-1250"></a>
<a name="line-1251"></a>      [WD] w1: F beta ~ fmv1
<a name="line-1252"></a>      [WD] w2: UnF fmv1 ~ fmv2
<a name="line-1253"></a>      [WD] w3: fmv2 ~ beta
<a name="line-1254"></a>      [WD] w4: fmv1 ~ fsk1   -- From F a ~ F beta using flat-cache
<a name="line-1255"></a>                             -- and re-orient to put meta-var on left
<a name="line-1256"></a>
<a name="line-1257"></a>Rewrite w2 with w4: [D] d1: UnF fsk1 ~ fmv2
<a name="line-1258"></a>React that with g2: [D] d2: fmv2 ~ fsk2
<a name="line-1259"></a>React that with w3: [D] beta ~ fsk2
<a name="line-1260"></a>            and g3: [D] beta ~ a -- Hooray beta := a
<a name="line-1261"></a>And that is enough to solve everything
<a name="line-1262"></a>
<a name="line-1263"></a>Note [Add derived shadows only for Wanteds]
<a name="line-1264"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1265"></a>We only add shadows for Wanted constraints. That is, we have
<a name="line-1266"></a>[WD] but not [GD]; and maybeEmitShaodw looks only at [WD]
<a name="line-1267"></a>constraints.
<a name="line-1268"></a>
<a name="line-1269"></a>It does just possibly make sense ot add a derived shadow for a
<a name="line-1270"></a>Given. If we created a Derived shadow of a Given, it could be
<a name="line-1271"></a>rewritten by other Deriveds, and that could, conceivably, lead to a
<a name="line-1272"></a>useful unification.
<a name="line-1273"></a>
<a name="line-1274"></a>But (a) I have been unable to come up with an example of this
<a name="line-1275"></a>        happening
<a name="line-1276"></a>    (b) see Trac #12660 for how adding the derived shadows
<a name="line-1277"></a>        of a Given led to an infinite loop.
<a name="line-1278"></a>    (c) It's unlikely that rewriting derived Givens will lead
<a name="line-1279"></a>        to a unification because Givens don't mention touchable
<a name="line-1280"></a>        unification variables
<a name="line-1281"></a>
<a name="line-1282"></a>For (b) there may be other ways to solve the loop, but simply
<a name="line-1283"></a>reraining from adding derived shadows of Givens is particularly
<a name="line-1284"></a>simple.  And it's more efficient too!
<a name="line-1285"></a>
<a name="line-1286"></a>Still, here's one possible reason for adding derived shadows
<a name="line-1287"></a>for Givens.  Consider
<a name="line-1288"></a>           work-item [G] a ~ [b], inerts has [D] b ~ a.
<a name="line-1289"></a>If we added the derived shadow (into the work list)
<a name="line-1290"></a>         [D] a ~ [b]
<a name="line-1291"></a>When we process it, we'll rewrite to a ~ [a] and get an
<a name="line-1292"></a>occurs check.  Without it we'll miss the occurs check (reporting
<a name="line-1293"></a>inaccessible code); but that's probably OK.
<a name="line-1294"></a>
<a name="line-1295"></a>Note [Keep CDictCan shadows as CDictCan]
<a name="line-1296"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1297"></a>Suppose we have
<a name="line-1298"></a>  class C a =&gt; D a b
<a name="line-1299"></a>and [G] D a b, [G] C a in the inert set.  Now we insert
<a name="line-1300"></a>[D] b ~ c.  We want to kick out a derived shadow for [D] D a b,
<a name="line-1301"></a>so we can rewrite it with the new constraint, and perhaps get
<a name="line-1302"></a>instance reduction or other consequences.
<a name="line-1303"></a>
<a name="line-1304"></a>BUT we do not want to kick out a *non-canonical* (D a b). If we
<a name="line-1305"></a>did, we would do this:
<a name="line-1306"></a>  - rewrite it to [D] D a c, with pend_sc = True
<a name="line-1307"></a>  - use expandSuperClasses to add C a
<a name="line-1308"></a>  - go round again, which solves C a from the givens
<a name="line-1309"></a>This loop goes on for ever and triggers the simpl_loop limit.
<a name="line-1310"></a>
<a name="line-1311"></a>Solution: kick out the CDictCan which will have pend_sc = False,
<a name="line-1312"></a>because we've already added its superclasses.  So we won't re-add
<a name="line-1313"></a>them.  If we forget the pend_sc flag, our cunning scheme for avoiding
<a name="line-1314"></a>generating superclasses repeatedly will fail.
<a name="line-1315"></a>
<a name="line-1316"></a>See Trac #11379 for a case of this.
<a name="line-1317"></a>
<a name="line-1318"></a>Note [Do not do improvement for WOnly]
<a name="line-1319"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1320"></a>We do improvement between two constraints (e.g. for injectivity
<a name="line-1321"></a>or functional dependencies) only if both are "improvable". And
<a name="line-1322"></a>we improve a constraint wrt the top-level instances only if
<a name="line-1323"></a>it is improvable.
<a name="line-1324"></a>
<a name="line-1325"></a>Improvable:     [G] [WD] [D}
<a name="line-1326"></a>Not improvable: [W]
<a name="line-1327"></a>
<a name="line-1328"></a>Reasons:
<a name="line-1329"></a>
<a name="line-1330"></a>* It's less work: fewer pairs to compare
<a name="line-1331"></a>
<a name="line-1332"></a>* Every [W] has a shadow [D] so nothing is lost
<a name="line-1333"></a>
<a name="line-1334"></a>* Consider [WD] C Int b,  where 'b' is a skolem, and
<a name="line-1335"></a>    class C a b | a -&gt; b
<a name="line-1336"></a>    instance C Int Bool
<a name="line-1337"></a>  We'll do a fundep on it and emit [D] b ~ Bool
<a name="line-1338"></a>  That will kick out constraint [WD] C Int b
<a name="line-1339"></a>  Then we'll split it to [W] C Int b (keep in inert)
<a name="line-1340"></a>                     and [D] C Int b (in work list)
<a name="line-1341"></a>  When processing the latter we'll rewrite it to
<a name="line-1342"></a>        [D] C Int Bool
<a name="line-1343"></a>  At that point it would be /stupid/ to interact it
<a name="line-1344"></a>  with the inert [W] C Int b in the inert set; after all,
<a name="line-1345"></a>  it's the very constraint from which the [D] C Int Bool
<a name="line-1346"></a>  was split!  We can avoid this by not doing improvement
<a name="line-1347"></a>  on [W] constraints. This came up in Trac #12860.
<a name="line-1348"></a>-}</span>
<a name="line-1349"></a>
<a name="line-1350"></a><a name="maybeEmitShadow"></a><span class='hs-definition'>maybeEmitShadow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Ct</span>
<a name="line-1351"></a><span class='hs-comment'>-- See Note [The improvement story and derived shadows]</span>
<a name="line-1352"></a><span class='hs-definition'>maybeEmitShadow</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1353"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-1354"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span>
<a name="line-1355"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ev</span>
<a name="line-1356"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>shouldSplitWD</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>ct</span>
<a name="line-1357"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emit derived shadow"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1358"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>derived_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span>
<a name="line-1359"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-1360"></a>             <span class='hs-varid'>shadow_ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>derived_ev</span> <span class='hs-layout'>}</span>
<a name="line-1361"></a>               <span class='hs-comment'>-- Te shadow constraint keeps the canonical shape.</span>
<a name="line-1362"></a>               <span class='hs-comment'>-- This just saves work, but is sometimes important;</span>
<a name="line-1363"></a>               <span class='hs-comment'>-- see Note [Keep CDictCan shadows as CDictCan]</span>
<a name="line-1364"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitWork</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>shadow_ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1365"></a>
<a name="line-1366"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span>
<a name="line-1367"></a>             <span class='hs-varid'>ct'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev'</span> <span class='hs-layout'>}</span>
<a name="line-1368"></a>                 <span class='hs-comment'>-- Record that it now has a shadow</span>
<a name="line-1369"></a>                 <span class='hs-comment'>-- This is /the/ place we set the flag to WOnly</span>
<a name="line-1370"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ct'</span> <span class='hs-layout'>}</span>
<a name="line-1371"></a>
<a name="line-1372"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1373"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ct</span>
<a name="line-1374"></a>
<a name="line-1375"></a><a name="shouldSplitWD"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1376"></a><span class='hs-comment'>-- Precondition: 'ct' is [WD], and is inert</span>
<a name="line-1377"></a><span class='hs-comment'>-- True &lt;=&gt; we should split ct ito [W] and [D] because</span>
<a name="line-1378"></a><span class='hs-comment'>--          the inert_eqs can make progress on the [D]</span>
<a name="line-1379"></a><span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1380"></a>
<a name="line-1381"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1382"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1383"></a>    <span class='hs-comment'>-- We don't need to split if the tv is the RHS fsk</span>
<a name="line-1384"></a>
<a name="line-1385"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1386"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1387"></a>    <span class='hs-comment'>-- NB True: ignore coercions</span>
<a name="line-1388"></a>    <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1389"></a>
<a name="line-1390"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-1391"></a>                                  <span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1392"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemDVarEnv`</span> <span class='hs-varid'>inert_eqs</span>
<a name="line-1393"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>False</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1394"></a>  <span class='hs-comment'>-- NB False: do not ignore casts and coercions</span>
<a name="line-1395"></a>  <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1396"></a>
<a name="line-1397"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1398"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvEqRel</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1399"></a>
<a name="line-1400"></a><span class='hs-definition'>shouldSplitWD</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>   <span class='hs-comment'>-- No point in splitting otherwise</span>
<a name="line-1401"></a>
<a name="line-1402"></a><a name="should_split_match_args"></a><span class='hs-definition'>should_split_match_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1403"></a><span class='hs-comment'>-- True if the inert_eqs can rewrite anything in the argument</span>
<a name="line-1404"></a><span class='hs-comment'>-- types, ignoring casts and coercions</span>
<a name="line-1405"></a><span class='hs-definition'>should_split_match_args</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tys</span>
<a name="line-1406"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>True</span> <span class='hs-conid'>NomEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1407"></a>    <span class='hs-comment'>-- NB True: ignore casts coercions</span>
<a name="line-1408"></a>    <span class='hs-comment'>-- See Note [Splitting WD constraints]</span>
<a name="line-1409"></a>
<a name="line-1410"></a><a name="canRewriteTv"></a><span class='hs-definition'>canRewriteTv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1411"></a><span class='hs-definition'>canRewriteTv</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>eq_rel</span> <span class='hs-varid'>tv</span>
<a name="line-1412"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>tv</span>
<a name="line-1413"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel1</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-1414"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel1</span> <span class='hs-varop'>`eqCanRewrite`</span> <span class='hs-varid'>eq_rel</span>
<a name="line-1415"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1416"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1417"></a>
<a name="line-1418"></a><a name="isImprovable"></a><span class='hs-definition'>isImprovable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1419"></a><span class='hs-comment'>-- See Note [Do not do improvement for WOnly]</span>
<a name="line-1420"></a><span class='hs-definition'>isImprovable</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WOnly</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1421"></a><span class='hs-definition'>isImprovable</span> <span class='hs-keyword'>_</span>                                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1422"></a>
<a name="line-1423"></a>
<a name="line-1424"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1425"></a>*                                                                      *
<a name="line-1426"></a>                   Inert equalities
<a name="line-1427"></a>*                                                                      *
<a name="line-1428"></a>********************************************************************* -}</span>
<a name="line-1429"></a>
<a name="line-1430"></a><a name="addTyEq"></a><span class='hs-definition'>addTyEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span>
<a name="line-1431"></a><span class='hs-definition'>addTyEq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ct</span>
<a name="line-1432"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendDVarEnv_C</span> <span class='hs-varid'>add_eq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1433"></a>  <span class='hs-keyword'>where</span>
<a name="line-1434"></a>    <span class='hs-varid'>add_eq</span> <span class='hs-varid'>old_eqs</span> <span class='hs-keyword'>_</span>
<a name="line-1435"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span>
<a name="line-1436"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>eq1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eqs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>old_eqs</span>
<a name="line-1437"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>eqs</span>
<a name="line-1438"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1439"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>old_eqs</span>
<a name="line-1440"></a>
<a name="line-1441"></a><a name="foldTyEqs"></a><span class='hs-definition'>foldTyEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-1442"></a><span class='hs-definition'>foldTyEqs</span> <span class='hs-varid'>k</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>z</span>
<a name="line-1443"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cts</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>eqs</span>
<a name="line-1444"></a>
<a name="line-1445"></a><a name="findTyEqs"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EqualCtList</span>
<a name="line-1446"></a><span class='hs-definition'>findTyEqs</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>icans</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-conid'>[]</span>
<a name="line-1447"></a>
<a name="line-1448"></a><a name="delTyEq"></a><span class='hs-definition'>delTyEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertEqs</span>
<a name="line-1449"></a><span class='hs-definition'>delTyEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyDVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isThisOne</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tv</span>
<a name="line-1450"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>isThisOne</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span> <span class='hs-varid'>t</span> <span class='hs-varid'>t1</span>
<a name="line-1451"></a>        <span class='hs-varid'>isThisOne</span> <span class='hs-keyword'>_</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1452"></a>
<a name="line-1453"></a><a name="lookupInertTyVar"></a><span class='hs-definition'>lookupInertTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>
<a name="line-1454"></a><span class='hs-definition'>lookupInertTyVar</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>tv</span>
<a name="line-1455"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-1456"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NomEq</span> <span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rhs</span>
<a name="line-1457"></a>      <span class='hs-keyword'>_</span>                                                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1458"></a>
<a name="line-1459"></a><a name="lookupFlattenTyVar"></a><span class='hs-definition'>lookupFlattenTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertEqs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-1460"></a><span class='hs-comment'>-- See Note [lookupFlattenTyVar]</span>
<a name="line-1461"></a><span class='hs-definition'>lookupFlattenTyVar</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>ftv</span>
<a name="line-1462"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupInertTyVar</span> <span class='hs-varid'>ieqs</span> <span class='hs-varid'>ftv</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>ftv</span>
<a name="line-1463"></a>
<a name="line-1464"></a><span class='hs-comment'>{- Note [lookupFlattenTyVar]
<a name="line-1465"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1466"></a>Suppose we have an injective function F and
<a name="line-1467"></a>  inert_funeqs:   F t1 ~ fsk1
<a name="line-1468"></a>                  F t2 ~ fsk2
<a name="line-1469"></a>  inert_eqs:      fsk1 ~ fsk2
<a name="line-1470"></a>
<a name="line-1471"></a>We never rewrite the RHS (cc_fsk) of a CFunEqCan.  But we /do/ want to
<a name="line-1472"></a>get the [D] t1 ~ t2 from the injectiveness of F.  So we look up the
<a name="line-1473"></a>cc_fsk of CFunEqCans in the inert_eqs when trying to find derived
<a name="line-1474"></a>equalities arising from injectivity.
<a name="line-1475"></a>-}</span>
<a name="line-1476"></a>
<a name="line-1477"></a>
<a name="line-1478"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1479"></a>*                                                                      *
<a name="line-1480"></a>                   Inert instances: inert_insts
<a name="line-1481"></a>*                                                                      *
<a name="line-1482"></a>********************************************************************* -}</span>
<a name="line-1483"></a>
<a name="line-1484"></a><a name="addInertForAll"></a><span class='hs-definition'>addInertForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>QCInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1485"></a><span class='hs-comment'>-- Add a local Given instance, typically arising from a type signature</span>
<a name="line-1486"></a><span class='hs-definition'>addInertForAll</span> <span class='hs-varid'>new_qci</span>
<a name="line-1487"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1488"></a>    <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>add_qci</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_insts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1489"></a>  <span class='hs-keyword'>where</span>
<a name="line-1490"></a>    <span class='hs-varid'>add_qci</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QCInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QCInst</span><span class='hs-keyglyph'>]</span>
<a name="line-1491"></a>    <span class='hs-comment'>-- See Note [Do not add duplicate quantified instances]</span>
<a name="line-1492"></a>    <span class='hs-varid'>add_qci</span> <span class='hs-varid'>qcis</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>same_qci</span> <span class='hs-varid'>qcis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qcis</span>
<a name="line-1493"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_qci</span> <span class='hs-conop'>:</span> <span class='hs-varid'>qcis</span>
<a name="line-1494"></a>
<a name="line-1495"></a>    <span class='hs-varid'>same_qci</span> <span class='hs-varid'>old_qci</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcEqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>qci_ev</span> <span class='hs-varid'>old_qci</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1496"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>qci_ev</span> <span class='hs-varid'>new_qci</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1497"></a>
<a name="line-1498"></a><span class='hs-comment'>{- Note [Do not add duplicate quantified instances]
<a name="line-1499"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1500"></a>Consider this (Trac #15244):
<a name="line-1501"></a>
<a name="line-1502"></a>  f :: (C g, D g) =&gt; ....
<a name="line-1503"></a>  class S g =&gt; C g where ...
<a name="line-1504"></a>  class S g =&gt; D g where ...
<a name="line-1505"></a>  class (forall a. Eq a =&gt; Eq (g a)) =&gt; S g where ...
<a name="line-1506"></a>
<a name="line-1507"></a>Then in f's RHS there are two identical quantified constraints
<a name="line-1508"></a>available, one via the superclasses of C and one via the superclasses
<a name="line-1509"></a>of D.  The two are identical, and it seems wrong to reject the program
<a name="line-1510"></a>because of that. But without doing duplicate-elimination we will have
<a name="line-1511"></a>two matching QCInsts when we try to solve constraints arising from f's
<a name="line-1512"></a>RHS.
<a name="line-1513"></a>
<a name="line-1514"></a>The simplest thing is simply to eliminate duplicattes, which we do here.
<a name="line-1515"></a>-}</span>
<a name="line-1516"></a>
<a name="line-1517"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1518"></a>*                                                                      *
<a name="line-1519"></a>                  Adding an inert
<a name="line-1520"></a>*                                                                      *
<a name="line-1521"></a>************************************************************************
<a name="line-1522"></a>
<a name="line-1523"></a>Note [Adding an equality to the InertCans]
<a name="line-1524"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1525"></a>When adding an equality to the inerts:
<a name="line-1526"></a>
<a name="line-1527"></a>* Split [WD] into [W] and [D] if the inerts can rewrite the latter;
<a name="line-1528"></a>  done by maybeEmitShadow.
<a name="line-1529"></a>
<a name="line-1530"></a>* Kick out any constraints that can be rewritten by the thing
<a name="line-1531"></a>  we are adding.  Done by kickOutRewritable.
<a name="line-1532"></a>
<a name="line-1533"></a>* Note that unifying a:=ty, is like adding [G] a~ty; just use
<a name="line-1534"></a>  kickOutRewritable with Nominal, Given.  See kickOutAfterUnification.
<a name="line-1535"></a>
<a name="line-1536"></a>Note [Kicking out CFunEqCan for fundeps]
<a name="line-1537"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1538"></a>Consider:
<a name="line-1539"></a>   New:    [D] fmv1 ~ fmv2
<a name="line-1540"></a>   Inert:  [W] F alpha ~ fmv1
<a name="line-1541"></a>           [W] F beta  ~ fmv2
<a name="line-1542"></a>
<a name="line-1543"></a>where F is injective. The new (derived) equality certainly can't
<a name="line-1544"></a>rewrite the inerts. But we *must* kick out the first one, to get:
<a name="line-1545"></a>
<a name="line-1546"></a>   New:   [W] F alpha ~ fmv1
<a name="line-1547"></a>   Inert: [W] F beta ~ fmv2
<a name="line-1548"></a>          [D] fmv1 ~ fmv2
<a name="line-1549"></a>
<a name="line-1550"></a>and now improvement will discover [D] alpha ~ beta. This is important;
<a name="line-1551"></a>eg in Trac #9587.
<a name="line-1552"></a>
<a name="line-1553"></a>So in kickOutRewritable we look at all the tyvars of the
<a name="line-1554"></a>CFunEqCan, including the fsk.
<a name="line-1555"></a>-}</span>
<a name="line-1556"></a>
<a name="line-1557"></a><a name="addInertCan"></a><span class='hs-definition'>addInertCan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- Constraints *other than* equalities</span>
<a name="line-1558"></a><span class='hs-comment'>-- Precondition: item /is/ canonical</span>
<a name="line-1559"></a><span class='hs-comment'>-- See Note [Adding an equality to the InertCans]</span>
<a name="line-1560"></a><span class='hs-definition'>addInertCan</span> <span class='hs-varid'>ct</span>
<a name="line-1561"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"insertInertCan {"</span> <span class='hs-varop'>$</span>
<a name="line-1562"></a>         <span class='hs-varid'>text</span> <span class='hs-str'>"Trying to insert new inert item:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span>
<a name="line-1563"></a>
<a name="line-1564"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1565"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ct</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeEmitShadow</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1566"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybeKickOut</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1567"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-layout'>(</span><span class='hs-varid'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1568"></a>
<a name="line-1569"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"addInertCan }"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-1570"></a>
<a name="line-1571"></a><a name="maybeKickOut"></a><span class='hs-definition'>maybeKickOut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertCans</span>
<a name="line-1572"></a><span class='hs-comment'>-- For a CTyEqCan, kick out any inert that can be rewritten by the CTyEqCan</span>
<a name="line-1573"></a><span class='hs-definition'>maybeKickOut</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>ct</span>
<a name="line-1574"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-1575"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kickOutRewritable</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_rel</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ics</span>
<a name="line-1576"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ics'</span> <span class='hs-layout'>}</span>
<a name="line-1577"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1578"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ics</span>
<a name="line-1579"></a>
<a name="line-1580"></a><a name="add_item"></a><span class='hs-definition'>add_item</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1581"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1582"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertFunEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1583"></a>
<a name="line-1584"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1585"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTyEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>item</span>
<a name="line-1586"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_count</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1587"></a>
<a name="line-1588"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1589"></a>         <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insoluble</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1590"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span> <span class='hs-varop'>`Bag.snocBag`</span> <span class='hs-varid'>item</span>
<a name="line-1591"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>insoluble</span>
<a name="line-1592"></a>                         <span class='hs-keyword'>then</span> <span class='hs-varid'>count</span>  <span class='hs-comment'>-- inert_count does not include insolubles</span>
<a name="line-1593"></a>                         <span class='hs-keyword'>else</span> <span class='hs-varid'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>count</span> <span class='hs-layout'>}</span>
<a name="line-1594"></a>
<a name="line-1595"></a><span class='hs-definition'>add_item</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1596"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span>
<a name="line-1597"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_count</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1598"></a>
<a name="line-1599"></a><span class='hs-definition'>add_item</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>item</span>
<a name="line-1600"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"upd_inert set: can't happen! Inserting "</span> <span class='hs-varop'>$</span>
<a name="line-1601"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>   <span class='hs-comment'>-- Can't be CNonCanonical, CHoleCan,</span>
<a name="line-1602"></a>               <span class='hs-comment'>-- because they only land in inert_irreds</span>
<a name="line-1603"></a>
<a name="line-1604"></a><a name="bumpUnsolvedCount"></a><span class='hs-definition'>bumpUnsolvedCount</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-1605"></a><span class='hs-definition'>bumpUnsolvedCount</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWanted</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span>
<a name="line-1606"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-1607"></a>
<a name="line-1608"></a>
<a name="line-1609"></a><a name="kickOutRewritable"></a><span class='hs-comment'>-----------------------------------------</span>
<a name="line-1610"></a><span class='hs-definition'>kickOutRewritable</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span>  <span class='hs-comment'>-- Flavour/role of the equality that</span>
<a name="line-1611"></a>                                      <span class='hs-comment'>-- is being added to the inert set</span>
<a name="line-1612"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- The new equality is tv ~ ty</span>
<a name="line-1613"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1614"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-1615"></a><span class='hs-definition'>kickOutRewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>ics</span>
<a name="line-1616"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kick_out_rewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>ics</span>
<a name="line-1617"></a>             <span class='hs-varid'>n_kicked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>workListSize</span> <span class='hs-varid'>kicked_out</span>
<a name="line-1618"></a>
<a name="line-1619"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1620"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>appendWorkList</span> <span class='hs-varid'>kicked_out</span><span class='hs-layout'>)</span>
<a name="line-1621"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>csTraceTcS</span> <span class='hs-varop'>$</span>
<a name="line-1622"></a>              <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Kick out, tv ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>new_tv</span><span class='hs-layout'>)</span>
<a name="line-1623"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"n-kicked ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n_kicked</span>
<a name="line-1624"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kicked_out ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kicked_out</span>
<a name="line-1625"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Residual inerts ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ics'</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1626"></a>
<a name="line-1627"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1628"></a>
<a name="line-1629"></a><a name="kick_out_rewritable"></a><span class='hs-definition'>kick_out_rewritable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span>  <span class='hs-comment'>-- Flavour/role of the equality that</span>
<a name="line-1630"></a>                                      <span class='hs-comment'>-- is being added to the inert set</span>
<a name="line-1631"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span>        <span class='hs-comment'>-- The new equality is tv ~ ty</span>
<a name="line-1632"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1633"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-1634"></a><span class='hs-comment'>-- See Note [kickOutRewritable]</span>
<a name="line-1635"></a><span class='hs-definition'>kick_out_rewritable</span> <span class='hs-varid'>new_fr</span> <span class='hs-varid'>new_tv</span>
<a name="line-1636"></a>                    <span class='hs-varid'>ics</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1637"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dictmap</span>
<a name="line-1638"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span>
<a name="line-1639"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funeqmap</span>
<a name="line-1640"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-1641"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_insts</span>
<a name="line-1642"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1643"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_fr</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>new_fr</span><span class='hs-layout'>)</span>
<a name="line-1644"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyWorkList</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span>
<a name="line-1645"></a>        <span class='hs-comment'>-- If new_fr can't rewrite itself, it can't rewrite</span>
<a name="line-1646"></a>        <span class='hs-comment'>-- anything else, so no need to kick out anything.</span>
<a name="line-1647"></a>        <span class='hs-comment'>-- (This is a common case: wanteds can't rewrite wanteds)</span>
<a name="line-1648"></a>        <span class='hs-comment'>-- Lemma (L2) in Note [Extending the inert equalities]</span>
<a name="line-1649"></a>
<a name="line-1650"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1651"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>kicked_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans_in</span><span class='hs-layout'>)</span>
<a name="line-1652"></a>  <span class='hs-keyword'>where</span>
<a name="line-1653"></a>    <span class='hs-varid'>inert_cans_in</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs_in</span>
<a name="line-1654"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts_in</span>
<a name="line-1655"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span>   <span class='hs-comment'>-- ??</span>
<a name="line-1656"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs_in</span>
<a name="line-1657"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irs_in</span>
<a name="line-1658"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts_in</span>
<a name="line-1659"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>inert_count</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-varid'>workListWantedCount</span> <span class='hs-varid'>kicked_out</span> <span class='hs-layout'>}</span>
<a name="line-1660"></a>
<a name="line-1661"></a>    <span class='hs-varid'>kicked_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WorkList</span>
<a name="line-1662"></a>    <span class='hs-comment'>-- NB: use extendWorkList to ensure that kicked-out equalities get priority</span>
<a name="line-1663"></a>    <span class='hs-comment'>-- See Note [Prioritise equality constraints] (Kick-out).</span>
<a name="line-1664"></a>    <span class='hs-comment'>-- The irreds may include non-canonical (hetero-kinded) equality</span>
<a name="line-1665"></a>    <span class='hs-comment'>-- constraints, which perhaps may have become soluble after new_tv</span>
<a name="line-1666"></a>    <span class='hs-comment'>-- is substituted; ditto the dictionaries, which may include (a~b)</span>
<a name="line-1667"></a>    <span class='hs-comment'>-- or (a~~b) constraints.</span>
<a name="line-1668"></a>    <span class='hs-varid'>kicked_out</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>extendWorkListCt</span>
<a name="line-1669"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>emptyWorkList</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs_out</span>
<a name="line-1670"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>wl_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>feqs_out</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1671"></a>                          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>dicts_out</span> <span class='hs-varop'>`andCts`</span> <span class='hs-varid'>irs_out</span><span class='hs-layout'>)</span>
<a name="line-1672"></a>                            <span class='hs-varop'>`extendCtsList`</span> <span class='hs-varid'>insts_out</span><span class='hs-layout'>)</span>
<a name="line-1673"></a>
<a name="line-1674"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tv_eqs_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_eqs_in</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDVarEnv</span> <span class='hs-varid'>kick_out_eqs</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDVarEnv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1675"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>feqs_out</span><span class='hs-layout'>,</span>   <span class='hs-varid'>feqs_in</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionFunEqs</span>  <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>funeqmap</span>
<a name="line-1676"></a>           <span class='hs-comment'>-- See Note [Kicking out CFunEqCan for fundeps]</span>
<a name="line-1677"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>dicts_out</span><span class='hs-layout'>,</span>  <span class='hs-varid'>dicts_in</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionDicts</span>   <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>dictmap</span>
<a name="line-1678"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>irs_out</span><span class='hs-layout'>,</span>    <span class='hs-varid'>irs_in</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionBag</span>     <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>irreds</span>
<a name="line-1679"></a>      <span class='hs-comment'>-- Kick out even insolubles: See Note [Rewrite insolubles]</span>
<a name="line-1680"></a>      <span class='hs-comment'>-- Of course we must kick out irreducibles like (c a), in case</span>
<a name="line-1681"></a>      <span class='hs-comment'>-- we can rewrite 'c' to something more useful</span>
<a name="line-1682"></a>
<a name="line-1683"></a>    <span class='hs-comment'>-- Kick-out for inert instances</span>
<a name="line-1684"></a>    <span class='hs-comment'>-- See Note [Quantified constraints] in TcCanonical</span>
<a name="line-1685"></a>    <span class='hs-varid'>insts_out</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1686"></a>    <span class='hs-varid'>insts_in</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>QCInst</span><span class='hs-keyglyph'>]</span>
<a name="line-1687"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>insts_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>insts_in</span><span class='hs-layout'>)</span>
<a name="line-1688"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- All the insts are Givens</span>
<a name="line-1689"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>kick_out_qci</span> <span class='hs-varid'>old_insts</span>
<a name="line-1690"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1691"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>old_insts</span><span class='hs-layout'>)</span>
<a name="line-1692"></a>    <span class='hs-varid'>kick_out_qci</span> <span class='hs-varid'>qci</span>
<a name="line-1693"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>qci_ev</span> <span class='hs-varid'>qci</span>
<a name="line-1694"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-conid'>NomEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>qci_ev</span> <span class='hs-varid'>qci</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1695"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1696"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1697"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-varid'>qci</span>
<a name="line-1698"></a>
<a name="line-1699"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_fr</span>
<a name="line-1700"></a>
<a name="line-1701"></a>    <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1702"></a>    <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>anyRewritableTyVar</span> <span class='hs-conid'>False</span> <span class='hs-varid'>role</span>
<a name="line-1703"></a>                                                   <span class='hs-varid'>fr_can_rewrite_tv</span> <span class='hs-varid'>ty</span>
<a name="line-1704"></a>    <span class='hs-varid'>fr_can_rewrite_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqRel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1705"></a>    <span class='hs-varid'>fr_can_rewrite_tv</span> <span class='hs-varid'>role</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_role</span> <span class='hs-varop'>`eqCanRewrite`</span> <span class='hs-varid'>role</span>
<a name="line-1706"></a>                             <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>new_tv</span>
<a name="line-1707"></a>
<a name="line-1708"></a>    <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavourRole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1709"></a>    <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_fr</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>fs</span>
<a name="line-1710"></a>        <span class='hs-comment'>-- Can the new item rewrite the inert item?</span>
<a name="line-1711"></a>
<a name="line-1712"></a>    <span class='hs-varid'>kick_out_ct</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1713"></a>    <span class='hs-comment'>-- Kick it out if the new CTyEqCan can rewrite the inert one</span>
<a name="line-1714"></a>    <span class='hs-comment'>-- See Note [kickOutRewritable]</span>
<a name="line-1715"></a>    <span class='hs-varid'>kick_out_ct</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fs</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctFlavourRole</span> <span class='hs-varid'>ct</span>
<a name="line-1716"></a>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span>
<a name="line-1717"></a>                   <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1718"></a>                  <span class='hs-comment'>-- False: ignore casts and coercions</span>
<a name="line-1719"></a>                  <span class='hs-comment'>-- NB: this includes the fsk of a CFunEqCan.  It can't</span>
<a name="line-1720"></a>                  <span class='hs-comment'>--     actually be rewritten, but we need to kick it out</span>
<a name="line-1721"></a>                  <span class='hs-comment'>--     so we get to take advantage of injectivity</span>
<a name="line-1722"></a>                  <span class='hs-comment'>-- See Note [Kicking out CFunEqCan for fundeps]</span>
<a name="line-1723"></a>
<a name="line-1724"></a>    <span class='hs-varid'>kick_out_eqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-1725"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-1726"></a>    <span class='hs-varid'>kick_out_eqs</span> <span class='hs-varid'>eqs</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_in</span><span class='hs-layout'>)</span>
<a name="line-1727"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>eqs_out</span> <span class='hs-varop'>++</span> <span class='hs-varid'>acc_out</span><span class='hs-layout'>,</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eqs_in</span> <span class='hs-keyword'>of</span>
<a name="line-1728"></a>                               <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>acc_in</span>
<a name="line-1729"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>eq1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendDVarEnv</span> <span class='hs-varid'>acc_in</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_tyvar</span> <span class='hs-varid'>eq1</span><span class='hs-layout'>)</span> <span class='hs-varid'>eqs_in</span><span class='hs-layout'>)</span>
<a name="line-1730"></a>      <span class='hs-keyword'>where</span>
<a name="line-1731"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>eqs_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqs_in</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>kick_out_eq</span> <span class='hs-varid'>eqs</span>
<a name="line-1732"></a>
<a name="line-1733"></a>    <span class='hs-comment'>-- Implements criteria K1-K3 in Note [Extending the inert equalities]</span>
<a name="line-1734"></a>    <span class='hs-varid'>kick_out_eq</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-1735"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1736"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fr_may_rewrite</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-1737"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- Keep it in the inert set if the new thing can't rewrite it</span>
<a name="line-1738"></a>
<a name="line-1739"></a>      <span class='hs-comment'>-- Below here (fr_may_rewrite fs) is True</span>
<a name="line-1740"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>==</span> <span class='hs-varid'>new_tv</span>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>        <span class='hs-comment'>-- (K1)</span>
<a name="line-1741"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kick_out_for_inertness</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1742"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>kick_out_for_completeness</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1743"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1744"></a>
<a name="line-1745"></a>      <span class='hs-keyword'>where</span>
<a name="line-1746"></a>        <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq_rel</span><span class='hs-layout'>)</span>
<a name="line-1747"></a>        <span class='hs-varid'>kick_out_for_inertness</span>
<a name="line-1748"></a>          <span class='hs-keyglyph'>=</span>        <span class='hs-layout'>(</span><span class='hs-varid'>fs</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- (K2a)</span>
<a name="line-1749"></a>            <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fs</span> <span class='hs-varop'>`eqMayRewriteFR`</span> <span class='hs-varid'>new_fr</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- (K2b)</span>
<a name="line-1750"></a>            <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>fr_can_rewrite_ty</span> <span class='hs-varid'>eq_rel</span> <span class='hs-varid'>rhs_ty</span>    <span class='hs-comment'>-- (K2d)</span>
<a name="line-1751"></a>            <span class='hs-comment'>-- (K2c) is guaranteed by the first guard of keep_eq</span>
<a name="line-1752"></a>
<a name="line-1753"></a>        <span class='hs-varid'>kick_out_for_completeness</span>
<a name="line-1754"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>eq_rel</span> <span class='hs-keyword'>of</span>
<a name="line-1755"></a>              <span class='hs-conid'>NomEq</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rhs_ty</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>new_tv</span>
<a name="line-1756"></a>              <span class='hs-conid'>ReprEq</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isTyVarHead</span> <span class='hs-varid'>new_tv</span> <span class='hs-varid'>rhs_ty</span>
<a name="line-1757"></a>
<a name="line-1758"></a>    <span class='hs-varid'>kick_out_eq</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"keep_eq"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1759"></a>
<a name="line-1760"></a><a name="kickOutAfterUnification"></a><span class='hs-definition'>kickOutAfterUnification</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Int</span>
<a name="line-1761"></a><span class='hs-definition'>kickOutAfterUnification</span> <span class='hs-varid'>new_tv</span>
<a name="line-1762"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1763"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_kicked</span><span class='hs-layout'>,</span> <span class='hs-varid'>ics2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kickOutRewritable</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span><span class='hs-layout'>,</span><span class='hs-conid'>NomEq</span><span class='hs-layout'>)</span>
<a name="line-1764"></a>                                                 <span class='hs-varid'>new_tv</span> <span class='hs-varid'>ics</span>
<a name="line-1765"></a>                     <span class='hs-comment'>-- Given because the tv := xi is given; NomEq because</span>
<a name="line-1766"></a>                     <span class='hs-comment'>-- only nominal equalities are solved by unification</span>
<a name="line-1767"></a>
<a name="line-1768"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setInertCans</span> <span class='hs-varid'>ics2</span>
<a name="line-1769"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>n_kicked</span> <span class='hs-layout'>}</span>
<a name="line-1770"></a>
<a name="line-1771"></a><span class='hs-comment'>{- Note [kickOutRewritable]
<a name="line-1772"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1773"></a>See also Note [inert_eqs: the inert equalities].
<a name="line-1774"></a>
<a name="line-1775"></a>When we add a new inert equality (a ~N ty) to the inert set,
<a name="line-1776"></a>we must kick out any inert items that could be rewritten by the
<a name="line-1777"></a>new equality, to maintain the inert-set invariants.
<a name="line-1778"></a>
<a name="line-1779"></a>  - We want to kick out an existing inert constraint if
<a name="line-1780"></a>    a) the new constraint can rewrite the inert one
<a name="line-1781"></a>    b) 'a' is free in the inert constraint (so that it *will*)
<a name="line-1782"></a>       rewrite it if we kick it out.
<a name="line-1783"></a>
<a name="line-1784"></a>    For (b) we use tyCoVarsOfCt, which returns the type variables /and
<a name="line-1785"></a>    the kind variables/ that are directly visible in the type. Hence
<a name="line-1786"></a>    we will have exposed all the rewriting we care about to make the
<a name="line-1787"></a>    most precise kinds visible for matching classes etc. No need to
<a name="line-1788"></a>    kick out constraints that mention type variables whose kinds
<a name="line-1789"></a>    contain this variable!
<a name="line-1790"></a>
<a name="line-1791"></a>  - A Derived equality can kick out [D] constraints in inert_eqs,
<a name="line-1792"></a>    inert_dicts, inert_irreds etc.
<a name="line-1793"></a>
<a name="line-1794"></a>  - We don't kick out constraints from inert_solved_dicts, and
<a name="line-1795"></a>    inert_solved_funeqs optimistically. But when we lookup we have to
<a name="line-1796"></a>    take the substitution into account
<a name="line-1797"></a>
<a name="line-1798"></a>
<a name="line-1799"></a>Note [Rewrite insolubles]
<a name="line-1800"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1801"></a>Suppose we have an insoluble alpha ~ [alpha], which is insoluble
<a name="line-1802"></a>because an occurs check.  And then we unify alpha := [Int].  Then we
<a name="line-1803"></a>really want to rewrite the insoluble to [Int] ~ [[Int]].  Now it can
<a name="line-1804"></a>be decomposed.  Otherwise we end up with a "Can't match [Int] ~
<a name="line-1805"></a>[[Int]]" which is true, but a bit confusing because the outer type
<a name="line-1806"></a>constructors match.
<a name="line-1807"></a>
<a name="line-1808"></a>Similarly, if we have a CHoleCan, we'd like to rewrite it with any
<a name="line-1809"></a>Givens, to give as informative an error messasge as possible
<a name="line-1810"></a>(Trac #12468, #11325).
<a name="line-1811"></a>
<a name="line-1812"></a>Hence:
<a name="line-1813"></a> * In the main simlifier loops in TcSimplify (solveWanteds,
<a name="line-1814"></a>   simpl_loop), we feed the insolubles in solveSimpleWanteds,
<a name="line-1815"></a>   so that they get rewritten (albeit not solved).
<a name="line-1816"></a>
<a name="line-1817"></a> * We kick insolubles out of the inert set, if they can be
<a name="line-1818"></a>   rewritten (see TcSMonad.kick_out_rewritable)
<a name="line-1819"></a>
<a name="line-1820"></a> * We rewrite those insolubles in TcCanonical.
<a name="line-1821"></a>   See Note [Make sure that insolubles are fully rewritten]
<a name="line-1822"></a>-}</span>
<a name="line-1823"></a>
<a name="line-1824"></a>
<a name="line-1825"></a>
<a name="line-1826"></a><a name="addInertSafehask"></a><span class='hs-comment'>--------------</span>
<a name="line-1827"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-1828"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1829"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span>
<a name="line-1830"></a>
<a name="line-1831"></a><span class='hs-definition'>addInertSafehask</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>item</span>
<a name="line-1832"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addInertSafehask: can't happen! Inserting "</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-1833"></a>
<a name="line-1834"></a><a name="insertSafeOverlapFailureTcS"></a><span class='hs-definition'>insertSafeOverlapFailureTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1835"></a><span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span>
<a name="line-1836"></a><span class='hs-definition'>insertSafeOverlapFailureTcS</span> <span class='hs-varid'>item</span>
<a name="line-1837"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addInertSafehask</span> <span class='hs-varid'>ics</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>
<a name="line-1838"></a>
<a name="line-1839"></a><a name="getSafeOverlapFailures"></a><span class='hs-definition'>getSafeOverlapFailures</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-1840"></a><span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation] in TcSimplify</span>
<a name="line-1841"></a><span class='hs-definition'>getSafeOverlapFailures</span>
<a name="line-1842"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safehask</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1843"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>consCts</span> <span class='hs-varid'>safehask</span> <span class='hs-varid'>emptyCts</span> <span class='hs-layout'>}</span>
<a name="line-1844"></a>
<a name="line-1845"></a><a name="addSolvedDict"></a><span class='hs-comment'>--------------</span>
<a name="line-1846"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1847"></a><span class='hs-comment'>-- Add a new item in the solved set of the monad</span>
<a name="line-1848"></a><span class='hs-comment'>-- See Note [Solved dictionaries]</span>
<a name="line-1849"></a><span class='hs-definition'>addSolvedDict</span> <span class='hs-varid'>item</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-1850"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvPred</span> <span class='hs-varid'>item</span><span class='hs-layout'>)</span>    <span class='hs-comment'>-- Never cache "solved" implicit parameters (not sure why!)</span>
<a name="line-1851"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1852"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1853"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"updSolvedSetTcs:"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>item</span>
<a name="line-1854"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1855"></a>             <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1856"></a>
<a name="line-1857"></a><a name="getSolvedDicts"></a><span class='hs-definition'>getSolvedDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-1858"></a><span class='hs-definition'>getSolvedDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1859"></a>
<a name="line-1860"></a><a name="setSolvedDicts"></a><span class='hs-definition'>setSolvedDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1861"></a><span class='hs-definition'>setSolvedDicts</span> <span class='hs-varid'>solved_dicts</span>
<a name="line-1862"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1863"></a>    <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved_dicts</span> <span class='hs-layout'>}</span>
<a name="line-1864"></a>
<a name="line-1865"></a>
<a name="line-1866"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1867"></a>*                                                                      *
<a name="line-1868"></a>                  Other inert-set operations
<a name="line-1869"></a>*                                                                      *
<a name="line-1870"></a>********************************************************************* -}</span>
<a name="line-1871"></a>
<a name="line-1872"></a><a name="updInertTcS"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1873"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1874"></a><span class='hs-definition'>updInertTcS</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1875"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-1876"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>curr_inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>is_var</span>
<a name="line-1877"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>upd_fn</span> <span class='hs-varid'>curr_inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1878"></a>
<a name="line-1879"></a><a name="getInertCans"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertCans</span>
<a name="line-1880"></a><span class='hs-definition'>getInertCans</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1881"></a>
<a name="line-1882"></a><a name="setInertCans"></a><span class='hs-definition'>setInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1883"></a><span class='hs-definition'>setInertCans</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>}</span>
<a name="line-1884"></a>
<a name="line-1885"></a><a name="updRetInertCans"></a><span class='hs-definition'>updRetInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-1886"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1887"></a><span class='hs-definition'>updRetInertCans</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1888"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span>
<a name="line-1889"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>is_var</span>
<a name="line-1890"></a>                     <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>cans'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-1891"></a>                     <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>is_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cans'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1892"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1893"></a>
<a name="line-1894"></a><a name="updInertCans"></a><span class='hs-definition'>updInertCans</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1895"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1896"></a><span class='hs-definition'>updInertCans</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1897"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1898"></a>
<a name="line-1899"></a><a name="updInertDicts"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1900"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1901"></a><span class='hs-definition'>updInertDicts</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1902"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1903"></a>
<a name="line-1904"></a><a name="updInertSafehask"></a><span class='hs-definition'>updInertSafehask</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1905"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1906"></a><span class='hs-definition'>updInertSafehask</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1907"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_safehask</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1908"></a>
<a name="line-1909"></a><a name="updInertFunEqs"></a><span class='hs-definition'>updInertFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1910"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1911"></a><span class='hs-definition'>updInertFunEqs</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1912"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1913"></a>
<a name="line-1914"></a><a name="updInertIrreds"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-1915"></a><span class='hs-comment'>-- Modify the inert set with the supplied function</span>
<a name="line-1916"></a><span class='hs-definition'>updInertIrreds</span> <span class='hs-varid'>upd_fn</span>
<a name="line-1917"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updInertCans</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ics</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>upd_fn</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1918"></a>
<a name="line-1919"></a><a name="getInertEqs"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span><span class='hs-layout'>)</span>
<a name="line-1920"></a><span class='hs-definition'>getInertEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1921"></a>
<a name="line-1922"></a><a name="getInertInsols"></a><span class='hs-definition'>getInertInsols</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-1923"></a><span class='hs-comment'>-- Returns insoluble equality constraints</span>
<a name="line-1924"></a><span class='hs-comment'>-- specifically including Givens</span>
<a name="line-1925"></a><span class='hs-definition'>getInertInsols</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1926"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterBag</span> <span class='hs-varid'>insolubleEqCt</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1927"></a>
<a name="line-1928"></a><a name="getInertGivens"></a><span class='hs-definition'>getInertGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1929"></a><span class='hs-comment'>-- Returns the Given constraints in the inert set,</span>
<a name="line-1930"></a><span class='hs-comment'>-- with type functions *not* unflattened</span>
<a name="line-1931"></a><span class='hs-definition'>getInertGivens</span>
<a name="line-1932"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-1933"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-1934"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span>
<a name="line-1935"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>concat</span> <span class='hs-layout'>(</span><span class='hs-varid'>dVarEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1936"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>all_cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1937"></a>
<a name="line-1938"></a><a name="getPendingGivenScs"></a><span class='hs-definition'>getPendingGivenScs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>
<a name="line-1939"></a><span class='hs-comment'>-- Find all inert Given dictionaries, or quantified constraints,</span>
<a name="line-1940"></a><span class='hs-comment'>--     whose cc_pend_sc flag is True</span>
<a name="line-1941"></a><span class='hs-comment'>--     and that belong to the current level</span>
<a name="line-1942"></a><span class='hs-comment'>-- Set their cc_pend_sc flag to False in the inert set, and return that Ct</span>
<a name="line-1943"></a><span class='hs-definition'>getPendingGivenScs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-1944"></a>                        <span class='hs-layout'>;</span> <span class='hs-varid'>updRetInertCans</span> <span class='hs-layout'>(</span><span class='hs-varid'>get_sc_pending</span> <span class='hs-varid'>lvl</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1945"></a>
<a name="line-1946"></a><a name="get_sc_pending"></a><span class='hs-definition'>get_sc_pending</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>InertCans</span><span class='hs-layout'>)</span>
<a name="line-1947"></a><span class='hs-definition'>get_sc_pending</span> <span class='hs-varid'>this_lvl</span> <span class='hs-varid'>ic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1948"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>sc_pending</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sc_pending</span> <span class='hs-layout'>)</span>
<a name="line-1949"></a>       <span class='hs-comment'>-- When getPendingScDics is called,</span>
<a name="line-1950"></a>       <span class='hs-comment'>-- there are never any Wanteds in the inert set</span>
<a name="line-1951"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sc_pending</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts'</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insts'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1952"></a>  <span class='hs-keyword'>where</span>
<a name="line-1953"></a>    <span class='hs-varid'>sc_pending</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sc_pend_insts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sc_pend_dicts</span>
<a name="line-1954"></a>
<a name="line-1955"></a>    <span class='hs-varid'>sc_pend_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>get_pending</span> <span class='hs-varid'>dicts</span> <span class='hs-conid'>[]</span>
<a name="line-1956"></a>    <span class='hs-varid'>dicts'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>add</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>sc_pend_dicts</span>
<a name="line-1957"></a>
<a name="line-1958"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>sc_pend_insts</span><span class='hs-layout'>,</span> <span class='hs-varid'>insts'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>get_pending_inst</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>insts</span>
<a name="line-1959"></a>
<a name="line-1960"></a>    <span class='hs-varid'>get_pending</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Get dicts with cc_pend_sc = True</span>
<a name="line-1961"></a>                                       <span class='hs-comment'>-- but flipping the flag</span>
<a name="line-1962"></a>    <span class='hs-varid'>get_pending</span> <span class='hs-varid'>dict</span> <span class='hs-varid'>dicts</span>
<a name="line-1963"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>dict'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPendingScDict</span> <span class='hs-varid'>dict</span>
<a name="line-1964"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>belongs_to_this_level</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>dict</span><span class='hs-layout'>)</span>
<a name="line-1965"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dict'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>dicts</span>
<a name="line-1966"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1967"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span>
<a name="line-1968"></a>
<a name="line-1969"></a>    <span class='hs-varid'>add</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-1970"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>dicts</span>
<a name="line-1971"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span>
<a name="line-1972"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"getPendingScDicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-1973"></a>
<a name="line-1974"></a>    <span class='hs-varid'>get_pending_inst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>QCInst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>QCInst</span><span class='hs-layout'>)</span>
<a name="line-1975"></a>    <span class='hs-varid'>get_pending_inst</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>qci</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>QCI</span> <span class='hs-layout'>{</span> <span class='hs-varid'>qci_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-1976"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>qci'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isPendingScInst</span> <span class='hs-varid'>qci</span>
<a name="line-1977"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>belongs_to_this_level</span> <span class='hs-varid'>ev</span>
<a name="line-1978"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CQuantCan</span> <span class='hs-varid'>qci'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>qci'</span><span class='hs-layout'>)</span>
<a name="line-1979"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1980"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>qci</span><span class='hs-layout'>)</span>
<a name="line-1981"></a>
<a name="line-1982"></a>    <span class='hs-varid'>belongs_to_this_level</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-varop'>==</span> <span class='hs-varid'>this_lvl</span>
<a name="line-1983"></a>    <span class='hs-comment'>-- We only want Givens from this level; see (3a) in</span>
<a name="line-1984"></a>    <span class='hs-comment'>-- Note [The superclass story] in TcCanonical</span>
<a name="line-1985"></a>
<a name="line-1986"></a><a name="getUnsolvedInerts"></a><span class='hs-definition'>getUnsolvedInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span>
<a name="line-1987"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Tyvar eqs: a ~ ty</span>
<a name="line-1988"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span>     <span class='hs-comment'>-- Fun eqs:   F a ~ ty</span>
<a name="line-1989"></a>                         <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- All others</span>
<a name="line-1990"></a><span class='hs-comment'>-- Return all the unsolved [Wanted] or [Derived] constraints</span>
<a name="line-1991"></a><span class='hs-comment'>--</span>
<a name="line-1992"></a><span class='hs-comment'>-- Post-condition: the returned simple constraints are all fully zonked</span>
<a name="line-1993"></a><span class='hs-comment'>--                     (because they come from the inert set)</span>
<a name="line-1994"></a><span class='hs-comment'>--                 the unsolved implics may not be</span>
<a name="line-1995"></a><span class='hs-definition'>getUnsolvedInerts</span>
<a name="line-1996"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv_eqs</span>
<a name="line-1997"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun_eqs</span>
<a name="line-1998"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span>
<a name="line-1999"></a>           <span class='hs-layout'>,</span> <span class='hs-varid'>inert_dicts</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>idicts</span>
<a name="line-2000"></a>           <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2001"></a>
<a name="line-2002"></a>      <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>unsolved_tv_eqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyEqs</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>tv_eqs</span> <span class='hs-varid'>emptyCts</span>
<a name="line-2003"></a>            <span class='hs-varid'>unsolved_fun_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldFunEqs</span> <span class='hs-varid'>add_if_wanted</span> <span class='hs-varid'>fun_eqs</span> <span class='hs-varid'>emptyCts</span>
<a name="line-2004"></a>            <span class='hs-varid'>unsolved_irreds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bag.filterBag</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>irreds</span>
<a name="line-2005"></a>            <span class='hs-varid'>unsolved_dicts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldDicts</span> <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>idicts</span> <span class='hs-varid'>emptyCts</span>
<a name="line-2006"></a>            <span class='hs-varid'>unsolved_others</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsolved_irreds</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>unsolved_dicts</span>
<a name="line-2007"></a>
<a name="line-2008"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWorkListImplics</span>
<a name="line-2009"></a>
<a name="line-2010"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getUnsolvedInerts"</span> <span class='hs-varop'>$</span>
<a name="line-2011"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>" tv eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_tv_eqs</span>
<a name="line-2012"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"fun eqs ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_fun_eqs</span>
<a name="line-2013"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"others ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>unsolved_others</span>
<a name="line-2014"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"implics ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>implics</span> <span class='hs-keyglyph'>]</span>
<a name="line-2015"></a>
<a name="line-2016"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>implics</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_tv_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_fun_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>unsolved_others</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2017"></a>  <span class='hs-keyword'>where</span>
<a name="line-2018"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2019"></a>    <span class='hs-varid'>add_if_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`consCts`</span> <span class='hs-varid'>cts</span>
<a name="line-2020"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-2021"></a>
<a name="line-2022"></a>    <span class='hs-varid'>is_unsolved</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isGivenCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Wanted or Derived</span>
<a name="line-2023"></a>
<a name="line-2024"></a>    <span class='hs-comment'>-- For CFunEqCans we ignore the Derived ones, and keep</span>
<a name="line-2025"></a>    <span class='hs-comment'>-- only the Wanteds for flattening.  The Derived ones</span>
<a name="line-2026"></a>    <span class='hs-comment'>-- share a unification variable with the corresponding</span>
<a name="line-2027"></a>    <span class='hs-comment'>-- Wanted, so we definitely don't want to participate</span>
<a name="line-2028"></a>    <span class='hs-comment'>-- in unflattening</span>
<a name="line-2029"></a>    <span class='hs-comment'>-- See Note [Type family equations]</span>
<a name="line-2030"></a>    <span class='hs-varid'>add_if_wanted</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isWantedCt</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-varop'>`consCts`</span> <span class='hs-varid'>cts</span>
<a name="line-2031"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-2032"></a>
<a name="line-2033"></a><a name="isInInertEqs"></a><span class='hs-definition'>isInInertEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DTyVarEnv</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2034"></a><span class='hs-comment'>-- True if (a ~N ty) is in the inert set, in either Given or Wanted</span>
<a name="line-2035"></a><span class='hs-definition'>isInInertEqs</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>rhs</span>
<a name="line-2036"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupDVarEnv</span> <span class='hs-varid'>eqs</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2037"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2038"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>same_pred</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-2039"></a>  <span class='hs-keyword'>where</span>
<a name="line-2040"></a>    <span class='hs-varid'>same_pred</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>ct</span>
<a name="line-2041"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_eq_rel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eq_rel</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ct</span>
<a name="line-2042"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>NomEq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>eq_rel</span>
<a name="line-2043"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>rhs2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2044"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2045"></a>
<a name="line-2046"></a><a name="getNoGivenEqs"></a><span class='hs-definition'>getNoGivenEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcLevel</span>          <span class='hs-comment'>-- TcLevel of this implication</span>
<a name="line-2047"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- Skolems of this implication</span>
<a name="line-2048"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Bool</span>      <span class='hs-comment'>-- True &lt;=&gt; definitely no residual given equalities</span>
<a name="line-2049"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span> <span class='hs-layout'>)</span>     <span class='hs-comment'>-- Insoluble equalities arising from givens</span>
<a name="line-2050"></a><span class='hs-comment'>-- See Note [When does an implication have given equalities?]</span>
<a name="line-2051"></a><span class='hs-definition'>getNoGivenEqs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2052"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ieqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>irreds</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2053"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getInertCans</span>
<a name="line-2054"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>has_given_eqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>||</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ct_given_here</span><span class='hs-layout'>)</span> <span class='hs-conid'>False</span> <span class='hs-varid'>irreds</span>
<a name="line-2055"></a>                          <span class='hs-varop'>||</span> <span class='hs-varid'>anyDVarEnv</span> <span class='hs-varid'>eqs_given_here</span> <span class='hs-varid'>ieqs</span>
<a name="line-2056"></a>             <span class='hs-varid'>insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>insolubleEqCt</span> <span class='hs-varid'>irreds</span>
<a name="line-2057"></a>                      <span class='hs-comment'>-- Specifically includes ones that originated in some</span>
<a name="line-2058"></a>                      <span class='hs-comment'>-- outer context but were refined to an insoluble by</span>
<a name="line-2059"></a>                      <span class='hs-comment'>-- a local equality; so do /not/ add ct_given_here.</span>
<a name="line-2060"></a>
<a name="line-2061"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"getNoGivenEqs"</span> <span class='hs-varop'>$</span>
<a name="line-2062"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>has_given_eqs</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"May have given equalities"</span>
<a name="line-2063"></a>                                 <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"No given equalities"</span>
<a name="line-2064"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Skols:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2065"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Inerts:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inerts</span>
<a name="line-2066"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Insols:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>insols</span><span class='hs-keyglyph'>]</span>
<a name="line-2067"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>has_given_eqs</span><span class='hs-layout'>,</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2068"></a>  <span class='hs-keyword'>where</span>
<a name="line-2069"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EqualCtList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2070"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CTyEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-2071"></a>                              <span class='hs-comment'>-- Givens are always a sigleton</span>
<a name="line-2072"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>skolem_bound_here</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ct_given_here</span> <span class='hs-varid'>ct</span>
<a name="line-2073"></a>    <span class='hs-varid'>eqs_given_here</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2074"></a>
<a name="line-2075"></a>    <span class='hs-varid'>ct_given_here</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2076"></a>    <span class='hs-comment'>-- True for a Given bound by the current implication,</span>
<a name="line-2077"></a>    <span class='hs-comment'>-- i.e. the current level</span>
<a name="line-2078"></a>    <span class='hs-varid'>ct_given_here</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>isGiven</span> <span class='hs-varid'>ev</span>
<a name="line-2079"></a>                     <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ctLocLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-2080"></a>        <span class='hs-keyword'>where</span>
<a name="line-2081"></a>          <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-2082"></a>
<a name="line-2083"></a>    <span class='hs-varid'>skol_tv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2084"></a>    <span class='hs-varid'>skolem_bound_here</span> <span class='hs-varid'>tv</span> <span class='hs-comment'>-- See Note [Let-bound skolems]</span>
<a name="line-2085"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-2086"></a>          <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>skol_tv_set</span>
<a name="line-2087"></a>          <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2088"></a>
<a name="line-2089"></a><a name="matchableGivens"></a><span class='hs-comment'>-- | Returns Given constraints that might,</span>
<a name="line-2090"></a><span class='hs-comment'>-- potentially, match the given pred. This is used when checking to see if a</span>
<a name="line-2091"></a><span class='hs-comment'>-- Given might overlap with an instance. See Note [Instance and Given overlap]</span>
<a name="line-2092"></a><span class='hs-comment'>-- in TcInteract.</span>
<a name="line-2093"></a><span class='hs-definition'>matchableGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span>
<a name="line-2094"></a><span class='hs-definition'>matchableGivens</span> <span class='hs-varid'>loc_w</span> <span class='hs-varid'>pred_w</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2095"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterBag</span> <span class='hs-varid'>matchable_given</span> <span class='hs-varid'>all_relevant_givens</span>
<a name="line-2096"></a>  <span class='hs-keyword'>where</span>
<a name="line-2097"></a>    <span class='hs-comment'>-- just look in class constraints and irreds. matchableGivens does get called</span>
<a name="line-2098"></a>    <span class='hs-comment'>-- for ~R constraints, but we don't need to look through equalities, because</span>
<a name="line-2099"></a>    <span class='hs-comment'>-- canonical equalities are used for rewriting. We'll only get caught by</span>
<a name="line-2100"></a>    <span class='hs-comment'>-- non-canonical -- that is, irreducible -- equalities.</span>
<a name="line-2101"></a>    <span class='hs-varid'>all_relevant_givens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span>
<a name="line-2102"></a>    <span class='hs-varid'>all_relevant_givens</span>
<a name="line-2103"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred_w</span>
<a name="line-2104"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findDictsByClass</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>inert_cans</span><span class='hs-layout'>)</span> <span class='hs-varid'>clas</span>
<a name="line-2105"></a>        <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert_cans</span>
<a name="line-2106"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2107"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_irreds</span> <span class='hs-varid'>inert_cans</span>
<a name="line-2108"></a>
<a name="line-2109"></a>    <span class='hs-varid'>matchable_given</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2110"></a>    <span class='hs-varid'>matchable_given</span> <span class='hs-varid'>ct</span>
<a name="line-2111"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc_g</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred_g</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span>
<a name="line-2112"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mightMatchLater</span> <span class='hs-varid'>pred_g</span> <span class='hs-varid'>loc_g</span> <span class='hs-varid'>pred_w</span> <span class='hs-varid'>loc_w</span>
<a name="line-2113"></a>
<a name="line-2114"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2115"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2116"></a>
<a name="line-2117"></a><a name="mightMatchLater"></a><span class='hs-definition'>mightMatchLater</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2118"></a><span class='hs-definition'>mightMatchLater</span> <span class='hs-varid'>given_pred</span> <span class='hs-varid'>given_loc</span> <span class='hs-varid'>wanted_pred</span> <span class='hs-varid'>wanted_loc</span>
<a name="line-2119"></a>  <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>prohibitedSuperClassSolve</span> <span class='hs-varid'>given_loc</span> <span class='hs-varid'>wanted_loc</span><span class='hs-layout'>)</span>
<a name="line-2120"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcUnifyTys</span> <span class='hs-varid'>bind_meta_tv</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>given_pred</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>wanted_pred</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2121"></a>  <span class='hs-keyword'>where</span>
<a name="line-2122"></a>    <span class='hs-varid'>bind_meta_tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BindFlag</span>
<a name="line-2123"></a>    <span class='hs-comment'>-- Any meta tyvar may be unified later, so we treat it as</span>
<a name="line-2124"></a>    <span class='hs-comment'>-- bindable when unifying with givens. That ensures that we</span>
<a name="line-2125"></a>    <span class='hs-comment'>-- conservatively assume that a meta tyvar might get unified with</span>
<a name="line-2126"></a>    <span class='hs-comment'>-- something that matches the 'given', until demonstrated</span>
<a name="line-2127"></a>    <span class='hs-comment'>-- otherwise.  More info in Note [Instance and Given overlap]</span>
<a name="line-2128"></a>    <span class='hs-comment'>-- in TcInteract</span>
<a name="line-2129"></a>    <span class='hs-varid'>bind_meta_tv</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-2130"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFskTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BindMe</span>
<a name="line-2131"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Skolem</span>
<a name="line-2132"></a>
<a name="line-2133"></a><a name="prohibitedSuperClassSolve"></a><span class='hs-definition'>prohibitedSuperClassSolve</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2134"></a><span class='hs-comment'>-- See Note [Solving superclass constraints] in TcInstDcls</span>
<a name="line-2135"></a><span class='hs-definition'>prohibitedSuperClassSolve</span> <span class='hs-varid'>from_loc</span> <span class='hs-varid'>solve_loc</span>
<a name="line-2136"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GivenOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstSC</span> <span class='hs-varid'>given_size</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>from_loc</span>
<a name="line-2137"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ScOrigin</span> <span class='hs-varid'>wanted_size</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>solve_loc</span>
<a name="line-2138"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given_size</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>wanted_size</span>
<a name="line-2139"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2140"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2141"></a>
<a name="line-2142"></a><span class='hs-comment'>{- Note [Unsolved Derived equalities]
<a name="line-2143"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2144"></a>In getUnsolvedInerts, we return a derived equality from the inert_eqs
<a name="line-2145"></a>because it is a candidate for floating out of this implication.  We
<a name="line-2146"></a>only float equalities with a meta-tyvar on the left, so we only pull
<a name="line-2147"></a>those out here.
<a name="line-2148"></a>
<a name="line-2149"></a>Note [When does an implication have given equalities?]
<a name="line-2150"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2151"></a>Consider an implication
<a name="line-2152"></a>   beta =&gt; alpha ~ Int
<a name="line-2153"></a>where beta is a unification variable that has already been unified
<a name="line-2154"></a>to () in an outer scope.  Then we can float the (alpha ~ Int) out
<a name="line-2155"></a>just fine. So when deciding whether the givens contain an equality,
<a name="line-2156"></a>we should canonicalise first, rather than just looking at the original
<a name="line-2157"></a>givens (Trac #8644).
<a name="line-2158"></a>
<a name="line-2159"></a>So we simply look at the inert, canonical Givens and see if there are
<a name="line-2160"></a>any equalities among them, the calculation of has_given_eqs.  There
<a name="line-2161"></a>are some wrinkles:
<a name="line-2162"></a>
<a name="line-2163"></a> * We must know which ones are bound in *this* implication and which
<a name="line-2164"></a>   are bound further out.  We can find that out from the TcLevel
<a name="line-2165"></a>   of the Given, which is itself recorded in the tcl_tclvl field
<a name="line-2166"></a>   of the TcLclEnv stored in the Given (ev_given_here).
<a name="line-2167"></a>
<a name="line-2168"></a>   What about interactions between inner and outer givens?
<a name="line-2169"></a>      - Outer given is rewritten by an inner given, then there must
<a name="line-2170"></a>        have been an inner given equality, hence the given-eq flag
<a name="line-2171"></a>        will be true anyway.
<a name="line-2172"></a>
<a name="line-2173"></a>      - Inner given rewritten by outer, retains its level (ie. The inner one)
<a name="line-2174"></a>
<a name="line-2175"></a> * We must take account of *potential* equalities, like the one above:
<a name="line-2176"></a>      beta =&gt; ...blah...
<a name="line-2177"></a>   If we still don't know what beta is, we conservatively treat it as potentially
<a name="line-2178"></a>   becoming an equality. Hence including 'irreds' in the calculation or has_given_eqs.
<a name="line-2179"></a>
<a name="line-2180"></a> * When flattening givens, we generate Given equalities like
<a name="line-2181"></a>     &lt;F [a]&gt; : F [a] ~ f,
<a name="line-2182"></a>   with Refl evidence, and we *don't* want those to count as an equality
<a name="line-2183"></a>   in the givens!  After all, the entire flattening business is just an
<a name="line-2184"></a>   internal matter, and the evidence does not mention any of the 'givens'
<a name="line-2185"></a>   of this implication.  So we do not treat inert_funeqs as a 'given equality'.
<a name="line-2186"></a>
<a name="line-2187"></a> * See Note [Let-bound skolems] for another wrinkle
<a name="line-2188"></a>
<a name="line-2189"></a> * We do *not* need to worry about representational equalities, because
<a name="line-2190"></a>   these do not affect the ability to float constraints.
<a name="line-2191"></a>
<a name="line-2192"></a>Note [Let-bound skolems]
<a name="line-2193"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2194"></a>If   * the inert set contains a canonical Given CTyEqCan (a ~ ty)
<a name="line-2195"></a>and  * 'a' is a skolem bound in this very implication, b
<a name="line-2196"></a>
<a name="line-2197"></a>then:
<a name="line-2198"></a>a) The Given is pretty much a let-binding, like
<a name="line-2199"></a>      f :: (a ~ b-&gt;c) =&gt; a -&gt; a
<a name="line-2200"></a>   Here the equality constraint is like saying
<a name="line-2201"></a>      let a = b-&gt;c in ...
<a name="line-2202"></a>   It is not adding any new, local equality  information,
<a name="line-2203"></a>   and hence can be ignored by has_given_eqs
<a name="line-2204"></a>
<a name="line-2205"></a>b) 'a' will have been completely substituted out in the inert set,
<a name="line-2206"></a>   so we can safely discard it.  Notably, it doesn't need to be
<a name="line-2207"></a>   returned as part of 'fsks'
<a name="line-2208"></a>
<a name="line-2209"></a>For an example, see Trac #9211.
<a name="line-2210"></a>
<a name="line-2211"></a>See also TcUnify Note [Deeper level on the left] for how we ensure
<a name="line-2212"></a>that the right variable is on the left of the equality when both are
<a name="line-2213"></a>tyvars.
<a name="line-2214"></a>-}</span>
<a name="line-2215"></a>
<a name="line-2216"></a><a name="removeInertCts"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-2217"></a><span class='hs-comment'>-- ^ Remove inert constraints from the 'InertCans', for use when a</span>
<a name="line-2218"></a><span class='hs-comment'>-- typechecker plugin wishes to discard a given.</span>
<a name="line-2219"></a><span class='hs-definition'>removeInertCts</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>icans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>removeInertCt</span> <span class='hs-varid'>icans</span> <span class='hs-varid'>cts</span>
<a name="line-2220"></a>
<a name="line-2221"></a><a name="removeInertCt"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InertCans</span>
<a name="line-2222"></a><span class='hs-definition'>removeInertCt</span> <span class='hs-varid'>is</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span>
<a name="line-2223"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-2224"></a>
<a name="line-2225"></a>    <span class='hs-conid'>CDictCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cl</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2226"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_dicts</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>cl</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-2227"></a>
<a name="line-2228"></a>    <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tf</span><span class='hs-layout'>,</span>  <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2229"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFunEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>tf</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span>
<a name="line-2230"></a>
<a name="line-2231"></a>    <span class='hs-conid'>CTyEqCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span><span class='hs-layout'>,</span>  <span class='hs-varid'>cc_rhs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2232"></a>      <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_eqs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTyEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_eqs</span> <span class='hs-varid'>is</span><span class='hs-layout'>)</span> <span class='hs-varid'>x</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-2233"></a>
<a name="line-2234"></a>    <span class='hs-conid'>CQuantCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CQuantCan"</span>
<a name="line-2235"></a>    <span class='hs-conid'>CIrredCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CIrredEvCan"</span>
<a name="line-2236"></a>    <span class='hs-conid'>CNonCanonical</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CNonCanonical"</span>
<a name="line-2237"></a>    <span class='hs-conid'>CHoleCan</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"removeInertCt: CHoleCan"</span>
<a name="line-2238"></a>
<a name="line-2239"></a>
<a name="line-2240"></a><a name="lookupFlatCache"></a><span class='hs-definition'>lookupFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2241"></a><span class='hs-definition'>lookupFlatCache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2242"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flat_cache</span>
<a name="line-2243"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2244"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>firstJusts</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span><span class='hs-layout'>,</span>
<a name="line-2245"></a>                             <span class='hs-varid'>lookup_flats</span> <span class='hs-varid'>flat_cache</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2246"></a>  <span class='hs-keyword'>where</span>
<a name="line-2247"></a>    <span class='hs-varid'>lookup_inerts</span> <span class='hs-varid'>inert_funeqs</span>
<a name="line-2248"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_fsk</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2249"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findFunEq</span> <span class='hs-varid'>inert_funeqs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2250"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`eqTypes`</span> <span class='hs-varid'>xis</span>   <span class='hs-comment'>-- The lookup might find a near-match; see</span>
<a name="line-2251"></a>                            <span class='hs-comment'>-- Note [Use loose types in inert set]</span>
<a name="line-2252"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvCoercion</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-2253"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2254"></a>
<a name="line-2255"></a>    <span class='hs-varid'>lookup_flats</span> <span class='hs-varid'>flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findExactFunEq</span> <span class='hs-varid'>flat_cache</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>tys</span>
<a name="line-2256"></a>
<a name="line-2257"></a>
<a name="line-2258"></a><a name="lookupInInerts"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span><span class='hs-layout'>)</span>
<a name="line-2259"></a><span class='hs-comment'>-- Is this exact predicate type cached in the solved or canonicals of the InertSet?</span>
<a name="line-2260"></a><span class='hs-definition'>lookupInInerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-2261"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ClassPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-varid'>pty</span>
<a name="line-2262"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInerts</span>
<a name="line-2263"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupSolvedDict</span> <span class='hs-varid'>inerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`mplus`</span>
<a name="line-2264"></a>                 <span class='hs-varid'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2265"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- NB: No caching for equalities, IPs, holes, or errors</span>
<a name="line-2266"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2267"></a>
<a name="line-2268"></a><a name="lookupInertDict"></a><span class='hs-comment'>-- | Look up a dictionary inert. NB: the returned 'CtEvidence' might not</span>
<a name="line-2269"></a><span class='hs-comment'>-- match the input exactly. Note [Use loose types in inert set].</span>
<a name="line-2270"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertCans</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2271"></a><span class='hs-definition'>lookupInertDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2272"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-2273"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvidence</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2274"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2275"></a>
<a name="line-2276"></a><a name="lookupSolvedDict"></a><span class='hs-comment'>-- | Look up a solved inert. NB: the returned 'CtEvidence' might not</span>
<a name="line-2277"></a><span class='hs-comment'>-- match the input exactly. See Note [Use loose types in inert set].</span>
<a name="line-2278"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-2279"></a><span class='hs-comment'>-- Returns just if exactly this predicate type exists in the solved.</span>
<a name="line-2280"></a><span class='hs-definition'>lookupSolvedDict</span> <span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>solved</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2281"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>findDict</span> <span class='hs-varid'>solved</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-2282"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span>
<a name="line-2283"></a>      <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-2284"></a>
<a name="line-2285"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2286"></a>*                                                                      *
<a name="line-2287"></a>                   Irreds
<a name="line-2288"></a>*                                                                      *
<a name="line-2289"></a>********************************************************************* -}</span>
<a name="line-2290"></a>
<a name="line-2291"></a><a name="foldIrreds"></a><span class='hs-definition'>foldIrreds</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2292"></a><span class='hs-definition'>foldIrreds</span> <span class='hs-varid'>k</span> <span class='hs-varid'>irreds</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldrBag</span> <span class='hs-varid'>k</span> <span class='hs-varid'>z</span> <span class='hs-varid'>irreds</span>
<a name="line-2293"></a>
<a name="line-2294"></a>
<a name="line-2295"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2296"></a>*                                                                      *
<a name="line-2297"></a>                   TcAppMap
<a name="line-2298"></a>*                                                                      *
<a name="line-2299"></a>************************************************************************
<a name="line-2300"></a>
<a name="line-2301"></a>Note [Use loose types in inert set]
<a name="line-2302"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2303"></a>Say we know (Eq (a |&gt; c1)) and we need (Eq (a |&gt; c2)). One is clearly
<a name="line-2304"></a>solvable from the other. So, we do lookup in the inert set using
<a name="line-2305"></a>loose types, which omit the kind-check.
<a name="line-2306"></a>
<a name="line-2307"></a>We must be careful when using the result of a lookup because it may
<a name="line-2308"></a>not match the requested info exactly!
<a name="line-2309"></a>
<a name="line-2310"></a>-}</span>
<a name="line-2311"></a>
<a name="line-2312"></a><a name="TcAppMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqDFM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>LooseTypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2313"></a>    <span class='hs-comment'>-- Indexed by tycon then the arg types, using "loose" matching, where</span>
<a name="line-2314"></a>    <span class='hs-comment'>-- we don't require kind equality. This allows, for example, (a |&gt; co)</span>
<a name="line-2315"></a>    <span class='hs-comment'>-- to match (a).</span>
<a name="line-2316"></a>    <span class='hs-comment'>-- See Note [Use loose types in inert set]</span>
<a name="line-2317"></a>    <span class='hs-comment'>-- Used for types and classes; hence UniqDFM</span>
<a name="line-2318"></a>    <span class='hs-comment'>-- See Note [foldTM determinism] for why we use UniqDFM here</span>
<a name="line-2319"></a>
<a name="line-2320"></a><a name="isEmptyTcAppMap"></a><span class='hs-definition'>isEmptyTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2321"></a><span class='hs-definition'>isEmptyTcAppMap</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isNullUDFM</span> <span class='hs-varid'>m</span>
<a name="line-2322"></a>
<a name="line-2323"></a><a name="emptyTcAppMap"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2324"></a><span class='hs-definition'>emptyTcAppMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUDFM</span>
<a name="line-2325"></a>
<a name="line-2326"></a><a name="findTcApp"></a><span class='hs-definition'>findTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2327"></a><span class='hs-definition'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_map</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>u</span>
<a name="line-2328"></a>                       <span class='hs-layout'>;</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys_map</span> <span class='hs-layout'>}</span>
<a name="line-2329"></a>
<a name="line-2330"></a><a name="delTcApp"></a><span class='hs-definition'>delTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2331"></a><span class='hs-definition'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>adjustUDFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>deleteTM</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-2332"></a>
<a name="line-2333"></a><a name="insertTcApp"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2334"></a><span class='hs-definition'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterUDFM</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-2335"></a>  <span class='hs-keyword'>where</span>
<a name="line-2336"></a>    <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>mb_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_tm</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2337"></a>
<a name="line-2338"></a><span class='hs-comment'>-- mapTcApp :: (a-&gt;b) -&gt; TcAppMap a -&gt; TcAppMap b</span>
<a name="line-2339"></a><span class='hs-comment'>-- mapTcApp f = mapUDFM (mapTM f)</span>
<a name="line-2340"></a>
<a name="line-2341"></a><a name="filterTcAppMap"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-conid'>Ct</span>
<a name="line-2342"></a><span class='hs-definition'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span>
<a name="line-2343"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapUDFM</span> <span class='hs-varid'>do_tm</span> <span class='hs-varid'>m</span>
<a name="line-2344"></a>  <span class='hs-keyword'>where</span>
<a name="line-2345"></a>    <span class='hs-varid'>do_tm</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>insert_mb</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>emptyTM</span>
<a name="line-2346"></a>    <span class='hs-varid'>insert_mb</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-2347"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-2348"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tm</span>
<a name="line-2349"></a>       <span class='hs-keyword'>where</span>
<a name="line-2350"></a>         <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>of</span>
<a name="line-2351"></a>                <span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span>
<a name="line-2352"></a>                <span class='hs-conid'>CDictCan</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tys</span>
<a name="line-2353"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"filterTcAppMap"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2354"></a>
<a name="line-2355"></a><a name="tcAppMapToBag"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2356"></a><span class='hs-definition'>tcAppMapToBag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2357"></a>
<a name="line-2358"></a><a name="foldTcAppMap"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2359"></a><span class='hs-definition'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-varid'>z</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldUDFM</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldTM</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>z</span> <span class='hs-varid'>m</span>
<a name="line-2360"></a>
<a name="line-2361"></a>
<a name="line-2362"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2363"></a>*                                                                      *
<a name="line-2364"></a>                   DictMap
<a name="line-2365"></a>*                                                                      *
<a name="line-2366"></a>********************************************************************* -}</span>
<a name="line-2367"></a>
<a name="line-2368"></a>
<a name="line-2369"></a><span class='hs-comment'>{- Note [Tuples hiding implicit parameters]
<a name="line-2370"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2371"></a>Consider
<a name="line-2372"></a>   f,g :: (?x::Int, C a) =&gt; a -&gt; a
<a name="line-2373"></a>   f v = let ?x = 4 in g v
<a name="line-2374"></a>
<a name="line-2375"></a>The call to 'g' gives rise to a Wanted constraint (?x::Int, C a).
<a name="line-2376"></a>We must /not/ solve this from the Given (?x::Int, C a), because of
<a name="line-2377"></a>the intervening binding for (?x::Int).  Trac #14218.
<a name="line-2378"></a>
<a name="line-2379"></a>We deal with this by arranging that we always fail when looking up a
<a name="line-2380"></a>tuple constraint that hides an implicit parameter. Not that this applies
<a name="line-2381"></a>  * both to the inert_dicts (lookupInertDict)
<a name="line-2382"></a>  * and to the solved_dicts (looukpSolvedDict)
<a name="line-2383"></a>An alternative would be not to extend these sets with such tuple
<a name="line-2384"></a>constraints, but it seemed more direct to deal with the lookup.
<a name="line-2385"></a>
<a name="line-2386"></a>Note [Solving CallStack constraints]
<a name="line-2387"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2388"></a>Suppose f :: HasCallStack =&gt; blah.  Then
<a name="line-2389"></a>
<a name="line-2390"></a>* Each call to 'f' gives rise to
<a name="line-2391"></a>    [W] s1 :: IP "callStack" CallStack    -- CtOrigin = OccurrenceOf f
<a name="line-2392"></a>  with a CtOrigin that says "OccurrenceOf f".
<a name="line-2393"></a>  Remember that HasCallStack is just shorthand for
<a name="line-2394"></a>    IP "callStack CallStack
<a name="line-2395"></a>  See Note [Overview of implicit CallStacks] in TcEvidence
<a name="line-2396"></a>
<a name="line-2397"></a>* We cannonicalise such constraints, in TcCanonical.canClassNC, by
<a name="line-2398"></a>  pushing the call-site info on the stack, and changing the CtOrigin
<a name="line-2399"></a>  to record that has been done.
<a name="line-2400"></a>   Bind:  s1 = pushCallStack &lt;site-info&gt; s2
<a name="line-2401"></a>   [W] s2 :: IP "callStack" CallStack   -- CtOrigin = IPOccOrigin
<a name="line-2402"></a>
<a name="line-2403"></a>* Then, and only then, we can solve the constraint from an enclosing
<a name="line-2404"></a>  Given.
<a name="line-2405"></a>
<a name="line-2406"></a>So we must be careful /not/ to solve 's1' from the Givens.  Again,
<a name="line-2407"></a>we ensure this by arranging that findDict always misses when looking
<a name="line-2408"></a>up souch constraints.
<a name="line-2409"></a>-}</span>
<a name="line-2410"></a>
<a name="line-2411"></a><a name="DictMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2412"></a>
<a name="line-2413"></a><a name="emptyDictMap"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2414"></a><span class='hs-definition'>emptyDictMap</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-2415"></a>
<a name="line-2416"></a><a name="findDict"></a><span class='hs-definition'>findDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2417"></a><span class='hs-definition'>findDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2418"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCTupleClass</span> <span class='hs-varid'>cls</span>
<a name="line-2419"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-varid'>hasIPPred</span> <span class='hs-varid'>tys</span>   <span class='hs-comment'>-- See Note [Tuples hiding implicit parameters]</span>
<a name="line-2420"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-2421"></a>
<a name="line-2422"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCallStackPred</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span>
<a name="line-2423"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>OccurrenceOf</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span>
<a name="line-2424"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>             <span class='hs-comment'>-- See Note [Solving CallStack constraints]</span>
<a name="line-2425"></a>
<a name="line-2426"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2427"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2428"></a>
<a name="line-2429"></a><a name="findDictsByClass"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2430"></a><span class='hs-definition'>findDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span>
<a name="line-2431"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2432"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2433"></a>
<a name="line-2434"></a><a name="delDict"></a><span class='hs-definition'>delDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2435"></a><span class='hs-definition'>delDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2436"></a>
<a name="line-2437"></a><a name="addDict"></a><span class='hs-definition'>addDict</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2438"></a><span class='hs-definition'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>cls</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>item</span>
<a name="line-2439"></a>
<a name="line-2440"></a><a name="addDictsByClass"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-2441"></a><span class='hs-definition'>addDictsByClass</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>items</span>
<a name="line-2442"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldrBag</span> <span class='hs-varid'>add</span> <span class='hs-varid'>emptyTM</span> <span class='hs-varid'>items</span><span class='hs-layout'>)</span>
<a name="line-2443"></a>  <span class='hs-keyword'>where</span>
<a name="line-2444"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>tm</span>
<a name="line-2445"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addDictsByClass"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2446"></a>
<a name="line-2447"></a><a name="filterDicts"></a><span class='hs-definition'>filterDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span>
<a name="line-2448"></a><span class='hs-definition'>filterDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterTcAppMap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span>
<a name="line-2449"></a>
<a name="line-2450"></a><a name="partitionDicts"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>DictMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-2451"></a><span class='hs-definition'>partitionDicts</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyDicts</span><span class='hs-layout'>)</span>
<a name="line-2452"></a>  <span class='hs-keyword'>where</span>
<a name="line-2453"></a>    <span class='hs-varid'>k</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span> <span class='hs-varop'>`consBag`</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-2454"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span>              <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>noes</span><span class='hs-layout'>)</span>
<a name="line-2455"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CDictCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_class</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-2456"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addDict</span> <span class='hs-varid'>m</span> <span class='hs-varid'>cls</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ct</span>
<a name="line-2457"></a>    <span class='hs-varid'>add</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"partitionDicts"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2458"></a>
<a name="line-2459"></a><a name="dictsToBag"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2460"></a><span class='hs-definition'>dictsToBag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAppMapToBag</span>
<a name="line-2461"></a>
<a name="line-2462"></a><a name="foldDicts"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2463"></a><span class='hs-definition'>foldDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-2464"></a>
<a name="line-2465"></a><a name="emptyDicts"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DictMap</span> <span class='hs-varid'>a</span>
<a name="line-2466"></a><span class='hs-definition'>emptyDicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-2467"></a>
<a name="line-2468"></a>
<a name="line-2469"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2470"></a>*                                                                      *
<a name="line-2471"></a>                   FunEqMap
<a name="line-2472"></a>*                                                                      *
<a name="line-2473"></a>********************************************************************* -}</span>
<a name="line-2474"></a>
<a name="line-2475"></a><a name="FunEqMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>  <span class='hs-comment'>-- A map whose key is a (TyCon, [Type]) pair</span>
<a name="line-2476"></a>
<a name="line-2477"></a><a name="emptyFunEqs"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcAppMap</span> <span class='hs-varid'>a</span>
<a name="line-2478"></a><span class='hs-definition'>emptyFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyTcAppMap</span>
<a name="line-2479"></a>
<a name="line-2480"></a><a name="findFunEq"></a><span class='hs-definition'>findFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2481"></a><span class='hs-definition'>findFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2482"></a>
<a name="line-2483"></a><a name="funEqsToBag"></a><span class='hs-definition'>funEqsToBag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-varid'>a</span>
<a name="line-2484"></a><span class='hs-definition'>funEqsToBag</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>consBag</span> <span class='hs-varid'>m</span> <span class='hs-varid'>emptyBag</span>
<a name="line-2485"></a>
<a name="line-2486"></a><a name="findFunEqsByTyCon"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-2487"></a><span class='hs-comment'>-- Get inert function equation constraints that have the given tycon</span>
<a name="line-2488"></a><span class='hs-comment'>-- in their head.  Not that the constraints remain in the inert set.</span>
<a name="line-2489"></a><span class='hs-comment'>-- We use this to check for derived interactions with built-in type-function</span>
<a name="line-2490"></a><span class='hs-comment'>-- constructors.</span>
<a name="line-2491"></a><span class='hs-definition'>findFunEqsByTyCon</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span>
<a name="line-2492"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUDFM</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTM</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span> <span class='hs-conid'>[]</span>
<a name="line-2493"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-2494"></a>
<a name="line-2495"></a><a name="foldFunEqs"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-2496"></a><span class='hs-definition'>foldFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span>
<a name="line-2497"></a>
<a name="line-2498"></a><span class='hs-comment'>-- mapFunEqs :: (a -&gt; b) -&gt; FunEqMap a -&gt; FunEqMap b</span>
<a name="line-2499"></a><span class='hs-comment'>-- mapFunEqs = mapTcApp</span>
<a name="line-2500"></a>
<a name="line-2501"></a><span class='hs-comment'>-- filterFunEqs :: (Ct -&gt; Bool) -&gt; FunEqMap Ct -&gt; FunEqMap Ct</span>
<a name="line-2502"></a><span class='hs-comment'>-- filterFunEqs = filterTcAppMap</span>
<a name="line-2503"></a>
<a name="line-2504"></a><a name="insertFunEq"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2505"></a><span class='hs-definition'>insertFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span>
<a name="line-2506"></a>
<a name="line-2507"></a><a name="partitionFunEqs"></a><span class='hs-definition'>partitionFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-conid'>Ct</span><span class='hs-layout'>)</span>
<a name="line-2508"></a><span class='hs-comment'>-- Optimise for the case where the predicate is false</span>
<a name="line-2509"></a><span class='hs-comment'>-- partitionFunEqs is called only from kick-out, and kick-out usually</span>
<a name="line-2510"></a><span class='hs-comment'>-- kicks out very few equalities, so we want to optimise for that case</span>
<a name="line-2511"></a><span class='hs-definition'>partitionFunEqs</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>yeses</span><span class='hs-layout'>,</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>del</span> <span class='hs-varid'>m</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>)</span>
<a name="line-2512"></a>  <span class='hs-keyword'>where</span>
<a name="line-2513"></a>    <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTcAppMap</span> <span class='hs-varid'>k</span> <span class='hs-varid'>m</span> <span class='hs-conid'>[]</span>
<a name="line-2514"></a>    <span class='hs-varid'>k</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-varid'>ct</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct</span> <span class='hs-conop'>:</span> <span class='hs-varid'>yeses</span>
<a name="line-2515"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>yeses</span>
<a name="line-2516"></a>    <span class='hs-varid'>del</span> <span class='hs-layout'>(</span><span class='hs-conid'>CFunEqCan</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cc_fun</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cc_tyargs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>m</span>
<a name="line-2517"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-2518"></a>    <span class='hs-varid'>del</span> <span class='hs-varid'>ct</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"partitionFunEqs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-2519"></a>
<a name="line-2520"></a><a name="delFunEq"></a><span class='hs-definition'>delFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2521"></a><span class='hs-definition'>delFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delTcApp</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2522"></a>
<a name="line-2523"></a><a name="ExactFunEqMap"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2524"></a><a name="ExactFunEqMap"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqFM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ListMap</span> <span class='hs-conid'>TypeMap</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2525"></a>
<a name="line-2526"></a><a name="emptyExactFunEqs"></a><span class='hs-definition'>emptyExactFunEqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2527"></a><span class='hs-definition'>emptyExactFunEqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyUFM</span>
<a name="line-2528"></a>
<a name="line-2529"></a><a name="findExactFunEq"></a><span class='hs-definition'>findExactFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span>
<a name="line-2530"></a><span class='hs-definition'>findExactFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_map</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupUFM</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2531"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>lookupTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys_map</span> <span class='hs-layout'>}</span>
<a name="line-2532"></a>
<a name="line-2533"></a><a name="insertExactFunEq"></a><span class='hs-definition'>insertExactFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExactFunEqMap</span> <span class='hs-varid'>a</span>
<a name="line-2534"></a><span class='hs-definition'>insertExactFunEq</span> <span class='hs-varid'>m</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterUFM</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2535"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>alter_tm</span> <span class='hs-varid'>mb_tm</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>insertTM</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>val</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_tm</span> <span class='hs-varop'>`orElse`</span> <span class='hs-varid'>emptyTM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2536"></a>
<a name="line-2537"></a><span class='hs-comment'>{-
<a name="line-2538"></a>************************************************************************
<a name="line-2539"></a>*                                                                      *
<a name="line-2540"></a>*              The TcS solver monad                                    *
<a name="line-2541"></a>*                                                                      *
<a name="line-2542"></a>************************************************************************
<a name="line-2543"></a>
<a name="line-2544"></a>Note [The TcS monad]
<a name="line-2545"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-2546"></a>The TcS monad is a weak form of the main Tc monad
<a name="line-2547"></a>
<a name="line-2548"></a>All you can do is
<a name="line-2549"></a>    * fail
<a name="line-2550"></a>    * allocate new variables
<a name="line-2551"></a>    * fill in evidence variables
<a name="line-2552"></a>
<a name="line-2553"></a>Filling in a dictionary evidence variable means to create a binding
<a name="line-2554"></a>for it, so TcS carries a mutable location where the binding can be
<a name="line-2555"></a>added.  This is initialised from the innermost implication constraint.
<a name="line-2556"></a>-}</span>
<a name="line-2557"></a>
<a name="line-2558"></a><a name="TcSEnv"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcSEnv</span>
<a name="line-2559"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span>
<a name="line-2560"></a>      <span class='hs-varid'>tcs_ev_binds</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span><span class='hs-layout'>,</span>
<a name="line-2561"></a>
<a name="line-2562"></a>      <span class='hs-varid'>tcs_unified</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span>
<a name="line-2563"></a>         <span class='hs-comment'>-- The number of unification variables we have filled</span>
<a name="line-2564"></a>         <span class='hs-comment'>-- The important thing is whether it is non-zero</span>
<a name="line-2565"></a>
<a name="line-2566"></a>      <span class='hs-varid'>tcs_count</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Global step count</span>
<a name="line-2567"></a>
<a name="line-2568"></a>      <span class='hs-varid'>tcs_inerts</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>,</span> <span class='hs-comment'>-- Current inert set</span>
<a name="line-2569"></a>
<a name="line-2570"></a>      <span class='hs-comment'>-- The main work-list and the flattening worklist</span>
<a name="line-2571"></a>      <span class='hs-comment'>-- See Note [Work list priorities] and</span>
<a name="line-2572"></a>      <span class='hs-varid'>tcs_worklist</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span> <span class='hs-comment'>-- Current worklist</span>
<a name="line-2573"></a>    <span class='hs-layout'>}</span>
<a name="line-2574"></a>
<a name="line-2575"></a><a name="TcS"></a><span class='hs-comment'>---------------</span>
<a name="line-2576"></a><a name="TcS"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-2577"></a>
<a name="line-2578"></a><a name="instance%20Functor%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Functor</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2579"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span>
<a name="line-2580"></a>
<a name="line-2581"></a><a name="instance%20Applicative%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Applicative</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2582"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2583"></a>  <span class='hs-layout'>(</span><span class='hs-varop'>&lt;*&gt;</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ap</span>
<a name="line-2584"></a>
<a name="line-2585"></a><a name="instance%20Monad%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monad</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2586"></a>  <span class='hs-varid'>fail</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MonadFail.fail</span>
<a name="line-2587"></a>  <span class='hs-varid'>m</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ebs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>m</span> <span class='hs-varid'>ebs</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>ebs</span><span class='hs-layout'>)</span>
<a name="line-2588"></a>
<a name="line-2589"></a><a name="instance%20MonadFail.MonadFail%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadFail.MonadFail</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2590"></a>  <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-2591"></a>
<a name="line-2592"></a><a name="instance%20MonadUnique%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadUnique</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2593"></a>   <span class='hs-varid'>getUniqueSupplyM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getUniqueSupplyM</span>
<a name="line-2594"></a>
<a name="line-2595"></a><a name="instance%20HasModule%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasModule</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2596"></a>   <span class='hs-varid'>getModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getModule</span>
<a name="line-2597"></a>
<a name="line-2598"></a><a name="instance%20MonadThings%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>MonadThings</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2599"></a>   <span class='hs-varid'>lookupThing</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupThing</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-2600"></a>
<a name="line-2601"></a><a name="wrapTcS"></a><span class='hs-comment'>-- Basic functionality</span>
<a name="line-2602"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2603"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2604"></a><span class='hs-comment'>-- Do not export wrapTcS, because it promotes an arbitrary TcM to TcS,</span>
<a name="line-2605"></a><span class='hs-comment'>-- and TcS is supposed to have limited functionality</span>
<a name="line-2606"></a><span class='hs-definition'>wrapTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span> <span class='hs-comment'>-- a TcM action will not use the TcEvBinds</span>
<a name="line-2607"></a>
<a name="line-2608"></a><a name="wrapErrTcS"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2609"></a><span class='hs-comment'>-- The thing wrapped should just fail</span>
<a name="line-2610"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-2611"></a><span class='hs-comment'>-- Having a variant for each error message is too painful</span>
<a name="line-2612"></a><span class='hs-definition'>wrapErrTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-2613"></a>
<a name="line-2614"></a><a name="wrapWarnTcS"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2615"></a><span class='hs-comment'>-- The thing wrapped should just add a warning, or no-op</span>
<a name="line-2616"></a><span class='hs-comment'>-- There's no static check; it's up to the user</span>
<a name="line-2617"></a><span class='hs-definition'>wrapWarnTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>
<a name="line-2618"></a>
<a name="line-2619"></a><a name="failTcS"></a><span class='hs-definition'>failTcS</span><span class='hs-layout'>,</span> <span class='hs-varid'>panicTcS</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2620"></a><a name="warnTcS"></a><span class='hs-definition'>warnTcS</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WarningFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2621"></a><a name="addErrTcS"></a><span class='hs-definition'>addErrTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2622"></a><span class='hs-definition'>failTcS</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.failWith</span>
<a name="line-2623"></a><span class='hs-definition'>warnTcS</span> <span class='hs-varid'>flag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.addWarn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span>
<a name="line-2624"></a><span class='hs-definition'>addErrTcS</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.addErr</span>
<a name="line-2625"></a><a name="panicTcS"></a><span class='hs-definition'>panicTcS</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"TcCanonical"</span> <span class='hs-varid'>doc</span>
<a name="line-2626"></a>
<a name="line-2627"></a><a name="traceTcS"></a><span class='hs-definition'>traceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2628"></a><span class='hs-definition'>traceTcS</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.traceTc</span> <span class='hs-varid'>herald</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-2629"></a>
<a name="line-2630"></a><a name="runTcPluginTcS"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPluginM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2631"></a><span class='hs-definition'>runTcPluginTcS</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-varid'>runTcPluginM</span> <span class='hs-varid'>m</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-2632"></a>
<a name="line-2633"></a><a name="instance%20HasDynFlags%20TcS"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>HasDynFlags</span> <span class='hs-conid'>TcS</span> <span class='hs-keyword'>where</span>
<a name="line-2634"></a>    <span class='hs-varid'>getDynFlags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2635"></a>
<a name="line-2636"></a><a name="getGlobalRdrEnvTcS"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-2637"></a><span class='hs-definition'>getGlobalRdrEnvTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.getGlobalRdrEnv</span>
<a name="line-2638"></a>
<a name="line-2639"></a><a name="bumpStepCountTcS"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2640"></a><span class='hs-definition'>bumpStepCountTcS</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span>
<a name="line-2641"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-2642"></a>                                    <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2643"></a>
<a name="line-2644"></a><a name="csTraceTcS"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2645"></a><span class='hs-definition'>csTraceTcS</span> <span class='hs-varid'>doc</span>
<a name="line-2646"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varid'>doc</span><span class='hs-layout'>)</span>
<a name="line-2647"></a>
<a name="line-2648"></a><a name="traceFireTcS"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2649"></a><span class='hs-comment'>-- Dump a rule-firing trace</span>
<a name="line-2650"></a><span class='hs-definition'>traceFireTcS</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>doc</span>
<a name="line-2651"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>csTraceTcM</span> <span class='hs-varop'>$</span>
<a name="line-2652"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_count</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-2653"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tclvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcLevel</span>
<a name="line-2654"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Step"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span>
<a name="line-2655"></a>                       <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"l:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tclvl</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-2656"></a>                                    <span class='hs-varid'>text</span> <span class='hs-str'>"d:"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvLoc</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2657"></a>                       <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>doc</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-2658"></a>                     <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2659"></a>
<a name="line-2660"></a><a name="csTraceTcM"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2661"></a><span class='hs-comment'>-- Constraint-solver tracing, -ddump-cs-trace</span>
<a name="line-2662"></a><span class='hs-definition'>csTraceTcM</span> <span class='hs-varid'>mk_doc</span>
<a name="line-2663"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2664"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span>  <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varid'>dflags</span>
<a name="line-2665"></a>                  <span class='hs-varop'>||</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_tc_trace</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>)</span>
<a name="line-2666"></a>              <span class='hs-layout'>(</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_doc</span>
<a name="line-2667"></a>                   <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.traceTcRn</span> <span class='hs-conid'>Opt_D_dump_cs_trace</span> <span class='hs-varid'>msg</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2668"></a>
<a name="line-2669"></a><a name="runTcS"></a><span class='hs-definition'>runTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>                <span class='hs-comment'>-- What to run</span>
<a name="line-2670"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvBindMap</span><span class='hs-layout'>)</span>
<a name="line-2671"></a><span class='hs-definition'>runTcS</span> <span class='hs-varid'>tcs</span>
<a name="line-2672"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-2673"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-2674"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2675"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>ev_binds</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2676"></a>
<a name="line-2677"></a><a name="runTcSDeriveds"></a><span class='hs-comment'>-- | This variant of 'runTcS' will keep solving, even when only Deriveds</span>
<a name="line-2678"></a><span class='hs-comment'>-- are left around. It also doesn't return any evidence, as callers won't</span>
<a name="line-2679"></a><span class='hs-comment'>-- need it.</span>
<a name="line-2680"></a><span class='hs-definition'>runTcSDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2681"></a><span class='hs-definition'>runTcSDeriveds</span> <span class='hs-varid'>tcs</span>
<a name="line-2682"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-2683"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span> <span class='hs-layout'>}</span>
<a name="line-2684"></a>
<a name="line-2685"></a><a name="runTcSEqualities"></a><span class='hs-comment'>-- | This can deal only with equality constraints.</span>
<a name="line-2686"></a><span class='hs-definition'>runTcSEqualities</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2687"></a><span class='hs-definition'>runTcSEqualities</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2688"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newNoTcEvBinds</span>
<a name="line-2689"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>}</span>
<a name="line-2690"></a>
<a name="line-2691"></a><a name="runTcSWithEvBinds"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-2692"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2693"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2694"></a><span class='hs-definition'>runTcSWithEvBinds</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>tcs</span>
<a name="line-2695"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>unified_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-num'>0</span>
<a name="line-2696"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>step_count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-num'>0</span>
<a name="line-2697"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyInert</span>
<a name="line-2698"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2699"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2700"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-2701"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>step_count</span>
<a name="line-2702"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_var</span>
<a name="line-2703"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_var</span> <span class='hs-layout'>}</span>
<a name="line-2704"></a>
<a name="line-2705"></a>             <span class='hs-comment'>-- Run the computation</span>
<a name="line-2706"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unTcS</span> <span class='hs-varid'>tcs</span> <span class='hs-varid'>env</span>
<a name="line-2707"></a>
<a name="line-2708"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>count</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>step_count</span>
<a name="line-2709"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>count</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2710"></a>         <span class='hs-varid'>csTraceTcM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Constraint solver steps ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>count</span><span class='hs-layout'>)</span>
<a name="line-2711"></a>
<a name="line-2712"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unflattenGivens</span> <span class='hs-varid'>inert_var</span>
<a name="line-2713"></a>
<a name="line-2714"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-2715"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2716"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-2717"></a><span class='hs-cpp'>#endif</span>
<a name="line-2718"></a>
<a name="line-2719"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-2720"></a>
<a name="line-2721"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2722"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-2723"></a><a name="checkForCyclicBinds"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2724"></a><span class='hs-definition'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds_map</span>
<a name="line-2725"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cycles</span>
<a name="line-2726"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2727"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-2728"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"Cycle in evidence binds"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cycles</span>
<a name="line-2729"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2730"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"Cycle in coercion bindings"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>coercion_cycles</span>
<a name="line-2731"></a>  <span class='hs-keyword'>where</span>
<a name="line-2732"></a>    <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evBindMapBinds</span> <span class='hs-varid'>ev_binds_map</span>
<a name="line-2733"></a>
<a name="line-2734"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvBind</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-2735"></a>    <span class='hs-varid'>cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CyclicSCC</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stronglyConnCompFromEdgedVerticesUniq</span> <span class='hs-varid'>edges</span><span class='hs-keyglyph'>]</span>
<a name="line-2736"></a>
<a name="line-2737"></a>    <span class='hs-varid'>coercion_cycles</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>c</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cycles</span><span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-varid'>is_co_bind</span> <span class='hs-varid'>c</span><span class='hs-keyglyph'>]</span>
<a name="line-2738"></a>    <span class='hs-varid'>is_co_bind</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>b</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-2739"></a>
<a name="line-2740"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>EvVar</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>]</span>
<a name="line-2741"></a>    <span class='hs-varid'>edges</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-conid'>DigraphNode</span> <span class='hs-varid'>bind</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>evVarsOfTerm</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2742"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bind</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>EvBind</span> <span class='hs-layout'>{</span> <span class='hs-varid'>eb_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>eb_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bagToList</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>]</span>
<a name="line-2743"></a>            <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here as</span>
<a name="line-2744"></a>            <span class='hs-comment'>-- stronglyConnCompFromEdgedVertices is still deterministic even</span>
<a name="line-2745"></a>            <span class='hs-comment'>-- if the edges are in nondeterministic order as explained in</span>
<a name="line-2746"></a>            <span class='hs-comment'>-- Note [Deterministic SCC] in Digraph.</span>
<a name="line-2747"></a><span class='hs-cpp'>#endif</span>
<a name="line-2748"></a>
<a name="line-2749"></a><a name="setEvBindsTcS"></a><span class='hs-comment'>----------------------------</span>
<a name="line-2750"></a><span class='hs-definition'>setEvBindsTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2751"></a><span class='hs-definition'>setEvBindsTcS</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2752"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2753"></a>
<a name="line-2754"></a><a name="nestImplicTcS"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-2755"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcLevel</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2756"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2757"></a><span class='hs-definition'>nestImplicTcS</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2758"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-2759"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-2760"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-2761"></a>                   <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2762"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>old_inert_var</span>
<a name="line-2763"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_inert</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInert</span>
<a name="line-2764"></a>                            <span class='hs-layout'>{</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span>
<a name="line-2765"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>inerts</span> <span class='hs-layout'>}</span>
<a name="line-2766"></a>                              <span class='hs-comment'>-- See Note [Do not inherit the flat cache]</span>
<a name="line-2767"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>nest_inert</span>
<a name="line-2768"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2769"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_ev_binds</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span>
<a name="line-2770"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_unified</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unified_var</span>
<a name="line-2771"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_count</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-2772"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_inerts</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2773"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span>
<a name="line-2774"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.setTcLevel</span> <span class='hs-varid'>inner_tclvl</span> <span class='hs-varop'>$</span>
<a name="line-2775"></a>                <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-2776"></a>
<a name="line-2777"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unflattenGivens</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2778"></a>
<a name="line-2779"></a><span class='hs-cpp'>#if defined(DEBUG)</span>
<a name="line-2780"></a>       <span class='hs-comment'>-- Perform a check that the thing_inside did not cause cycles</span>
<a name="line-2781"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ref</span>
<a name="line-2782"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkForCyclicBinds</span> <span class='hs-varid'>ev_binds</span>
<a name="line-2783"></a><span class='hs-cpp'>#endif</span>
<a name="line-2784"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-2785"></a>
<a name="line-2786"></a><span class='hs-comment'>{- Note [Do not inherit the flat cache]
<a name="line-2787"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2788"></a>We do not want to inherit the flat cache when processing nested
<a name="line-2789"></a>implications.  Consider
<a name="line-2790"></a>   a ~ F b, forall c. b~Int =&gt; blah
<a name="line-2791"></a>If we have F b ~ fsk in the flat-cache, and we push that into the
<a name="line-2792"></a>nested implication, we might miss that F b can be rewritten to F Int,
<a name="line-2793"></a>and hence perhpas solve it.  Moreover, the fsk from outside is
<a name="line-2794"></a>flattened out after solving the outer level, but and we don't
<a name="line-2795"></a>do that flattening recursively.
<a name="line-2796"></a>-}</span>
<a name="line-2797"></a>
<a name="line-2798"></a><a name="nestTcS"></a><span class='hs-definition'>nestTcS</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2799"></a><span class='hs-comment'>-- Use the current untouchables, augmenting the current</span>
<a name="line-2800"></a><span class='hs-comment'>-- evidence bindings, and solved dictionaries</span>
<a name="line-2801"></a><span class='hs-comment'>-- But have no effect on the InertCans, or on the inert_flat_cache</span>
<a name="line-2802"></a><span class='hs-comment'>-- (we want to inherit the latter from processing the Givens)</span>
<a name="line-2803"></a><span class='hs-definition'>nestTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2804"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TcSEnv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inerts_var</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2805"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>inerts_var</span>
<a name="line-2806"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inert_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>inerts</span>
<a name="line-2807"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_wl_var</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>emptyWorkList</span>
<a name="line-2808"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nest_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_inerts</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2809"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_wl_var</span> <span class='hs-layout'>}</span>
<a name="line-2810"></a>
<a name="line-2811"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>nest_env</span>
<a name="line-2812"></a>
<a name="line-2813"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>new_inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>new_inert_var</span>
<a name="line-2814"></a>
<a name="line-2815"></a>       <span class='hs-comment'>-- we want to propogate the safe haskell failures</span>
<a name="line-2816"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>old_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>inerts</span>
<a name="line-2817"></a>             <span class='hs-varid'>new_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_cans</span> <span class='hs-varid'>new_inerts</span>
<a name="line-2818"></a>             <span class='hs-varid'>nxt_ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_ic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_safehask</span> <span class='hs-varid'>new_ic</span> <span class='hs-layout'>}</span>
<a name="line-2819"></a>
<a name="line-2820"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>inerts_var</span>  <span class='hs-comment'>-- See Note [Propagate the solved dictionaries]</span>
<a name="line-2821"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>inerts</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inert_solved_dicts</span> <span class='hs-varid'>new_inerts</span>
<a name="line-2822"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>inert_cans</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nxt_ic</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2823"></a>
<a name="line-2824"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-2825"></a>
<a name="line-2826"></a><a name="checkTvConstraintsTcS"></a><span class='hs-definition'>checkTvConstraintsTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-2827"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Skolems</span>
<a name="line-2828"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>)</span>
<a name="line-2829"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>result</span>
<a name="line-2830"></a><span class='hs-comment'>-- Just like TcUnify.checkTvConstraints, but</span>
<a name="line-2831"></a><span class='hs-comment'>--   - In the TcS monnad</span>
<a name="line-2832"></a><span class='hs-comment'>--   - The thing-inside should not put things in the work-list</span>
<a name="line-2833"></a><span class='hs-comment'>--     Instead, it returns the Wanted constraints it needs</span>
<a name="line-2834"></a><span class='hs-comment'>--   - No 'givens', and no TcEvBinds; this is type-level constraints only</span>
<a name="line-2835"></a><span class='hs-definition'>checkTvConstraintsTcS</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2836"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tcs_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2837"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wl_panic</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"TcSMonad.buildImplication"</span> <span class='hs-varop'>$</span>
<a name="line-2838"></a>                         <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2839"></a>                         <span class='hs-comment'>-- This panic checks that the thing-inside</span>
<a name="line-2840"></a>                         <span class='hs-comment'>-- does not emit any work-list constraints</span>
<a name="line-2841"></a>             <span class='hs-varid'>new_tcs_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_panic</span> <span class='hs-layout'>}</span>
<a name="line-2842"></a>
<a name="line-2843"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tclvl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.pushTcLevelM</span> <span class='hs-varop'>$</span>
<a name="line-2844"></a>                                        <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_tcs_env</span>
<a name="line-2845"></a>
<a name="line-2846"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-2847"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newNoTcEvBinds</span>
<a name="line-2848"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newImplication</span>
<a name="line-2849"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanteds</span> <span class='hs-layout'>}</span>
<a name="line-2850"></a>                  <span class='hs-varid'>imp'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tclvl</span>
<a name="line-2851"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2852"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-2853"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2854"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span>
<a name="line-2855"></a>
<a name="line-2856"></a>           <span class='hs-comment'>-- Add the implication to the work-list</span>
<a name="line-2857"></a>           <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_worklist</span> <span class='hs-varid'>tcs_env</span><span class='hs-layout'>)</span>
<a name="line-2858"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListImplic</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>imp'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2859"></a>
<a name="line-2860"></a>      <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res</span> <span class='hs-layout'>}</span>
<a name="line-2861"></a>
<a name="line-2862"></a><a name="checkConstraintsTcS"></a><span class='hs-definition'>checkConstraintsTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-2863"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- Skolems</span>
<a name="line-2864"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Givens</span>
<a name="line-2865"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>Cts</span><span class='hs-layout'>)</span>
<a name="line-2866"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span><span class='hs-layout'>)</span>
<a name="line-2867"></a><span class='hs-comment'>-- Just like checkConstraintsTcS, but</span>
<a name="line-2868"></a><span class='hs-comment'>--   - In the TcS monnad</span>
<a name="line-2869"></a><span class='hs-comment'>--   - The thing-inside should not put things in the work-list</span>
<a name="line-2870"></a><span class='hs-comment'>--     Instead, it returns the Wanted constraints it needs</span>
<a name="line-2871"></a><span class='hs-comment'>--   - I did not bother to put in the fast-path for</span>
<a name="line-2872"></a><span class='hs-comment'>--     empty-skols/empty-givens, or for empty-wanteds, because</span>
<a name="line-2873"></a><span class='hs-comment'>--     this function is used only for "quantified constraints" in</span>
<a name="line-2874"></a><span class='hs-comment'>--     with both tests are pretty much guaranteed to fail</span>
<a name="line-2875"></a><span class='hs-definition'>checkConstraintsTcS</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>given</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2876"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>tcs_env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2877"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wl_panic</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"TcSMonad.buildImplication"</span> <span class='hs-varop'>$</span>
<a name="line-2878"></a>                         <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2879"></a>                         <span class='hs-comment'>-- This panic checks that the thing-inside</span>
<a name="line-2880"></a>                         <span class='hs-comment'>-- does not emit any work-list constraints</span>
<a name="line-2881"></a>             <span class='hs-varid'>new_tcs_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcs_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_worklist</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wl_panic</span> <span class='hs-layout'>}</span>
<a name="line-2882"></a>
<a name="line-2883"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_tclvl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.pushTcLevelM</span> <span class='hs-varop'>$</span>
<a name="line-2884"></a>                                        <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>new_tcs_env</span>
<a name="line-2885"></a>
<a name="line-2886"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-2887"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>imp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newImplication</span>
<a name="line-2888"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_simple</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanteds</span> <span class='hs-layout'>}</span>
<a name="line-2889"></a>             <span class='hs-varid'>imp'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_tclvl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_tclvl</span>
<a name="line-2890"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_skols</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_tvs</span>
<a name="line-2891"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span>
<a name="line-2892"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc</span>
<a name="line-2893"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2894"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ic_info</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>}</span>
<a name="line-2895"></a>
<a name="line-2896"></a>           <span class='hs-comment'>-- Add the implication to the work-list</span>
<a name="line-2897"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_worklist</span> <span class='hs-varid'>tcs_env</span><span class='hs-layout'>)</span>
<a name="line-2898"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListImplic</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>imp'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2899"></a>
<a name="line-2900"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcEvBinds</span> <span class='hs-varid'>ev_binds_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2901"></a>
<a name="line-2902"></a><span class='hs-comment'>{-
<a name="line-2903"></a>Note [Propagate the solved dictionaries]
<a name="line-2904"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2905"></a>It's really quite important that nestTcS does not discard the solved
<a name="line-2906"></a>dictionaries from the thing_inside.
<a name="line-2907"></a>Consider
<a name="line-2908"></a>   Eq [a]
<a name="line-2909"></a>   forall b. empty =&gt;  Eq [a]
<a name="line-2910"></a>We solve the simple (Eq [a]), under nestTcS, and then turn our attention to
<a name="line-2911"></a>the implications.  It's definitely fine to use the solved dictionaries on
<a name="line-2912"></a>the inner implications, and it can make a signficant performance difference
<a name="line-2913"></a>if you do so.
<a name="line-2914"></a>-}</span>
<a name="line-2915"></a>
<a name="line-2916"></a><span class='hs-comment'>-- Getters and setters of TcEnv fields</span>
<a name="line-2917"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-2918"></a>
<a name="line-2919"></a><a name="getTcSInertsRef"></a><span class='hs-comment'>-- Getter of inerts and worklist</span>
<a name="line-2920"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span><span class='hs-layout'>)</span>
<a name="line-2921"></a><span class='hs-definition'>getTcSInertsRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_inerts</span><span class='hs-layout'>)</span>
<a name="line-2922"></a>
<a name="line-2923"></a><a name="getTcSWorkListRef"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span>
<a name="line-2924"></a><span class='hs-definition'>getTcSWorkListRef</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_worklist</span><span class='hs-layout'>)</span>
<a name="line-2925"></a>
<a name="line-2926"></a><a name="getTcSInerts"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InertSet</span>
<a name="line-2927"></a><span class='hs-definition'>getTcSInerts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTcSInertsRef</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span><span class='hs-layout'>)</span>
<a name="line-2928"></a>
<a name="line-2929"></a><a name="setTcSInerts"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2930"></a><span class='hs-definition'>setTcSInerts</span> <span class='hs-varid'>ics</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSInertsRef</span><span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ics</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2931"></a>
<a name="line-2932"></a><a name="getWorkListImplics"></a><span class='hs-definition'>getWorkListImplics</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span><span class='hs-layout'>)</span>
<a name="line-2933"></a><span class='hs-definition'>getWorkListImplics</span>
<a name="line-2934"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-2935"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wl_curr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>wl_var</span><span class='hs-layout'>)</span>
<a name="line-2936"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wl_implics</span> <span class='hs-varid'>wl_curr</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2937"></a>
<a name="line-2938"></a><a name="updWorkListTcS"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>WorkList</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WorkList</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2939"></a><span class='hs-definition'>updWorkListTcS</span> <span class='hs-varid'>f</span>
<a name="line-2940"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wl_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcSWorkListRef</span>
<a name="line-2941"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.updTcRef</span> <span class='hs-varid'>wl_var</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-2942"></a>
<a name="line-2943"></a><a name="emitWorkNC"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2944"></a><span class='hs-definition'>emitWorkNC</span> <span class='hs-varid'>evs</span>
<a name="line-2945"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>evs</span>
<a name="line-2946"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2947"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2948"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitWork</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-2949"></a>
<a name="line-2950"></a><a name="emitWork"></a><span class='hs-definition'>emitWork</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2951"></a><span class='hs-definition'>emitWork</span> <span class='hs-varid'>cts</span>
<a name="line-2952"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting fresh work"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2953"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListCts</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2954"></a>
<a name="line-2955"></a><a name="newTcRef"></a><span class='hs-definition'>newTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2956"></a><span class='hs-definition'>newTcRef</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newTcRef</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-2957"></a>
<a name="line-2958"></a><a name="readTcRef"></a><span class='hs-definition'>readTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span>
<a name="line-2959"></a><span class='hs-definition'>readTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-2960"></a>
<a name="line-2961"></a><a name="updTcRef"></a><span class='hs-definition'>updTcRef</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcRef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>-&gt;</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2962"></a><span class='hs-definition'>updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.updTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>upd_fn</span><span class='hs-layout'>)</span>
<a name="line-2963"></a>
<a name="line-2964"></a><a name="getTcEvBindsVar"></a><span class='hs-definition'>getTcEvBindsVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-2965"></a><span class='hs-definition'>getTcEvBindsVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tcs_ev_binds</span><span class='hs-layout'>)</span>
<a name="line-2966"></a>
<a name="line-2967"></a><a name="getTcLevel"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLevel</span>
<a name="line-2968"></a><span class='hs-definition'>getTcLevel</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.getTcLevel</span>
<a name="line-2969"></a>
<a name="line-2970"></a><a name="getTcEvTyCoVars"></a><span class='hs-definition'>getTcEvTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-2971"></a><span class='hs-definition'>getTcEvTyCoVars</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2972"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getTcEvTyCoVars</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2973"></a>
<a name="line-2974"></a><a name="getTcEvBindsMap"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindMap</span>
<a name="line-2975"></a><span class='hs-definition'>getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2976"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-2977"></a>
<a name="line-2978"></a><a name="setTcEvBindsMap"></a><span class='hs-definition'>setTcEvBindsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvBindMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2979"></a><span class='hs-definition'>setTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>binds</span>
<a name="line-2980"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.setTcEvBindsMap</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>binds</span>
<a name="line-2981"></a>
<a name="line-2982"></a><a name="unifyTyVar"></a><span class='hs-definition'>unifyTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-2983"></a><span class='hs-comment'>-- Unify a meta-tyvar with a type</span>
<a name="line-2984"></a><span class='hs-comment'>-- We keep track of how many unifications have happened in tcs_unified,</span>
<a name="line-2985"></a><span class='hs-comment'>--</span>
<a name="line-2986"></a><span class='hs-comment'>-- We should never unify the same variable twice!</span>
<a name="line-2987"></a><span class='hs-definition'>unifyTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2988"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-2989"></a>    <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2990"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"unifyTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2991"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2992"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_unified</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2993"></a>
<a name="line-2994"></a><a name="reportUnifications"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2995"></a><span class='hs-definition'>reportUnifications</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcS</span> <span class='hs-varid'>thing_inside</span><span class='hs-layout'>)</span>
<a name="line-2996"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2997"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inner_unified</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newTcRef</span> <span class='hs-num'>0</span>
<a name="line-2998"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcs_unified</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inner_unified</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2999"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>n_unifs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>inner_unified</span>
<a name="line-3000"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.updTcRef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcs_unified</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varop'>+</span> <span class='hs-varid'>n_unifs</span><span class='hs-layout'>)</span>
<a name="line-3001"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n_unifs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3002"></a>
<a name="line-3003"></a><a name="getDefaultInfo"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>::</span>  <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3004"></a><span class='hs-definition'>getDefaultInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.tcGetDefaultTys</span>
<a name="line-3005"></a>
<a name="line-3006"></a><span class='hs-comment'>-- Just get some environments needed for instance looking up and matching</span>
<a name="line-3007"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3008"></a>
<a name="line-3009"></a><a name="getInstEnvs"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>InstEnvs</span>
<a name="line-3010"></a><span class='hs-definition'>getInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcGetInstEnvs</span>
<a name="line-3011"></a>
<a name="line-3012"></a><a name="getFamInstEnvs"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>FamInstEnv</span><span class='hs-layout'>)</span>
<a name="line-3013"></a><span class='hs-definition'>getFamInstEnvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FamInst.tcGetFamInstEnvs</span>
<a name="line-3014"></a>
<a name="line-3015"></a><a name="getTopEnv"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>HscEnv</span>
<a name="line-3016"></a><span class='hs-definition'>getTopEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getTopEnv</span>
<a name="line-3017"></a>
<a name="line-3018"></a><a name="getGblEnv"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-3019"></a><span class='hs-definition'>getGblEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getGblEnv</span>
<a name="line-3020"></a>
<a name="line-3021"></a><a name="getLclEnv"></a><span class='hs-definition'>getLclEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcLclEnv</span>
<a name="line-3022"></a><span class='hs-definition'>getLclEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.getLclEnv</span>
<a name="line-3023"></a>
<a name="line-3024"></a><a name="tcLookupClass"></a><span class='hs-definition'>tcLookupClass</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Class</span>
<a name="line-3025"></a><span class='hs-definition'>tcLookupClass</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcLookupClass</span> <span class='hs-varid'>c</span>
<a name="line-3026"></a>
<a name="line-3027"></a><a name="tcLookupId"></a><span class='hs-definition'>tcLookupId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Id</span>
<a name="line-3028"></a><span class='hs-definition'>tcLookupId</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcLookupId</span> <span class='hs-varid'>n</span>
<a name="line-3029"></a>
<a name="line-3030"></a><a name="addUsedGREs"></a><span class='hs-comment'>-- Setting names as used (used in the deriving of Coercible evidence)</span>
<a name="line-3031"></a><span class='hs-comment'>-- Too hackish to expose it to TcS? In that case somehow extract the used</span>
<a name="line-3032"></a><span class='hs-comment'>-- constructors from the result of solveInteract</span>
<a name="line-3033"></a><span class='hs-definition'>addUsedGREs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>GlobalRdrElt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3034"></a><span class='hs-definition'>addUsedGREs</span> <span class='hs-varid'>gres</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span>  <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.addUsedGREs</span> <span class='hs-varid'>gres</span>
<a name="line-3035"></a>
<a name="line-3036"></a><a name="addUsedGRE"></a><span class='hs-definition'>addUsedGRE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GlobalRdrElt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3037"></a><span class='hs-definition'>addUsedGRE</span> <span class='hs-varid'>warn_if_deprec</span> <span class='hs-varid'>gre</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.addUsedGRE</span> <span class='hs-varid'>warn_if_deprec</span> <span class='hs-varid'>gre</span>
<a name="line-3038"></a>
<a name="line-3039"></a>
<a name="line-3040"></a><span class='hs-comment'>-- Various smaller utilities [TODO, maybe will be absorbed in the instance matcher]</span>
<a name="line-3041"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3042"></a>
<a name="line-3043"></a><a name="checkWellStagedDFun"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3044"></a><span class='hs-definition'>checkWellStagedDFun</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>loc</span>
<a name="line-3045"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.setCtLocM</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-3046"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>use_stage</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.getStage</span>
<a name="line-3047"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.checkWellStaged</span> <span class='hs-varid'>pp_thing</span> <span class='hs-varid'>bind_lvl</span> <span class='hs-layout'>(</span><span class='hs-varid'>thLevel</span> <span class='hs-varid'>use_stage</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3048"></a>  <span class='hs-keyword'>where</span>
<a name="line-3049"></a>    <span class='hs-varid'>pp_thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"instance for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-3050"></a>    <span class='hs-varid'>bind_lvl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM.topIdLvl</span> <span class='hs-varid'>dfun_id</span>
<a name="line-3051"></a>
<a name="line-3052"></a><a name="pprEq"></a><span class='hs-definition'>pprEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3053"></a><span class='hs-definition'>pprEq</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'~'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>ty2</span>
<a name="line-3054"></a>
<a name="line-3055"></a><a name="isFilledMetaTyVar_maybe"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-3056"></a><span class='hs-definition'>isFilledMetaTyVar_maybe</span> <span class='hs-varid'>tv</span>
<a name="line-3057"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-3058"></a>     <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mtv_ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>}</span>
<a name="line-3059"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span><span class='hs-layout'>)</span>
<a name="line-3060"></a>              <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cts</span> <span class='hs-keyword'>of</span>
<a name="line-3061"></a>                  <span class='hs-conid'>Indirect</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3062"></a>                  <span class='hs-conid'>Flexi</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-3063"></a>     <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-3064"></a>
<a name="line-3065"></a><a name="isFilledMetaTyVar"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Bool</span>
<a name="line-3066"></a><span class='hs-definition'>isFilledMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.isFilledMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3067"></a>
<a name="line-3068"></a><a name="zonkTyCoVarsAndFV"></a><span class='hs-definition'>zonkTyCoVarsAndFV</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyCoVarSet</span>
<a name="line-3069"></a><span class='hs-definition'>zonkTyCoVarsAndFV</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTyCoVarsAndFV</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3070"></a>
<a name="line-3071"></a><a name="zonkTyCoVarsAndFVList"></a><span class='hs-definition'>zonkTyCoVarsAndFVList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3072"></a><span class='hs-definition'>zonkTyCoVarsAndFVList</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTyCoVarsAndFVList</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3073"></a>
<a name="line-3074"></a><a name="zonkCo"></a><span class='hs-definition'>zonkCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Coercion</span>
<a name="line-3075"></a><span class='hs-definition'>zonkCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>.</span> <span class='hs-conid'>TcM.zonkCo</span>
<a name="line-3076"></a>
<a name="line-3077"></a><a name="zonkTcType"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-3078"></a><span class='hs-definition'>zonkTcType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTcType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3079"></a>
<a name="line-3080"></a><a name="zonkTcTypes"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>
<a name="line-3081"></a><span class='hs-definition'>zonkTcTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTcTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3082"></a>
<a name="line-3083"></a><a name="zonkTcTyVar"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-3084"></a><span class='hs-definition'>zonkTcTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3085"></a>
<a name="line-3086"></a><a name="zonkSimples"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Cts</span>
<a name="line-3087"></a><span class='hs-definition'>zonkSimples</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkSimples</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-3088"></a>
<a name="line-3089"></a><a name="zonkWC"></a><span class='hs-definition'>zonkWC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-3090"></a><span class='hs-definition'>zonkWC</span> <span class='hs-varid'>wc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkWC</span> <span class='hs-varid'>wc</span><span class='hs-layout'>)</span>
<a name="line-3091"></a>
<a name="line-3092"></a><a name="zonkTcTyCoVarBndr"></a><span class='hs-definition'>zonkTcTyCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyCoVar</span>
<a name="line-3093"></a><span class='hs-definition'>zonkTcTyCoVarBndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.zonkTcTyCoVarBndr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3094"></a>
<a name="line-3095"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-3096"></a>*                                                                      *
<a name="line-3097"></a>*                Flatten skolems                                       *
<a name="line-3098"></a>*                                                                      *
<a name="line-3099"></a>********************************************************************* -}</span>
<a name="line-3100"></a>
<a name="line-3101"></a><a name="newFlattenSkolem"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span>
<a name="line-3102"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>                    <span class='hs-comment'>-- F xis</span>
<a name="line-3103"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- [G/WD] x:: F xis ~ fsk</span>
<a name="line-3104"></a><span class='hs-definition'>newFlattenSkolem</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span>
<a name="line-3105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>new_skolem</span>
<a name="line-3106"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fsk_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span>
<a name="line-3107"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>extendFlatCache</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsk_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctEvFlavour</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3108"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span>
<a name="line-3109"></a>  <span class='hs-keyword'>where</span>
<a name="line-3110"></a>    <span class='hs-varid'>fam_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xis</span>
<a name="line-3111"></a>
<a name="line-3112"></a>    <span class='hs-varid'>new_skolem</span>
<a name="line-3113"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Given</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>flav</span>
<a name="line-3114"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fsk</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newFskTyVar</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-3115"></a>
<a name="line-3116"></a>           <span class='hs-comment'>-- Extend the inert_fsks list, for use by unflattenGivens</span>
<a name="line-3117"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>is</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>inert_fsks</span> <span class='hs-varid'>is</span> <span class='hs-layout'>}</span>
<a name="line-3118"></a>
<a name="line-3119"></a>           <span class='hs-comment'>-- Construct the Refl evidence</span>
<a name="line-3120"></a>           <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span> <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span>
<a name="line-3121"></a>                 <span class='hs-varid'>co</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>fam_ty</span>
<a name="line-3122"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>ev</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>evCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3123"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3124"></a>
<a name="line-3125"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-comment'>-- Generate a [WD] for both Wanted and Derived</span>
<a name="line-3126"></a>                   <span class='hs-comment'>-- See Note [No Derived CFunEqCans]</span>
<a name="line-3127"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fmv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newFmvTyVar</span> <span class='hs-varid'>fam_ty</span><span class='hs-layout'>)</span>
<a name="line-3128"></a>           <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>hole_co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>fam_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span>
<a name="line-3129"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>hole_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3130"></a>
<a name="line-3131"></a><a name="unflattenGivens"></a><span class='hs-comment'>----------------------------</span>
<a name="line-3132"></a><span class='hs-definition'>unflattenGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>InertSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3133"></a><span class='hs-comment'>-- Unflatten all the fsks created by flattening types in Given</span>
<a name="line-3134"></a><span class='hs-comment'>-- constraints. We must be sure to do this, else we end up with</span>
<a name="line-3135"></a><span class='hs-comment'>-- flatten-skolems buried in any residual Wanteds</span>
<a name="line-3136"></a><span class='hs-comment'>--</span>
<a name="line-3137"></a><span class='hs-comment'>-- NB: this is the /only/ way that a fsk (MetaDetails = FlatSkolTv)</span>
<a name="line-3138"></a><span class='hs-comment'>--     is filled in. Nothing else does so.</span>
<a name="line-3139"></a><span class='hs-comment'>--</span>
<a name="line-3140"></a><span class='hs-comment'>-- It's here (rather than in TcFlatten) because the Right Places</span>
<a name="line-3141"></a><span class='hs-comment'>-- to call it are in runTcSWithEvBinds/nestImplicTcS, where it</span>
<a name="line-3142"></a><span class='hs-comment'>-- is nicely paired with the creation an empty inert_fsks list.</span>
<a name="line-3143"></a><span class='hs-definition'>unflattenGivens</span> <span class='hs-varid'>inert_var</span>
<a name="line-3144"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inerts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>inert_var</span>
<a name="line-3145"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"unflattenGivens"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_fsks</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3146"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>flatten_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>inert_fsks</span> <span class='hs-varid'>inerts</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3147"></a>  <span class='hs-keyword'>where</span>
<a name="line-3148"></a>    <span class='hs-varid'>flatten_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsk</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcM.writeMetaTyVar</span> <span class='hs-varid'>fsk</span> <span class='hs-varid'>ty</span>
<a name="line-3149"></a>
<a name="line-3150"></a><a name="extendFlatCache"></a><span class='hs-comment'>----------------------------</span>
<a name="line-3151"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcCoercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtFlavour</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3152"></a><span class='hs-definition'>extendFlatCache</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>fl</span><span class='hs-layout'>)</span>
<a name="line-3153"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGivenOrWDeriv</span> <span class='hs-varid'>fl</span>  <span class='hs-comment'>-- Maintain the invariant that inert_flat_cache</span>
<a name="line-3154"></a>                        <span class='hs-comment'>-- only has [G] and [WD] CFunEqCans</span>
<a name="line-3155"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-3156"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_FlatCache</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-3157"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"extendFlatCache"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>xi_args</span>
<a name="line-3158"></a>                                          <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fl</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3159"></a>            <span class='hs-comment'>-- 'co' can be bottom, in the case of derived items</span>
<a name="line-3160"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updInertTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>is</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>IS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3161"></a>            <span class='hs-varid'>is</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inert_flat_cache</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insertExactFunEq</span> <span class='hs-varid'>fc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>xi_args</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3162"></a>
<a name="line-3163"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3164"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3165"></a>
<a name="line-3166"></a><a name="unflattenFmv"></a><span class='hs-comment'>----------------------------</span>
<a name="line-3167"></a><span class='hs-definition'>unflattenFmv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3168"></a><span class='hs-comment'>-- Fill a flatten-meta-var, simply by unifying it.</span>
<a name="line-3169"></a><span class='hs-comment'>-- This does NOT count as a unification in tcs_unified.</span>
<a name="line-3170"></a><span class='hs-definition'>unflattenFmv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-3171"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-3172"></a>    <span class='hs-conid'>TcS</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3173"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"unflattenFmv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>":="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3174"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-3175"></a>
<a name="line-3176"></a><a name="demoteUnfilledFmv"></a><span class='hs-comment'>----------------------------</span>
<a name="line-3177"></a><span class='hs-definition'>demoteUnfilledFmv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3178"></a><span class='hs-comment'>-- If a flatten-meta-var is still un-filled,</span>
<a name="line-3179"></a><span class='hs-comment'>-- turn it into an ordinary meta-var</span>
<a name="line-3180"></a><span class='hs-definition'>demoteUnfilledFmv</span> <span class='hs-varid'>fmv</span>
<a name="line-3181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>is_filled</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.isFilledMetaTyVar</span> <span class='hs-varid'>fmv</span>
<a name="line-3182"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>is_filled</span> <span class='hs-varop'>$</span>
<a name="line-3183"></a>                   <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tv_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newFlexiTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span>
<a name="line-3184"></a>                      <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeMetaTyVar</span> <span class='hs-varid'>fmv</span> <span class='hs-varid'>tv_ty</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3185"></a>
<a name="line-3186"></a><a name="dischargeFunEq"></a><span class='hs-comment'>-----------------------------</span>
<a name="line-3187"></a><span class='hs-definition'>dischargeFunEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3188"></a><span class='hs-comment'>-- (dischargeFunEqCan ev tv co ty)</span>
<a name="line-3189"></a><span class='hs-comment'>--     Preconditions</span>
<a name="line-3190"></a><span class='hs-comment'>--       - ev :: F tys ~ tv   is a CFunEqCan</span>
<a name="line-3191"></a><span class='hs-comment'>--       - tv is a FlatMetaTv of FlatSkolTv</span>
<a name="line-3192"></a><span class='hs-comment'>--       - co :: F tys ~ xi</span>
<a name="line-3193"></a><span class='hs-comment'>--       - fmv/fsk `notElem` xi</span>
<a name="line-3194"></a><span class='hs-comment'>--       - fmv not filled (for Wanteds)</span>
<a name="line-3195"></a><span class='hs-comment'>--</span>
<a name="line-3196"></a><span class='hs-comment'>-- Then for [W] or [WD], we actually fill in the fmv:</span>
<a name="line-3197"></a><span class='hs-comment'>--      set fmv := xi,</span>
<a name="line-3198"></a><span class='hs-comment'>--      set ev  := co</span>
<a name="line-3199"></a><span class='hs-comment'>--      kick out any inert things that are now rewritable</span>
<a name="line-3200"></a><span class='hs-comment'>--</span>
<a name="line-3201"></a><span class='hs-comment'>-- For [D], we instead emit an equality that must ultimately hold</span>
<a name="line-3202"></a><span class='hs-comment'>--      [D] xi ~ fmv</span>
<a name="line-3203"></a><span class='hs-comment'>--      Does not evaluate 'co' if 'ev' is Derived</span>
<a name="line-3204"></a><span class='hs-comment'>--</span>
<a name="line-3205"></a><span class='hs-comment'>-- For [G], emit this equality</span>
<a name="line-3206"></a><span class='hs-comment'>--     [G] (sym ev; co) :: fsk ~ xi</span>
<a name="line-3207"></a>
<a name="line-3208"></a><span class='hs-comment'>-- See TcFlatten Note [The flattening story],</span>
<a name="line-3209"></a><span class='hs-comment'>-- especially "Ownership of fsk/fmv"</span>
<a name="line-3210"></a><span class='hs-definition'>dischargeFunEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_evar</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>fsk</span> <span class='hs-varid'>co</span> <span class='hs-varid'>xi</span>
<a name="line-3211"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span> <span class='hs-varid'>new_pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>evCoercion</span> <span class='hs-varid'>new_co</span>  <span class='hs-layout'>)</span>
<a name="line-3212"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitWorkNC</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>new_ev</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-3213"></a>  <span class='hs-keyword'>where</span>
<a name="line-3214"></a>    <span class='hs-varid'>new_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fsk</span><span class='hs-layout'>)</span> <span class='hs-varid'>xi</span>
<a name="line-3215"></a>    <span class='hs-varid'>new_co</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>old_evar</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkTcTransCo`</span> <span class='hs-varid'>co</span>
<a name="line-3216"></a>
<a name="line-3217"></a><span class='hs-definition'>dischargeFunEq</span> <span class='hs-varid'>ev</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>fmv</span> <span class='hs-varid'>co</span> <span class='hs-varid'>xi</span>
<a name="line-3218"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>xi</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fmv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>)</span>
<a name="line-3219"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>setWantedEvTerm</span> <span class='hs-varid'>dest</span> <span class='hs-layout'>(</span><span class='hs-varid'>evCoercion</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3220"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>unflattenFmv</span> <span class='hs-varid'>fmv</span> <span class='hs-varid'>xi</span>
<a name="line-3221"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>n_kicked</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kickOutAfterUnification</span> <span class='hs-varid'>fmv</span>
<a name="line-3222"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"dischargeFmv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fmv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>xi</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprKicked</span> <span class='hs-varid'>n_kicked</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3223"></a>
<a name="line-3224"></a><span class='hs-definition'>dischargeFunEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>fmv</span> <span class='hs-sel'>_co</span> <span class='hs-varid'>xi</span>
<a name="line-3225"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emitNewDerivedEq</span> <span class='hs-varid'>loc</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>xi</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>fmv</span><span class='hs-layout'>)</span>
<a name="line-3226"></a>              <span class='hs-comment'>-- FunEqs are always at Nominal role</span>
<a name="line-3227"></a>
<a name="line-3228"></a><a name="pprKicked"></a><span class='hs-definition'>pprKicked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3229"></a><span class='hs-definition'>pprKicked</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-3230"></a><span class='hs-definition'>pprKicked</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kicked out"</span><span class='hs-layout'>)</span>
<a name="line-3231"></a>
<a name="line-3232"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-3233"></a>*                                                                      *
<a name="line-3234"></a>*                Instantiation etc.
<a name="line-3235"></a>*                                                                      *
<a name="line-3236"></a>********************************************************************* -}</span>
<a name="line-3237"></a>
<a name="line-3238"></a><span class='hs-comment'>-- Instantiations</span>
<a name="line-3239"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3240"></a>
<a name="line-3241"></a><a name="instDFunType"></a><span class='hs-definition'>instDFunType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DFunId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DFunInstType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>)</span>
<a name="line-3242"></a><span class='hs-definition'>instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>inst_tys</span>
<a name="line-3243"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.instDFunType</span> <span class='hs-varid'>dfun_id</span> <span class='hs-varid'>inst_tys</span>
<a name="line-3244"></a>
<a name="line-3245"></a><a name="newFlexiTcSTy"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcType</span>
<a name="line-3246"></a><span class='hs-definition'>newFlexiTcSTy</span> <span class='hs-varid'>knd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newFlexiTyVarTy</span> <span class='hs-varid'>knd</span><span class='hs-layout'>)</span>
<a name="line-3247"></a>
<a name="line-3248"></a><a name="cloneMetaTyVar"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-3249"></a><span class='hs-definition'>cloneMetaTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.cloneMetaTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3250"></a>
<a name="line-3251"></a><a name="instFlexi"></a><span class='hs-definition'>instFlexi</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-3252"></a><span class='hs-definition'>instFlexi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>instFlexiX</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-3253"></a>
<a name="line-3254"></a><a name="instFlexiX"></a><span class='hs-definition'>instFlexiX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TKVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-3255"></a><span class='hs-definition'>instFlexiX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-3256"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldlM</span> <span class='hs-varid'>instFlexiHelper</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3257"></a>
<a name="line-3258"></a><a name="instFlexiHelper"></a><span class='hs-definition'>instFlexiHelper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TKVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-3259"></a><span class='hs-definition'>instFlexiHelper</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3260"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newUnique</span>
<a name="line-3261"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-3262"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNameUnique</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>uniq</span>
<a name="line-3263"></a>             <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3264"></a>             <span class='hs-varid'>ty'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-3265"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"instFlexi"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-3266"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3267"></a>
<a name="line-3268"></a><a name="tcInstType"></a><span class='hs-definition'>tcInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3269"></a>                   <span class='hs-comment'>-- ^ How to instantiate the type variables</span>
<a name="line-3270"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Id</span>   <span class='hs-comment'>-- ^ Type to instantiate</span>
<a name="line-3271"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Result</span>
<a name="line-3272"></a>                <span class='hs-comment'>-- (type vars, preds (incl equalities), rho)</span>
<a name="line-3273"></a><span class='hs-definition'>tcInstType</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.tcInstType</span> <span class='hs-varid'>inst_tyvars</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-3274"></a>
<a name="line-3275"></a><a name="tcInstSkolTyVarsX"></a><span class='hs-definition'>tcInstSkolTyVarsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3276"></a><span class='hs-definition'>tcInstSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.tcInstSkolTyVarsX</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span>
<a name="line-3277"></a>
<a name="line-3278"></a><span class='hs-comment'>-- Creating and setting evidence variables and CtFlavors</span>
<a name="line-3279"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-3280"></a>
<a name="line-3281"></a><a name="MaybeNew"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Cached</span> <span class='hs-conid'>EvExpr</span>
<a name="line-3282"></a>
<a name="line-3283"></a><a name="isFresh"></a><span class='hs-definition'>isFresh</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3284"></a><span class='hs-definition'>isFresh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3285"></a><span class='hs-definition'>isFresh</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3286"></a>
<a name="line-3287"></a><a name="freshGoals"></a><span class='hs-definition'>freshGoals</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MaybeNew</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-3288"></a><span class='hs-definition'>freshGoals</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mns</span> <span class='hs-keyglyph'>]</span>
<a name="line-3289"></a>
<a name="line-3290"></a><a name="getEvExpr"></a><span class='hs-definition'>getEvExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MaybeNew</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvExpr</span>
<a name="line-3291"></a><span class='hs-definition'>getEvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctEvExpr</span> <span class='hs-varid'>ctev</span>
<a name="line-3292"></a><span class='hs-definition'>getEvExpr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Cached</span> <span class='hs-varid'>evt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evt</span>
<a name="line-3293"></a>
<a name="line-3294"></a><a name="setEvBind"></a><span class='hs-definition'>setEvBind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3295"></a><span class='hs-definition'>setEvBind</span> <span class='hs-varid'>ev_bind</span>
<a name="line-3296"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-3297"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.addTcEvBind</span> <span class='hs-varid'>evb</span> <span class='hs-varid'>ev_bind</span> <span class='hs-layout'>}</span>
<a name="line-3298"></a>
<a name="line-3299"></a><a name="useVars"></a><span class='hs-comment'>-- | Mark variables as used filling a coercion hole</span>
<a name="line-3300"></a><span class='hs-definition'>useVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3301"></a><span class='hs-definition'>useVars</span> <span class='hs-varid'>vars</span>
<a name="line-3302"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcEvBindsVar</span>
<a name="line-3303"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ebv_tcvs</span> <span class='hs-varid'>ev_binds_var</span>
<a name="line-3304"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span>
<a name="line-3305"></a>         <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>TcM.readTcRef</span> <span class='hs-varid'>ref</span>
<a name="line-3306"></a>            <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tcvs'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcvs</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>vars</span>
<a name="line-3307"></a>            <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.writeTcRef</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>tcvs'</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3308"></a>
<a name="line-3309"></a><a name="setWantedEq"></a><span class='hs-comment'>-- | Equalities only</span>
<a name="line-3310"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvDest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3311"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-3312"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>useVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3313"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3314"></a><span class='hs-definition'>setWantedEq</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"setWantedEq"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3315"></a>
<a name="line-3316"></a><a name="setWantedEvTerm"></a><span class='hs-comment'>-- | Good for both equalities and non-equalities</span>
<a name="line-3317"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcEvDest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3318"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span>
<a name="line-3319"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evTermCoercion_maybe</span> <span class='hs-varid'>tm</span>
<a name="line-3320"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>useVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3321"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3322"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3323"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>hole</span>
<a name="line-3324"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWantedEvBind</span> <span class='hs-varid'>co_var</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-3325"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.fillCoercionHole</span> <span class='hs-varid'>hole</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcCoVarCo</span> <span class='hs-varid'>co_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3326"></a>
<a name="line-3327"></a><span class='hs-definition'>setWantedEvTerm</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>ev_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>tm</span>
<a name="line-3328"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkWantedEvBind</span> <span class='hs-varid'>ev_id</span> <span class='hs-varid'>tm</span><span class='hs-layout'>)</span>
<a name="line-3329"></a>
<a name="line-3330"></a><a name="setEvBindIfWanted"></a><span class='hs-definition'>setEvBindIfWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3331"></a><span class='hs-definition'>setEvBindIfWanted</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>tm</span>
<a name="line-3332"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ev</span> <span class='hs-keyword'>of</span>
<a name="line-3333"></a>      <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dest</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>setWantedEvTerm</span> <span class='hs-varid'>dest</span> <span class='hs-varid'>tm</span>
<a name="line-3334"></a>      <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3335"></a>
<a name="line-3336"></a><a name="newTcEvBinds"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3337"></a><span class='hs-definition'>newTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.newTcEvBinds</span>
<a name="line-3338"></a>
<a name="line-3339"></a><a name="newNoTcEvBinds"></a><span class='hs-definition'>newNoTcEvBinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvBindsVar</span>
<a name="line-3340"></a><span class='hs-definition'>newNoTcEvBinds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-conid'>TcM.newNoTcEvBinds</span>
<a name="line-3341"></a>
<a name="line-3342"></a><a name="newEvVar"></a><span class='hs-definition'>newEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-3343"></a><span class='hs-definition'>newEvVar</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcM.newEvVar</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-3344"></a>
<a name="line-3345"></a><a name="newGivenEvVar"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3346"></a><span class='hs-comment'>-- Make a new variable of the given PredType,</span>
<a name="line-3347"></a><span class='hs-comment'>-- immediately bind it to the given term</span>
<a name="line-3348"></a><span class='hs-comment'>-- and return its CtEvidence</span>
<a name="line-3349"></a><span class='hs-comment'>-- See Note [Bind new Givens immediately] in TcRnTypes</span>
<a name="line-3350"></a><span class='hs-definition'>newGivenEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-3351"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newBoundEvVarId</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>rhs</span>
<a name="line-3352"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtGiven</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3353"></a>
<a name="line-3354"></a><a name="newBoundEvVarId"></a><span class='hs-comment'>-- | Make a new 'Id' of the given type, bound (in the monad's EvBinds) to the</span>
<a name="line-3355"></a><span class='hs-comment'>-- given term</span>
<a name="line-3356"></a><span class='hs-definition'>newBoundEvVarId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>EvTerm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>EvVar</span>
<a name="line-3357"></a><span class='hs-definition'>newBoundEvVarId</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>rhs</span>
<a name="line-3358"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pred</span>
<a name="line-3359"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setEvBind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkGivenEvBind</span> <span class='hs-varid'>new_ev</span> <span class='hs-varid'>rhs</span><span class='hs-layout'>)</span>
<a name="line-3360"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>new_ev</span> <span class='hs-layout'>}</span>
<a name="line-3361"></a>
<a name="line-3362"></a><a name="newGivenEvVars"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcPredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvTerm</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CtEvidence</span><span class='hs-keyglyph'>]</span>
<a name="line-3363"></a><span class='hs-definition'>newGivenEvVars</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newGivenEvVar</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>pts</span>
<a name="line-3364"></a>
<a name="line-3365"></a><a name="emitNewWantedEq"></a><span class='hs-definition'>emitNewWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>Coercion</span>
<a name="line-3366"></a><span class='hs-comment'>-- | Emit a new Wanted equality into the work-list</span>
<a name="line-3367"></a><span class='hs-definition'>emitNewWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3368"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3369"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3370"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-varop'>$</span>
<a name="line-3371"></a>         <span class='hs-varid'>extendWorkListEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-3372"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>co</span> <span class='hs-layout'>}</span>
<a name="line-3373"></a>
<a name="line-3374"></a><a name="newWantedEq"></a><span class='hs-comment'>-- | Make a new equality CtEvidence</span>
<a name="line-3375"></a><span class='hs-definition'>newWantedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtEvidence</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-3376"></a><span class='hs-definition'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3377"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hole</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TcM.newCoercionHole</span> <span class='hs-varid'>pty</span>
<a name="line-3378"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new coercion hole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hole</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pty</span><span class='hs-layout'>)</span>
<a name="line-3379"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleDest</span> <span class='hs-varid'>hole</span>
<a name="line-3380"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span>
<a name="line-3381"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>}</span>
<a name="line-3382"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>mkHoleCo</span> <span class='hs-varid'>hole</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3383"></a>  <span class='hs-keyword'>where</span>
<a name="line-3384"></a>    <span class='hs-varid'>pty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPredRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3385"></a>
<a name="line-3386"></a><a name="newWantedEvVarNC"></a><span class='hs-comment'>-- no equalities here. Use newWantedEq instead</span>
<a name="line-3387"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3388"></a><span class='hs-comment'>-- Don't look up in the solved/inerts; we know it's not there</span>
<a name="line-3389"></a><span class='hs-definition'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3390"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>new_ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEvVar</span> <span class='hs-varid'>pty</span>
<a name="line-3391"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new wanted"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>new_ev</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pty</span> <span class='hs-varop'>$$</span>
<a name="line-3392"></a>                                         <span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-3393"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtWanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvVarDest</span> <span class='hs-varid'>new_ev</span>
<a name="line-3394"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_nosh</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WDeriv</span>
<a name="line-3395"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>}</span>
<a name="line-3396"></a>
<a name="line-3397"></a><a name="newWantedEvVar"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-3398"></a><span class='hs-comment'>-- For anything except ClassPred, this is the same as newWantedEvVarNC</span>
<a name="line-3399"></a><span class='hs-definition'>newWantedEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3400"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupInInerts</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3401"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ct</span> <span class='hs-keyword'>of</span>
<a name="line-3402"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>ctev</span>
<a name="line-3403"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDerived</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span>
<a name="line-3404"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"newWantedEvVar/cache hit"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ctev</span>
<a name="line-3405"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Cached</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctEvExpr</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3406"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3407"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fresh</span> <span class='hs-varid'>ctev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-3408"></a>
<a name="line-3409"></a><a name="newWanted"></a><span class='hs-comment'>-- deals with both equalities and non equalities. Tries to look</span>
<a name="line-3410"></a><span class='hs-comment'>-- up non-equalities in the cache</span>
<a name="line-3411"></a><span class='hs-definition'>newWanted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>MaybeNew</span>
<a name="line-3412"></a><span class='hs-definition'>newWanted</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3413"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pty</span>
<a name="line-3414"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Fresh</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3415"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3416"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVar</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3417"></a>
<a name="line-3418"></a><a name="newWantedNC"></a><span class='hs-comment'>-- deals with both equalities and non equalities. Doesn't do any cache lookups.</span>
<a name="line-3419"></a><span class='hs-definition'>newWantedNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3420"></a><span class='hs-definition'>newWantedNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3421"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getEqPredTys_maybe</span> <span class='hs-varid'>pty</span>
<a name="line-3422"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newWantedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3423"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3424"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newWantedEvVarNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pty</span>
<a name="line-3425"></a>
<a name="line-3426"></a><a name="emitNewDeriveds"></a><span class='hs-definition'>emitNewDeriveds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcPredType</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3427"></a><span class='hs-definition'>emitNewDeriveds</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>preds</span>
<a name="line-3428"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>preds</span>
<a name="line-3429"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-3430"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3431"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>evs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>newDerivedNC</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>preds</span>
<a name="line-3432"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new deriveds"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span>
<a name="line-3433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListDeriveds</span> <span class='hs-varid'>evs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3434"></a>
<a name="line-3435"></a><a name="emitNewDerivedEq"></a><span class='hs-definition'>emitNewDerivedEq</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3436"></a><span class='hs-comment'>-- Create new equality Derived and put it in the work list</span>
<a name="line-3437"></a><span class='hs-comment'>-- There's no caching, no lookupInInerts</span>
<a name="line-3438"></a><span class='hs-definition'>emitNewDerivedEq</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-3439"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newDerivedNC</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPrimEqPredRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-3440"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTcS</span> <span class='hs-str'>"Emitting new derived equality"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprCtLoc</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-3441"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>updWorkListTcS</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendWorkListEq</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNonCanonical</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3442"></a>         <span class='hs-comment'>-- Very important: put in the wl_eqs</span>
<a name="line-3443"></a>         <span class='hs-comment'>-- See Note [Prioritise equalities] (Avoiding fundep iteration)</span>
<a name="line-3444"></a>
<a name="line-3445"></a><a name="newDerivedNC"></a><span class='hs-definition'>newDerivedNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcPredType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>CtEvidence</span>
<a name="line-3446"></a><span class='hs-definition'>newDerivedNC</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>pred</span>
<a name="line-3447"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- checkReductionDepth loc pred</span>
<a name="line-3448"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtDerived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3449"></a>
<a name="line-3450"></a><a name="checkReductionDepth"></a><span class='hs-comment'>-- --------- Check done in TcInteract.selectNewWorkItem???? ---------</span>
<a name="line-3451"></a><span class='hs-comment'>-- | Checks if the depth of the given location is too much. Fails if</span>
<a name="line-3452"></a><span class='hs-comment'>-- it's too big, with an appropriate error message.</span>
<a name="line-3453"></a><span class='hs-definition'>checkReductionDepth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>   <span class='hs-comment'>-- ^ type being reduced</span>
<a name="line-3454"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-conid'>()</span>
<a name="line-3455"></a><span class='hs-definition'>checkReductionDepth</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span>
<a name="line-3456"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-3457"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>subGoalDepthExceeded</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocDepth</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-3458"></a>         <span class='hs-varid'>wrapErrTcS</span> <span class='hs-varop'>$</span>
<a name="line-3459"></a>         <span class='hs-varid'>solverDepthErrorTcS</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-3460"></a>
<a name="line-3461"></a><a name="matchFam"></a><span class='hs-definition'>matchFam</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcS</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3462"></a><span class='hs-definition'>matchFam</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wrapTcS</span> <span class='hs-varop'>$</span> <span class='hs-varid'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3463"></a>
<a name="line-3464"></a><a name="matchFamTcM"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3465"></a><span class='hs-comment'>-- Given (F tys) return (ty, co), where co :: F tys ~ ty</span>
<a name="line-3466"></a><span class='hs-definition'>matchFamTcM</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3467"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fam_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>FamInst.tcGetFamInstEnvs</span>
<a name="line-3468"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>match_fam_result</span>
<a name="line-3469"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reduceTyFamApp_maybe</span> <span class='hs-varid'>fam_envs</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3470"></a>       <span class='hs-layout'>;</span> <span class='hs-conid'>TcM.traceTc</span> <span class='hs-str'>"matchFamTcM"</span> <span class='hs-varop'>$</span>
<a name="line-3471"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Matching:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-3472"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr_res</span> <span class='hs-varid'>match_fam_result</span> <span class='hs-keyglyph'>]</span>
<a name="line-3473"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>match_fam_result</span> <span class='hs-layout'>}</span>
<a name="line-3474"></a>  <span class='hs-keyword'>where</span>
<a name="line-3475"></a>    <span class='hs-varid'>ppr_res</span> <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Match failed"</span>
<a name="line-3476"></a>    <span class='hs-varid'>ppr_res</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Match succeeded:"</span><span class='hs-layout'>)</span>
<a name="line-3477"></a>                                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Rewrites to:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-3478"></a>                                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Coercion:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3479"></a>
<a name="line-3480"></a><span class='hs-comment'>{-
<a name="line-3481"></a>Note [Residual implications]
<a name="line-3482"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3483"></a>The wl_implics in the WorkList are the residual implication
<a name="line-3484"></a>constraints that are generated while solving or canonicalising the
<a name="line-3485"></a>current worklist.  Specifically, when canonicalising
<a name="line-3486"></a>   (forall a. t1 ~ forall a. t2)
<a name="line-3487"></a>from which we get the implication
<a name="line-3488"></a>   (forall a. t1 ~ t2)
<a name="line-3489"></a>See TcSMonad.deferTcSForAllEq
<a name="line-3490"></a>-}</span>
</pre></body>
</html>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>types/TyCoRep.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-
<a name="line-2"></a>(c) The University of Glasgow 2006
<a name="line-3"></a>(c) The GRASP/AQUA Project, Glasgow University, 1998
<a name="line-4"></a>\section[TyCoRep]{Type and Coercion - friends' interface}
<a name="line-5"></a>
<a name="line-6"></a>Note [The Type-related module hierarchy]
<a name="line-7"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-8"></a>  Class
<a name="line-9"></a>  CoAxiom
<a name="line-10"></a>  TyCon    imports Class, CoAxiom
<a name="line-11"></a>  TyCoRep  imports Class, CoAxiom, TyCon
<a name="line-12"></a>  TysPrim  imports TyCoRep ( including mkTyConTy )
<a name="line-13"></a>  Kind     imports TysPrim ( mainly for primitive kinds )
<a name="line-14"></a>  Type     imports Kind
<a name="line-15"></a>  Coercion imports Type
<a name="line-16"></a>-}</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>-- We expose the relevant stuff from this module via the Type module</span>
<a name="line-19"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK not-home #-}</span>
<a name="line-20"></a><span class='hs-comment'>{-# LANGUAGE CPP, DeriveDataTypeable, MultiWayIf #-}</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TyCoRep</span> <span class='hs-layout'>(</span>
<a name="line-23"></a>        <span class='hs-conid'>TyThing</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyThingCategory</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprShortTyThing</span><span class='hs-layout'>,</span>
<a name="line-24"></a>
<a name="line-25"></a>        <span class='hs-comment'>-- * Types</span>
<a name="line-26"></a>        <span class='hs-conid'>Type</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-conid'>TyLit</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-conid'>KindOrType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-conid'>KnotTied</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-conid'>PredType</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span>      <span class='hs-comment'>-- Synonyms</span>
<a name="line-31"></a>        <span class='hs-conid'>ArgFlag</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-32"></a>
<a name="line-33"></a>        <span class='hs-comment'>-- * Coercions</span>
<a name="line-34"></a>        <span class='hs-conid'>Coercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-conid'>UnivCoProvenance</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-conid'>CoercionHole</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>coHoleCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoHoleCoVar</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionR</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionP</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindCoercion</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-conid'>MCoercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>MCoercionR</span><span class='hs-layout'>,</span> <span class='hs-conid'>MCoercionN</span><span class='hs-layout'>,</span>
<a name="line-39"></a>
<a name="line-40"></a>        <span class='hs-comment'>-- * Functions over types</span>
<a name="line-41"></a>        <span class='hs-varid'>mkTyConTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyVarTys</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>mkTyCoVarTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoVarTys</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>mkFunTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoForAllTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllTys</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>mkForAllTy</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>mkTyCoPiTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoPiTys</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>mkPiTys</span><span class='hs-layout'>,</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-varid'>kindRep_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindRep</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>isLiftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedTypeKind</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>isLiftedRuntimeRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedRuntimeRep</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>isRuntimeRepTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRuntimeRepVar</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>sameVis</span><span class='hs-layout'>,</span>
<a name="line-53"></a>
<a name="line-54"></a>        <span class='hs-comment'>-- * Functions over binders</span>
<a name="line-55"></a>        <span class='hs-conid'>TyCoBinder</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVarBinder</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyBinder</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>binderVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderType</span><span class='hs-layout'>,</span> <span class='hs-varid'>binderArgFlag</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>delBinderVar</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>isInvisibleArgFlag</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVisibleArgFlag</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>isInvisibleBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>isVisibleBinder</span><span class='hs-layout'>,</span>
<a name="line-60"></a>        <span class='hs-varid'>isTyBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>isNamedBinder</span><span class='hs-layout'>,</span>
<a name="line-61"></a>        <span class='hs-varid'>tyCoBinderArgFlag</span><span class='hs-layout'>,</span>
<a name="line-62"></a>
<a name="line-63"></a>        <span class='hs-comment'>-- * Functions over coercions</span>
<a name="line-64"></a>        <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>        <span class='hs-comment'>-- * Pretty-printing</span>
<a name="line-67"></a>        <span class='hs-varid'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPrecType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprPrecTypeX</span><span class='hs-layout'>,</span>
<a name="line-68"></a>        <span class='hs-varid'>pprTypeApp</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTCvBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTCvBndrs</span><span class='hs-layout'>,</span>
<a name="line-69"></a>        <span class='hs-varid'>pprSigmaType</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>pprTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendTheta</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprForAll</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprUserForAll</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>pprTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyVars</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>pprThetaArrowTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprClassPred</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyLit</span><span class='hs-layout'>,</span>
<a name="line-74"></a>        <span class='hs-conid'>PprPrec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>topPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>opPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>funPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>appPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeParen</span><span class='hs-layout'>,</span>
<a name="line-75"></a>        <span class='hs-varid'>pprDataCons</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprWithExplicitKindsWhen</span><span class='hs-layout'>,</span>
<a name="line-76"></a>
<a name="line-77"></a>        <span class='hs-varid'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span><span class='hs-layout'>,</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-varid'>debugPprType</span><span class='hs-layout'>,</span>
<a name="line-80"></a>
<a name="line-81"></a>        <span class='hs-comment'>-- * Free variables</span>
<a name="line-82"></a>        <span class='hs-varid'>tyCoVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeDSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesDSet</span><span class='hs-layout'>,</span>
<a name="line-83"></a>        <span class='hs-varid'>tyCoFVsBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-84"></a>        <span class='hs-varid'>tyCoFVsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeList</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-varid'>tyCoFVsOfTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesList</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>coVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfTypes</span><span class='hs-layout'>,</span>
<a name="line-87"></a>        <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-88"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span>
<a name="line-89"></a>        <span class='hs-varid'>tyCoVarsOfCoDSet</span><span class='hs-layout'>,</span>
<a name="line-90"></a>        <span class='hs-varid'>tyCoFVsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfCos</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>tyCoVarsOfCoList</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfProv</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>almostDevoidCoVarOfCo</span><span class='hs-layout'>,</span>
<a name="line-93"></a>        <span class='hs-varid'>injectiveVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConAppNeedsKindSig</span><span class='hs-layout'>,</span>
<a name="line-94"></a>
<a name="line-95"></a>        <span class='hs-varid'>noFreeVarsOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>noFreeVarsOfCo</span><span class='hs-layout'>,</span>
<a name="line-96"></a>
<a name="line-97"></a>        <span class='hs-comment'>-- * Substitutions</span>
<a name="line-98"></a>        <span class='hs-conid'>TCvSubst</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-99"></a>        <span class='hs-varid'>emptyTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-100"></a>        <span class='hs-varid'>emptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkEmptyTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>isEmptyTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-101"></a>        <span class='hs-varid'>mkTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCvSubst</span><span class='hs-layout'>,</span>
<a name="line-102"></a>        <span class='hs-varid'>getTvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>getCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>getTCvSubstRangeFVs</span><span class='hs-layout'>,</span>
<a name="line-104"></a>        <span class='hs-varid'>isInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>notElemTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-105"></a>        <span class='hs-varid'>setTvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-106"></a>        <span class='hs-varid'>extendTCvInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-107"></a>        <span class='hs-varid'>extendTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTCvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-108"></a>        <span class='hs-varid'>extendCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendCvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-109"></a>        <span class='hs-varid'>extendTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstBinderAndInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstWithClone</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>extendTvSubstList</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span>
<a name="line-111"></a>        <span class='hs-varid'>extendTCvSubstList</span><span class='hs-layout'>,</span>
<a name="line-112"></a>        <span class='hs-varid'>unionTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipTyEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipCoEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyCoInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-113"></a>        <span class='hs-varid'>zipTvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipCvSubst</span><span class='hs-layout'>,</span>
<a name="line-114"></a>        <span class='hs-varid'>zipTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-115"></a>        <span class='hs-varid'>mkTvSubstPrs</span><span class='hs-layout'>,</span>
<a name="line-116"></a>
<a name="line-117"></a>        <span class='hs-varid'>substTyWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyWithCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysWithCoVars</span><span class='hs-layout'>,</span>
<a name="line-118"></a>        <span class='hs-varid'>substCoWith</span><span class='hs-layout'>,</span>
<a name="line-119"></a>        <span class='hs-varid'>substTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyAddInScope</span><span class='hs-layout'>,</span>
<a name="line-120"></a>        <span class='hs-varid'>substTyUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTysUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substThetaUnchecked</span><span class='hs-layout'>,</span>
<a name="line-121"></a>        <span class='hs-varid'>substTyWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-122"></a>        <span class='hs-varid'>substCoUnchecked</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWithUnchecked</span><span class='hs-layout'>,</span>
<a name="line-123"></a>        <span class='hs-varid'>substTyWithInScope</span><span class='hs-layout'>,</span>
<a name="line-124"></a>        <span class='hs-varid'>substTys</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTheta</span><span class='hs-layout'>,</span>
<a name="line-125"></a>        <span class='hs-varid'>lookupTyVar</span><span class='hs-layout'>,</span>
<a name="line-126"></a>        <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupCoVar</span><span class='hs-layout'>,</span>
<a name="line-127"></a>        <span class='hs-varid'>cloneTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>cloneTyVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-128"></a>        <span class='hs-varid'>substVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-129"></a>        <span class='hs-varid'>substTyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVarBndrs</span><span class='hs-layout'>,</span>
<a name="line-130"></a>        <span class='hs-varid'>substCoVarBndr</span><span class='hs-layout'>,</span>
<a name="line-131"></a>        <span class='hs-varid'>substTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-132"></a>        <span class='hs-varid'>substForAllCoBndr</span><span class='hs-layout'>,</span>
<a name="line-133"></a>        <span class='hs-varid'>substVarBndrUsing</span><span class='hs-layout'>,</span> <span class='hs-varid'>substForAllCoBndrUsing</span><span class='hs-layout'>,</span>
<a name="line-134"></a>        <span class='hs-varid'>checkValidSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>isValidTCvSubst</span><span class='hs-layout'>,</span>
<a name="line-135"></a>
<a name="line-136"></a>        <span class='hs-comment'>-- * Tidying type related things up for printing</span>
<a name="line-137"></a>        <span class='hs-varid'>tidyType</span><span class='hs-layout'>,</span>      <span class='hs-varid'>tidyTypes</span><span class='hs-layout'>,</span>
<a name="line-138"></a>        <span class='hs-varid'>tidyOpenType</span><span class='hs-layout'>,</span>  <span class='hs-varid'>tidyOpenTypes</span><span class='hs-layout'>,</span>
<a name="line-139"></a>        <span class='hs-varid'>tidyOpenKind</span><span class='hs-layout'>,</span>
<a name="line-140"></a>        <span class='hs-varid'>tidyVarBndr</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyVarBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyFreeTyCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>avoidNameClashes</span><span class='hs-layout'>,</span>
<a name="line-141"></a>        <span class='hs-varid'>tidyOpenTyCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyOpenTyCoVars</span><span class='hs-layout'>,</span>
<a name="line-142"></a>        <span class='hs-varid'>tidyTyCoVarOcc</span><span class='hs-layout'>,</span>
<a name="line-143"></a>        <span class='hs-varid'>tidyTopType</span><span class='hs-layout'>,</span>
<a name="line-144"></a>        <span class='hs-varid'>tidyKind</span><span class='hs-layout'>,</span>
<a name="line-145"></a>        <span class='hs-varid'>tidyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCos</span><span class='hs-layout'>,</span>
<a name="line-146"></a>        <span class='hs-varid'>tidyTyCoVarBinder</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTyCoVarBinders</span><span class='hs-layout'>,</span>
<a name="line-147"></a>
<a name="line-148"></a>        <span class='hs-comment'>-- * Sizes</span>
<a name="line-149"></a>        <span class='hs-varid'>typeSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>provSize</span>
<a name="line-150"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-151"></a>
<a name="line-152"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-153"></a>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GhcPrelude</span>
<a name="line-155"></a>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>DataCon</span><span class='hs-layout'>(</span> <span class='hs-varid'>dataConFullSig</span>
<a name="line-157"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>dataConUserTyVarBinders</span>
<a name="line-158"></a>                             <span class='hs-layout'>,</span> <span class='hs-conid'>DataCon</span> <span class='hs-layout'>)</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>Type</span><span class='hs-layout'>(</span> <span class='hs-varid'>isPredTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoercionTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCastTy</span>
<a name="line-160"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span>
<a name="line-161"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span>
<a name="line-162"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>scopedSort</span>
<a name="line-163"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>coreView</span> <span class='hs-layout'>)</span>
<a name="line-164"></a>   <span class='hs-comment'>-- Transitively pulls in a LOT of stuff, better to break the loop</span>
<a name="line-165"></a>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>Coercion</span>
<a name="line-167"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>ConLike</span> <span class='hs-layout'>(</span> <span class='hs-conid'>ConLike</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>conLikeName</span> <span class='hs-layout'>)</span>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>ToIface</span><span class='hs-layout'>(</span> <span class='hs-varid'>toIfaceTypeX</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceTyLit</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceForAllBndr</span>
<a name="line-169"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceTcArgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>toIfaceCoercionX</span> <span class='hs-layout'>)</span>
<a name="line-170"></a>
<a name="line-171"></a><span class='hs-comment'>-- friends:</span>
<a name="line-172"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IfaceType</span>
<a name="line-173"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-174"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-175"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-176"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>)</span>
<a name="line-177"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-178"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Class</span>
<a name="line-179"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>CoAxiom</span>
<a name="line-180"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FV</span>
<a name="line-181"></a>
<a name="line-182"></a><span class='hs-comment'>-- others</span>
<a name="line-183"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>BasicTypes</span> <span class='hs-layout'>(</span> <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>PprPrec</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>topPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>sigPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>opPrec</span>
<a name="line-184"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>funPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>appPrec</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybeParen</span><span class='hs-layout'>,</span> <span class='hs-varid'>pickLR</span> <span class='hs-layout'>)</span>
<a name="line-185"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>PrelNames</span>
<a name="line-186"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-187"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-188"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-189"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Pair</span>
<a name="line-190"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSupply</span>
<a name="line-191"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-192"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqFM</span>
<a name="line-193"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>UniqSet</span>
<a name="line-194"></a>
<a name="line-195"></a><span class='hs-comment'>-- libraries</span>
<a name="line-196"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Data</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-conid'>TyCon</span> <span class='hs-layout'>)</span>
<a name="line-197"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span>
<a name="line-198"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.IORef</span> <span class='hs-layout'>(</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- for CoercionHole</span>
<a name="line-199"></a>
<a name="line-200"></a><span class='hs-comment'>{-
<a name="line-201"></a>%************************************************************************
<a name="line-202"></a>%*                                                                      *
<a name="line-203"></a>                        TyThing
<a name="line-204"></a>%*                                                                      *
<a name="line-205"></a>%************************************************************************
<a name="line-206"></a>
<a name="line-207"></a>Despite the fact that DataCon has to be imported via a hi-boot route,
<a name="line-208"></a>this module seems the right place for TyThing, because it's needed for
<a name="line-209"></a>funTyCon and all the types in TysPrim.
<a name="line-210"></a>
<a name="line-211"></a>It is also SOURCE-imported into Name.hs
<a name="line-212"></a>
<a name="line-213"></a>
<a name="line-214"></a>Note [ATyCon for classes]
<a name="line-215"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-216"></a>Both classes and type constructors are represented in the type environment
<a name="line-217"></a>as ATyCon.  You can tell the difference, and get to the class, with
<a name="line-218"></a>   isClassTyCon :: TyCon -&gt; Bool
<a name="line-219"></a>   tyConClass_maybe :: TyCon -&gt; Maybe Class
<a name="line-220"></a>The Class and its associated TyCon have the same Name.
<a name="line-221"></a>-}</span>
<a name="line-222"></a>
<a name="line-223"></a><a name="TyThing"></a><span class='hs-comment'>-- | A global typecheckable-thing, essentially anything that has a name.</span>
<a name="line-224"></a><a name="TyThing"></a><span class='hs-comment'>-- Not to be confused with a 'TcTyThing', which is also a typecheckable</span>
<a name="line-225"></a><a name="TyThing"></a><span class='hs-comment'>-- thing but in the *local* context.  See 'TcEnv' for how to retrieve</span>
<a name="line-226"></a><a name="TyThing"></a><span class='hs-comment'>-- a 'TyThing' given a 'Name'.</span>
<a name="line-227"></a><a name="TyThing"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyThing</span>
<a name="line-228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnId</span>     <span class='hs-conid'>Id</span>
<a name="line-229"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AConLike</span> <span class='hs-conid'>ConLike</span>
<a name="line-230"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyCon</span>   <span class='hs-conid'>TyCon</span>       <span class='hs-comment'>-- TyCons and classes; see Note [ATyCon for classes]</span>
<a name="line-231"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ACoAxiom</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="instance%20Outputable%20TyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyword'>where</span>
<a name="line-234"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprShortTyThing</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="instance%20NamedThing%20TyThing"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NamedThing</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyword'>where</span>       <span class='hs-comment'>-- Can't put this with the type</span>
<a name="line-237"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>id</span>    <span class='hs-comment'>-- decl, because the DataCon instance</span>
<a name="line-238"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>tc</span>    <span class='hs-comment'>-- isn't visible there</span>
<a name="line-239"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-varid'>cc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>cc</span>
<a name="line-240"></a>  <span class='hs-varid'>getName</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-varid'>cl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>conLikeName</span> <span class='hs-varid'>cl</span>
<a name="line-241"></a>
<a name="line-242"></a><a name="pprShortTyThing"></a><span class='hs-definition'>pprShortTyThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-243"></a><span class='hs-comment'>-- c.f. PprTyThing.pprTyThing, which prints all the details</span>
<a name="line-244"></a><span class='hs-definition'>pprShortTyThing</span> <span class='hs-varid'>thing</span>
<a name="line-245"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyThingCategory</span> <span class='hs-varid'>thing</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getName</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-246"></a>
<a name="line-247"></a><a name="pprTyThingCategory"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-248"></a><span class='hs-definition'>pprTyThingCategory</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varop'>.</span> <span class='hs-varid'>capitalise</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyThingCategory</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="tyThingCategory"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-251"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-252"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isClassTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"class"</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-str'>"type constructor"</span>
<a name="line-254"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>ACoAxiom</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"coercion axiom"</span>
<a name="line-255"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnId</span>   <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-str'>"identifier"</span>
<a name="line-256"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"data constructor"</span>
<a name="line-257"></a><span class='hs-definition'>tyThingCategory</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSynCon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-str'>"pattern synonym"</span>
<a name="line-258"></a>
<a name="line-259"></a>
<a name="line-260"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-261"></a>*                                                                       *
<a name="line-262"></a>                        Type
<a name="line-263"></a>*                                                                       *
<a name="line-264"></a>********************************************************************** -}</span>
<a name="line-265"></a>
<a name="line-266"></a><span class='hs-comment'>-- | The key representation of types within the compiler</span>
<a name="line-267"></a>
<a name="line-268"></a><a name="KindOrType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KindOrType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- See Note [Arguments to type constructors]</span>
<a name="line-269"></a>
<a name="line-270"></a><a name="Kind"></a><span class='hs-comment'>-- | The key type representing kinds in the compiler.</span>
<a name="line-271"></a><a name="Kind"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-272"></a>
<a name="line-273"></a><a name="Type"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-274"></a><a name="Type"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span>
<a name="line-275"></a><a name="Type"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Type</span>
<a name="line-276"></a>  <span class='hs-comment'>-- See Note [Non-trivial definitional equality]</span>
<a name="line-277"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-conid'>Var</span> <span class='hs-comment'>-- ^ Vanilla type or kind variable (*never* a coercion variable)</span>
<a name="line-278"></a>
<a name="line-279"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppTy</span>
<a name="line-280"></a>        <span class='hs-conid'>Type</span>
<a name="line-281"></a>        <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- ^ Type application to something other than a 'TyCon'. Parameters:</span>
<a name="line-282"></a>                        <span class='hs-comment'>--</span>
<a name="line-283"></a>                        <span class='hs-comment'>--  1) Function: must /not/ be a 'TyConApp' or 'CastTy',</span>
<a name="line-284"></a>                        <span class='hs-comment'>--     must be another 'AppTy', or 'TyVarTy'</span>
<a name="line-285"></a>                        <span class='hs-comment'>--     See Note [Respecting definitional equality] (EQ1) about the</span>
<a name="line-286"></a>                        <span class='hs-comment'>--     no 'CastTy' requirement</span>
<a name="line-287"></a>                        <span class='hs-comment'>--</span>
<a name="line-288"></a>                        <span class='hs-comment'>--  2) Argument type</span>
<a name="line-289"></a>
<a name="line-290"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span>
<a name="line-291"></a>        <span class='hs-conid'>TyCon</span>
<a name="line-292"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindOrType</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ Application of a 'TyCon', including newtypes /and/ synonyms.</span>
<a name="line-293"></a>                        <span class='hs-comment'>-- Invariant: saturated applications of 'FunTyCon' must</span>
<a name="line-294"></a>                        <span class='hs-comment'>-- use 'FunTy' and saturated synonyms must use their own</span>
<a name="line-295"></a>                        <span class='hs-comment'>-- constructors. However, /unsaturated/ 'FunTyCon's</span>
<a name="line-296"></a>                        <span class='hs-comment'>-- do appear as 'TyConApp's.</span>
<a name="line-297"></a>                        <span class='hs-comment'>-- Parameters:</span>
<a name="line-298"></a>                        <span class='hs-comment'>--</span>
<a name="line-299"></a>                        <span class='hs-comment'>-- 1) Type constructor being applied to.</span>
<a name="line-300"></a>                        <span class='hs-comment'>--</span>
<a name="line-301"></a>                        <span class='hs-comment'>-- 2) Type arguments. Might not have enough type arguments</span>
<a name="line-302"></a>                        <span class='hs-comment'>--    here to saturate the constructor.</span>
<a name="line-303"></a>                        <span class='hs-comment'>--    Even type synonyms are not necessarily saturated;</span>
<a name="line-304"></a>                        <span class='hs-comment'>--    for example unsaturated type synonyms</span>
<a name="line-305"></a>                        <span class='hs-comment'>--    can appear as the right hand side of a type synonym.</span>
<a name="line-306"></a>
<a name="line-307"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span>
<a name="line-308"></a>        <span class='hs-comment'>{-# UNPACK #-}</span> <span class='hs-varop'>!</span><span class='hs-conid'>TyCoVarBinder</span>
<a name="line-309"></a>        <span class='hs-conid'>Type</span>            <span class='hs-comment'>-- ^ A Î  type.</span>
<a name="line-310"></a>
<a name="line-311"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunTy</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>     <span class='hs-comment'>-- ^ t1 -&gt; t2   Very common, so an important special case</span>
<a name="line-312"></a>
<a name="line-313"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LitTy</span> <span class='hs-conid'>TyLit</span>     <span class='hs-comment'>-- ^ Type literals are similar to type constructors.</span>
<a name="line-314"></a>
<a name="line-315"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CastTy</span>
<a name="line-316"></a>        <span class='hs-conid'>Type</span>
<a name="line-317"></a>        <span class='hs-conid'>KindCoercion</span>  <span class='hs-comment'>-- ^ A kind cast. The coercion is always nominal.</span>
<a name="line-318"></a>                      <span class='hs-comment'>-- INVARIANT: The cast is never refl.</span>
<a name="line-319"></a>                      <span class='hs-comment'>-- INVARIANT: The Type is not a CastTy (use TransCo instead)</span>
<a name="line-320"></a>                      <span class='hs-comment'>-- See Note [Respecting definitional equality] (EQ2) and (EQ3)</span>
<a name="line-321"></a>
<a name="line-322"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercionTy</span>
<a name="line-323"></a>        <span class='hs-conid'>Coercion</span>    <span class='hs-comment'>-- ^ Injection of a Coercion into a type</span>
<a name="line-324"></a>                    <span class='hs-comment'>-- This should only ever be used in the RHS of an AppTy,</span>
<a name="line-325"></a>                    <span class='hs-comment'>-- in the list of a TyConApp, when applying a promoted</span>
<a name="line-326"></a>                    <span class='hs-comment'>-- GADT data constructor</span>
<a name="line-327"></a>
<a name="line-328"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data.Data</span>
<a name="line-329"></a>
<a name="line-330"></a>
<a name="line-331"></a><a name="TyLit"></a><span class='hs-comment'>-- NOTE:  Other parts of the code assume that type literals do not contain</span>
<a name="line-332"></a><a name="TyLit"></a><span class='hs-comment'>-- types or type variables.</span>
<a name="line-333"></a><a name="TyLit"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyLit</span>
<a name="line-334"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NumTyLit</span> <span class='hs-conid'>Integer</span>
<a name="line-335"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>StrTyLit</span> <span class='hs-conid'>FastString</span>
<a name="line-336"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data.Data</span><span class='hs-layout'>)</span>
<a name="line-337"></a>
<a name="line-338"></a><span class='hs-comment'>{- Note [Arguments to type constructors]
<a name="line-339"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-340"></a>Because of kind polymorphism, in addition to type application we now
<a name="line-341"></a>have kind instantiation. We reuse the same notations to do so.
<a name="line-342"></a>
<a name="line-343"></a>For example:
<a name="line-344"></a>
<a name="line-345"></a>  Just (* -&gt; *) Maybe
<a name="line-346"></a>  Right * Nat Zero
<a name="line-347"></a>
<a name="line-348"></a>are represented by:
<a name="line-349"></a>
<a name="line-350"></a>  TyConApp (PromotedDataCon Just) [* -&gt; *, Maybe]
<a name="line-351"></a>  TyConApp (PromotedDataCon Right) [*, Nat, (PromotedDataCon Zero)]
<a name="line-352"></a>
<a name="line-353"></a>Important note: Nat is used as a *kind* and not as a type. This can be
<a name="line-354"></a>confusing, since type-level Nat and kind-level Nat are identical. We
<a name="line-355"></a>use the kind of (PromotedDataCon Right) to know if its arguments are
<a name="line-356"></a>kinds or types.
<a name="line-357"></a>
<a name="line-358"></a>This kind instantiation only happens in TyConApp currently.
<a name="line-359"></a>
<a name="line-360"></a>Note [Non-trivial definitional equality]
<a name="line-361"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-362"></a>Is Int |&gt; &lt;*&gt; the same as Int? YES! In order to reduce headaches,
<a name="line-363"></a>we decide that any reflexive casts in types are just ignored.
<a name="line-364"></a>(Indeed they must be. See Note [Respecting definitional equality].)
<a name="line-365"></a>More generally, the `eqType` function, which defines Core's type equality
<a name="line-366"></a>relation, ignores casts and coercion arguments, as long as the
<a name="line-367"></a>two types have the same kind. This allows us to be a little sloppier
<a name="line-368"></a>in keeping track of coercions, which is a good thing. It also means
<a name="line-369"></a>that eqType does not depend on eqCoercion, which is also a good thing.
<a name="line-370"></a>
<a name="line-371"></a>Why is this sensible? That is, why is something different than Î±-equivalence
<a name="line-372"></a>appropriate for the implementation of eqType?
<a name="line-373"></a>
<a name="line-374"></a>Anything smaller than ~ and homogeneous is an appropriate definition for
<a name="line-375"></a>equality. The type safety of FC depends only on ~. Let's say Î· : Ï ~ Ï. Any
<a name="line-376"></a>expression of type Ï can be transmuted to one of type Ï at any point by
<a name="line-377"></a>casting. The same is true of expressions of type Ï. So in some sense, Ï and Ï
<a name="line-378"></a>are interchangeable.
<a name="line-379"></a>
<a name="line-380"></a>But let's be more precise. If we examine the typing rules of FC (say, those in
<a name="line-381"></a>https://cs.brynmawr.edu/~rae/papers/2015/equalities/equalities.pdf)
<a name="line-382"></a>there are several places where the same metavariable is used in two different
<a name="line-383"></a>premises to a rule. (For example, see Ty_App.) There is an implicit equality
<a name="line-384"></a>check here. What definition of equality should we use? By convention, we use
<a name="line-385"></a>Î±-equivalence. Take any rule with one (or more) of these implicit equality
<a name="line-386"></a>checks. Then there is an admissible rule that uses ~ instead of the implicit
<a name="line-387"></a>check, adding in casts as appropriate.
<a name="line-388"></a>
<a name="line-389"></a>The only problem here is that ~ is heterogeneous. To make the kinds work out
<a name="line-390"></a>in the admissible rule that uses ~, it is necessary to homogenize the
<a name="line-391"></a>coercions. That is, if we have Î· : (Ï : Îº1) ~ (Ï : Îº2), then we don't use Î·;
<a name="line-392"></a>we use Î· |&gt; kind Î·, which is homogeneous.
<a name="line-393"></a>
<a name="line-394"></a>The effect of this all is that eqType, the implementation of the implicit
<a name="line-395"></a>equality check, can use any homogeneous relation that is smaller than ~, as
<a name="line-396"></a>those rules must also be admissible.
<a name="line-397"></a>
<a name="line-398"></a>A more drawn out argument around all of this is presented in Section 7.2 of
<a name="line-399"></a>Richard E's thesis (<a href="http://cs.brynmawr.edu/~rae/papers/2016/thesis/eisenberg-thesis.pdf).">http://cs.brynmawr.edu/~rae/papers/2016/thesis/eisenberg-thesis.pdf).</a>
<a name="line-400"></a>
<a name="line-401"></a>What would go wrong if we insisted on the casts matching? See the beginning of
<a name="line-402"></a>Section 8 in the unpublished paper above. Theoretically, nothing at all goes
<a name="line-403"></a>wrong. But in practical terms, getting the coercions right proved to be
<a name="line-404"></a>nightmarish. And types would explode: during kind-checking, we often produce
<a name="line-405"></a>reflexive kind coercions. When we try to cast by these, mkCastTy just discards
<a name="line-406"></a>them. But if we used an eqType that distinguished between Int and Int |&gt; &lt;*&gt;,
<a name="line-407"></a>then we couldn't discard -- the output of kind-checking would be enormous,
<a name="line-408"></a>and we would need enormous casts with lots of CoherenceCo's to straighten
<a name="line-409"></a>them out.
<a name="line-410"></a>
<a name="line-411"></a>Would anything go wrong if eqType respected type families? No, not at all. But
<a name="line-412"></a>that makes eqType rather hard to implement.
<a name="line-413"></a>
<a name="line-414"></a>Thus, the guideline for eqType is that it should be the largest
<a name="line-415"></a>easy-to-implement relation that is still smaller than ~ and homogeneous. The
<a name="line-416"></a>precise choice of relation is somewhat incidental, as long as the smart
<a name="line-417"></a>constructors and destructors in Type respect whatever relation is chosen.
<a name="line-418"></a>
<a name="line-419"></a>Another helpful principle with eqType is this:
<a name="line-420"></a>
<a name="line-421"></a> (EQ) If (t1 `eqType` t2) then I can replace t1 by t2 anywhere.
<a name="line-422"></a>
<a name="line-423"></a>This principle also tells us that eqType must relate only types with the
<a name="line-424"></a>same kinds.
<a name="line-425"></a>
<a name="line-426"></a>Note [Respecting definitional equality]
<a name="line-427"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-428"></a>Note [Non-trivial definitional equality] introduces the property (EQ).
<a name="line-429"></a>How is this upheld?
<a name="line-430"></a>
<a name="line-431"></a>Any function that pattern matches on all the constructors will have to
<a name="line-432"></a>consider the possibility of CastTy. Presumably, those functions will handle
<a name="line-433"></a>CastTy appropriately and we'll be OK.
<a name="line-434"></a>
<a name="line-435"></a>More dangerous are the splitXXX functions. Let's focus on splitTyConApp.
<a name="line-436"></a>We don't want it to fail on (T a b c |&gt; co). Happily, if we have
<a name="line-437"></a>  (T a b c |&gt; co) `eqType` (T d e f)
<a name="line-438"></a>then co must be reflexive. Why? eqType checks that the kinds are equal, as
<a name="line-439"></a>well as checking that (a `eqType` d), (b `eqType` e), and (c `eqType` f).
<a name="line-440"></a>By the kind check, we know that (T a b c |&gt; co) and (T d e f) have the same
<a name="line-441"></a>kind. So the only way that co could be non-reflexive is for (T a b c) to have
<a name="line-442"></a>a different kind than (T d e f). But because T's kind is closed (all tycon kinds
<a name="line-443"></a>are closed), the only way for this to happen is that one of the arguments has
<a name="line-444"></a>to differ, leading to a contradiction. Thus, co is reflexive.
<a name="line-445"></a>
<a name="line-446"></a>Accordingly, by eliminating reflexive casts, splitTyConApp need not worry
<a name="line-447"></a>about outermost casts to uphold (EQ). Eliminating reflexive casts is done
<a name="line-448"></a>in mkCastTy.
<a name="line-449"></a>
<a name="line-450"></a>Unforunately, that's not the end of the story. Consider comparing
<a name="line-451"></a>  (T a b c)      =?       (T a b |&gt; (co -&gt; &lt;Type&gt;)) (c |&gt; co)
<a name="line-452"></a>These two types have the same kind (Type), but the left type is a TyConApp
<a name="line-453"></a>while the right type is not. To handle this case, we say that the right-hand
<a name="line-454"></a>type is ill-formed, requiring an AppTy never to have a casted TyConApp
<a name="line-455"></a>on its left. It is easy enough to pull around the coercions to maintain
<a name="line-456"></a>this invariant, as done in Type.mkAppTy. In the example above, trying to
<a name="line-457"></a>form the right-hand type will instead yield (T a b (c |&gt; co |&gt; sym co) |&gt; &lt;Type&gt;).
<a name="line-458"></a>Both the casts there are reflexive and will be dropped. Huzzah.
<a name="line-459"></a>
<a name="line-460"></a>This idea of pulling coercions to the right works for splitAppTy as well.
<a name="line-461"></a>
<a name="line-462"></a>However, there is one hiccup: it's possible that a coercion doesn't relate two
<a name="line-463"></a>Pi-types. For example, if we have @type family Fun a b where Fun a b = a -&gt; b@,
<a name="line-464"></a>then we might have (T :: Fun Type Type) and (T |&gt; axFun) Int. That axFun can't
<a name="line-465"></a>be pulled to the right. But we don't need to pull it: (T |&gt; axFun) Int is not
<a name="line-466"></a>`eqType` to any proper TyConApp -- thus, leaving it where it is doesn't violate
<a name="line-467"></a>our (EQ) property.
<a name="line-468"></a>
<a name="line-469"></a>Lastly, in order to detect reflexive casts reliably, we must make sure not
<a name="line-470"></a>to have nested casts: we update (t |&gt; co1 |&gt; co2) to (t |&gt; (co1 `TransCo` co2)).
<a name="line-471"></a>
<a name="line-472"></a>In sum, in order to uphold (EQ), we need the following three invariants:
<a name="line-473"></a>
<a name="line-474"></a>  (EQ1) No decomposable CastTy to the left of an AppTy, where a decomposable
<a name="line-475"></a>        cast is one that relates either a FunTy to a FunTy or a
<a name="line-476"></a>        ForAllTy to a ForAllTy.
<a name="line-477"></a>  (EQ2) No reflexive casts in CastTy.
<a name="line-478"></a>  (EQ3) No nested CastTys.
<a name="line-479"></a>  (EQ4) No CastTy over (ForAllTy (Bndr tyvar vis) body).
<a name="line-480"></a>        See Note [Weird typing rule for ForAllTy] in Type.
<a name="line-481"></a>
<a name="line-482"></a>These invariants are all documented above, in the declaration for Type.
<a name="line-483"></a>
<a name="line-484"></a>Note [Unused coercion variable in ForAllTy]
<a name="line-485"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-486"></a>Suppose we have
<a name="line-487"></a>  \(co:t1 ~ t2). e
<a name="line-488"></a>
<a name="line-489"></a>What type should we give to this expression?
<a name="line-490"></a>  (1) forall (co:t1 ~ t2) -&gt; t
<a name="line-491"></a>  (2) (t1 ~ t2) -&gt; t
<a name="line-492"></a>
<a name="line-493"></a>If co is used in t, (1) should be the right choice.
<a name="line-494"></a>if co is not used in t, we would like to have (1) and (2) equivalent.
<a name="line-495"></a>
<a name="line-496"></a>However, we want to keep eqType simple and don't want eqType (1) (2) to return
<a name="line-497"></a>True in any case.
<a name="line-498"></a>
<a name="line-499"></a>We decide to always construct (2) if co is not used in t.
<a name="line-500"></a>
<a name="line-501"></a>Thus in mkTyCoForAllTy, we check whether the variable is a coercion
<a name="line-502"></a>variable and whether it is used in the body. If so, it returns a FunTy
<a name="line-503"></a>instead of a ForAllTy.
<a name="line-504"></a>
<a name="line-505"></a>There are cases we want to skip the check. For example, the check is unnecessary
<a name="line-506"></a>when it is known from the context that the input variable is a type variable.
<a name="line-507"></a>In those cases, we use mkForAllTy.
<a name="line-508"></a>-}</span>
<a name="line-509"></a>
<a name="line-510"></a><a name="KnotTied"></a><span class='hs-comment'>-- | A type labeled 'KnotTied' might have knot-tied tycons in it. See</span>
<a name="line-511"></a><a name="KnotTied"></a><span class='hs-comment'>-- Note [Type checking recursive type and class declarations] in</span>
<a name="line-512"></a><a name="KnotTied"></a><span class='hs-comment'>-- TcTyClsDecls</span>
<a name="line-513"></a><a name="KnotTied"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KnotTied</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-514"></a>
<a name="line-515"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-516"></a>*                                                                       *
<a name="line-517"></a>                  TyCoBinder and ArgFlag
<a name="line-518"></a>*                                                                       *
<a name="line-519"></a>********************************************************************** -}</span>
<a name="line-520"></a>
<a name="line-521"></a><a name="TyCoBinder"></a><span class='hs-comment'>-- | A 'TyCoBinder' represents an argument to a function. TyCoBinders can be</span>
<a name="line-522"></a><a name="TyCoBinder"></a><span class='hs-comment'>-- dependent ('Named') or nondependent ('Anon'). They may also be visible or</span>
<a name="line-523"></a><a name="TyCoBinder"></a><span class='hs-comment'>-- not. See Note [TyCoBinders]</span>
<a name="line-524"></a><a name="TyCoBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TyCoBinder</span>
<a name="line-525"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Named</span> <span class='hs-conid'>TyCoVarBinder</span> <span class='hs-comment'>-- A type-lambda binder</span>
<a name="line-526"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Anon</span> <span class='hs-conid'>Type</span>           <span class='hs-comment'>-- A term-lambda binder. Type here can be CoercionTy.</span>
<a name="line-527"></a>                        <span class='hs-comment'>-- Visibility is determined by the type (Constraint vs. *)</span>
<a name="line-528"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data.Data</span>
<a name="line-529"></a>
<a name="line-530"></a><a name="TyBinder"></a><span class='hs-comment'>-- | 'TyBinder' is like 'TyCoBinder', but there can only be 'TyVarBinder'</span>
<a name="line-531"></a><a name="TyBinder"></a><span class='hs-comment'>-- in the 'Named' field.</span>
<a name="line-532"></a><a name="TyBinder"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TyBinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoBinder</span>
<a name="line-533"></a>
<a name="line-534"></a><a name="delBinderVar"></a><span class='hs-comment'>-- | Remove the binder's variable from the set, if the binder has</span>
<a name="line-535"></a><span class='hs-comment'>-- a variable.</span>
<a name="line-536"></a><span class='hs-definition'>delBinderVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-537"></a><span class='hs-definition'>delBinderVar</span> <span class='hs-varid'>vars</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span> <span class='hs-varop'>`delVarSet`</span> <span class='hs-varid'>tv</span>
<a name="line-538"></a>
<a name="line-539"></a><a name="isInvisibleBinder"></a><span class='hs-comment'>-- | Does this binder bind an invisible argument?</span>
<a name="line-540"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-541"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isInvisibleArgFlag</span> <span class='hs-varid'>vis</span>
<a name="line-542"></a><span class='hs-definition'>isInvisibleBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>ty</span>
<a name="line-543"></a>
<a name="line-544"></a><a name="isVisibleBinder"></a><span class='hs-comment'>-- | Does this binder bind a visible argument?</span>
<a name="line-545"></a><span class='hs-definition'>isVisibleBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-546"></a><span class='hs-definition'>isVisibleBinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isInvisibleBinder</span>
<a name="line-547"></a>
<a name="line-548"></a><a name="isNamedBinder"></a><span class='hs-definition'>isNamedBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-549"></a><span class='hs-definition'>isNamedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-550"></a><span class='hs-definition'>isNamedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-551"></a>
<a name="line-552"></a><a name="isTyBinder"></a><span class='hs-comment'>-- | If its a named binder, is the binder a tyvar?</span>
<a name="line-553"></a><span class='hs-comment'>-- Returns True for nondependent binder.</span>
<a name="line-554"></a><span class='hs-definition'>isTyBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-555"></a><span class='hs-definition'>isTyBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-varid'>bnd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTyVarBinder</span> <span class='hs-varid'>bnd</span>
<a name="line-556"></a><span class='hs-definition'>isTyBinder</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-557"></a>
<a name="line-558"></a><a name="tyCoBinderArgFlag"></a><span class='hs-definition'>tyCoBinderArgFlag</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgFlag</span>
<a name="line-559"></a><span class='hs-definition'>tyCoBinderArgFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>flag</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flag</span>
<a name="line-560"></a><span class='hs-definition'>tyCoBinderArgFlag</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-561"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isPredTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Inferred</span>
<a name="line-562"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Required</span>
<a name="line-563"></a>
<a name="line-564"></a><span class='hs-comment'>{- Note [TyCoBinders]
<a name="line-565"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-566"></a>A ForAllTy contains a TyCoVarBinder.  But a type can be decomposed
<a name="line-567"></a>to a telescope consisting of a [TyCoBinder]
<a name="line-568"></a>
<a name="line-569"></a>A TyCoBinder represents the type of binders -- that is, the type of an
<a name="line-570"></a>argument to a Pi-type. GHC Core currently supports two different
<a name="line-571"></a>Pi-types:
<a name="line-572"></a>
<a name="line-573"></a> * A non-dependent function type,
<a name="line-574"></a>   written with -&gt;, e.g. ty1 -&gt; ty2
<a name="line-575"></a>   represented as FunTy ty1 ty2. These are
<a name="line-576"></a>   lifted to Coercions with the corresponding FunCo.
<a name="line-577"></a>
<a name="line-578"></a> * A dependent compile-time-only polytype,
<a name="line-579"></a>   written with forall, e.g.  forall (a:*). ty
<a name="line-580"></a>   represented as ForAllTy (Bndr a v) ty
<a name="line-581"></a>
<a name="line-582"></a>Both Pi-types classify terms/types that take an argument. In other
<a name="line-583"></a>words, if `x` is either a function or a polytype, `x arg` makes sense
<a name="line-584"></a>(for an appropriate `arg`).
<a name="line-585"></a>
<a name="line-586"></a>
<a name="line-587"></a>Note [VarBndrs, TyCoVarBinders, TyConBinders, and visibility]
<a name="line-588"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-589"></a>* A ForAllTy (used for both types and kinds) contains a TyCoVarBinder.
<a name="line-590"></a>  Each TyCoVarBinder
<a name="line-591"></a>      Bndr a tvis
<a name="line-592"></a>  is equipped with tvis::ArgFlag, which says whether or not arguments
<a name="line-593"></a>  for this binder should be visible (explicit) in source Haskell.
<a name="line-594"></a>
<a name="line-595"></a>* A TyCon contains a list of TyConBinders.  Each TyConBinder
<a name="line-596"></a>      Bndr a cvis
<a name="line-597"></a>  is equipped with cvis::TyConBndrVis, which says whether or not type
<a name="line-598"></a>  and kind arguments for this TyCon should be visible (explicit) in
<a name="line-599"></a>  source Haskell.
<a name="line-600"></a>
<a name="line-601"></a>This table summarises the visibility rules:
<a name="line-602"></a>---------------------------------------------------------------------------------------
<a name="line-603"></a>|                                                      Occurrences look like this
<a name="line-604"></a>|                             GHC displays type as     in Haskell source code
<a name="line-605"></a>|--------------------------------------------------------------------------------------
<a name="line-606"></a>| Bndr a tvis :: TyCoVarBinder, in the binder of ForAllTy for a term
<a name="line-607"></a>|  tvis :: ArgFlag
<a name="line-608"></a>|  tvis = Inferred:            f :: forall {a}. type    Arg not allowed:  f
<a name="line-609"></a>                               f :: forall {co}. type   Arg not allowed:  f
<a name="line-610"></a>|  tvis = Specified:           f :: forall a. type      Arg optional:     f  or  f @Int
<a name="line-611"></a>|  tvis = Required:            T :: forall k -&gt; type    Arg required:     T *
<a name="line-612"></a>|    This last form is illegal in terms: See Note [No Required TyCoBinder in terms]
<a name="line-613"></a>|
<a name="line-614"></a>| Bndr k cvis :: TyConBinder, in the TyConBinders of a TyCon
<a name="line-615"></a>|  cvis :: TyConBndrVis
<a name="line-616"></a>|  cvis = AnonTCB:             T :: kind -&gt; kind        Required:            T *
<a name="line-617"></a>|  cvis = NamedTCB Inferred:   T :: forall {k}. kind    Arg not allowed:     T
<a name="line-618"></a>|                              T :: forall {co}. kind   Arg not allowed:     T
<a name="line-619"></a>|  cvis = NamedTCB Specified:  T :: forall k. kind      Arg not allowed[1]:  T
<a name="line-620"></a>|  cvis = NamedTCB Required:   T :: forall k -&gt; kind    Required:            T *
<a name="line-621"></a>---------------------------------------------------------------------------------------
<a name="line-622"></a>
<a name="line-623"></a>[1] In types, in the Specified case, it would make sense to allow
<a name="line-624"></a>    optional kind applications, thus (T @*), but we have not
<a name="line-625"></a>    yet implemented that
<a name="line-626"></a>
<a name="line-627"></a>---- In term declarations ----
<a name="line-628"></a>
<a name="line-629"></a>* Inferred.  Function defn, with no signature:  f1 x = x
<a name="line-630"></a>  We infer f1 :: forall {a}. a -&gt; a, with 'a' Inferred
<a name="line-631"></a>  It's Inferred because it doesn't appear in any
<a name="line-632"></a>  user-written signature for f1
<a name="line-633"></a>
<a name="line-634"></a>* Specified.  Function defn, with signature (implicit forall):
<a name="line-635"></a>     f2 :: a -&gt; a; f2 x = x
<a name="line-636"></a>  So f2 gets the type f2 :: forall a. a -&gt; a, with 'a' Specified
<a name="line-637"></a>  even though 'a' is not bound in the source code by an explicit forall
<a name="line-638"></a>
<a name="line-639"></a>* Specified.  Function defn, with signature (explicit forall):
<a name="line-640"></a>     f3 :: forall a. a -&gt; a; f3 x = x
<a name="line-641"></a>  So f3 gets the type f3 :: forall a. a -&gt; a, with 'a' Specified
<a name="line-642"></a>
<a name="line-643"></a>* Inferred/Specified.  Function signature with inferred kind polymorphism.
<a name="line-644"></a>     f4 :: a b -&gt; Int
<a name="line-645"></a>  So 'f4' gets the type f4 :: forall {k} (a:k-&gt;*) (b:k). a b -&gt; Int
<a name="line-646"></a>  Here 'k' is Inferred (it's not mentioned in the type),
<a name="line-647"></a>  but 'a' and 'b' are Specified.
<a name="line-648"></a>
<a name="line-649"></a>* Specified.  Function signature with explicit kind polymorphism
<a name="line-650"></a>     f5 :: a (b :: k) -&gt; Int
<a name="line-651"></a>  This time 'k' is Specified, because it is mentioned explicitly,
<a name="line-652"></a>  so we get f5 :: forall (k:*) (a:k-&gt;*) (b:k). a b -&gt; Int
<a name="line-653"></a>
<a name="line-654"></a>* Similarly pattern synonyms:
<a name="line-655"></a>  Inferred - from inferred types (e.g. no pattern type signature)
<a name="line-656"></a>           - or from inferred kind polymorphism
<a name="line-657"></a>
<a name="line-658"></a>---- In type declarations ----
<a name="line-659"></a>
<a name="line-660"></a>* Inferred (k)
<a name="line-661"></a>     data T1 a b = MkT1 (a b)
<a name="line-662"></a>  Here T1's kind is  T1 :: forall {k:*}. (k-&gt;*) -&gt; k -&gt; *
<a name="line-663"></a>  The kind variable 'k' is Inferred, since it is not mentioned
<a name="line-664"></a>
<a name="line-665"></a>  Note that 'a' and 'b' correspond to /Anon/ TyCoBinders in T1's kind,
<a name="line-666"></a>  and Anon binders don't have a visibility flag. (Or you could think
<a name="line-667"></a>  of Anon having an implicit Required flag.)
<a name="line-668"></a>
<a name="line-669"></a>* Specified (k)
<a name="line-670"></a>     data T2 (a::k-&gt;*) b = MkT (a b)
<a name="line-671"></a>  Here T's kind is  T :: forall (k:*). (k-&gt;*) -&gt; k -&gt; *
<a name="line-672"></a>  The kind variable 'k' is Specified, since it is mentioned in
<a name="line-673"></a>  the signature.
<a name="line-674"></a>
<a name="line-675"></a>* Required (k)
<a name="line-676"></a>     data T k (a::k-&gt;*) b = MkT (a b)
<a name="line-677"></a>  Here T's kind is  T :: forall k:* -&gt; (k-&gt;*) -&gt; k -&gt; *
<a name="line-678"></a>  The kind is Required, since it bound in a positional way in T's declaration
<a name="line-679"></a>  Every use of T must be explicitly applied to a kind
<a name="line-680"></a>
<a name="line-681"></a>* Inferred (k1), Specified (k)
<a name="line-682"></a>     data T a b (c :: k) = MkT (a b) (Proxy c)
<a name="line-683"></a>  Here T's kind is  T :: forall {k1:*} (k:*). (k1-&gt;*) -&gt; k1 -&gt; k -&gt; *
<a name="line-684"></a>  So 'k' is Specified, because it appears explicitly,
<a name="line-685"></a>  but 'k1' is Inferred, because it does not
<a name="line-686"></a>
<a name="line-687"></a>Generally, in the list of TyConBinders for a TyCon,
<a name="line-688"></a>
<a name="line-689"></a>* Inferred arguments always come first
<a name="line-690"></a>* Specified, Anon and Required can be mixed
<a name="line-691"></a>
<a name="line-692"></a>e.g.
<a name="line-693"></a>  data Foo (a :: Type) :: forall b. (a -&gt; b -&gt; Type) -&gt; Type where ...
<a name="line-694"></a>
<a name="line-695"></a>Here Foo's TyConBinders are
<a name="line-696"></a>   [Required 'a', Specified 'b', Anon]
<a name="line-697"></a>and its kind prints as
<a name="line-698"></a>   Foo :: forall a -&gt; forall b. (a -&gt; b -&gt; Type) -&gt; Type
<a name="line-699"></a>
<a name="line-700"></a>See also Note [Required, Specified, and Inferred for types] in TcTyClsDecls
<a name="line-701"></a>
<a name="line-702"></a>---- Printing -----
<a name="line-703"></a>
<a name="line-704"></a> We print forall types with enough syntax to tell you their visibility
<a name="line-705"></a> flag.  But this is not source Haskell, and these types may not all
<a name="line-706"></a> be parsable.
<a name="line-707"></a>
<a name="line-708"></a> Specified: a list of Specified binders is written between `forall` and `.`:
<a name="line-709"></a>               const :: forall a b. a -&gt; b -&gt; a
<a name="line-710"></a>
<a name="line-711"></a> Inferred:  with -fprint-explicit-foralls, Inferred binders are written
<a name="line-712"></a>            in braces:
<a name="line-713"></a>               f :: forall {k} (a:k). S k a -&gt; Int
<a name="line-714"></a>            Otherwise, they are printed like Specified binders.
<a name="line-715"></a>
<a name="line-716"></a> Required: binders are put between `forall` and `-&gt;`:
<a name="line-717"></a>              T :: forall k -&gt; *
<a name="line-718"></a>
<a name="line-719"></a>---- Other points -----
<a name="line-720"></a>
<a name="line-721"></a>* In classic Haskell, all named binders (that is, the type variables in
<a name="line-722"></a>  a polymorphic function type f :: forall a. a -&gt; a) have been Inferred.
<a name="line-723"></a>
<a name="line-724"></a>* Inferred variables correspond to "generalized" variables from the
<a name="line-725"></a>  Visible Type Applications paper (ESOP'16).
<a name="line-726"></a>
<a name="line-727"></a>Note [No Required TyCoBinder in terms]
<a name="line-728"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-729"></a>We don't allow Required foralls for term variables, including pattern
<a name="line-730"></a>synonyms and data constructors.  Why?  Because then an application
<a name="line-731"></a>would need a /compulsory/ type argument (possibly without an "@"?),
<a name="line-732"></a>thus (f Int); and we don't have concrete syntax for that.
<a name="line-733"></a>
<a name="line-734"></a>We could change this decision, but Required, Named TyCoBinders are rare
<a name="line-735"></a>anyway.  (Most are Anons.)
<a name="line-736"></a>
<a name="line-737"></a>However the type of a term can (just about) have a required quantifier;
<a name="line-738"></a>see Note [Required quantifiers in the type of a term] in TcExpr.
<a name="line-739"></a>-}</span>
<a name="line-740"></a>
<a name="line-741"></a>
<a name="line-742"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-743"></a>*                                                                       *
<a name="line-744"></a>                        PredType
<a name="line-745"></a>*                                                                       *
<a name="line-746"></a>********************************************************************** -}</span>
<a name="line-747"></a>
<a name="line-748"></a>
<a name="line-749"></a><a name="PredType"></a><span class='hs-comment'>-- | A type of the form @p@ of kind @Constraint@ represents a value whose type is</span>
<a name="line-750"></a><a name="PredType"></a><span class='hs-comment'>-- the Haskell predicate @p@, where a predicate is what occurs before</span>
<a name="line-751"></a><a name="PredType"></a><span class='hs-comment'>-- the @=&gt;@ in a Haskell type.</span>
<a name="line-752"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-753"></a><a name="PredType"></a><span class='hs-comment'>-- We use 'PredType' as documentation to mark those types that we guarantee to have</span>
<a name="line-754"></a><a name="PredType"></a><span class='hs-comment'>-- this kind.</span>
<a name="line-755"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-756"></a><a name="PredType"></a><span class='hs-comment'>-- It can be expanded into its representation, but:</span>
<a name="line-757"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-758"></a><a name="PredType"></a><span class='hs-comment'>-- * The type checker must treat it as opaque</span>
<a name="line-759"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-760"></a><a name="PredType"></a><span class='hs-comment'>-- * The rest of the compiler treats it as transparent</span>
<a name="line-761"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-762"></a><a name="PredType"></a><span class='hs-comment'>-- Consider these examples:</span>
<a name="line-763"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-764"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; f :: (Eq a) =&gt; a -&gt; Int</span>
<a name="line-765"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; g :: (?x :: Int -&gt; Int) =&gt; a -&gt; Int</span>
<a name="line-766"></a><a name="PredType"></a><span class='hs-comment'>-- &gt; h :: (r\l) =&gt; {r} =&gt; {l::Int | r}</span>
<a name="line-767"></a><a name="PredType"></a><span class='hs-comment'>--</span>
<a name="line-768"></a><a name="PredType"></a><span class='hs-comment'>-- Here the @Eq a@ and @?x :: Int -&gt; Int@ and @r\l@ are all called \"predicates\"</span>
<a name="line-769"></a><a name="PredType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>PredType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Type</span>
<a name="line-770"></a>
<a name="line-771"></a><a name="ThetaType"></a><span class='hs-comment'>-- | A collection of 'PredType's</span>
<a name="line-772"></a><a name="ThetaType"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-773"></a>
<a name="line-774"></a><span class='hs-comment'>{-
<a name="line-775"></a>(We don't support TREX records yet, but the setup is designed
<a name="line-776"></a>to expand to allow them.)
<a name="line-777"></a>
<a name="line-778"></a>A Haskell qualified type, such as that for f,g,h above, is
<a name="line-779"></a>represented using
<a name="line-780"></a>        * a FunTy for the double arrow
<a name="line-781"></a>        * with a type of kind Constraint as the function argument
<a name="line-782"></a>
<a name="line-783"></a>The predicate really does turn into a real extra argument to the
<a name="line-784"></a>function.  If the argument has type (p :: Constraint) then the predicate p is
<a name="line-785"></a>represented by evidence of type p.
<a name="line-786"></a>
<a name="line-787"></a>
<a name="line-788"></a>%************************************************************************
<a name="line-789"></a>%*                                                                      *
<a name="line-790"></a>            Simple constructors
<a name="line-791"></a>%*                                                                      *
<a name="line-792"></a>%************************************************************************
<a name="line-793"></a>
<a name="line-794"></a>These functions are here so that they can be used by TysPrim,
<a name="line-795"></a>which in turn is imported by Type
<a name="line-796"></a>-}</span>
<a name="line-797"></a>
<a name="line-798"></a><a name="mkTyVarTy"></a><span class='hs-definition'>mkTyVarTy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-799"></a><span class='hs-definition'>mkTyVarTy</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-800"></a>              <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span>
<a name="line-801"></a>
<a name="line-802"></a><a name="mkTyVarTys"></a><span class='hs-definition'>mkTyVarTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-803"></a><span class='hs-definition'>mkTyVarTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-comment'>-- a common use of mkTyVarTy</span>
<a name="line-804"></a>
<a name="line-805"></a><a name="mkTyCoVarTy"></a><span class='hs-definition'>mkTyCoVarTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-806"></a><span class='hs-definition'>mkTyCoVarTy</span> <span class='hs-varid'>v</span>
<a name="line-807"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-808"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span>
<a name="line-809"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-811"></a>
<a name="line-812"></a><a name="mkTyCoVarTys"></a><span class='hs-definition'>mkTyCoVarTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-813"></a><span class='hs-definition'>mkTyCoVarTys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkTyCoVarTy</span>
<a name="line-814"></a>
<a name="line-815"></a><span class='hs-keyword'>infixr</span> <span class='hs-num'>3</span> <span class='hs-varop'>`mkFunTy`</span>      <span class='hs-comment'>-- Associates to the right</span>
<a name="line-816"></a><a name="mkFunTy"></a><span class='hs-comment'>-- | Make an arrow type</span>
<a name="line-817"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-818"></a><span class='hs-definition'>mkFunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span>
<a name="line-819"></a>
<a name="line-820"></a><a name="mkFunTys"></a><span class='hs-comment'>-- | Make nested arrow types</span>
<a name="line-821"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-822"></a><span class='hs-definition'>mkFunTys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkFunTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span>
<a name="line-823"></a>
<a name="line-824"></a><a name="mkTyCoForAllTy"></a><span class='hs-comment'>-- | If tv is a coercion variable and it is not used in the body, returns</span>
<a name="line-825"></a><span class='hs-comment'>-- a FunTy, otherwise makes a forall type.</span>
<a name="line-826"></a><span class='hs-comment'>-- See Note [Unused coercion variable in ForAllTy]</span>
<a name="line-827"></a><span class='hs-definition'>mkTyCoForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-828"></a><span class='hs-definition'>mkTyCoForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>ty</span>
<a name="line-829"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>tv</span>
<a name="line-830"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-831"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>vis</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Inferred</span> <span class='hs-layout'>)</span>
<a name="line-832"></a>    <span class='hs-varid'>mkFunTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-833"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-834"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-835"></a>
<a name="line-836"></a><a name="mkForAllTy"></a><span class='hs-comment'>-- | Like 'mkTyCoForAllTy', but does not check the occurrence of the binder</span>
<a name="line-837"></a><span class='hs-comment'>-- See Note [Unused coercion variable in ForAllTy]</span>
<a name="line-838"></a><span class='hs-definition'>mkForAllTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ArgFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-839"></a><span class='hs-definition'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-840"></a>
<a name="line-841"></a><a name="mkForAllTys"></a><span class='hs-comment'>-- | Wraps foralls over the type using the provided 'TyCoVar's from left to right</span>
<a name="line-842"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-843"></a><span class='hs-definition'>mkForAllTys</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tyvars</span>
<a name="line-844"></a>
<a name="line-845"></a><a name="mkTyCoPiTy"></a><span class='hs-definition'>mkTyCoPiTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-846"></a><span class='hs-definition'>mkTyCoPiTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-847"></a><span class='hs-definition'>mkTyCoPiTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyCoForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>ty</span>
<a name="line-848"></a>
<a name="line-849"></a><a name="mkPiTy"></a><span class='hs-comment'>-- | Like 'mkTyCoPiTy', but does not check the occurrence of the binder</span>
<a name="line-850"></a><span class='hs-definition'>mkPiTy</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-851"></a><span class='hs-definition'>mkPiTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-852"></a><span class='hs-definition'>mkPiTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span> <span class='hs-varid'>ty</span>
<a name="line-853"></a>
<a name="line-854"></a><a name="mkTyCoPiTys"></a><span class='hs-definition'>mkTyCoPiTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-855"></a><span class='hs-definition'>mkTyCoPiTys</span> <span class='hs-varid'>tbs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkTyCoPiTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tbs</span>
<a name="line-856"></a>
<a name="line-857"></a><a name="mkPiTys"></a><span class='hs-comment'>-- | Like 'mkTyCoPiTys', but does not check the occurrence of the binder</span>
<a name="line-858"></a><span class='hs-definition'>mkPiTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-859"></a><span class='hs-definition'>mkPiTys</span> <span class='hs-varid'>tbs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>mkPiTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tbs</span>
<a name="line-860"></a>
<a name="line-861"></a><a name="mkTyConTy"></a><span class='hs-comment'>-- | Create the plain type constructor type which has been applied to no type arguments at all.</span>
<a name="line-862"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-863"></a><span class='hs-definition'>mkTyConTy</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-conid'>[]</span>
<a name="line-864"></a>
<a name="line-865"></a><span class='hs-comment'>{-
<a name="line-866"></a>Some basic functions, put here to break loops eg with the pretty printer
<a name="line-867"></a>-}</span>
<a name="line-868"></a>
<a name="line-869"></a><a name="kindRep"></a><span class='hs-comment'>-- | Extract the RuntimeRep classifier of a type from its kind. For example,</span>
<a name="line-870"></a><span class='hs-comment'>-- @kindRep * = LiftedRep@; Panics if this is not possible.</span>
<a name="line-871"></a><span class='hs-comment'>-- Treats * and Constraint as the same</span>
<a name="line-872"></a><span class='hs-definition'>kindRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-873"></a><span class='hs-definition'>kindRep</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>k</span> <span class='hs-keyword'>of</span>
<a name="line-874"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span>
<a name="line-875"></a>              <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"kindRep"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-876"></a>
<a name="line-877"></a><a name="kindRep_maybe"></a><span class='hs-comment'>-- | Given a kind (TYPE rr), extract its RuntimeRep classifier rr.</span>
<a name="line-878"></a><span class='hs-comment'>-- For example, @kindRep_maybe * = Just LiftedRep@</span>
<a name="line-879"></a><span class='hs-comment'>-- Returns 'Nothing' if the kind is not of form (TYPE rr)</span>
<a name="line-880"></a><span class='hs-comment'>-- Treats * and Constraint as the same</span>
<a name="line-881"></a><span class='hs-definition'>kindRep_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-882"></a><span class='hs-definition'>kindRep_maybe</span> <span class='hs-varid'>kind</span>
<a name="line-883"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>kind'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>kind'</span>
<a name="line-884"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kind</span>
<a name="line-885"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>tYPETyConKey</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg</span>
<a name="line-886"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-887"></a>
<a name="line-888"></a><a name="isLiftedTypeKind"></a><span class='hs-comment'>-- | This version considers Constraint to be the same as *. Returns True</span>
<a name="line-889"></a><span class='hs-comment'>-- if the argument is equivalent to Type/Constraint and False otherwise.</span>
<a name="line-890"></a><span class='hs-comment'>-- See Note [Kind Constraint and kind Type]</span>
<a name="line-891"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-892"></a><span class='hs-definition'>isLiftedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-893"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-894"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isLiftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-895"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-896"></a>
<a name="line-897"></a><a name="isUnliftedTypeKind"></a><span class='hs-comment'>-- | Returns True if the kind classifies unlifted types and False otherwise.</span>
<a name="line-898"></a><span class='hs-comment'>-- Note that this returns False for levity-polymorphic kinds, which may</span>
<a name="line-899"></a><span class='hs-comment'>-- be specialized to a kind that classifies unlifted types.</span>
<a name="line-900"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-901"></a><span class='hs-definition'>isUnliftedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-902"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>kindRep_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-903"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rep</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isUnliftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-904"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-905"></a>
<a name="line-906"></a><a name="isLiftedRuntimeRep"></a><span class='hs-definition'>isLiftedRuntimeRep</span><span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedRuntimeRep</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-907"></a><span class='hs-comment'>-- isLiftedRuntimeRep is true of LiftedRep :: RuntimeRep</span>
<a name="line-908"></a><span class='hs-comment'>-- Similarly isUnliftedRuntimeRep</span>
<a name="line-909"></a><span class='hs-definition'>isLiftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-910"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rep'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>rep</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isLiftedRuntimeRep</span> <span class='hs-varid'>rep'</span>
<a name="line-911"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>rr_tc</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rep</span>
<a name="line-912"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>rr_tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>liftedRepDataConKey</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-913"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-914"></a>
<a name="line-915"></a><a name="isUnliftedRuntimeRep"></a><span class='hs-definition'>isUnliftedRuntimeRep</span> <span class='hs-varid'>rep</span>
<a name="line-916"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>rep'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>rep</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isUnliftedRuntimeRep</span> <span class='hs-varid'>rep'</span>
<a name="line-917"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>rr_tc</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rep</span>
<a name="line-918"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isUnliftedRuntimeRepTyCon</span> <span class='hs-varid'>rr_tc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>null</span> <span class='hs-varid'>args</span> <span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-919"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-920"></a>
<a name="line-921"></a><a name="isUnliftedRuntimeRepTyCon"></a><span class='hs-definition'>isUnliftedRuntimeRepTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-922"></a><span class='hs-definition'>isUnliftedRuntimeRepTyCon</span> <span class='hs-varid'>rr_tc</span>
<a name="line-923"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>elem</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>rr_tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>unliftedRepDataConKeys</span>
<a name="line-924"></a>
<a name="line-925"></a><a name="isRuntimeRepTy"></a><span class='hs-comment'>-- | Is this the type 'RuntimeRep'?</span>
<a name="line-926"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-927"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varid'>ty'</span>
<a name="line-928"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>runtimeRepTyConKey</span>
<a name="line-929"></a><span class='hs-definition'>isRuntimeRepTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-930"></a>
<a name="line-931"></a><a name="isRuntimeRepVar"></a><span class='hs-comment'>-- | Is a tyvar of type 'RuntimeRep'?</span>
<a name="line-932"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-933"></a><span class='hs-definition'>isRuntimeRepVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRuntimeRepTy</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarKind</span>
<a name="line-934"></a>
<a name="line-935"></a><span class='hs-comment'>{-
<a name="line-936"></a>%************************************************************************
<a name="line-937"></a>%*                                                                      *
<a name="line-938"></a>            Coercions
<a name="line-939"></a>%*                                                                      *
<a name="line-940"></a>%************************************************************************
<a name="line-941"></a>-}</span>
<a name="line-942"></a>
<a name="line-943"></a><span class='hs-comment'>-- | A 'Coercion' is concrete evidence of the equality/convertibility</span>
<a name="line-944"></a><span class='hs-comment'>-- of two types.</span>
<a name="line-945"></a>
<a name="line-946"></a><a name="Coercion"></a><span class='hs-comment'>-- If you edit this type, you may need to update the GHC formalism</span>
<a name="line-947"></a><a name="Coercion"></a><span class='hs-comment'>-- See Note [GHC Formalism] in coreSyn/CoreLint.hs</span>
<a name="line-948"></a><a name="Coercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Coercion</span>
<a name="line-949"></a>  <span class='hs-comment'>-- Each constructor has a "role signature", indicating the way roles are</span>
<a name="line-950"></a>  <span class='hs-comment'>-- propagated through coercions.</span>
<a name="line-951"></a>  <span class='hs-comment'>--    -  P, N, and R stand for coercions of the given role</span>
<a name="line-952"></a>  <span class='hs-comment'>--    -  e stands for a coercion of a specific unknown role</span>
<a name="line-953"></a>  <span class='hs-comment'>--           (think "role polymorphism")</span>
<a name="line-954"></a>  <span class='hs-comment'>--    -  "e" stands for an explicit role parameter indicating role e.</span>
<a name="line-955"></a>  <span class='hs-comment'>--    -   _ stands for a parameter that is not a Role or Coercion.</span>
<a name="line-956"></a>
<a name="line-957"></a>  <span class='hs-comment'>-- These ones mirror the shape of types</span>
<a name="line-958"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- Refl :: _ -&gt; N</span>
<a name="line-959"></a>    <span class='hs-conid'>Refl</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-960"></a>          <span class='hs-comment'>-- Invariant: applications of (Refl T) to a bunch of identity coercions</span>
<a name="line-961"></a>          <span class='hs-comment'>--            always show up as Refl.</span>
<a name="line-962"></a>          <span class='hs-comment'>-- For example  (Refl T) (Refl a) (Refl b) shows up as (Refl (T a b)).</span>
<a name="line-963"></a>
<a name="line-964"></a>          <span class='hs-comment'>-- Applications of (Refl T) to some coercions, at least one of</span>
<a name="line-965"></a>          <span class='hs-comment'>-- which is NOT the identity, show up as TyConAppCo.</span>
<a name="line-966"></a>          <span class='hs-comment'>-- (They may not be fully saturated however.)</span>
<a name="line-967"></a>          <span class='hs-comment'>-- ConAppCo coercions (like all coercions other than Refl)</span>
<a name="line-968"></a>          <span class='hs-comment'>-- are NEVER the identity.</span>
<a name="line-969"></a>
<a name="line-970"></a>          <span class='hs-comment'>-- Use (GRefl Representational ty MRefl), not (SubCo (Refl ty))</span>
<a name="line-971"></a>
<a name="line-972"></a>  <span class='hs-comment'>-- GRefl :: "e" -&gt; _ -&gt; Maybe N -&gt; e</span>
<a name="line-973"></a>  <span class='hs-comment'>-- See Note [Generalized reflexive coercion]</span>
<a name="line-974"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>GRefl</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>MCoercionN</span>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-975"></a>          <span class='hs-comment'>-- Use (Refl ty), not (GRefl Nominal ty MRefl)</span>
<a name="line-976"></a>          <span class='hs-comment'>-- Use (GRefl Representational _ _), not (SubCo (GRefl Nominal _ _))</span>
<a name="line-977"></a>
<a name="line-978"></a>  <span class='hs-comment'>-- These ones simply lift the correspondingly-named</span>
<a name="line-979"></a>  <span class='hs-comment'>-- Type constructors into Coercions</span>
<a name="line-980"></a>
<a name="line-981"></a>  <span class='hs-comment'>-- TyConAppCo :: "e" -&gt; _ -&gt; ?? -&gt; e</span>
<a name="line-982"></a>  <span class='hs-comment'>-- See Note [TyConAppCo roles]</span>
<a name="line-983"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- lift TyConApp</span>
<a name="line-984"></a>               <span class='hs-comment'>-- The TyCon is never a synonym;</span>
<a name="line-985"></a>               <span class='hs-comment'>-- we expand synonyms eagerly</span>
<a name="line-986"></a>               <span class='hs-comment'>-- But it can be a type function</span>
<a name="line-987"></a>
<a name="line-988"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AppCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>CoercionN</span>             <span class='hs-comment'>-- lift AppTy</span>
<a name="line-989"></a>          <span class='hs-comment'>-- AppCo :: e -&gt; N -&gt; e</span>
<a name="line-990"></a>
<a name="line-991"></a>  <span class='hs-comment'>-- See Note [Forall coercions]</span>
<a name="line-992"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-conid'>Coercion</span>
<a name="line-993"></a>         <span class='hs-comment'>-- ForAllCo :: _ -&gt; N -&gt; e -&gt; e</span>
<a name="line-994"></a>
<a name="line-995"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FunCo</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>         <span class='hs-comment'>-- lift FunTy</span>
<a name="line-996"></a>         <span class='hs-comment'>-- FunCo :: "e" -&gt; e -&gt; e -&gt; e</span>
<a name="line-997"></a>
<a name="line-998"></a>  <span class='hs-comment'>-- These are special</span>
<a name="line-999"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-conid'>CoVar</span>      <span class='hs-comment'>-- :: _ -&gt; (N or R)</span>
<a name="line-1000"></a>                       <span class='hs-comment'>-- result role depends on the tycon of the variable's type</span>
<a name="line-1001"></a>
<a name="line-1002"></a>    <span class='hs-comment'>-- AxiomInstCo :: e -&gt; _ -&gt; [N] -&gt; e</span>
<a name="line-1003"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span><span class='hs-layout'>)</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-1004"></a>     <span class='hs-comment'>-- See also [CoAxiom index]</span>
<a name="line-1005"></a>     <span class='hs-comment'>-- The coercion arguments always *precisely* saturate</span>
<a name="line-1006"></a>     <span class='hs-comment'>-- arity of (that branch of) the CoAxiom. If there are</span>
<a name="line-1007"></a>     <span class='hs-comment'>-- any left over, we use AppCo.</span>
<a name="line-1008"></a>     <span class='hs-comment'>-- See [Coercion axioms applied to coercions]</span>
<a name="line-1009"></a>
<a name="line-1010"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-1011"></a>    <span class='hs-comment'>-- AxiomRuleCo is very like AxiomInstCo, but for a CoAxiomRule</span>
<a name="line-1012"></a>    <span class='hs-comment'>-- The number coercions should match exactly the expectations</span>
<a name="line-1013"></a>    <span class='hs-comment'>-- of the CoAxiomRule (i.e., the rule is fully saturated).</span>
<a name="line-1014"></a>
<a name="line-1015"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>UnivCo</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-conid'>Role</span> <span class='hs-conid'>Type</span> <span class='hs-conid'>Type</span>
<a name="line-1016"></a>      <span class='hs-comment'>-- :: _ -&gt; "e" -&gt; _ -&gt; _ -&gt; e</span>
<a name="line-1017"></a>
<a name="line-1018"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SymCo</span> <span class='hs-conid'>Coercion</span>             <span class='hs-comment'>-- :: e -&gt; e</span>
<a name="line-1019"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>TransCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- :: e -&gt; e -&gt; e</span>
<a name="line-1020"></a>
<a name="line-1021"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NthCo</span>  <span class='hs-conid'>Role</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- Zero-indexed; decomposes (T t0 ... tn)</span>
<a name="line-1022"></a>    <span class='hs-comment'>-- :: "e" -&gt; _ -&gt; e0 -&gt; e (inverse of TyConAppCo, see Note [TyConAppCo roles])</span>
<a name="line-1023"></a>    <span class='hs-comment'>-- Using NthCo on a ForAllCo gives an N coercion always</span>
<a name="line-1024"></a>    <span class='hs-comment'>-- See Note [NthCo and newtypes]</span>
<a name="line-1025"></a>    <span class='hs-comment'>--</span>
<a name="line-1026"></a>    <span class='hs-comment'>-- Invariant:  (NthCo r i co), it is always the case that r = role of (Nth i co)</span>
<a name="line-1027"></a>    <span class='hs-comment'>-- That is: the role of the entire coercion is redundantly cached here.</span>
<a name="line-1028"></a>    <span class='hs-comment'>-- See Note [NthCo Cached Roles]</span>
<a name="line-1029"></a>
<a name="line-1030"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LRCo</span>   <span class='hs-conid'>LeftOrRight</span> <span class='hs-conid'>CoercionN</span>     <span class='hs-comment'>-- Decomposes (t_left t_right)</span>
<a name="line-1031"></a>    <span class='hs-comment'>-- :: _ -&gt; N -&gt; N</span>
<a name="line-1032"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InstCo</span> <span class='hs-conid'>Coercion</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1033"></a>    <span class='hs-comment'>-- :: e -&gt; N -&gt; e</span>
<a name="line-1034"></a>    <span class='hs-comment'>-- See Note [InstCo roles]</span>
<a name="line-1035"></a>
<a name="line-1036"></a>  <span class='hs-comment'>-- Extract a kind coercion from a (heterogeneous) type coercion</span>
<a name="line-1037"></a>  <span class='hs-comment'>-- NB: all kind coercions are Nominal</span>
<a name="line-1038"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>KindCo</span> <span class='hs-conid'>Coercion</span>
<a name="line-1039"></a>     <span class='hs-comment'>-- :: e -&gt; N</span>
<a name="line-1040"></a>
<a name="line-1041"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>SubCo</span> <span class='hs-conid'>CoercionN</span>                  <span class='hs-comment'>-- Turns a ~N into a ~R</span>
<a name="line-1042"></a>    <span class='hs-comment'>-- :: N -&gt; R</span>
<a name="line-1043"></a>
<a name="line-1044"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HoleCo</span> <span class='hs-conid'>CoercionHole</span>              <span class='hs-comment'>-- ^ See Note [Coercion holes]</span>
<a name="line-1045"></a>                                     <span class='hs-comment'>-- Only present during typechecking</span>
<a name="line-1046"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data.Data</span>
<a name="line-1047"></a>
<a name="line-1048"></a><a name="CoercionN"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always nominal</span>
<a name="line-1049"></a><a name="CoercionR"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always representational</span>
<a name="line-1050"></a><a name="CoercionP"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CoercionP</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Coercion</span>       <span class='hs-comment'>-- always phantom</span>
<a name="line-1051"></a><a name="KindCoercion"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionN</span>   <span class='hs-comment'>-- always nominal</span>
<a name="line-1052"></a>
<a name="line-1053"></a><a name="MCoercion"></a><span class='hs-comment'>-- | A semantically more meaningful type to represent what may or may not be a</span>
<a name="line-1054"></a><a name="MCoercion"></a><span class='hs-comment'>-- useful 'Coercion'.</span>
<a name="line-1055"></a><a name="MCoercion"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MCoercion</span>
<a name="line-1056"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-1057"></a>    <span class='hs-comment'>-- A trivial Reflexivity coercion</span>
<a name="line-1058"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>MCo</span> <span class='hs-conid'>Coercion</span>
<a name="line-1059"></a>    <span class='hs-comment'>-- Other coercions</span>
<a name="line-1060"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data.Data</span>
<a name="line-1061"></a><a name="MCoercionR"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MCoercionR</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCoercion</span>
<a name="line-1062"></a><a name="MCoercionN"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MCoercionN</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCoercion</span>
<a name="line-1063"></a>
<a name="line-1064"></a><a name="instance%20Outputable%20MCoercion"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyword'>where</span>
<a name="line-1065"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"MRefl"</span>
<a name="line-1066"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"MCo"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-1067"></a>
<a name="line-1068"></a><span class='hs-comment'>{-
<a name="line-1069"></a>Note [Refl invariant]
<a name="line-1070"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1071"></a>Invariant 1:
<a name="line-1072"></a>
<a name="line-1073"></a>Coercions have the following invariant
<a name="line-1074"></a>     Refl (similar for GRefl r ty MRefl) is always lifted as far as possible.
<a name="line-1075"></a>
<a name="line-1076"></a>You might think that a consequencs is:
<a name="line-1077"></a>     Every identity coercions has Refl at the root
<a name="line-1078"></a>
<a name="line-1079"></a>But that's not quite true because of coercion variables.  Consider
<a name="line-1080"></a>     g         where g :: Int~Int
<a name="line-1081"></a>     Left h    where h :: Maybe Int ~ Maybe Int
<a name="line-1082"></a>etc.  So the consequence is only true of coercions that
<a name="line-1083"></a>have no coercion variables.
<a name="line-1084"></a>
<a name="line-1085"></a>Note [Generalized reflexive coercion]
<a name="line-1086"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1087"></a>
<a name="line-1088"></a>GRefl is a generalized reflexive coercion (see Trac #15192). It wraps a kind
<a name="line-1089"></a>coercion, which might be reflexive (MRefl) or any coercion (MCo co). The typing
<a name="line-1090"></a>rules for GRefl:
<a name="line-1091"></a>
<a name="line-1092"></a>  ty : k1
<a name="line-1093"></a>  ------------------------------------
<a name="line-1094"></a>  GRefl r ty MRefl: ty ~r ty
<a name="line-1095"></a>
<a name="line-1096"></a>  ty : k1       co :: k1 ~ k2
<a name="line-1097"></a>  ------------------------------------
<a name="line-1098"></a>  GRefl r ty (MCo co) : ty ~r ty |&gt; co
<a name="line-1099"></a>
<a name="line-1100"></a>Consider we have
<a name="line-1101"></a>
<a name="line-1102"></a>   g1 :: s ~r t
<a name="line-1103"></a>   s  :: k1
<a name="line-1104"></a>   g2 :: k1 ~ k2
<a name="line-1105"></a>
<a name="line-1106"></a>and we want to construct a coercions co which has type
<a name="line-1107"></a>
<a name="line-1108"></a>   (s |&gt; g2) ~r t
<a name="line-1109"></a>
<a name="line-1110"></a>We can define
<a name="line-1111"></a>
<a name="line-1112"></a>   co = Sym (GRefl r s g2) ; g1
<a name="line-1113"></a>
<a name="line-1114"></a>It is easy to see that
<a name="line-1115"></a>
<a name="line-1116"></a>   Refl == GRefl Nominal ty MRefl :: ty ~n ty
<a name="line-1117"></a>
<a name="line-1118"></a>A nominal reflexive coercion is quite common, so we keep the special form Refl to
<a name="line-1119"></a>save allocation.
<a name="line-1120"></a>
<a name="line-1121"></a>Note [Coercion axioms applied to coercions]
<a name="line-1122"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1123"></a>The reason coercion axioms can be applied to coercions and not just
<a name="line-1124"></a>types is to allow for better optimization.  There are some cases where
<a name="line-1125"></a>we need to be able to "push transitivity inside" an axiom in order to
<a name="line-1126"></a>expose further opportunities for optimization.
<a name="line-1127"></a>
<a name="line-1128"></a>For example, suppose we have
<a name="line-1129"></a>
<a name="line-1130"></a>  C a : t[a] ~ F a
<a name="line-1131"></a>  g   : b ~ c
<a name="line-1132"></a>
<a name="line-1133"></a>and we want to optimize
<a name="line-1134"></a>
<a name="line-1135"></a>  sym (C b) ; t[g] ; C c
<a name="line-1136"></a>
<a name="line-1137"></a>which has the kind
<a name="line-1138"></a>
<a name="line-1139"></a>  F b ~ F c
<a name="line-1140"></a>
<a name="line-1141"></a>(stopping through t[b] and t[c] along the way).
<a name="line-1142"></a>
<a name="line-1143"></a>We'd like to optimize this to just F g -- but how?  The key is
<a name="line-1144"></a>that we need to allow axioms to be instantiated by *coercions*,
<a name="line-1145"></a>not just by types.  Then we can (in certain cases) push
<a name="line-1146"></a>transitivity inside the axiom instantiations, and then react
<a name="line-1147"></a>opposite-polarity instantiations of the same axiom.  In this
<a name="line-1148"></a>case, e.g., we match t[g] against the LHS of (C c)'s kind, to
<a name="line-1149"></a>obtain the substitution  a |-&gt; g  (note this operation is sort
<a name="line-1150"></a>of the dual of lifting!) and hence end up with
<a name="line-1151"></a>
<a name="line-1152"></a>  C g : t[b] ~ F c
<a name="line-1153"></a>
<a name="line-1154"></a>which indeed has the same kind as  t[g] ; C c.
<a name="line-1155"></a>
<a name="line-1156"></a>Now we have
<a name="line-1157"></a>
<a name="line-1158"></a>  sym (C b) ; C g
<a name="line-1159"></a>
<a name="line-1160"></a>which can be optimized to F g.
<a name="line-1161"></a>
<a name="line-1162"></a>Note [CoAxiom index]
<a name="line-1163"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-1164"></a>A CoAxiom has 1 or more branches. Each branch has contains a list
<a name="line-1165"></a>of the free type variables in that branch, the LHS type patterns,
<a name="line-1166"></a>and the RHS type for that branch. When we apply an axiom to a list
<a name="line-1167"></a>of coercions, we must choose which branch of the axiom we wish to
<a name="line-1168"></a>use, as the different branches may have different numbers of free
<a name="line-1169"></a>type variables. (The number of type patterns is always the same
<a name="line-1170"></a>among branches, but that doesn't quite concern us here.)
<a name="line-1171"></a>
<a name="line-1172"></a>The Int in the AxiomInstCo constructor is the 0-indexed number
<a name="line-1173"></a>of the chosen branch.
<a name="line-1174"></a>
<a name="line-1175"></a>Note [Forall coercions]
<a name="line-1176"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1177"></a>Constructing coercions between forall-types can be a bit tricky,
<a name="line-1178"></a>because the kinds of the bound tyvars can be different.
<a name="line-1179"></a>
<a name="line-1180"></a>The typing rule is:
<a name="line-1181"></a>
<a name="line-1182"></a>
<a name="line-1183"></a>  kind_co : k1 ~ k2
<a name="line-1184"></a>  tv1:k1 |- co : t1 ~ t2
<a name="line-1185"></a>  -------------------------------------------------------------------
<a name="line-1186"></a>  ForAllCo tv1 kind_co co : all tv1:k1. t1  ~
<a name="line-1187"></a>                            all tv1:k2. (t2[tv1 |-&gt; tv1 |&gt; sym kind_co])
<a name="line-1188"></a>
<a name="line-1189"></a>First, the TyCoVar stored in a ForAllCo is really an optimisation: this field
<a name="line-1190"></a>should be a Name, as its kind is redundant. Thinking of the field as a Name
<a name="line-1191"></a>is helpful in understanding what a ForAllCo means.
<a name="line-1192"></a>The kind of TyCoVar always matches the left-hand kind of the coercion.
<a name="line-1193"></a>
<a name="line-1194"></a>The idea is that kind_co gives the two kinds of the tyvar. See how, in the
<a name="line-1195"></a>conclusion, tv1 is assigned kind k1 on the left but kind k2 on the right.
<a name="line-1196"></a>
<a name="line-1197"></a>Of course, a type variable can't have different kinds at the same time. So,
<a name="line-1198"></a>we arbitrarily prefer the first kind when using tv1 in the inner coercion
<a name="line-1199"></a>co, which shows that t1 equals t2.
<a name="line-1200"></a>
<a name="line-1201"></a>The last wrinkle is that we need to fix the kinds in the conclusion. In
<a name="line-1202"></a>t2, tv1 is assumed to have kind k1, but it has kind k2 in the conclusion of
<a name="line-1203"></a>the rule. So we do a kind-fixing substitution, replacing (tv1:k1) with
<a name="line-1204"></a>(tv1:k2) |&gt; sym kind_co. This substitution is slightly bizarre, because it
<a name="line-1205"></a>mentions the same name with different kinds, but it *is* well-kinded, noting
<a name="line-1206"></a>that `(tv1:k2) |&gt; sym kind_co` has kind k1.
<a name="line-1207"></a>
<a name="line-1208"></a>This all really would work storing just a Name in the ForAllCo. But we can't
<a name="line-1209"></a>add Names to, e.g., VarSets, and there generally is just an impedance mismatch
<a name="line-1210"></a>in a bunch of places. So we use tv1. When we need tv2, we can use
<a name="line-1211"></a>setTyVarKind.
<a name="line-1212"></a>
<a name="line-1213"></a>Note [Predicate coercions]
<a name="line-1214"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1215"></a>Suppose we have
<a name="line-1216"></a>   g :: a~b
<a name="line-1217"></a>How can we coerce between types
<a name="line-1218"></a>   ([c]~a) =&gt; [a] -&gt; c
<a name="line-1219"></a>and
<a name="line-1220"></a>   ([c]~b) =&gt; [b] -&gt; c
<a name="line-1221"></a>where the equality predicate *itself* differs?
<a name="line-1222"></a>
<a name="line-1223"></a>Answer: we simply treat (~) as an ordinary type constructor, so these
<a name="line-1224"></a>types really look like
<a name="line-1225"></a>
<a name="line-1226"></a>   ((~) [c] a) -&gt; [a] -&gt; c
<a name="line-1227"></a>   ((~) [c] b) -&gt; [b] -&gt; c
<a name="line-1228"></a>
<a name="line-1229"></a>So the coercion between the two is obviously
<a name="line-1230"></a>
<a name="line-1231"></a>   ((~) [c] g) -&gt; [g] -&gt; c
<a name="line-1232"></a>
<a name="line-1233"></a>Another way to see this to say that we simply collapse predicates to
<a name="line-1234"></a>their representation type (see Type.coreView and Type.predTypeRep).
<a name="line-1235"></a>
<a name="line-1236"></a>This collapse is done by mkPredCo; there is no PredCo constructor
<a name="line-1237"></a>in Coercion.  This is important because we need Nth to work on
<a name="line-1238"></a>predicates too:
<a name="line-1239"></a>    Nth 1 ((~) [c] g) = g
<a name="line-1240"></a>See Simplify.simplCoercionF, which generates such selections.
<a name="line-1241"></a>
<a name="line-1242"></a>Note [Roles]
<a name="line-1243"></a>~~~~~~~~~~~~
<a name="line-1244"></a>Roles are a solution to the GeneralizedNewtypeDeriving problem, articulated
<a name="line-1245"></a>in Trac #1496. The full story is in docs/core-spec/core-spec.pdf. Also, see
<a name="line-1246"></a><a href="http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation">http://ghc.haskell.org/trac/ghc/wiki/RolesImplementation</a>
<a name="line-1247"></a>
<a name="line-1248"></a>Here is one way to phrase the problem:
<a name="line-1249"></a>
<a name="line-1250"></a>Given:
<a name="line-1251"></a>newtype Age = MkAge Int
<a name="line-1252"></a>type family F x
<a name="line-1253"></a>type instance F Age = Bool
<a name="line-1254"></a>type instance F Int = Char
<a name="line-1255"></a>
<a name="line-1256"></a>This compiles down to:
<a name="line-1257"></a>axAge :: Age ~ Int
<a name="line-1258"></a>axF1 :: F Age ~ Bool
<a name="line-1259"></a>axF2 :: F Int ~ Char
<a name="line-1260"></a>
<a name="line-1261"></a>Then, we can make:
<a name="line-1262"></a>(sym (axF1) ; F axAge ; axF2) :: Bool ~ Char
<a name="line-1263"></a>
<a name="line-1264"></a>Yikes!
<a name="line-1265"></a>
<a name="line-1266"></a>The solution is _roles_, as articulated in "Generative Type Abstraction and
<a name="line-1267"></a>Type-level Computation" (POPL 2010), available at
<a name="line-1268"></a><a href="http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf">http://www.seas.upenn.edu/~sweirich/papers/popl163af-weirich.pdf</a>
<a name="line-1269"></a>
<a name="line-1270"></a>The specification for roles has evolved somewhat since that paper. For the
<a name="line-1271"></a>current full details, see the documentation in docs/core-spec. Here are some
<a name="line-1272"></a>highlights.
<a name="line-1273"></a>
<a name="line-1274"></a>We label every equality with a notion of type equivalence, of which there are
<a name="line-1275"></a>three options: Nominal, Representational, and Phantom. A ground type is
<a name="line-1276"></a>nominally equivalent only with itself. A newtype (which is considered a ground
<a name="line-1277"></a>type in Haskell) is representationally equivalent to its representation.
<a name="line-1278"></a>Anything is "phantomly" equivalent to anything else. We use "N", "R", and "P"
<a name="line-1279"></a>to denote the equivalences.
<a name="line-1280"></a>
<a name="line-1281"></a>The axioms above would be:
<a name="line-1282"></a>axAge :: Age ~R Int
<a name="line-1283"></a>axF1 :: F Age ~N Bool
<a name="line-1284"></a>axF2 :: F Age ~N Char
<a name="line-1285"></a>
<a name="line-1286"></a>Then, because transitivity applies only to coercions proving the same notion
<a name="line-1287"></a>of equivalence, the above construction is impossible.
<a name="line-1288"></a>
<a name="line-1289"></a>However, there is still an escape hatch: we know that any two types that are
<a name="line-1290"></a>nominally equivalent are representationally equivalent as well. This is what
<a name="line-1291"></a>the form SubCo proves -- it "demotes" a nominal equivalence into a
<a name="line-1292"></a>representational equivalence. So, it would seem the following is possible:
<a name="line-1293"></a>
<a name="line-1294"></a>sub (sym axF1) ; F axAge ; sub axF2 :: Bool ~R Char   -- WRONG
<a name="line-1295"></a>
<a name="line-1296"></a>What saves us here is that the arguments to a type function F, lifted into a
<a name="line-1297"></a>coercion, *must* prove nominal equivalence. So, (F axAge) is ill-formed, and
<a name="line-1298"></a>we are safe.
<a name="line-1299"></a>
<a name="line-1300"></a>Roles are attached to parameters to TyCons. When lifting a TyCon into a
<a name="line-1301"></a>coercion (through TyConAppCo), we need to ensure that the arguments to the
<a name="line-1302"></a>TyCon respect their roles. For example:
<a name="line-1303"></a>
<a name="line-1304"></a>data T a b = MkT a (F b)
<a name="line-1305"></a>
<a name="line-1306"></a>If we know that a1 ~R a2, then we know (T a1 b) ~R (T a2 b). But, if we know
<a name="line-1307"></a>that b1 ~R b2, we know nothing about (T a b1) and (T a b2)! This is because
<a name="line-1308"></a>the type function F branches on b's *name*, not representation. So, we say
<a name="line-1309"></a>that 'a' has role Representational and 'b' has role Nominal. The third role,
<a name="line-1310"></a>Phantom, is for parameters not used in the type's definition. Given the
<a name="line-1311"></a>following definition
<a name="line-1312"></a>
<a name="line-1313"></a>data Q a = MkQ Int
<a name="line-1314"></a>
<a name="line-1315"></a>the Phantom role allows us to say that (Q Bool) ~R (Q Char), because we
<a name="line-1316"></a>can construct the coercion Bool ~P Char (using UnivCo).
<a name="line-1317"></a>
<a name="line-1318"></a>See the paper cited above for more examples and information.
<a name="line-1319"></a>
<a name="line-1320"></a>Note [TyConAppCo roles]
<a name="line-1321"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1322"></a>The TyConAppCo constructor has a role parameter, indicating the role at
<a name="line-1323"></a>which the coercion proves equality. The choice of this parameter affects
<a name="line-1324"></a>the required roles of the arguments of the TyConAppCo. To help explain
<a name="line-1325"></a>it, assume the following definition:
<a name="line-1326"></a>
<a name="line-1327"></a>  type instance F Int = Bool   -- Axiom axF : F Int ~N Bool
<a name="line-1328"></a>  newtype Age = MkAge Int      -- Axiom axAge : Age ~R Int
<a name="line-1329"></a>  data Foo a = MkFoo a         -- Role on Foo's parameter is Representational
<a name="line-1330"></a>
<a name="line-1331"></a>TyConAppCo Nominal Foo axF : Foo (F Int) ~N Foo Bool
<a name="line-1332"></a>  For (TyConAppCo Nominal) all arguments must have role Nominal. Why?
<a name="line-1333"></a>  So that Foo Age ~N Foo Int does *not* hold.
<a name="line-1334"></a>
<a name="line-1335"></a>TyConAppCo Representational Foo (SubCo axF) : Foo (F Int) ~R Foo Bool
<a name="line-1336"></a>TyConAppCo Representational Foo axAge       : Foo Age     ~R Foo Int
<a name="line-1337"></a>  For (TyConAppCo Representational), all arguments must have the roles
<a name="line-1338"></a>  corresponding to the result of tyConRoles on the TyCon. This is the
<a name="line-1339"></a>  whole point of having roles on the TyCon to begin with. So, we can
<a name="line-1340"></a>  have Foo Age ~R Foo Int, if Foo's parameter has role R.
<a name="line-1341"></a>
<a name="line-1342"></a>  If a Representational TyConAppCo is over-saturated (which is otherwise fine),
<a name="line-1343"></a>  the spill-over arguments must all be at Nominal. This corresponds to the
<a name="line-1344"></a>  behavior for AppCo.
<a name="line-1345"></a>
<a name="line-1346"></a>TyConAppCo Phantom Foo (UnivCo Phantom Int Bool) : Foo Int ~P Foo Bool
<a name="line-1347"></a>  All arguments must have role Phantom. This one isn't strictly
<a name="line-1348"></a>  necessary for soundness, but this choice removes ambiguity.
<a name="line-1349"></a>
<a name="line-1350"></a>The rules here dictate the roles of the parameters to mkTyConAppCo
<a name="line-1351"></a>(should be checked by Lint).
<a name="line-1352"></a>
<a name="line-1353"></a>Note [NthCo and newtypes]
<a name="line-1354"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1355"></a>Suppose we have
<a name="line-1356"></a>
<a name="line-1357"></a>  newtype N a = MkN Int
<a name="line-1358"></a>  type role N representational
<a name="line-1359"></a>
<a name="line-1360"></a>This yields axiom
<a name="line-1361"></a>
<a name="line-1362"></a>  NTCo:N :: forall a. N a ~R Int
<a name="line-1363"></a>
<a name="line-1364"></a>We can then build
<a name="line-1365"></a>
<a name="line-1366"></a>  co :: forall a b. N a ~R N b
<a name="line-1367"></a>  co = NTCo:N a ; sym (NTCo:N b)
<a name="line-1368"></a>
<a name="line-1369"></a>for any `a` and `b`. Because of the role annotation on N, if we use
<a name="line-1370"></a>NthCo, we'll get out a representational coercion. That is:
<a name="line-1371"></a>
<a name="line-1372"></a>  NthCo r 0 co :: forall a b. a ~R b
<a name="line-1373"></a>
<a name="line-1374"></a>Yikes! Clearly, this is terrible. The solution is simple: forbid
<a name="line-1375"></a>NthCo to be used on newtypes if the internal coercion is representational.
<a name="line-1376"></a>
<a name="line-1377"></a>This is not just some corner case discovered by a segfault somewhere;
<a name="line-1378"></a>it was discovered in the proof of soundness of roles and described
<a name="line-1379"></a>in the "Safe Coercions" paper (ICFP '14).
<a name="line-1380"></a>
<a name="line-1381"></a>Note [NthCo Cached Roles]
<a name="line-1382"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1383"></a>Why do we cache the role of NthCo in the NthCo constructor?
<a name="line-1384"></a>Because computing role(Nth i co) involves figuring out that
<a name="line-1385"></a>
<a name="line-1386"></a>  co :: T tys1 ~ T tys2
<a name="line-1387"></a>
<a name="line-1388"></a>using coercionKind, and finding (coercionRole co), and then looking
<a name="line-1389"></a>at the tyConRoles of T. Avoiding bad asymptotic behaviour here means
<a name="line-1390"></a>we have to compute the kind and role of a coercion simultaneously,
<a name="line-1391"></a>which makes the code complicated and inefficient.
<a name="line-1392"></a>
<a name="line-1393"></a>This only happens for NthCo. Caching the role solves the problem, and
<a name="line-1394"></a>allows coercionKind and coercionRole to be simple.
<a name="line-1395"></a>
<a name="line-1396"></a>See Trac #11735
<a name="line-1397"></a>
<a name="line-1398"></a>Note [InstCo roles]
<a name="line-1399"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-1400"></a>Here is (essentially) the typing rule for InstCo:
<a name="line-1401"></a>
<a name="line-1402"></a>g :: (forall a. t1) ~r (forall a. t2)
<a name="line-1403"></a>w :: s1 ~N s2
<a name="line-1404"></a>------------------------------- InstCo
<a name="line-1405"></a>InstCo g w :: (t1 [a |-&gt; s1]) ~r (t2 [a |-&gt; s2])
<a name="line-1406"></a>
<a name="line-1407"></a>Note that the Coercion w *must* be nominal. This is necessary
<a name="line-1408"></a>because the variable a might be used in a "nominal position"
<a name="line-1409"></a>(that is, a place where role inference would require a nominal
<a name="line-1410"></a>role) in t1 or t2. If we allowed w to be representational, we
<a name="line-1411"></a>could get bogus equalities.
<a name="line-1412"></a>
<a name="line-1413"></a>A more nuanced treatment might be able to relax this condition
<a name="line-1414"></a>somewhat, by checking if t1 and/or t2 use their bound variables
<a name="line-1415"></a>in nominal ways. If not, having w be representational is OK.
<a name="line-1416"></a>
<a name="line-1417"></a>
<a name="line-1418"></a>%************************************************************************
<a name="line-1419"></a>%*                                                                      *
<a name="line-1420"></a>                UnivCoProvenance
<a name="line-1421"></a>%*                                                                      *
<a name="line-1422"></a>%************************************************************************
<a name="line-1423"></a>
<a name="line-1424"></a>A UnivCo is a coercion whose proof does not directly express its role
<a name="line-1425"></a>and kind (indeed for some UnivCos, like UnsafeCoerceProv, there /is/
<a name="line-1426"></a>no proof).
<a name="line-1427"></a>
<a name="line-1428"></a>The different kinds of UnivCo are described by UnivCoProvenance.  Really
<a name="line-1429"></a>each is entirely separate, but they all share the need to represent their
<a name="line-1430"></a>role and kind, which is done in the UnivCo constructor.
<a name="line-1431"></a>
<a name="line-1432"></a>-}</span>
<a name="line-1433"></a>
<a name="line-1434"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- | For simplicity, we have just one UnivCo that represents a coercion from</span>
<a name="line-1435"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- some type to some other type, with (in general) no restrictions on the</span>
<a name="line-1436"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- type. The UnivCoProvenance specifies more exactly what the coercion really</span>
<a name="line-1437"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- is and why a program should (or shouldn't!) trust the coercion.</span>
<a name="line-1438"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- It is reasonable to consider each constructor of 'UnivCoProvenance'</span>
<a name="line-1439"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- as a totally independent coercion form; their only commonality is</span>
<a name="line-1440"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- that they don't tell you what types they coercion between. (That info</span>
<a name="line-1441"></a><a name="UnivCoProvenance"></a><span class='hs-comment'>-- is in the 'UnivCo' constructor of 'Coercion'.</span>
<a name="line-1442"></a><a name="UnivCoProvenance"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>UnivCoProvenance</span>
<a name="line-1443"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>   <span class='hs-comment'>-- ^ From @unsafeCoerce#@. These are unsound.</span>
<a name="line-1444"></a>
<a name="line-1445"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-conid'>KindCoercion</span> <span class='hs-comment'>-- ^ See Note [Phantom coercions]. Only in Phantom</span>
<a name="line-1446"></a>                             <span class='hs-comment'>-- roled coercions</span>
<a name="line-1447"></a>
<a name="line-1448"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-conid'>KindCoercion</span>  <span class='hs-comment'>-- ^ From the fact that any two coercions are</span>
<a name="line-1449"></a>                                 <span class='hs-comment'>--   considered equivalent. See Note [ProofIrrelProv].</span>
<a name="line-1450"></a>                                 <span class='hs-comment'>-- Can be used in Nominal or Representational coercions</span>
<a name="line-1451"></a>
<a name="line-1452"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>PluginProv</span> <span class='hs-conid'>String</span>  <span class='hs-comment'>-- ^ From a plugin, which asserts that this coercion</span>
<a name="line-1453"></a>                       <span class='hs-comment'>--   is sound. The string is for the use of the plugin.</span>
<a name="line-1454"></a>
<a name="line-1455"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Data.Data</span>
<a name="line-1456"></a>
<a name="line-1457"></a><a name="instance%20Outputable%20UnivCoProvenance"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyword'>where</span>
<a name="line-1458"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>UnsafeCoerceProv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(unsafeCoerce#)"</span>
<a name="line-1459"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(phantom)"</span>
<a name="line-1460"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(proof irrel.)"</span>
<a name="line-1461"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"plugin"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1462"></a>
<a name="line-1463"></a><a name="CoercionHole"></a><span class='hs-comment'>-- | A coercion to be filled in by the type-checker. See Note [Coercion holes]</span>
<a name="line-1464"></a><a name="CoercionHole"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>CoercionHole</span>
<a name="line-1465"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ch_co_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span>
<a name="line-1466"></a>                       <span class='hs-comment'>-- See Note [CoercionHoles and coercion free variables]</span>
<a name="line-1467"></a>
<a name="line-1468"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>ch_ref</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1469"></a>                 <span class='hs-layout'>}</span>
<a name="line-1470"></a>
<a name="line-1471"></a><a name="coHoleCoVar"></a><span class='hs-definition'>coHoleCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-1472"></a><span class='hs-definition'>coHoleCoVar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ch_co_var</span>
<a name="line-1473"></a>
<a name="line-1474"></a><a name="setCoHoleCoVar"></a><span class='hs-definition'>setCoHoleCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionHole</span>
<a name="line-1475"></a><span class='hs-definition'>setCoHoleCoVar</span> <span class='hs-varid'>h</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ch_co_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>}</span>
<a name="line-1476"></a>
<a name="line-1477"></a><a name="instance%20Data.Data%20CoercionHole"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Data.Data</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyword'>where</span>
<a name="line-1478"></a>  <span class='hs-comment'>-- don't traverse?</span>
<a name="line-1479"></a>  <span class='hs-varid'>toConstr</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>abstractConstr</span> <span class='hs-str'>"CoercionHole"</span>
<a name="line-1480"></a>  <span class='hs-varid'>gunfold</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"gunfold"</span>
<a name="line-1481"></a>  <span class='hs-varid'>dataTypeOf</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNoRepType</span> <span class='hs-str'>"CoercionHole"</span>
<a name="line-1482"></a>
<a name="line-1483"></a><a name="instance%20Outputable%20CoercionHole"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyword'>where</span>
<a name="line-1484"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionHole</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ch_co_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-1485"></a>
<a name="line-1486"></a>
<a name="line-1487"></a><span class='hs-comment'>{- Note [Phantom coercions]
<a name="line-1488"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1489"></a>Consider
<a name="line-1490"></a>     data T a = T1 | T2
<a name="line-1491"></a>Then we have
<a name="line-1492"></a>     T s ~R T t
<a name="line-1493"></a>for any old s,t. The witness for this is (TyConAppCo T Rep co),
<a name="line-1494"></a>where (co :: s ~P t) is a phantom coercion built with PhantomProv.
<a name="line-1495"></a>The role of the UnivCo is always Phantom.  The Coercion stored is the
<a name="line-1496"></a>(nominal) kind coercion between the types
<a name="line-1497"></a>   kind(s) ~N kind (t)
<a name="line-1498"></a>
<a name="line-1499"></a>Note [Coercion holes]
<a name="line-1500"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1501"></a>During typechecking, constraint solving for type classes works by
<a name="line-1502"></a>  - Generate an evidence Id,  d7 :: Num a
<a name="line-1503"></a>  - Wrap it in a Wanted constraint, [W] d7 :: Num a
<a name="line-1504"></a>  - Use the evidence Id where the evidence is needed
<a name="line-1505"></a>  - Solve the constraint later
<a name="line-1506"></a>  - When solved, add an enclosing let-binding  let d7 = .... in ....
<a name="line-1507"></a>    which actually binds d7 to the (Num a) evidence
<a name="line-1508"></a>
<a name="line-1509"></a>For equality constraints we use a different strategy.  See Note [The
<a name="line-1510"></a>equality types story] in TysPrim for background on equality constraints.
<a name="line-1511"></a>  - For /boxed/ equality constraints, (t1 ~N t2) and (t1 ~R t2), it's just
<a name="line-1512"></a>    like type classes above. (Indeed, boxed equality constraints *are* classes.)
<a name="line-1513"></a>  - But for /unboxed/ equality constraints (t1 ~R# t2) and (t1 ~N# t2)
<a name="line-1514"></a>    we use a different plan
<a name="line-1515"></a>
<a name="line-1516"></a>For unboxed equalities:
<a name="line-1517"></a>  - Generate a CoercionHole, a mutable variable just like a unification
<a name="line-1518"></a>    variable
<a name="line-1519"></a>  - Wrap the CoercionHole in a Wanted constraint; see TcRnTypes.TcEvDest
<a name="line-1520"></a>  - Use the CoercionHole in a Coercion, via HoleCo
<a name="line-1521"></a>  - Solve the constraint later
<a name="line-1522"></a>  - When solved, fill in the CoercionHole by side effect, instead of
<a name="line-1523"></a>    doing the let-binding thing
<a name="line-1524"></a>
<a name="line-1525"></a>The main reason for all this is that there may be no good place to let-bind
<a name="line-1526"></a>the evidence for unboxed equalities:
<a name="line-1527"></a>
<a name="line-1528"></a>  - We emit constraints for kind coercions, to be used to cast a
<a name="line-1529"></a>    type's kind. These coercions then must be used in types. Because
<a name="line-1530"></a>    they might appear in a top-level type, there is no place to bind
<a name="line-1531"></a>    these (unlifted) coercions in the usual way.
<a name="line-1532"></a>
<a name="line-1533"></a>  - A coercion for (forall a. t1) ~ (forall a. t2) will look like
<a name="line-1534"></a>       forall a. (coercion for t1~t2)
<a name="line-1535"></a>    But the coercion for (t1~t2) may mention 'a', and we don't have
<a name="line-1536"></a>    let-bindings within coercions.  We could add them, but coercion
<a name="line-1537"></a>    holes are easier.
<a name="line-1538"></a>
<a name="line-1539"></a>  - Moreover, nothing is lost from the lack of let-bindings. For
<a name="line-1540"></a>    dicionaries want to achieve sharing to avoid recomoputing the
<a name="line-1541"></a>    dictionary.  But coercions are entirely erased, so there's little
<a name="line-1542"></a>    benefit to sharing. Indeed, even if we had a let-binding, we
<a name="line-1543"></a>    always inline types and coercions at every use site and drop the
<a name="line-1544"></a>    binding.
<a name="line-1545"></a>
<a name="line-1546"></a>Other notes about HoleCo:
<a name="line-1547"></a>
<a name="line-1548"></a> * INVARIANT: CoercionHole and HoleCo are used only during type checking,
<a name="line-1549"></a>   and should never appear in Core. Just like unification variables; a Type
<a name="line-1550"></a>   can contain a TcTyVar, but only during type checking. If, one day, we
<a name="line-1551"></a>   use type-level information to separate out forms that can appear during
<a name="line-1552"></a>   type-checking vs forms that can appear in core proper, holes in Core will
<a name="line-1553"></a>   be ruled out.
<a name="line-1554"></a>
<a name="line-1555"></a> * See Note [CoercionHoles and coercion free variables]
<a name="line-1556"></a>
<a name="line-1557"></a> * Coercion holes can be compared for equality like other coercions:
<a name="line-1558"></a>   by looking at the types coerced.
<a name="line-1559"></a>
<a name="line-1560"></a>
<a name="line-1561"></a>Note [CoercionHoles and coercion free variables]
<a name="line-1562"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1563"></a>Why does a CoercionHole contain a CoVar, as well as reference to
<a name="line-1564"></a>fill in?  Because we want to treat that CoVar as a free variable of
<a name="line-1565"></a>the coercion.  See Trac #14584, and Note [What prevents a
<a name="line-1566"></a>constraint from floating] in TcSimplify, item (4):
<a name="line-1567"></a>
<a name="line-1568"></a>        forall k. [W] co1 :: t1 ~# t2 |&gt; co2
<a name="line-1569"></a>                  [W] co2 :: k ~# *
<a name="line-1570"></a>
<a name="line-1571"></a>Here co2 is a CoercionHole. But we /must/ know that it is free in
<a name="line-1572"></a>co1, because that's all that stops it floating outside the
<a name="line-1573"></a>implication.
<a name="line-1574"></a>
<a name="line-1575"></a>
<a name="line-1576"></a>Note [ProofIrrelProv]
<a name="line-1577"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-1578"></a>A ProofIrrelProv is a coercion between coercions. For example:
<a name="line-1579"></a>
<a name="line-1580"></a>  data G a where
<a name="line-1581"></a>    MkG :: G Bool
<a name="line-1582"></a>
<a name="line-1583"></a>In core, we get
<a name="line-1584"></a>
<a name="line-1585"></a>  G :: * -&gt; *
<a name="line-1586"></a>  MkG :: forall (a :: *). (a ~ Bool) -&gt; G a
<a name="line-1587"></a>
<a name="line-1588"></a>Now, consider 'MkG -- that is, MkG used in a type -- and suppose we want
<a name="line-1589"></a>a proof that ('MkG a1 co1) ~ ('MkG a2 co2). This will have to be
<a name="line-1590"></a>
<a name="line-1591"></a>  TyConAppCo Nominal MkG [co3, co4]
<a name="line-1592"></a>  where
<a name="line-1593"></a>    co3 :: co1 ~ co2
<a name="line-1594"></a>    co4 :: a1 ~ a2
<a name="line-1595"></a>
<a name="line-1596"></a>Note that
<a name="line-1597"></a>  co1 :: a1 ~ Bool
<a name="line-1598"></a>  co2 :: a2 ~ Bool
<a name="line-1599"></a>
<a name="line-1600"></a>Here,
<a name="line-1601"></a>  co3 = UnivCo (ProofIrrelProv co5) Nominal (CoercionTy co1) (CoercionTy co2)
<a name="line-1602"></a>  where
<a name="line-1603"></a>    co5 :: (a1 ~ Bool) ~ (a2 ~ Bool)
<a name="line-1604"></a>    co5 = TyConAppCo Nominal (~#) [&lt;*&gt;, &lt;*&gt;, co4, &lt;Bool&gt;]
<a name="line-1605"></a>
<a name="line-1606"></a>
<a name="line-1607"></a>%************************************************************************
<a name="line-1608"></a>%*                                                                      *
<a name="line-1609"></a>                 Free variables of types and coercions
<a name="line-1610"></a>%*                                                                      *
<a name="line-1611"></a>%************************************************************************
<a name="line-1612"></a>-}</span>
<a name="line-1613"></a>
<a name="line-1614"></a><span class='hs-comment'>{- Note [Free variables of types]
<a name="line-1615"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1616"></a>The family of functions tyCoVarsOfType, tyCoVarsOfTypes etc, returns
<a name="line-1617"></a>a VarSet that is closed over the types of its variables.  More precisely,
<a name="line-1618"></a>  if    S = tyCoVarsOfType( t )
<a name="line-1619"></a>  and   (a:k) is in S
<a name="line-1620"></a>  then  tyCoVarsOftype( k ) is a subset of S
<a name="line-1621"></a>
<a name="line-1622"></a>Example: The tyCoVars of this ((a:* -&gt; k) Int) is {a, k}.
<a name="line-1623"></a>
<a name="line-1624"></a>We could /not/ close over the kinds of the variable occurrences, and
<a name="line-1625"></a>instead do so at call sites, but it seems that we always want to do
<a name="line-1626"></a>so, so it's easiest to do it here.
<a name="line-1627"></a>
<a name="line-1628"></a>It turns out that getting the free variables of types is performance critical,
<a name="line-1629"></a>so we profiled several versions, exploring different implementation strategies.
<a name="line-1630"></a>
<a name="line-1631"></a>1. Baseline version: uses FV naively. Essentially:
<a name="line-1632"></a>
<a name="line-1633"></a>   tyCoVarsOfType ty = fvVarSet $ tyCoFVsOfType ty
<a name="line-1634"></a>
<a name="line-1635"></a>   This is not nice, because FV introduces some overhead to implement
<a name="line-1636"></a>   determinism, and throught its "interesting var" function, neither of which
<a name="line-1637"></a>   we need here, so they are a complete waste.
<a name="line-1638"></a>
<a name="line-1639"></a>2. UnionVarSet version: instead of reusing the FV-based code, we simply used
<a name="line-1640"></a>   VarSets directly, trying to avoid the overhead of FV. E.g.:
<a name="line-1641"></a>
<a name="line-1642"></a>   -- FV version:
<a name="line-1643"></a>   tyCoFVsOfType (AppTy fun arg)    a b c = (tyCoFVsOfType fun `unionFV` tyCoFVsOfType arg) a b c
<a name="line-1644"></a>
<a name="line-1645"></a>   -- UnionVarSet version:
<a name="line-1646"></a>   tyCoVarsOfType (AppTy fun arg)    = (tyCoVarsOfType fun `unionVarSet` tyCoVarsOfType arg)
<a name="line-1647"></a>
<a name="line-1648"></a>   This looks deceptively similar, but while FV internally builds a list- and
<a name="line-1649"></a>   set-generating function, the VarSet functions manipulate sets directly, and
<a name="line-1650"></a>   the latter peforms a lot worse than the naive FV version.
<a name="line-1651"></a>
<a name="line-1652"></a>3. Accumulator-style VarSet version: this is what we use now. We do use VarSet
<a name="line-1653"></a>   as our data structure, but delegate the actual work to a new
<a name="line-1654"></a>   ty_co_vars_of_...  family of functions, which use accumulator style and the
<a name="line-1655"></a>   "in-scope set" filter found in the internals of FV, but without the
<a name="line-1656"></a>   determinism overhead.
<a name="line-1657"></a>
<a name="line-1658"></a>See Trac #14880.
<a name="line-1659"></a>
<a name="line-1660"></a>Note [Closing over free variable kinds]
<a name="line-1661"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1662"></a>tyCoVarsOfType and tyCoFVsOfType, while traversing a type, will also close over
<a name="line-1663"></a>free variable kinds. In previous GHC versions, this happened naively: whenever
<a name="line-1664"></a>we would encounter an occurrence of a free type variable, we would close over
<a name="line-1665"></a>its kind. This, however is wrong for two reasons (see Trac #14880):
<a name="line-1666"></a>
<a name="line-1667"></a>1. Efficiency. If we have Proxy (a::k) -&gt; Proxy (a::k) -&gt; Proxy (a::k), then
<a name="line-1668"></a>   we don't want to have to traverse k more than once.
<a name="line-1669"></a>
<a name="line-1670"></a>2. Correctness. Imagine we have forall k. b -&gt; k, where b has
<a name="line-1671"></a>   kind k, for some k bound in an outer scope. If we look at b's kind inside
<a name="line-1672"></a>   the forall, we'll collect that k is free and then remove k from the set of
<a name="line-1673"></a>   free variables. This is plain wrong. We must instead compute that b is free
<a name="line-1674"></a>   and then conclude that b's kind is free.
<a name="line-1675"></a>
<a name="line-1676"></a>An obvious first approach is to move the closing-over-kinds from the
<a name="line-1677"></a>occurrences of a type variable to after finding the free vars - however, this
<a name="line-1678"></a>turns out to introduce performance regressions, and isn't even entirely
<a name="line-1679"></a>correct.
<a name="line-1680"></a>
<a name="line-1681"></a>In fact, it isn't even important *when* we close over kinds; what matters is
<a name="line-1682"></a>that we handle each type var exactly once, and that we do it in the right
<a name="line-1683"></a>context.
<a name="line-1684"></a>
<a name="line-1685"></a>So the next approach we tried was to use the "in-scope set" part of FV or the
<a name="line-1686"></a>equivalent argument in the accumulator-style `ty_co_vars_of_type` function, to
<a name="line-1687"></a>say "don't bother with variables we have already closed over". This should work
<a name="line-1688"></a>fine in theory, but the code is complicated and doesn't perform well.
<a name="line-1689"></a>
<a name="line-1690"></a>But there is a simpler way, which is implemented here. Consider the two points
<a name="line-1691"></a>above:
<a name="line-1692"></a>
<a name="line-1693"></a>1. Efficiency: we now have an accumulator, so the second time we encounter 'a',
<a name="line-1694"></a>   we'll ignore it, certainly not looking at its kind - this is why
<a name="line-1695"></a>   pre-checking set membership before inserting ends up not only being faster,
<a name="line-1696"></a>   but also being correct.
<a name="line-1697"></a>
<a name="line-1698"></a>2. Correctness: we have an "in-scope set" (I think we should call it it a
<a name="line-1699"></a>  "bound-var set"), specifying variables that are bound by a forall in the type
<a name="line-1700"></a>  we are traversing; we simply ignore these variables, certainly not looking at
<a name="line-1701"></a>  their kind.
<a name="line-1702"></a>
<a name="line-1703"></a>So now consider:
<a name="line-1704"></a>
<a name="line-1705"></a>    forall k. b -&gt; k
<a name="line-1706"></a>
<a name="line-1707"></a>where b :: k-&gt;Type is free; but of course, it's a different k! When looking at
<a name="line-1708"></a>b -&gt; k we'll have k in the bound-var set. So we'll ignore the k. But suppose
<a name="line-1709"></a>this is our first encounter with b; we want the free vars of its kind. But we
<a name="line-1710"></a>want to behave as if we took the free vars of its kind at the end; that is,
<a name="line-1711"></a>with no bound vars in scope.
<a name="line-1712"></a>
<a name="line-1713"></a>So the solution is easy. The old code was this:
<a name="line-1714"></a>
<a name="line-1715"></a>  ty_co_vars_of_type (TyVarTy v) is acc
<a name="line-1716"></a>    | v `elemVarSet` is  = acc
<a name="line-1717"></a>    | v `elemVarSet` acc = acc
<a name="line-1718"></a>    | otherwise          = ty_co_vars_of_type (tyVarKind v) is (extendVarSet acc v)
<a name="line-1719"></a>
<a name="line-1720"></a>Now all we need to do is take the free vars of tyVarKind v *with an empty
<a name="line-1721"></a>bound-var set*, thus:
<a name="line-1722"></a>
<a name="line-1723"></a>ty_co_vars_of_type (TyVarTy v) is acc
<a name="line-1724"></a>  | v `elemVarSet` is  = acc
<a name="line-1725"></a>  | v `elemVarSet` acc = acc
<a name="line-1726"></a>  | otherwise          = ty_co_vars_of_type (tyVarKind v) emptyVarSet (extendVarSet acc v)
<a name="line-1727"></a>                                                          ^^^^^^^^^^^
<a name="line-1728"></a>
<a name="line-1729"></a>And that's it.
<a name="line-1730"></a>
<a name="line-1731"></a>-}</span>
<a name="line-1732"></a>
<a name="line-1733"></a><a name="tyCoVarsOfType"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1734"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1735"></a><span class='hs-definition'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1736"></a>
<a name="line-1737"></a><a name="tyCoVarsOfTypes"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1738"></a><span class='hs-definition'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1739"></a>
<a name="line-1740"></a><a name="ty_co_vars_of_type"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1741"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1742"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>is</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1743"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1744"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1745"></a>                            <span class='hs-varid'>emptyVarSet</span>  <span class='hs-comment'>-- See Note [Closing over free variable kinds]</span>
<a name="line-1746"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1747"></a>
<a name="line-1748"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1749"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-keyword'>_</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1750"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>    <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-1751"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>    <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>res</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-1752"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1753"></a>                                                      <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-1754"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-1755"></a><span class='hs-definition'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1756"></a>
<a name="line-1757"></a><a name="ty_co_vars_of_types"></a><span class='hs-definition'>ty_co_vars_of_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1758"></a><span class='hs-definition'>ty_co_vars_of_types</span> <span class='hs-conid'>[]</span>       <span class='hs-keyword'>_</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1759"></a><span class='hs-definition'>ty_co_vars_of_types</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_vars_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-1760"></a>
<a name="line-1761"></a><a name="tyCoVarsOfCo"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1762"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1763"></a><span class='hs-definition'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1764"></a>
<a name="line-1765"></a><a name="tyCoVarsOfCos"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1766"></a><span class='hs-definition'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1767"></a>
<a name="line-1768"></a>
<a name="line-1769"></a><a name="ty_co_vars_of_co"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1770"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>            <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1771"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>     <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1772"></a>                                               <span class='hs-varid'>ty_co_vars_of_mco</span> <span class='hs-varid'>mco</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1773"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1774"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>       <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1775"></a>                                               <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1776"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1777"></a>                                                   <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>is</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span>
<a name="line-1778"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1779"></a>                                               <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1780"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>          <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co_var</span> <span class='hs-varid'>v</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1781"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>           <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1782"></a>    <span class='hs-comment'>-- See Note [CoercionHoles and coercion free variables]</span>
<a name="line-1783"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1784"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_prov</span> <span class='hs-varid'>p</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1785"></a>                                                <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1786"></a>                                                <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1787"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1788"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1789"></a>                                              <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1790"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1791"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1792"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varop'>$</span>
<a name="line-1793"></a>                                              <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1794"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1795"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1796"></a><span class='hs-definition'>ty_co_vars_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_cos</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1797"></a>
<a name="line-1798"></a><a name="ty_co_vars_of_mco"></a><span class='hs-definition'>ty_co_vars_of_mco</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1799"></a><span class='hs-definition'>ty_co_vars_of_mco</span> <span class='hs-conid'>MRefl</span>    <span class='hs-sel'>_is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1800"></a><span class='hs-definition'>ty_co_vars_of_mco</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1801"></a>
<a name="line-1802"></a><a name="ty_co_vars_of_co_var"></a><span class='hs-definition'>ty_co_vars_of_co_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1803"></a><span class='hs-definition'>ty_co_vars_of_co_var</span> <span class='hs-varid'>v</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1804"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>is</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1805"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1806"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1807"></a>                            <span class='hs-varid'>emptyVarSet</span>  <span class='hs-comment'>-- See Note [Closing over free variable kinds]</span>
<a name="line-1808"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1809"></a>
<a name="line-1810"></a><a name="ty_co_vars_of_cos"></a><span class='hs-definition'>ty_co_vars_of_cos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1811"></a><span class='hs-definition'>ty_co_vars_of_cos</span> <span class='hs-conid'>[]</span>       <span class='hs-keyword'>_</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1812"></a><span class='hs-definition'>ty_co_vars_of_cos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_vars_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-1813"></a>
<a name="line-1814"></a><a name="tyCoVarsOfProv"></a><span class='hs-definition'>tyCoVarsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1815"></a><span class='hs-definition'>tyCoVarsOfProv</span> <span class='hs-varid'>prov</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_prov</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>emptyVarSet</span>
<a name="line-1816"></a>
<a name="line-1817"></a><a name="ty_co_vars_of_prov"></a><span class='hs-definition'>ty_co_vars_of_prov</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1818"></a><span class='hs-definition'>ty_co_vars_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1819"></a><span class='hs-definition'>ty_co_vars_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_vars_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>is</span> <span class='hs-varid'>acc</span>
<a name="line-1820"></a><span class='hs-definition'>ty_co_vars_of_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyword'>_</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1821"></a><span class='hs-definition'>ty_co_vars_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span>  <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1822"></a>
<a name="line-1823"></a><a name="mkTyCoInScopeSet"></a><span class='hs-comment'>-- | Generates an in-scope set from the free variables in a list of types</span>
<a name="line-1824"></a><span class='hs-comment'>-- and a list of coercions</span>
<a name="line-1825"></a><span class='hs-definition'>mkTyCoInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-1826"></a><span class='hs-definition'>mkTyCoInScopeSet</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-1827"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_vars_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varop'>$</span>
<a name="line-1828"></a>                  <span class='hs-varid'>ty_co_vars_of_cos</span>   <span class='hs-varid'>cos</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>)</span>
<a name="line-1829"></a>
<a name="line-1830"></a><a name="tyCoVarsOfTypeDSet"></a><span class='hs-comment'>-- | `tyCoFVsOfType` that returns free variables of a type in a deterministic</span>
<a name="line-1831"></a><span class='hs-comment'>-- set. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-1832"></a><span class='hs-comment'>-- Note [Deterministic FV] in FV.</span>
<a name="line-1833"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1834"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1835"></a><span class='hs-definition'>tyCoVarsOfTypeDSet</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1836"></a>
<a name="line-1837"></a><a name="tyCoVarsOfTypeList"></a><span class='hs-comment'>-- | `tyCoFVsOfType` that returns free variables of a type in deterministic</span>
<a name="line-1838"></a><span class='hs-comment'>-- order. For explanation of why using `VarSet` is not deterministic see</span>
<a name="line-1839"></a><span class='hs-comment'>-- Note [Deterministic FV] in FV.</span>
<a name="line-1840"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1841"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1842"></a><span class='hs-definition'>tyCoVarsOfTypeList</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-1843"></a>
<a name="line-1844"></a><a name="tyCoVarsOfTypesSet"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1845"></a><span class='hs-comment'>-- a non-deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1846"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1847"></a><span class='hs-definition'>tyCoVarsOfTypesSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1848"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1849"></a><span class='hs-definition'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>tys</span>
<a name="line-1850"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because we immediately forget the</span>
<a name="line-1851"></a>  <span class='hs-comment'>-- ordering by returning a set</span>
<a name="line-1852"></a>
<a name="line-1853"></a><a name="tyCoVarsOfTypesDSet"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1854"></a><span class='hs-comment'>-- a deterministic set. For type synonyms it does /not/ expand the</span>
<a name="line-1855"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1856"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1857"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1858"></a><span class='hs-definition'>tyCoVarsOfTypesDSet</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1859"></a>
<a name="line-1860"></a><a name="tyCoVarsOfTypesList"></a><span class='hs-comment'>-- | Returns free variables of types, including kind variables as</span>
<a name="line-1861"></a><span class='hs-comment'>-- a deterministically ordered list. For type synonyms it does /not/ expand the</span>
<a name="line-1862"></a><span class='hs-comment'>-- synonym.</span>
<a name="line-1863"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1864"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1865"></a><span class='hs-definition'>tyCoVarsOfTypesList</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span>
<a name="line-1866"></a>
<a name="line-1867"></a><a name="tyCoFVsOfType"></a><span class='hs-comment'>-- | The worker for `tyCoFVsOfType` and `tyCoFVsOfTypeList`.</span>
<a name="line-1868"></a><span class='hs-comment'>-- The previous implementation used `unionVarSet` which is O(n+m) and can</span>
<a name="line-1869"></a><span class='hs-comment'>-- make the function quadratic.</span>
<a name="line-1870"></a><span class='hs-comment'>-- It's exported, so that it can be composed with</span>
<a name="line-1871"></a><span class='hs-comment'>-- other functions that compute free variables.</span>
<a name="line-1872"></a><span class='hs-comment'>-- See Note [FV naming conventions] in FV.</span>
<a name="line-1873"></a><span class='hs-comment'>--</span>
<a name="line-1874"></a><span class='hs-comment'>-- Eta-expanded because that makes it run faster (apparently)</span>
<a name="line-1875"></a><span class='hs-comment'>-- See Note [FV eta expansion] in FV for explanation.</span>
<a name="line-1876"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1877"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1878"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>        <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-1879"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-1880"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>bound_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-1881"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>acc_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc_set</span><span class='hs-layout'>)</span>
<a name="line-1882"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span>
<a name="line-1883"></a>                               <span class='hs-varid'>emptyVarSet</span>   <span class='hs-comment'>-- See Note [Closing over free variable kinds]</span>
<a name="line-1884"></a>                               <span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-conop'>:</span><span class='hs-varid'>acc_list</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendVarSet</span> <span class='hs-varid'>acc_set</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1885"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>   <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-1886"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-1887"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>    <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-1888"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>    <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>arg</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-1889"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsBndr</span> <span class='hs-varid'>bndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>  <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-1890"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>     <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-1891"></a><span class='hs-definition'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>f</span> <span class='hs-varid'>bound_vars</span> <span class='hs-varid'>acc</span>
<a name="line-1892"></a>
<a name="line-1893"></a><a name="tyCoFVsBndr"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVarBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1894"></a><span class='hs-comment'>-- Free vars of (forall b. &lt;thing with fvs&gt;)</span>
<a name="line-1895"></a><span class='hs-definition'>tyCoFVsBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsVarBndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>fvs</span>
<a name="line-1896"></a>
<a name="line-1897"></a><a name="tyCoFVsVarBndrs"></a><span class='hs-definition'>tyCoFVsVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1898"></a><span class='hs-definition'>tyCoFVsVarBndrs</span> <span class='hs-varid'>vars</span> <span class='hs-varid'>fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>tyCoFVsVarBndr</span> <span class='hs-varid'>fvs</span> <span class='hs-varid'>vars</span>
<a name="line-1899"></a>
<a name="line-1900"></a><a name="tyCoFVsVarBndr"></a><span class='hs-definition'>tyCoFVsVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1901"></a><span class='hs-definition'>tyCoFVsVarBndr</span> <span class='hs-varid'>var</span> <span class='hs-varid'>fvs</span>
<a name="line-1902"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Free vars of its type/kind</span>
<a name="line-1903"></a>    <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>delFV</span> <span class='hs-varid'>var</span> <span class='hs-varid'>fvs</span>       <span class='hs-comment'>-- Delete it from the thing-inside</span>
<a name="line-1904"></a>
<a name="line-1905"></a><a name="tyCoFVsOfTypes"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1906"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1907"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1908"></a><span class='hs-definition'>tyCoFVsOfTypes</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1909"></a>
<a name="line-1910"></a><a name="tyCoVarsOfCoDSet"></a><span class='hs-comment'>-- | Get a deterministic set of the vars free in a coercion</span>
<a name="line-1911"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DTyCoVarSet</span>
<a name="line-1912"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1913"></a><span class='hs-definition'>tyCoVarsOfCoDSet</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvDVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1914"></a>
<a name="line-1915"></a><a name="tyCoVarsOfCoList"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>
<a name="line-1916"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1917"></a><span class='hs-definition'>tyCoVarsOfCoList</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1918"></a>
<a name="line-1919"></a><a name="tyCoFVsOfMCo"></a><span class='hs-definition'>tyCoFVsOfMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1920"></a><span class='hs-definition'>tyCoFVsOfMCo</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span>
<a name="line-1921"></a><span class='hs-definition'>tyCoFVsOfMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-1922"></a>
<a name="line-1923"></a><a name="tyCoVarsOfCosSet"></a><span class='hs-definition'>tyCoVarsOfCosSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVarEnv</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-1924"></a><span class='hs-definition'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nonDetEltsUFM</span> <span class='hs-varid'>cos</span>
<a name="line-1925"></a>  <span class='hs-comment'>-- It's OK to use nonDetEltsUFM here because we immediately forget the</span>
<a name="line-1926"></a>  <span class='hs-comment'>-- ordering by returning a set</span>
<a name="line-1927"></a>
<a name="line-1928"></a><a name="tyCoFVsOfCo"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1929"></a><span class='hs-comment'>-- Extracts type and coercion variables from a coercion</span>
<a name="line-1930"></a><span class='hs-comment'>-- See Note [Free variables of types]</span>
<a name="line-1931"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1932"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1933"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1934"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfMCo</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1935"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1936"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1937"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1938"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1939"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsVarBndr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1940"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1941"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1942"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1943"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCoVar</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1944"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1945"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1946"></a>    <span class='hs-comment'>-- See Note [CoercionHoles and coercion free variables]</span>
<a name="line-1947"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1948"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1949"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t1</span>
<a name="line-1950"></a>                     <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1951"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1952"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1953"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1954"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1955"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1956"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1957"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1958"></a><span class='hs-definition'>tyCoFVsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1959"></a>
<a name="line-1960"></a><a name="tyCoFVsOfCoVar"></a><span class='hs-definition'>tyCoFVsOfCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1961"></a><span class='hs-definition'>tyCoFVsOfCoVar</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1962"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1963"></a>
<a name="line-1964"></a><a name="tyCoFVsOfProv"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1965"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1966"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1967"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1968"></a><span class='hs-definition'>tyCoFVsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1969"></a>
<a name="line-1970"></a><a name="tyCoFVsOfCos"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-1971"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-conid'>[]</span>       <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1972"></a><span class='hs-definition'>tyCoFVsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_cand</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>acc</span>
<a name="line-1973"></a>
<a name="line-1974"></a>
<a name="line-1975"></a><span class='hs-comment'>------------- Extracting the CoVars of a type or coercion -----------</span>
<a name="line-1976"></a>
<a name="line-1977"></a><span class='hs-comment'>{-
<a name="line-1978"></a>
<a name="line-1979"></a>Note [CoVarsOfX and the InterestingVarFun]
<a name="line-1980"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1981"></a>
<a name="line-1982"></a>The coVarsOfType, coVarsOfTypes, coVarsOfCo, and coVarsOfCos functions are
<a name="line-1983"></a>implemented in terms of the respective FV equivalents (tyCoFVsOf...), rather
<a name="line-1984"></a>than the VarSet-based flavors (tyCoVarsOf...), despite the performance
<a name="line-1985"></a>considerations outlined in Note [Free variables of types].
<a name="line-1986"></a>
<a name="line-1987"></a>This is because FV includes the InterestingVarFun, which is useful here,
<a name="line-1988"></a>because we can cleverly use it to restrict our calculations to CoVars - this
<a name="line-1989"></a>is what getCoVarSet achieves.
<a name="line-1990"></a>
<a name="line-1991"></a>See Trac #14880.
<a name="line-1992"></a>
<a name="line-1993"></a>-}</span>
<a name="line-1994"></a>
<a name="line-1995"></a><a name="getCoVarSet"></a><span class='hs-definition'>getCoVarSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FV</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1996"></a><span class='hs-definition'>getCoVarSet</span> <span class='hs-varid'>fv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>fv</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyVarSet</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1997"></a>
<a name="line-1998"></a><a name="coVarsOfType"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-1999"></a><span class='hs-definition'>coVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCoVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2000"></a>
<a name="line-2001"></a><a name="coVarsOfTypes"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>
<a name="line-2002"></a><span class='hs-definition'>coVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCoVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2003"></a>
<a name="line-2004"></a><a name="coVarsOfCo"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-2005"></a><span class='hs-definition'>coVarsOfCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCoVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2006"></a>
<a name="line-2007"></a><a name="coVarsOfCos"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarSet</span>
<a name="line-2008"></a><span class='hs-definition'>coVarsOfCos</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getCoVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoFVsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2009"></a>
<a name="line-2010"></a><span class='hs-comment'>----- Whether a covar is /Almost Devoid/ in a type or coercion ----</span>
<a name="line-2011"></a>
<a name="line-2012"></a><a name="almostDevoidCoVarOfCo"></a><span class='hs-comment'>-- | Given a covar and a coercion, returns True if covar is almost devoid in</span>
<a name="line-2013"></a><span class='hs-comment'>-- the coercion. That is, covar can only appear in Refl and GRefl.</span>
<a name="line-2014"></a><span class='hs-comment'>-- See last wrinkle in Note [Unused coercion variable in ForAllCo] in Coercion</span>
<a name="line-2015"></a><span class='hs-definition'>almostDevoidCoVarOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2016"></a><span class='hs-definition'>almostDevoidCoVarOfCo</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span>
<a name="line-2017"></a>  <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2018"></a>
<a name="line-2019"></a><a name="almost_devoid_co_var_of_co"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2020"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- covar is allowed in Refl and</span>
<a name="line-2021"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>  <span class='hs-comment'>-- GRefl, so we don't look into</span>
<a name="line-2022"></a>                                                <span class='hs-comment'>-- the coercions</span>
<a name="line-2023"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2024"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>cv</span>
<a name="line-2025"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2026"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2027"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-2028"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2029"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>cv</span>
<a name="line-2030"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>||</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-2031"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2032"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cv</span>
<a name="line-2033"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>cv</span>
<a name="line-2034"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>cv</span>
<a name="line-2035"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>  <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>cv</span>
<a name="line-2036"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2037"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>cv</span>
<a name="line-2038"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2039"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_prov</span> <span class='hs-varid'>p</span> <span class='hs-varid'>cv</span>
<a name="line-2040"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>cv</span>
<a name="line-2041"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>cv</span>
<a name="line-2042"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2043"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2044"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2045"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cv</span>
<a name="line-2046"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co2</span> <span class='hs-varid'>cv</span>
<a name="line-2047"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2048"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2049"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2050"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2051"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2052"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2053"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-2054"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2055"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2056"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2057"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2058"></a><span class='hs-definition'>almost_devoid_co_var_of_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2059"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cs</span> <span class='hs-varid'>cv</span>
<a name="line-2060"></a>
<a name="line-2061"></a><a name="almost_devoid_co_var_of_cos"></a><span class='hs-definition'>almost_devoid_co_var_of_cos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2062"></a><span class='hs-definition'>almost_devoid_co_var_of_cos</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2063"></a><span class='hs-definition'>almost_devoid_co_var_of_cos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2064"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2065"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_cos</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>cv</span>
<a name="line-2066"></a>
<a name="line-2067"></a><a name="almost_devoid_co_var_of_prov"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2068"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2069"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2070"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2071"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2072"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2073"></a><span class='hs-definition'>almost_devoid_co_var_of_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2074"></a>
<a name="line-2075"></a><a name="almost_devoid_co_var_of_type"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2076"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2077"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2078"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cv</span>
<a name="line-2079"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2080"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2081"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>cv</span>
<a name="line-2082"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-2083"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2084"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>cv</span>
<a name="line-2085"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>res</span> <span class='hs-varid'>cv</span>
<a name="line-2086"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2087"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2088"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>==</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>||</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-2089"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2090"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cv</span>
<a name="line-2091"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2092"></a><span class='hs-definition'>almost_devoid_co_var_of_type</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2093"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_co</span> <span class='hs-varid'>co</span> <span class='hs-varid'>cv</span>
<a name="line-2094"></a>
<a name="line-2095"></a><a name="almost_devoid_co_var_of_types"></a><span class='hs-definition'>almost_devoid_co_var_of_types</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2096"></a><span class='hs-definition'>almost_devoid_co_var_of_types</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2097"></a><span class='hs-definition'>almost_devoid_co_var_of_types</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-2098"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>almost_devoid_co_var_of_type</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>cv</span>
<a name="line-2099"></a>  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>almost_devoid_co_var_of_types</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cv</span>
<a name="line-2100"></a>
<a name="line-2101"></a><span class='hs-comment'>------------- Injective free vars -----------------</span>
<a name="line-2102"></a>
<a name="line-2103"></a><a name="injectiveVarsOfType"></a><span class='hs-comment'>-- | Returns the free variables of a 'Type' that are in injective positions.</span>
<a name="line-2104"></a><span class='hs-comment'>-- For example, if @F@ is a non-injective type family, then:</span>
<a name="line-2105"></a><span class='hs-comment'>--</span>
<a name="line-2106"></a><span class='hs-comment'>-- @</span>
<a name="line-2107"></a><span class='hs-comment'>-- injectiveTyVarsOf( Either c (Maybe (a, F b c)) ) = {a,c}</span>
<a name="line-2108"></a><span class='hs-comment'>-- @</span>
<a name="line-2109"></a><span class='hs-comment'>--</span>
<a name="line-2110"></a><span class='hs-comment'>-- If @'injectiveVarsOfType' ty = itvs@, then knowing @ty@ fixes @itvs@.</span>
<a name="line-2111"></a><span class='hs-comment'>-- More formally, if</span>
<a name="line-2112"></a><span class='hs-comment'>-- @a@ is in @'injectiveVarsOfType' ty@</span>
<a name="line-2113"></a><span class='hs-comment'>-- and  @S1(ty) ~ S2(ty)@,</span>
<a name="line-2114"></a><span class='hs-comment'>-- then @S1(a)  ~ S2(a)@,</span>
<a name="line-2115"></a><span class='hs-comment'>-- where @S1@ and @S2@ are arbitrary substitutions.</span>
<a name="line-2116"></a><span class='hs-comment'>--</span>
<a name="line-2117"></a><span class='hs-comment'>-- See @Note [When does a tycon application need an explicit kind signature?]@.</span>
<a name="line-2118"></a><span class='hs-definition'>injectiveVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-2119"></a><span class='hs-definition'>injectiveVarsOfType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-2120"></a>  <span class='hs-keyword'>where</span>
<a name="line-2121"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-2122"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty'</span>
<a name="line-2123"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-2124"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>a</span>
<a name="line-2125"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty2</span>
<a name="line-2126"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2127"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>tyConInjectivityInfo</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-2128"></a>        <span class='hs-conid'>NotInjective</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyFV</span>
<a name="line-2129"></a>        <span class='hs-conid'>Injective</span> <span class='hs-varid'>inj</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapUnionFV</span> <span class='hs-varid'>go</span> <span class='hs-varop'>$</span>
<a name="line-2130"></a>                         <span class='hs-varid'>filterByList</span> <span class='hs-layout'>(</span><span class='hs-varid'>inj</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-2131"></a>                         <span class='hs-comment'>-- Oversaturated arguments to a tycon are</span>
<a name="line-2132"></a>                         <span class='hs-comment'>-- always injective, hence the repeat True</span>
<a name="line-2133"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tvb</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoFVsBndr</span> <span class='hs-varid'>tvb</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2134"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>LitTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span>
<a name="line-2135"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-2136"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>CoercionTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyFV</span>
<a name="line-2137"></a>
<a name="line-2138"></a><span class='hs-comment'>-- | Does a 'TyCon' (that is applied to some number of arguments) need to be</span>
<a name="line-2139"></a><span class='hs-comment'>-- ascribed with an explicit kind signature to resolve ambiguity if rendered as</span>
<a name="line-2140"></a><span class='hs-comment'>-- a source-syntax type?</span>
<a name="line-2141"></a><span class='hs-comment'>-- (See @Note [When does a tycon application need an explicit kind signature?]@</span>
<a name="line-2142"></a><span class='hs-comment'>-- for a full explanation of what this function checks for.)</span>
<a name="line-2143"></a>
<a name="line-2144"></a><a name="tyConAppNeedsKindSig"></a><span class='hs-comment'>-- Morally, this function ought to belong in TyCon.hs, not TyCoRep.hs, but</span>
<a name="line-2145"></a><span class='hs-comment'>-- accomplishing this requires a fair deal of futzing aruond with .hs-boot</span>
<a name="line-2146"></a><span class='hs-comment'>-- files.</span>
<a name="line-2147"></a><span class='hs-definition'>tyConAppNeedsKindSig</span>
<a name="line-2148"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- ^ Should specified binders count towards injective positions in</span>
<a name="line-2149"></a>           <span class='hs-comment'>--   the kind of the TyCon?</span>
<a name="line-2150"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>
<a name="line-2151"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>   <span class='hs-comment'>-- ^ The number of args the 'TyCon' is applied to.</span>
<a name="line-2152"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- ^ Does @T t_1 ... t_n@ need a kind signature? (Where @n@ is the</span>
<a name="line-2153"></a>           <span class='hs-comment'>--   number of arguments)</span>
<a name="line-2154"></a><span class='hs-definition'>tyConAppNeedsKindSig</span> <span class='hs-varid'>spec_inj_pos</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n_args</span>
<a name="line-2155"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LT</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>listLengthCmp</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>n_args</span>
<a name="line-2156"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2158"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropped_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>remaining_binders</span><span class='hs-layout'>)</span>
<a name="line-2159"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>n_args</span> <span class='hs-varid'>tc_binders</span>
<a name="line-2160"></a>        <span class='hs-varid'>result_kind</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>remaining_binders</span> <span class='hs-varid'>tc_res_kind</span>
<a name="line-2161"></a>        <span class='hs-varid'>result_vars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>result_kind</span>
<a name="line-2162"></a>        <span class='hs-varid'>dropped_vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fvVarSet</span> <span class='hs-varop'>$</span>
<a name="line-2163"></a>                       <span class='hs-varid'>mapUnionFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>injective_vars_of_binder</span> <span class='hs-varid'>spec_inj_pos</span><span class='hs-layout'>)</span>
<a name="line-2164"></a>                                  <span class='hs-varid'>dropped_binders</span>
<a name="line-2165"></a>
<a name="line-2166"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>subVarSet</span> <span class='hs-varid'>result_vars</span> <span class='hs-varid'>dropped_vars</span><span class='hs-layout'>)</span>
<a name="line-2167"></a>  <span class='hs-keyword'>where</span>
<a name="line-2168"></a>    <span class='hs-varid'>tc_binders</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tc</span>
<a name="line-2169"></a>    <span class='hs-varid'>tc_res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span>
<a name="line-2170"></a>
<a name="line-2171"></a>    <span class='hs-comment'>-- Returns the variables that would be fixed by knowing a TyConBinder. See</span>
<a name="line-2172"></a>    <span class='hs-comment'>-- Note [When does a tycon application need an explicit kind signature?]</span>
<a name="line-2173"></a>    <span class='hs-comment'>-- for a more detailed explanation of what this function does.</span>
<a name="line-2174"></a>    <span class='hs-varid'>injective_vars_of_binder</span>
<a name="line-2175"></a>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- Should specified binders count towards injective positions?</span>
<a name="line-2176"></a>              <span class='hs-comment'>-- (If you're using visible kind applications, then you want True</span>
<a name="line-2177"></a>              <span class='hs-comment'>-- here.)</span>
<a name="line-2178"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FV</span>
<a name="line-2179"></a>    <span class='hs-varid'>injective_vars_of_binder</span> <span class='hs-varid'>spec_inj_pos</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2180"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>vis</span> <span class='hs-keyword'>of</span>
<a name="line-2181"></a>        <span class='hs-conid'>AnonTCB</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>injectiveVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2182"></a>        <span class='hs-conid'>NamedTCB</span> <span class='hs-varid'>argf</span>
<a name="line-2183"></a>          <span class='hs-keyglyph'>|</span>     <span class='hs-layout'>(</span><span class='hs-varid'>argf</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Required</span><span class='hs-layout'>)</span>
<a name="line-2184"></a>             <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>spec_inj_pos</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>argf</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2185"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitFV</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`unionFV`</span> <span class='hs-varid'>injectiveVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-2186"></a>          <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>otherwise</span>
<a name="line-2187"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyFV</span>
<a name="line-2188"></a>
<a name="line-2189"></a><span class='hs-comment'>{-
<a name="line-2190"></a>Note [When does a tycon application need an explicit kind signature?]
<a name="line-2191"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2192"></a>There are a couple of places in GHC where we convert Core Types into forms that
<a name="line-2193"></a>more closely resemble user-written syntax. These include:
<a name="line-2194"></a>
<a name="line-2195"></a>1. Template Haskell Type reification (see, for instance, TcSplice.reify_tc_app)
<a name="line-2196"></a>2. Converting Types to LHsTypes (in HsUtils.typeToLHsType, or in Haddock)
<a name="line-2197"></a>
<a name="line-2198"></a>This conversion presents a challenge: how do we ensure that the resulting type
<a name="line-2199"></a>has enough kind information so as not to be ambiguous? To better motivate this
<a name="line-2200"></a>question, consider the following Core type:
<a name="line-2201"></a>
<a name="line-2202"></a>  -- Foo :: Type -&gt; Type
<a name="line-2203"></a>  type Foo = Proxy Type
<a name="line-2204"></a>
<a name="line-2205"></a>There is nothing ambiguous about the RHS of Foo in Core. But if we were to,
<a name="line-2206"></a>say, reify it into a TH Type, then it's tempting to just drop the invisible
<a name="line-2207"></a>Type argument and simply return `Proxy`. But now we've lost crucial kind
<a name="line-2208"></a>information: we don't know if we're dealing with `Proxy Type` or `Proxy Bool`
<a name="line-2209"></a>or `Proxy Int` or something else! We've inadvertently introduced ambiguity.
<a name="line-2210"></a>
<a name="line-2211"></a>Unlike in other situations in GHC, we can't just turn on
<a name="line-2212"></a>-fprint-explicit-kinds, as we need to produce something which has the same
<a name="line-2213"></a>structure as a source-syntax type. Moreover, we can't rely on visible kind
<a name="line-2214"></a>application, since the first kind argument to Proxy is inferred, not specified.
<a name="line-2215"></a>Our solution is to annotate certain tycons with their kinds whenever they
<a name="line-2216"></a>appear in applied form in order to resolve the ambiguity. For instance, we
<a name="line-2217"></a>would reify the RHS of Foo like so:
<a name="line-2218"></a>
<a name="line-2219"></a>  type Foo = (Proxy :: Type -&gt; Type)
<a name="line-2220"></a>
<a name="line-2221"></a>We need to devise an algorithm that determines precisely which tycons need
<a name="line-2222"></a>these explicit kind signatures. We certainly don't want to annotate _every_
<a name="line-2223"></a>tycon with a kind signature, or else we might end up with horribly bloated
<a name="line-2224"></a>types like the following:
<a name="line-2225"></a>
<a name="line-2226"></a>  (Either :: Type -&gt; Type -&gt; Type) (Int :: Type) (Char :: Type)
<a name="line-2227"></a>
<a name="line-2228"></a>We only want to annotate tycons that absolutely require kind signatures in
<a name="line-2229"></a>order to resolve some sort of ambiguity, and nothing more.
<a name="line-2230"></a>
<a name="line-2231"></a>Suppose we have a tycon application (T ty_1 ... ty_n). Why might this type
<a name="line-2232"></a>require a kind signature? It might require it when we need to fill in any of
<a name="line-2233"></a>T's omitted arguments. By "omitted argument", we mean one that is dropped when
<a name="line-2234"></a>reifying ty_1 ... ty_n. Sometimes, the omitted arguments are inferred and
<a name="line-2235"></a>specified arguments (e.g., TH reification in TcSplice), and sometimes the
<a name="line-2236"></a>omitted arguments are only the inferred ones (e.g., in HsUtils.typeToLHsType,
<a name="line-2237"></a>which reifies specified arguments through visible kind application).
<a name="line-2238"></a>Regardless, the key idea is that _some_ arguments are going to be omitted after
<a name="line-2239"></a>reification, and the only mechanism we have at our disposal for filling them in
<a name="line-2240"></a>is through explicit kind signatures.
<a name="line-2241"></a>
<a name="line-2242"></a>What do we mean by "fill in"? Let's consider this small example:
<a name="line-2243"></a>
<a name="line-2244"></a>  T :: forall {k}. Type -&gt; (k -&gt; Type) -&gt; k
<a name="line-2245"></a>
<a name="line-2246"></a>Moreover, we have this application of T:
<a name="line-2247"></a>
<a name="line-2248"></a>  T @{j} Int aty
<a name="line-2249"></a>
<a name="line-2250"></a>When we reify this type, we omit the inferred argument @{j}. Is it fixed by the
<a name="line-2251"></a>other (non-inferred) arguments? Yes! If we know the kind of (aty :: blah), then
<a name="line-2252"></a>we'll generate an equality constraint (kappa -&gt; Type) and, assuming we can
<a name="line-2253"></a>solve it, that will fix `kappa`. (Here, `kappa` is the unification variable
<a name="line-2254"></a>that we instantiate `k` with.)
<a name="line-2255"></a>
<a name="line-2256"></a>Therefore, for any application of a tycon T to some arguments, the Question We
<a name="line-2257"></a>Must Answer is:
<a name="line-2258"></a>
<a name="line-2259"></a>* Given the first n arguments of T, do the kinds of the non-omitted arguments
<a name="line-2260"></a>  fill in the omitted arguments?
<a name="line-2261"></a>
<a name="line-2262"></a>(This is still a bit hand-wavey, but we'll refine this question incrementally
<a name="line-2263"></a>as we explain more of the machinery underlying this process.)
<a name="line-2264"></a>
<a name="line-2265"></a>Answering this question is precisely the role that the `injectiveVarsOfType`
<a name="line-2266"></a>and `injective_vars_of_binder` functions exist to serve. If an omitted argument
<a name="line-2267"></a>`a` appears in the set returned by `injectiveVarsOfType ty`, then knowing
<a name="line-2268"></a>`ty` determines (i.e., fills in) `a`. (More on `injective_vars_of_binder` in a
<a name="line-2269"></a>bit.)
<a name="line-2270"></a>
<a name="line-2271"></a>More formally, if
<a name="line-2272"></a>`a` is in `injectiveVarsOfType ty`
<a name="line-2273"></a>and  S1(ty) ~ S2(ty),
<a name="line-2274"></a>then S1(a)  ~ S2(a),
<a name="line-2275"></a>where S1 and S2 are arbitrary substitutions.
<a name="line-2276"></a>
<a name="line-2277"></a>For example, is `F` is a non-injective type family, then
<a name="line-2278"></a>
<a name="line-2279"></a>  injectiveVarsOfType(Either c (Maybe (a, F b c))) = {a, c}
<a name="line-2280"></a>
<a name="line-2281"></a>Now that we know what this function does, here is a second attempt at the
<a name="line-2282"></a>Question We Must Answer:
<a name="line-2283"></a>
<a name="line-2284"></a>* Given the first n arguments of T (ty_1 ... ty_n), consider the binders
<a name="line-2285"></a>  of T that are instantiated by non-omitted arguments. Do the injective
<a name="line-2286"></a>  variables of these binders fill in the remainder of T's kind?
<a name="line-2287"></a>
<a name="line-2288"></a>Alright, we're getting closer. Next, we need to clarify what the injective
<a name="line-2289"></a>variables of a tycon binder are. This the role that the
<a name="line-2290"></a>`injective_vars_of_binder` function serves. Here is what this function does for
<a name="line-2291"></a>each form of tycon binder:
<a name="line-2292"></a>
<a name="line-2293"></a>* Anonymous binders are injective positions. For example, in the promoted data
<a name="line-2294"></a>  constructor '(:):
<a name="line-2295"></a>
<a name="line-2296"></a>    '(:) :: forall a. a -&gt; [a] -&gt; [a]
<a name="line-2297"></a>
<a name="line-2298"></a>  The second and third tyvar binders (of kinds `a` and `[a]`) are both
<a name="line-2299"></a>  anonymous, so if we had '(:) 'True '[], then the kinds of 'True and
<a name="line-2300"></a>  '[] would contribute to the kind of '(:) 'True '[]. Therefore,
<a name="line-2301"></a>  injective_vars_of_binder(_ :: a) = injectiveVarsOfType(a) = {a}.
<a name="line-2302"></a>  (Similarly, injective_vars_of_binder(_ :: [a]) = {a}.)
<a name="line-2303"></a>* Named binders:
<a name="line-2304"></a>  - Inferred binders are never injective positions. For example, in this data
<a name="line-2305"></a>    type:
<a name="line-2306"></a>
<a name="line-2307"></a>      data Proxy a
<a name="line-2308"></a>      Proxy :: forall {k}. k -&gt; Type
<a name="line-2309"></a>
<a name="line-2310"></a>    If we had Proxy 'True, then the kind of 'True would not contribute to the
<a name="line-2311"></a>    kind of Proxy 'True. Therefore,
<a name="line-2312"></a>    injective_vars_of_binder(forall {k}. ...) = {}.
<a name="line-2313"></a>  - Required binders are injective positions. For example, in this data type:
<a name="line-2314"></a>
<a name="line-2315"></a>      data Wurble k (a :: k) :: k
<a name="line-2316"></a>      Wurble :: forall k -&gt; k -&gt; k
<a name="line-2317"></a>
<a name="line-2318"></a>  The first tyvar binder (of kind `forall k`) has required visibility, so if
<a name="line-2319"></a>  we had Wurble (Maybe a) Nothing, then the kind of Maybe a would
<a name="line-2320"></a>  contribute to the kind of Wurble (Maybe a) Nothing. Hence,
<a name="line-2321"></a>  injective_vars_of_binder(forall a -&gt; ...) = {a}.
<a name="line-2322"></a>  - Specified binders /might/ be injective positions, depending on how you
<a name="line-2323"></a>    approach things. Continuing the '(:) example:
<a name="line-2324"></a>
<a name="line-2325"></a>      '(:) :: forall a. a -&gt; [a] -&gt; [a]
<a name="line-2326"></a>
<a name="line-2327"></a>    Normally, the (forall a. ...) tyvar binder wouldn't contribute to the kind
<a name="line-2328"></a>    of '(:) 'True '[], since it's not explicitly instantiated by the user. But
<a name="line-2329"></a>    if visible kind application is enabled, then this is possible, since the
<a name="line-2330"></a>    user can write '(:) @Bool 'True '[]. (In that case,
<a name="line-2331"></a>    injective_vars_of_binder(forall a. ...) = {a}.)
<a name="line-2332"></a>
<a name="line-2333"></a>    There are some situations where using visible kind application is appropriate
<a name="line-2334"></a>    (e.g., HsUtils.typeToLHsType) and others where it is not (e.g., TH
<a name="line-2335"></a>    reification), so the `injective_vars_of_binder` function is parametrized by
<a name="line-2336"></a>    a Bool which decides if specified binders should be counted towards
<a name="line-2337"></a>    injective positions or not.
<a name="line-2338"></a>
<a name="line-2339"></a>Now that we've defined injective_vars_of_binder, we can refine the Question We
<a name="line-2340"></a>Must Answer once more:
<a name="line-2341"></a>
<a name="line-2342"></a>* Given the first n arguments of T (ty_1 ... ty_n), consider the binders
<a name="line-2343"></a>  of T that are instantiated by non-omitted arguments. For each such binder
<a name="line-2344"></a>  b_i, take the union of all injective_vars_of_binder(b_i). Is this set a
<a name="line-2345"></a>  superset of the free variables of the remainder of T's kind?
<a name="line-2346"></a>
<a name="line-2347"></a>If the answer to this question is "no", then (T ty_1 ... ty_n) needs an
<a name="line-2348"></a>explicit kind signature, since T's kind has kind variables leftover that
<a name="line-2349"></a>aren't fixed by the non-omitted arguments.
<a name="line-2350"></a>
<a name="line-2351"></a>One last sticking point: what does "the remainder of T's kind" mean? You might
<a name="line-2352"></a>be tempted to think that it corresponds to all of the arguments in the kind of
<a name="line-2353"></a>T that would normally be instantiated by omitted arguments. But this isn't
<a name="line-2354"></a>quite right, strictly speaking. Consider the following (silly) example:
<a name="line-2355"></a>
<a name="line-2356"></a>  S :: forall {k}. Type -&gt; Type
<a name="line-2357"></a>
<a name="line-2358"></a>And suppose we have this application of S:
<a name="line-2359"></a>
<a name="line-2360"></a>  S Int Bool
<a name="line-2361"></a>
<a name="line-2362"></a>The Int argument would be omitted, and
<a name="line-2363"></a>injective_vars_of_binder(_ :: Type) = {}. This is not a superset of {k}, which
<a name="line-2364"></a>might suggest that (S Bool) needs an explicit kind signature. But
<a name="line-2365"></a>(S Bool :: Type) doesn't actually fix `k`! This is because the kind signature
<a name="line-2366"></a>only affects the /result/ of the application, not all of the individual
<a name="line-2367"></a>arguments. So adding a kind signature here won't make a difference. Therefore,
<a name="line-2368"></a>the fourth (and final) iteration of the Question We Must Answer is:
<a name="line-2369"></a>
<a name="line-2370"></a>* Given the first n arguments of T (ty_1 ... ty_n), consider the binders
<a name="line-2371"></a>  of T that are instantiated by non-omitted arguments. For each such binder
<a name="line-2372"></a>  b_i, take the union of all injective_vars_of_binder(b_i). Is this set a
<a name="line-2373"></a>  superset of the free variables of the kind of (T ty_1 ... ty_n)?
<a name="line-2374"></a>
<a name="line-2375"></a>Phew, that was a lot of work!
<a name="line-2376"></a>
<a name="line-2377"></a>How can be sure that this is correct? That is, how can we be sure that in the
<a name="line-2378"></a>event that we leave off a kind annotation, that one could infer the kind of the
<a name="line-2379"></a>tycon application from its arguments? It's essentially a proof by induction: if
<a name="line-2380"></a>we can infer the kinds of every subtree of a type, then the whole tycon
<a name="line-2381"></a>application will have an inferrable kind--unless, of course, the remainder of
<a name="line-2382"></a>the tycon application's kind has uninstantiated kind variables.
<a name="line-2383"></a>
<a name="line-2384"></a>What happens if T is oversaturated? That is, if T's kind has fewer than n
<a name="line-2385"></a>arguments, in the case that the concrete application instantiates a result
<a name="line-2386"></a>kind variable with an arrow kind? If we run out of arguments, we do not attach
<a name="line-2387"></a>a kind annotation. This should be a rare case, indeed. Here is an example:
<a name="line-2388"></a>
<a name="line-2389"></a>   data T1 :: k1 -&gt; k2 -&gt; *
<a name="line-2390"></a>   data T2 :: k1 -&gt; k2 -&gt; *
<a name="line-2391"></a>
<a name="line-2392"></a>   type family G (a :: k) :: k
<a name="line-2393"></a>   type instance G T1 = T2
<a name="line-2394"></a>
<a name="line-2395"></a>   type instance F Char = (G T1 Bool :: (* -&gt; *) -&gt; *)   -- F from above
<a name="line-2396"></a>
<a name="line-2397"></a>Here G's kind is (forall k. k -&gt; k), and the desugared RHS of that last
<a name="line-2398"></a>instance of F is (G (* -&gt; (* -&gt; *) -&gt; *) (T1 * (* -&gt; *)) Bool). According to
<a name="line-2399"></a>the algorithm above, there are 3 arguments to G so we should peel off 3
<a name="line-2400"></a>arguments in G's kind. But G's kind has only two arguments. This is the
<a name="line-2401"></a>rare special case, and we choose not to annotate the application of G with
<a name="line-2402"></a>a kind signature. After all, we needn't do this, since that instance would
<a name="line-2403"></a>be reified as:
<a name="line-2404"></a>
<a name="line-2405"></a>   type instance F Char = G (T1 :: * -&gt; (* -&gt; *) -&gt; *) Bool
<a name="line-2406"></a>
<a name="line-2407"></a>So the kind of G isn't ambiguous anymore due to the explicit kind annotation
<a name="line-2408"></a>on its argument. See #8953 and test th/T8953.
<a name="line-2409"></a>-}</span>
<a name="line-2410"></a>
<a name="line-2411"></a><span class='hs-comment'>------------- No free vars -----------------</span>
<a name="line-2412"></a>
<a name="line-2413"></a><a name="noFreeVarsOfType"></a><span class='hs-comment'>-- | Returns True if this type has no free variables. Should be the same as</span>
<a name="line-2414"></a><span class='hs-comment'>-- isEmptyVarSet . tyCoVarsOfType, but faster in the non-forall case.</span>
<a name="line-2415"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2416"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2417"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t2</span>
<a name="line-2418"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>tys</span>
<a name="line-2419"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2420"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t2</span>
<a name="line-2421"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2422"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2423"></a><span class='hs-definition'>noFreeVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2424"></a>
<a name="line-2425"></a><a name="noFreeVarsOfMCo"></a><span class='hs-definition'>noFreeVarsOfMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2426"></a><span class='hs-definition'>noFreeVarsOfMCo</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2427"></a><span class='hs-definition'>noFreeVarsOfMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2428"></a>
<a name="line-2429"></a><a name="noFreeVarsOfTypes"></a><span class='hs-definition'>noFreeVarsOfTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2430"></a><span class='hs-definition'>noFreeVarsOfTypes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfType</span>
<a name="line-2431"></a>
<a name="line-2432"></a><a name="noFreeVarsOfCo"></a><span class='hs-comment'>-- | Returns True if this coercion has no free variables. Should be the same as</span>
<a name="line-2433"></a><span class='hs-comment'>-- isEmptyVarSet . tyCoVarsOfCo, but faster in the non-forall case.</span>
<a name="line-2434"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2435"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-2436"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfMCo</span> <span class='hs-varid'>co</span>
<a name="line-2437"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>args</span>
<a name="line-2438"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c2</span>
<a name="line-2439"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2440"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c1</span> <span class='hs-varid'>c2</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>c2</span>
<a name="line-2441"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-2442"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>    <span class='hs-comment'>-- I'm unsure; probably never happens</span>
<a name="line-2443"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>args</span>
<a name="line-2444"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2445"></a>                                        <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2446"></a>                                        <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>t2</span>
<a name="line-2447"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2448"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-2449"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2450"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2451"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co2</span>
<a name="line-2452"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2453"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2454"></a><span class='hs-definition'>noFreeVarsOfCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>cs</span>
<a name="line-2455"></a>
<a name="line-2456"></a><a name="noFreeVarsOfProv"></a><span class='hs-comment'>-- | Returns True if this UnivCoProv has no free variables. Should be the same as</span>
<a name="line-2457"></a><span class='hs-comment'>-- isEmptyVarSet . tyCoVarsOfProv, but faster in the non-forall case.</span>
<a name="line-2458"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2459"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2460"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2461"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>co</span>
<a name="line-2462"></a><span class='hs-definition'>noFreeVarsOfProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-2463"></a>
<a name="line-2464"></a><span class='hs-comment'>{-
<a name="line-2465"></a>%************************************************************************
<a name="line-2466"></a>%*                                                                      *
<a name="line-2467"></a>                        Substitutions
<a name="line-2468"></a>      Data type defined here to avoid unnecessary mutual recursion
<a name="line-2469"></a>%*                                                                      *
<a name="line-2470"></a>%************************************************************************
<a name="line-2471"></a>-}</span>
<a name="line-2472"></a>
<a name="line-2473"></a><a name="TCvSubst"></a><span class='hs-comment'>-- | Type &amp; coercion substitution</span>
<a name="line-2474"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-2475"></a><a name="TCvSubst"></a><span class='hs-comment'>-- #tcvsubst_invariant#</span>
<a name="line-2476"></a><a name="TCvSubst"></a><span class='hs-comment'>-- The following invariants must hold of a 'TCvSubst':</span>
<a name="line-2477"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-2478"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 1. The in-scope set is needed /only/ to</span>
<a name="line-2479"></a><a name="TCvSubst"></a><span class='hs-comment'>-- guide the generation of fresh uniques</span>
<a name="line-2480"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-2481"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 2. In particular, the /kind/ of the type variables in</span>
<a name="line-2482"></a><a name="TCvSubst"></a><span class='hs-comment'>-- the in-scope set is not relevant</span>
<a name="line-2483"></a><a name="TCvSubst"></a><span class='hs-comment'>--</span>
<a name="line-2484"></a><a name="TCvSubst"></a><span class='hs-comment'>-- 3. The substitution is only applied ONCE! This is because</span>
<a name="line-2485"></a><a name="TCvSubst"></a><span class='hs-comment'>-- in general such application will not reach a fixed point.</span>
<a name="line-2486"></a><a name="TCvSubst"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2487"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-comment'>-- The in-scope type and kind variables</span>
<a name="line-2488"></a>             <span class='hs-conid'>TvSubstEnv</span> <span class='hs-comment'>-- Substitutes both type and kind variables</span>
<a name="line-2489"></a>             <span class='hs-conid'>CvSubstEnv</span> <span class='hs-comment'>-- Substitutes coercion variables</span>
<a name="line-2490"></a>        <span class='hs-comment'>-- See Note [Substitutions apply only once]</span>
<a name="line-2491"></a>        <span class='hs-comment'>-- and Note [Extending the TvSubstEnv]</span>
<a name="line-2492"></a>        <span class='hs-comment'>-- and Note [Substituting types and coercions]</span>
<a name="line-2493"></a>        <span class='hs-comment'>-- and Note [The substitution invariant]</span>
<a name="line-2494"></a>
<a name="line-2495"></a><a name="TvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Type's for 'TyVar's</span>
<a name="line-2496"></a><a name="TvSubstEnv"></a><span class='hs-comment'>--                 and 'Kind's for 'KindVar's</span>
<a name="line-2497"></a><a name="TvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarEnv</span> <span class='hs-conid'>Type</span>
<a name="line-2498"></a>  <span class='hs-comment'>-- NB: A TvSubstEnv is used</span>
<a name="line-2499"></a>  <span class='hs-comment'>--   both inside a TCvSubst (with the apply-once invariant</span>
<a name="line-2500"></a>  <span class='hs-comment'>--        discussed in Note [Substitutions apply only once],</span>
<a name="line-2501"></a>  <span class='hs-comment'>--   and  also independently in the middle of matching,</span>
<a name="line-2502"></a>  <span class='hs-comment'>--        and unification (see Types.Unify).</span>
<a name="line-2503"></a>  <span class='hs-comment'>-- So you have to look at the context to know if it's idempotent or</span>
<a name="line-2504"></a>  <span class='hs-comment'>-- apply-once or whatever</span>
<a name="line-2505"></a>
<a name="line-2506"></a><a name="CvSubstEnv"></a><span class='hs-comment'>-- | A substitution of 'Coercion's for 'CoVar's</span>
<a name="line-2507"></a><a name="CvSubstEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-2508"></a>
<a name="line-2509"></a><span class='hs-comment'>{- Note [The substitution invariant]
<a name="line-2510"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2511"></a>When calling (substTy subst ty) it should be the case that
<a name="line-2512"></a>the in-scope set in the substitution is a superset of both:
<a name="line-2513"></a>
<a name="line-2514"></a>  (SIa) The free vars of the range of the substitution
<a name="line-2515"></a>  (SIb) The free vars of ty minus the domain of the substitution
<a name="line-2516"></a>
<a name="line-2517"></a>The same rules apply to other substitutions (notably CoreSubst.Subst)
<a name="line-2518"></a>
<a name="line-2519"></a>* Reason for (SIa). Consider
<a name="line-2520"></a>      substTy [a :-&gt; Maybe b] (forall b. b-&gt;a)
<a name="line-2521"></a>  we must rename the forall b, to get
<a name="line-2522"></a>      forall b2. b2 -&gt; Maybe b
<a name="line-2523"></a>  Making 'b' part of the in-scope set forces this renaming to
<a name="line-2524"></a>  take place.
<a name="line-2525"></a>
<a name="line-2526"></a>* Reason for (SIb). Consider
<a name="line-2527"></a>     substTy [a :-&gt; Maybe b] (forall b. (a,b,x))
<a name="line-2528"></a>  Then if we use the in-scope set {b}, satisfying (SIa), there is
<a name="line-2529"></a>  a danger we will rename the forall'd variable to 'x' by mistake,
<a name="line-2530"></a>  getting this:
<a name="line-2531"></a>      forall x. (Maybe b, x, x)
<a name="line-2532"></a>  Breaking (SIb) caused the bug from #11371.
<a name="line-2533"></a>
<a name="line-2534"></a>Note: if the free vars of the range of the substitution are freshly created,
<a name="line-2535"></a>then the problems of (SIa) can't happen, and so it would be sound to
<a name="line-2536"></a>ignore (SIa).
<a name="line-2537"></a>
<a name="line-2538"></a>Note [Substitutions apply only once]
<a name="line-2539"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2540"></a>We use TCvSubsts to instantiate things, and we might instantiate
<a name="line-2541"></a>        forall a b. ty
<a name="line-2542"></a>with the types
<a name="line-2543"></a>        [a, b], or [b, a].
<a name="line-2544"></a>So the substitution might go [a-&gt;b, b-&gt;a].  A similar situation arises in Core
<a name="line-2545"></a>when we find a beta redex like
<a name="line-2546"></a>        (/\ a /\ b -&gt; e) b a
<a name="line-2547"></a>Then we also end up with a substitution that permutes type variables. Other
<a name="line-2548"></a>variations happen to; for example [a -&gt; (a, b)].
<a name="line-2549"></a>
<a name="line-2550"></a>        ********************************************************
<a name="line-2551"></a>        *** So a substitution must be applied precisely once ***
<a name="line-2552"></a>        ********************************************************
<a name="line-2553"></a>
<a name="line-2554"></a>A TCvSubst is not idempotent, but, unlike the non-idempotent substitution
<a name="line-2555"></a>we use during unifications, it must not be repeatedly applied.
<a name="line-2556"></a>
<a name="line-2557"></a>Note [Extending the TvSubstEnv]
<a name="line-2558"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2559"></a>See #tcvsubst_invariant# for the invariants that must hold.
<a name="line-2560"></a>
<a name="line-2561"></a>This invariant allows a short-cut when the subst envs are empty:
<a name="line-2562"></a>if the TvSubstEnv and CvSubstEnv are empty --- i.e. (isEmptyTCvSubst subst)
<a name="line-2563"></a>holds --- then (substTy subst ty) does nothing.
<a name="line-2564"></a>
<a name="line-2565"></a>For example, consider:
<a name="line-2566"></a>        (/\a. /\b:(a~Int). ...b..) Int
<a name="line-2567"></a>We substitute Int for 'a'.  The Unique of 'b' does not change, but
<a name="line-2568"></a>nevertheless we add 'b' to the TvSubstEnv, because b's kind does change
<a name="line-2569"></a>
<a name="line-2570"></a>This invariant has several crucial consequences:
<a name="line-2571"></a>
<a name="line-2572"></a>* In substVarBndr, we need extend the TvSubstEnv
<a name="line-2573"></a>        - if the unique has changed
<a name="line-2574"></a>        - or if the kind has changed
<a name="line-2575"></a>
<a name="line-2576"></a>* In substTyVar, we do not need to consult the in-scope set;
<a name="line-2577"></a>  the TvSubstEnv is enough
<a name="line-2578"></a>
<a name="line-2579"></a>* In substTy, substTheta, we can short-circuit when the TvSubstEnv is empty
<a name="line-2580"></a>
<a name="line-2581"></a>Note [Substituting types and coercions]
<a name="line-2582"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2583"></a>Types and coercions are mutually recursive, and either may have variables
<a name="line-2584"></a>"belonging" to the other. Thus, every time we wish to substitute in a
<a name="line-2585"></a>type, we may also need to substitute in a coercion, and vice versa.
<a name="line-2586"></a>However, the constructor used to create type variables is distinct from
<a name="line-2587"></a>that of coercion variables, so we carry two VarEnvs in a TCvSubst. Note
<a name="line-2588"></a>that it would be possible to use the CoercionTy constructor to combine
<a name="line-2589"></a>these environments, but that seems like a false economy.
<a name="line-2590"></a>
<a name="line-2591"></a>Note that the TvSubstEnv should *never* map a CoVar (built with the Id
<a name="line-2592"></a>constructor) and the CvSubstEnv should *never* map a TyVar. Furthermore,
<a name="line-2593"></a>the range of the TvSubstEnv should *never* include a type headed with
<a name="line-2594"></a>CoercionTy.
<a name="line-2595"></a>-}</span>
<a name="line-2596"></a>
<a name="line-2597"></a><a name="emptyTvSubstEnv"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-2598"></a><span class='hs-definition'>emptyTvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-2599"></a>
<a name="line-2600"></a><a name="emptyCvSubstEnv"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-2601"></a><span class='hs-definition'>emptyCvSubstEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-2602"></a>
<a name="line-2603"></a><a name="composeTCvSubstEnv"></a><span class='hs-definition'>composeTCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-2604"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-2605"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-2606"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span>
<a name="line-2607"></a><span class='hs-comment'>-- ^ @(compose env1 env2)(x)@ is @env1(env2(x))@; i.e. apply @env2@ then @env1@.</span>
<a name="line-2608"></a><span class='hs-comment'>-- It assumes that both are idempotent.</span>
<a name="line-2609"></a><span class='hs-comment'>-- Typically, @env1@ is the refinement to a base substitution @env2@</span>
<a name="line-2610"></a><span class='hs-definition'>composeTCvSubstEnv</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-2611"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tenv1</span> <span class='hs-varop'>`plusVarEnv`</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv2</span>
<a name="line-2612"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span> <span class='hs-varop'>`plusVarEnv`</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv2</span> <span class='hs-layout'>)</span>
<a name="line-2613"></a>        <span class='hs-comment'>-- First apply env1 to the range of env2</span>
<a name="line-2614"></a>        <span class='hs-comment'>-- Then combine the two, making sure that env1 loses if</span>
<a name="line-2615"></a>        <span class='hs-comment'>-- both bind the same variable; that's why env1 is the</span>
<a name="line-2616"></a>        <span class='hs-comment'>--  *left* argument to plusVarEnv, because the right arg wins</span>
<a name="line-2617"></a>  <span class='hs-keyword'>where</span>
<a name="line-2618"></a>    <span class='hs-varid'>subst1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span>
<a name="line-2619"></a>
<a name="line-2620"></a><a name="composeTCvSubst"></a><span class='hs-comment'>-- | Composes two substitutions, applying the second one provided first,</span>
<a name="line-2621"></a><span class='hs-comment'>-- like in function composition.</span>
<a name="line-2622"></a><span class='hs-definition'>composeTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2623"></a><span class='hs-definition'>composeTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is1</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is2</span> <span class='hs-varid'>tenv2</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-2624"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is3</span> <span class='hs-varid'>tenv3</span> <span class='hs-varid'>cenv3</span>
<a name="line-2625"></a>  <span class='hs-keyword'>where</span>
<a name="line-2626"></a>    <span class='hs-varid'>is3</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>is2</span>
<a name="line-2627"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tenv3</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv3</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>composeTCvSubstEnv</span> <span class='hs-varid'>is3</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-2628"></a>
<a name="line-2629"></a><a name="emptyTCvSubst"></a><span class='hs-definition'>emptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2630"></a><span class='hs-definition'>emptyTCvSubst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-2631"></a>
<a name="line-2632"></a><a name="mkEmptyTCvSubst"></a><span class='hs-definition'>mkEmptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2633"></a><span class='hs-definition'>mkEmptyTCvSubst</span> <span class='hs-varid'>is</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>is</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-2634"></a>
<a name="line-2635"></a><a name="isEmptyTCvSubst"></a><span class='hs-definition'>isEmptyTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2636"></a>         <span class='hs-comment'>-- See Note [Extending the TvSubstEnv]</span>
<a name="line-2637"></a><span class='hs-definition'>isEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-2638"></a>
<a name="line-2639"></a><a name="mkTCvSubst"></a><span class='hs-definition'>mkTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2640"></a><span class='hs-definition'>mkTCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-2641"></a>
<a name="line-2642"></a><a name="mkTvSubst"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2643"></a><span class='hs-comment'>-- ^ Make a TCvSubst with specified tyvar subst and empty covar subst</span>
<a name="line-2644"></a><span class='hs-definition'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>emptyCvSubstEnv</span>
<a name="line-2645"></a>
<a name="line-2646"></a><a name="mkCvSubst"></a><span class='hs-definition'>mkCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2647"></a><span class='hs-comment'>-- ^ Make a TCvSubst with specified covar subst and empty tyvar subst</span>
<a name="line-2648"></a><span class='hs-definition'>mkCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-2649"></a>
<a name="line-2650"></a><a name="getTvSubstEnv"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-2651"></a><span class='hs-definition'>getTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-2652"></a>
<a name="line-2653"></a><a name="getCvSubstEnv"></a><span class='hs-definition'>getCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-2654"></a><span class='hs-definition'>getCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span>
<a name="line-2655"></a>
<a name="line-2656"></a><a name="getTCvInScope"></a><span class='hs-definition'>getTCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-2657"></a><span class='hs-definition'>getTCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>in_scope</span>
<a name="line-2658"></a>
<a name="line-2659"></a><a name="getTCvSubstRangeFVs"></a><span class='hs-comment'>-- | Returns the free variables of the types in the range of a substitution as</span>
<a name="line-2660"></a><span class='hs-comment'>-- a non-deterministic set.</span>
<a name="line-2661"></a><span class='hs-definition'>getTCvSubstRangeFVs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span>
<a name="line-2662"></a><span class='hs-definition'>getTCvSubstRangeFVs</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-2663"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unionVarSet</span> <span class='hs-varid'>tenvFVs</span> <span class='hs-varid'>cenvFVs</span>
<a name="line-2664"></a>  <span class='hs-keyword'>where</span>
<a name="line-2665"></a>    <span class='hs-varid'>tenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span>
<a name="line-2666"></a>    <span class='hs-varid'>cenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cenv</span>
<a name="line-2667"></a>
<a name="line-2668"></a><a name="isInScope"></a><span class='hs-definition'>isInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2669"></a><span class='hs-definition'>isInScope</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`elemInScopeSet`</span> <span class='hs-varid'>in_scope</span>
<a name="line-2670"></a>
<a name="line-2671"></a><a name="notElemTCvSubst"></a><span class='hs-definition'>notElemTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2672"></a><span class='hs-definition'>notElemTCvSubst</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-2673"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-2674"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-2675"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2676"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-2677"></a>
<a name="line-2678"></a><a name="setTvSubstEnv"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2679"></a><span class='hs-definition'>setTvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-2680"></a>
<a name="line-2681"></a><a name="setCvSubstEnv"></a><span class='hs-definition'>setCvSubstEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2682"></a><span class='hs-definition'>setCvSubstEnv</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-2683"></a>
<a name="line-2684"></a><a name="zapTCvSubst"></a><span class='hs-definition'>zapTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2685"></a><span class='hs-definition'>zapTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>emptyVarEnv</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-2686"></a>
<a name="line-2687"></a><a name="extendTCvInScope"></a><span class='hs-definition'>extendTCvInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2688"></a><span class='hs-definition'>extendTCvInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span>
<a name="line-2689"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-2690"></a>
<a name="line-2691"></a><a name="extendTCvInScopeList"></a><span class='hs-definition'>extendTCvInScopeList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2692"></a><span class='hs-definition'>extendTCvInScopeList</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-2693"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetList</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-2694"></a>
<a name="line-2695"></a><a name="extendTCvInScopeSet"></a><span class='hs-definition'>extendTCvInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2696"></a><span class='hs-definition'>extendTCvInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>vars</span>
<a name="line-2697"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>vars</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span>
<a name="line-2698"></a>
<a name="line-2699"></a><a name="extendTCvSubst"></a><span class='hs-definition'>extendTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2700"></a><span class='hs-definition'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-2701"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-2702"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-2703"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-2704"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-2705"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2706"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"extendTCvSubst"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"|-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2707"></a>
<a name="line-2708"></a><a name="extendTCvSubstWithClone"></a><span class='hs-definition'>extendTCvSubstWithClone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2709"></a><span class='hs-definition'>extendTCvSubstWithClone</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tcv</span>
<a name="line-2710"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tcv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubstWithClone</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tcv</span>
<a name="line-2711"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCvSubstWithClone</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tcv</span>
<a name="line-2712"></a>
<a name="line-2713"></a><a name="extendTvSubst"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2714"></a><span class='hs-definition'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2715"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>cenv</span>
<a name="line-2716"></a>
<a name="line-2717"></a><a name="extendTvSubstBinderAndInScope"></a><span class='hs-definition'>extendTvSubstBinderAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2718"></a><span class='hs-definition'>extendTvSubstBinderAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2719"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-layout'>)</span>
<a name="line-2720"></a>    <span class='hs-varid'>extendTvSubstAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span>
<a name="line-2721"></a><span class='hs-definition'>extendTvSubstBinderAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyword'>_</span>
<a name="line-2722"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst</span>
<a name="line-2723"></a>
<a name="line-2724"></a><a name="extendTvSubstWithClone"></a><span class='hs-definition'>extendTvSubstWithClone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2725"></a><span class='hs-comment'>-- Adds a new tv -&gt; tv mapping, /and/ extends the in-scope set</span>
<a name="line-2726"></a><span class='hs-definition'>extendTvSubstWithClone</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>tv'</span>
<a name="line-2727"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>new_in_scope</span><span class='hs-layout'>)</span>
<a name="line-2728"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2729"></a>             <span class='hs-varid'>cenv</span>
<a name="line-2730"></a>  <span class='hs-keyword'>where</span>
<a name="line-2731"></a>    <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>tv'</span>
<a name="line-2732"></a>
<a name="line-2733"></a><a name="extendCvSubst"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2734"></a><span class='hs-definition'>extendCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span>
<a name="line-2735"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2736"></a>
<a name="line-2737"></a><a name="extendCvSubstWithClone"></a><span class='hs-definition'>extendCvSubstWithClone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2738"></a><span class='hs-definition'>extendCvSubstWithClone</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>cv'</span>
<a name="line-2739"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSetSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>new_in_scope</span><span class='hs-layout'>)</span>
<a name="line-2740"></a>             <span class='hs-varid'>tenv</span>
<a name="line-2741"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2742"></a>  <span class='hs-keyword'>where</span>
<a name="line-2743"></a>    <span class='hs-varid'>new_in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>`extendVarSet`</span> <span class='hs-varid'>cv'</span>
<a name="line-2744"></a>
<a name="line-2745"></a><a name="extendTvSubstAndInScope"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2746"></a><span class='hs-comment'>-- Also extends the in-scope set</span>
<a name="line-2747"></a><span class='hs-definition'>extendTvSubstAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span>
<a name="line-2748"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSetSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2749"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2750"></a>             <span class='hs-varid'>cenv</span>
<a name="line-2751"></a>
<a name="line-2752"></a><a name="extendTvSubstList"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2753"></a><span class='hs-definition'>extendTvSubstList</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2754"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl2</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2755"></a>
<a name="line-2756"></a><a name="extendTCvSubstList"></a><span class='hs-definition'>extendTCvSubstList</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2757"></a><span class='hs-definition'>extendTCvSubstList</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2758"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl2</span> <span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2759"></a>
<a name="line-2760"></a><a name="unionTCvSubst"></a><span class='hs-definition'>unionTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2761"></a><span class='hs-comment'>-- Works when the ranges are disjoint</span>
<a name="line-2762"></a><span class='hs-definition'>unionTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope1</span> <span class='hs-varid'>tenv1</span> <span class='hs-varid'>cenv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope2</span> <span class='hs-varid'>tenv2</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-2763"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span> <span class='hs-varop'>`intersectsVarEnv`</span> <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-2764"></a>         <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>cenv1</span> <span class='hs-varop'>`intersectsVarEnv`</span> <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-2765"></a>    <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope1</span> <span class='hs-varop'>`unionInScope`</span> <span class='hs-varid'>in_scope2</span><span class='hs-layout'>)</span>
<a name="line-2766"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>tenv1</span>     <span class='hs-varop'>`plusVarEnv`</span>   <span class='hs-varid'>tenv2</span><span class='hs-layout'>)</span>
<a name="line-2767"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>cenv1</span>     <span class='hs-varop'>`plusVarEnv`</span>   <span class='hs-varid'>cenv2</span><span class='hs-layout'>)</span>
<a name="line-2768"></a>
<a name="line-2769"></a><span class='hs-comment'>-- mkTvSubstPrs and zipTvSubst generate the in-scope set from</span>
<a name="line-2770"></a><span class='hs-comment'>-- the types given; but it's just a thunk so with a bit of luck</span>
<a name="line-2771"></a><span class='hs-comment'>-- it'll never be evaluated</span>
<a name="line-2772"></a>
<a name="line-2773"></a><a name="zipTvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the incoming</span>
<a name="line-2774"></a><span class='hs-comment'>-- environment. No CoVars, please!</span>
<a name="line-2775"></a><span class='hs-definition'>zipTvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2776"></a><span class='hs-definition'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2777"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span>
<a name="line-2778"></a>  <span class='hs-keyword'>where</span>
<a name="line-2779"></a>    <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2780"></a>
<a name="line-2781"></a><a name="zipCvSubst"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the incoming</span>
<a name="line-2782"></a><span class='hs-comment'>-- environment.  No TyVars, please!</span>
<a name="line-2783"></a><span class='hs-definition'>zipCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2784"></a><span class='hs-definition'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span>
<a name="line-2785"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyTvSubstEnv</span> <span class='hs-varid'>cenv</span>
<a name="line-2786"></a>  <span class='hs-keyword'>where</span>
<a name="line-2787"></a>    <span class='hs-varid'>cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipCoEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span>
<a name="line-2788"></a>
<a name="line-2789"></a><a name="zipTCvSubst"></a><span class='hs-definition'>zipTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2790"></a><span class='hs-definition'>zipTCvSubst</span> <span class='hs-varid'>tcvs</span> <span class='hs-varid'>tys</span>
<a name="line-2791"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip_tcvsubst</span> <span class='hs-varid'>tcvs</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2792"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>zip_tcvsubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2793"></a>        <span class='hs-varid'>zip_tcvsubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-2794"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip_tcvsubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2795"></a>        <span class='hs-varid'>zip_tcvsubst</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst</span> <span class='hs-comment'>-- empty case</span>
<a name="line-2796"></a>        <span class='hs-varid'>zip_tcvsubst</span> <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>  <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zipTCvSubst: length mismatch"</span>
<a name="line-2797"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tcvs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2798"></a>
<a name="line-2799"></a><a name="mkTvSubstPrs"></a><span class='hs-comment'>-- | Generates the in-scope set for the 'TCvSubst' from the types in the</span>
<a name="line-2800"></a><span class='hs-comment'>-- incoming environment. No CoVars, please!</span>
<a name="line-2801"></a><span class='hs-definition'>mkTvSubstPrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2802"></a><span class='hs-definition'>mkTvSubstPrs</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>=</span>
<a name="line-2803"></a>    <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>onlyTyVarsAndNoCoercionTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"prs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>prs</span> <span class='hs-layout'>)</span>
<a name="line-2804"></a>    <span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span>
<a name="line-2805"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>prs</span>
<a name="line-2806"></a>        <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>prs</span>
<a name="line-2807"></a>        <span class='hs-varid'>onlyTyVarsAndNoCoercionTy</span> <span class='hs-keyglyph'>=</span>
<a name="line-2808"></a>          <span class='hs-varid'>and</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isCoercionTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2809"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>prs</span> <span class='hs-keyglyph'>]</span>
<a name="line-2810"></a>
<a name="line-2811"></a><a name="zipTyEnv"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TvSubstEnv</span>
<a name="line-2812"></a><span class='hs-definition'>zipTyEnv</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span>
<a name="line-2813"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span>
<a name="line-2814"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-2815"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zipTyEnv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvars</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2816"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2817"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isCoercionTy</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2818"></a>    <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"zipTyEnv"</span> <span class='hs-varid'>tyvars</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2819"></a>        <span class='hs-comment'>-- There used to be a special case for when</span>
<a name="line-2820"></a>        <span class='hs-comment'>--      ty == TyVarTy tv</span>
<a name="line-2821"></a>        <span class='hs-comment'>-- (a not-uncommon case) in which case the substitution was dropped.</span>
<a name="line-2822"></a>        <span class='hs-comment'>-- But the type-tidier changes the print-name of a type variable without</span>
<a name="line-2823"></a>        <span class='hs-comment'>-- changing the unique, and that led to a bug.   Why?  Pre-tidying, we had</span>
<a name="line-2824"></a>        <span class='hs-comment'>-- a type {Foo t}, where Foo is a one-method class.  So Foo is really a newtype.</span>
<a name="line-2825"></a>        <span class='hs-comment'>-- And it happened that t was the type variable of the class.  Post-tiding,</span>
<a name="line-2826"></a>        <span class='hs-comment'>-- it got turned into {Foo t2}.  The ext-core printer expanded this using</span>
<a name="line-2827"></a>        <span class='hs-comment'>-- sourceTypeRep, but that said "Oh, t == t2" because they have the same unique,</span>
<a name="line-2828"></a>        <span class='hs-comment'>-- and so generated a rep type mentioning t not t2.</span>
<a name="line-2829"></a>        <span class='hs-comment'>--</span>
<a name="line-2830"></a>        <span class='hs-comment'>-- Simplest fix is to nuke the "optimisation"</span>
<a name="line-2831"></a>
<a name="line-2832"></a><a name="zipCoEnv"></a><span class='hs-definition'>zipCoEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CvSubstEnv</span>
<a name="line-2833"></a><span class='hs-definition'>zipCoEnv</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span>
<a name="line-2834"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>debugIsOn</span>
<a name="line-2835"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span>
<a name="line-2836"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"zipCoEnv"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2837"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2838"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"zipCoEnv"</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2839"></a>
<a name="line-2840"></a><a name="instance%20Outputable%20TCvSubst"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>where</span>
<a name="line-2841"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>ins</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-2842"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>brackets</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span><span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TCvSubst"</span><span class='hs-layout'>,</span>
<a name="line-2843"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In scope:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2844"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Type env:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-2845"></a>                      <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Co env:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2846"></a>
<a name="line-2847"></a><span class='hs-comment'>{-
<a name="line-2848"></a>%************************************************************************
<a name="line-2849"></a>%*                                                                      *
<a name="line-2850"></a>                Performing type or kind substitutions
<a name="line-2851"></a>%*                                                                      *
<a name="line-2852"></a>%************************************************************************
<a name="line-2853"></a>
<a name="line-2854"></a>Note [Sym and ForAllCo]
<a name="line-2855"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2856"></a>In OptCoercion, we try to push "sym" out to the leaves of a coercion. But,
<a name="line-2857"></a>how do we push sym into a ForAllCo? It's a little ugly.
<a name="line-2858"></a>
<a name="line-2859"></a>Here is the typing rule:
<a name="line-2860"></a>
<a name="line-2861"></a>h : k1 ~# k2
<a name="line-2862"></a>(tv : k1) |- g : ty1 ~# ty2
<a name="line-2863"></a>----------------------------
<a name="line-2864"></a>ForAllCo tv h g : (ForAllTy (tv : k1) ty1) ~#
<a name="line-2865"></a>                  (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; sym h]))
<a name="line-2866"></a>
<a name="line-2867"></a>Here is what we want:
<a name="line-2868"></a>
<a name="line-2869"></a>ForAllCo tv h' g' : (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; sym h])) ~#
<a name="line-2870"></a>                    (ForAllTy (tv : k1) ty1)
<a name="line-2871"></a>
<a name="line-2872"></a>
<a name="line-2873"></a>Because the kinds of the type variables to the right of the colon are the kinds
<a name="line-2874"></a>coerced by h', we know (h' : k2 ~# k1). Thus, (h' = sym h).
<a name="line-2875"></a>
<a name="line-2876"></a>Now, we can rewrite ty1 to be (ty1[tv |-&gt; tv |&gt; sym h' |&gt; h']). We thus want
<a name="line-2877"></a>
<a name="line-2878"></a>ForAllCo tv h' g' :
<a name="line-2879"></a>  (ForAllTy (tv : k2) (ty2[tv |-&gt; tv |&gt; h'])) ~#
<a name="line-2880"></a>  (ForAllTy (tv : k1) (ty1[tv |-&gt; tv |&gt; h'][tv |-&gt; tv |&gt; sym h']))
<a name="line-2881"></a>
<a name="line-2882"></a>We thus see that we want
<a name="line-2883"></a>
<a name="line-2884"></a>g' : ty2[tv |-&gt; tv |&gt; h'] ~# ty1[tv |-&gt; tv |&gt; h']
<a name="line-2885"></a>
<a name="line-2886"></a>and thus g' = sym (g[tv |-&gt; tv |&gt; h']).
<a name="line-2887"></a>
<a name="line-2888"></a>Putting it all together, we get this:
<a name="line-2889"></a>
<a name="line-2890"></a>sym (ForAllCo tv h g)
<a name="line-2891"></a>==&gt;
<a name="line-2892"></a>ForAllCo tv (sym h) (sym g[tv |-&gt; tv |&gt; sym h])
<a name="line-2893"></a>
<a name="line-2894"></a>Note [Substituting in a coercion hole]
<a name="line-2895"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2896"></a>It seems highly suspicious to be substituting in a coercion that still
<a name="line-2897"></a>has coercion holes. Yet, this can happen in a situation like this:
<a name="line-2898"></a>
<a name="line-2899"></a>  f :: forall k. k :~: Type -&gt; ()
<a name="line-2900"></a>  f Refl = let x :: forall (a :: k). [a] -&gt; ...
<a name="line-2901"></a>               x = ...
<a name="line-2902"></a>
<a name="line-2903"></a>When we check x's type signature, we require that k ~ Type. We indeed
<a name="line-2904"></a>know this due to the Refl pattern match, but the eager unifier can't
<a name="line-2905"></a>make use of givens. So, when we're done looking at x's type, a coercion
<a name="line-2906"></a>hole will remain. Then, when we're checking x's definition, we skolemise
<a name="line-2907"></a>x's type (in order to, e.g., bring the scoped type variable `a` into scope).
<a name="line-2908"></a>This requires performing a substitution for the fresh skolem variables.
<a name="line-2909"></a>
<a name="line-2910"></a>This subsitution needs to affect the kind of the coercion hole, too --
<a name="line-2911"></a>otherwise, the kind will have an out-of-scope variable in it. More problematically
<a name="line-2912"></a>in practice (we won't actually notice the out-of-scope variable ever), skolems
<a name="line-2913"></a>in the kind might have too high a level, triggering a failure to uphold the
<a name="line-2914"></a>invariant that no free variables in a type have a higher level than the
<a name="line-2915"></a>ambient level in the type checker. In the event of having free variables in the
<a name="line-2916"></a>hole's kind, I'm pretty sure we'll always have an erroneous program, so we
<a name="line-2917"></a>don't need to worry what will happen when the hole gets filled in. After all,
<a name="line-2918"></a>a hole relating a locally-bound type variable will be unable to be solved. This
<a name="line-2919"></a>is why it's OK not to look through the IORef of a coercion hole during
<a name="line-2920"></a>substitution.
<a name="line-2921"></a>
<a name="line-2922"></a>-}</span>
<a name="line-2923"></a>
<a name="line-2924"></a><a name="substTyWith"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-2925"></a><span class='hs-definition'>substTyWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2926"></a><span class='hs-comment'>-- Works only if the domain of the substitution is a</span>
<a name="line-2927"></a><span class='hs-comment'>-- superset of the type being substituted into</span>
<a name="line-2928"></a><span class='hs-definition'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-#SCC "substTyWith" #-}</span>
<a name="line-2929"></a>                      <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2930"></a>                      <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2931"></a>
<a name="line-2932"></a><a name="substTyWithUnchecked"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'. Disables sanity checks.</span>
<a name="line-2933"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-2934"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2935"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-2936"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-2937"></a><span class='hs-definition'>substTyWithUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2938"></a><span class='hs-definition'>substTyWithUnchecked</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2939"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2940"></a>    <span class='hs-varid'>substTyUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2941"></a>
<a name="line-2942"></a><a name="substTyWithInScope"></a><span class='hs-comment'>-- | Substitute tyvars within a type using a known 'InScopeSet'.</span>
<a name="line-2943"></a><span class='hs-comment'>-- Pre-condition: the 'in_scope' set should satisfy Note [The substitution</span>
<a name="line-2944"></a><span class='hs-comment'>-- invariant]; specifically it should include the free vars of 'tys',</span>
<a name="line-2945"></a><span class='hs-comment'>-- and of 'ty' minus the domain of the subst.</span>
<a name="line-2946"></a><span class='hs-definition'>substTyWithInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2947"></a><span class='hs-definition'>substTyWithInScope</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-2948"></a>  <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2949"></a>  <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2950"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipTyEnv</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2951"></a>
<a name="line-2952"></a><a name="substCoWith"></a><span class='hs-comment'>-- | Coercion substitution, see 'zipTvSubst'</span>
<a name="line-2953"></a><span class='hs-definition'>substCoWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2954"></a><span class='hs-definition'>substCoWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2955"></a>                      <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2956"></a>
<a name="line-2957"></a><a name="substCoWithUnchecked"></a><span class='hs-comment'>-- | Coercion substitution, see 'zipTvSubst'. Disables sanity checks.</span>
<a name="line-2958"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-2959"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-2960"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-2961"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-2962"></a><span class='hs-definition'>substCoWithUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2963"></a><span class='hs-definition'>substCoWithUnchecked</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2964"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2965"></a>    <span class='hs-varid'>substCoUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2966"></a>
<a name="line-2967"></a>
<a name="line-2968"></a>
<a name="line-2969"></a><a name="substTyWithCoVars"></a><span class='hs-comment'>-- | Substitute covars within a type</span>
<a name="line-2970"></a><span class='hs-definition'>substTyWithCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2971"></a><span class='hs-definition'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2972"></a>
<a name="line-2973"></a><a name="substTysWith"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-2974"></a><span class='hs-definition'>substTysWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2975"></a><span class='hs-definition'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys</span> <span class='hs-layout'>)</span>
<a name="line-2976"></a>                       <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTvSubst</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2977"></a>
<a name="line-2978"></a><a name="substTysWithCoVars"></a><span class='hs-comment'>-- | Type substitution, see 'zipTvSubst'</span>
<a name="line-2979"></a><span class='hs-definition'>substTysWithCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2980"></a><span class='hs-definition'>substTysWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>cvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-2981"></a>                             <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipCvSubst</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2982"></a>
<a name="line-2983"></a><a name="substTyAddInScope"></a><span class='hs-comment'>-- | Substitute within a 'Type' after adding the free variables of the type</span>
<a name="line-2984"></a><span class='hs-comment'>-- to the in-scope set. This is useful for the case when the free variables</span>
<a name="line-2985"></a><span class='hs-comment'>-- aren't already in the in-scope set or easily available.</span>
<a name="line-2986"></a><span class='hs-comment'>-- See also Note [The substitution invariant].</span>
<a name="line-2987"></a><span class='hs-definition'>substTyAddInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2988"></a><span class='hs-definition'>substTyAddInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span>
<a name="line-2989"></a>  <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvInScopeSet</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-2990"></a>
<a name="line-2991"></a><a name="isValidTCvSubst"></a><span class='hs-comment'>-- | When calling `substTy` it should be the case that the in-scope set in</span>
<a name="line-2992"></a><span class='hs-comment'>-- the substitution is a superset of the free vars of the range of the</span>
<a name="line-2993"></a><span class='hs-comment'>-- substitution.</span>
<a name="line-2994"></a><span class='hs-comment'>-- See also Note [The substitution invariant].</span>
<a name="line-2995"></a><span class='hs-definition'>isValidTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2996"></a><span class='hs-definition'>isValidTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2997"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tenvFVs</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-2998"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>cenvFVs</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span>
<a name="line-2999"></a>  <span class='hs-keyword'>where</span>
<a name="line-3000"></a>  <span class='hs-varid'>tenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span>
<a name="line-3001"></a>  <span class='hs-varid'>cenvFVs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cenv</span>
<a name="line-3002"></a>
<a name="line-3003"></a><a name="checkValidSubst"></a><span class='hs-comment'>-- | This checks if the substitution satisfies the invariant from</span>
<a name="line-3004"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3005"></a><span class='hs-definition'>checkValidSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-3006"></a><span class='hs-definition'>checkValidSubst</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>a</span>
<a name="line-3007"></a><span class='hs-comment'>-- TODO (RAE): Change back to ASSERT</span>
<a name="line-3008"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isValidTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-3009"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"in_scope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$$</span>
<a name="line-3010"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>$$</span>
<a name="line-3011"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenvFVs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-3012"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span> <span class='hs-varop'>$$</span>
<a name="line-3013"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenvFVs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCosSet</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-3014"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span>
<a name="line-3015"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-3016"></a>    <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-varid'>tysCosFVsInScope</span><span class='hs-layout'>,</span>
<a name="line-3017"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"in_scope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$$</span>
<a name="line-3018"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>$$</span>
<a name="line-3019"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cenv"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cenv</span> <span class='hs-varop'>$$</span>
<a name="line-3020"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"tys"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>$$</span>
<a name="line-3021"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"cos"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$$</span>
<a name="line-3022"></a>             <span class='hs-varid'>text</span> <span class='hs-str'>"needInScope"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>needInScope</span> <span class='hs-layout'>)</span>
<a name="line-3023"></a>    <span class='hs-varid'>a</span>
<a name="line-3024"></a>  <span class='hs-keyword'>where</span>
<a name="line-3025"></a>  <span class='hs-varid'>substDomain</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetKeysUFM</span> <span class='hs-varid'>tenv</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nonDetKeysUFM</span> <span class='hs-varid'>cenv</span>
<a name="line-3026"></a>    <span class='hs-comment'>-- It's OK to use nonDetKeysUFM here, because we only use this list to</span>
<a name="line-3027"></a>    <span class='hs-comment'>-- remove some elements from a set</span>
<a name="line-3028"></a>  <span class='hs-varid'>needInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-3029"></a>                  <span class='hs-varop'>`delListFromUniqSet_Directly`</span> <span class='hs-varid'>substDomain</span>
<a name="line-3030"></a>  <span class='hs-varid'>tysCosFVsInScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needInScope</span> <span class='hs-varop'>`varSetInScope`</span> <span class='hs-varid'>in_scope</span>
<a name="line-3031"></a>
<a name="line-3032"></a>
<a name="line-3033"></a><a name="substTy"></a><span class='hs-comment'>-- | Substitute within a 'Type'</span>
<a name="line-3034"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-3035"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3036"></a><span class='hs-definition'>substTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3037"></a><span class='hs-definition'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-3038"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-3039"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span>
<a name="line-3040"></a>                            <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-3041"></a>
<a name="line-3042"></a><a name="substTyUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'Type' disabling the sanity checks.</span>
<a name="line-3043"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-3044"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3045"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-3046"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-3047"></a><span class='hs-definition'>substTyUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3048"></a><span class='hs-definition'>substTyUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-3049"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-3050"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-3051"></a>
<a name="line-3052"></a><a name="substTys"></a><span class='hs-comment'>-- | Substitute within several 'Type's</span>
<a name="line-3053"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-3054"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3055"></a><span class='hs-definition'>substTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-3056"></a><span class='hs-definition'>substTys</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span>
<a name="line-3057"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-3058"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3059"></a>
<a name="line-3060"></a><a name="substTysUnchecked"></a><span class='hs-comment'>-- | Substitute within several 'Type's disabling the sanity checks.</span>
<a name="line-3061"></a><span class='hs-comment'>-- The problems that the sanity checks in substTys catch are described in</span>
<a name="line-3062"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3063"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTysUnchecked to</span>
<a name="line-3064"></a><span class='hs-comment'>-- substTys and remove this function. Please don't use in new code.</span>
<a name="line-3065"></a><span class='hs-definition'>substTysUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-3066"></a><span class='hs-definition'>substTysUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tys</span>
<a name="line-3067"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span>
<a name="line-3068"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3069"></a>
<a name="line-3070"></a><a name="substTheta"></a><span class='hs-comment'>-- | Substitute within a 'ThetaType'</span>
<a name="line-3071"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-3072"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3073"></a><span class='hs-definition'>substTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-3074"></a><span class='hs-definition'>substTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTys</span>
<a name="line-3075"></a>
<a name="line-3076"></a><a name="substThetaUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'ThetaType' disabling the sanity checks.</span>
<a name="line-3077"></a><span class='hs-comment'>-- The problems that the sanity checks in substTys catch are described in</span>
<a name="line-3078"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3079"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substThetaUnchecked to</span>
<a name="line-3080"></a><span class='hs-comment'>-- substTheta and remove this function. Please don't use in new code.</span>
<a name="line-3081"></a><span class='hs-definition'>substThetaUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ThetaType</span>
<a name="line-3082"></a><span class='hs-definition'>substThetaUnchecked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTysUnchecked</span>
<a name="line-3083"></a>
<a name="line-3084"></a>
<a name="line-3085"></a><a name="subst_ty"></a><span class='hs-definition'>subst_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3086"></a><span class='hs-comment'>-- subst_ty is the main workhorse for type substitution</span>
<a name="line-3087"></a><span class='hs-comment'>--</span>
<a name="line-3088"></a><span class='hs-comment'>-- Note that the in_scope set is poked only if we hit a forall</span>
<a name="line-3089"></a><span class='hs-comment'>-- so it may often never be fully computed</span>
<a name="line-3090"></a><span class='hs-definition'>subst_ty</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-3091"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-3092"></a>  <span class='hs-keyword'>where</span>
<a name="line-3093"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3094"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-3095"></a>                <span class='hs-comment'>-- The mkAppTy smart constructor is important</span>
<a name="line-3096"></a>                <span class='hs-comment'>-- we might be replacing (a Int), represented with App</span>
<a name="line-3097"></a>                <span class='hs-comment'>-- by [Int], represented with TyConApp</span>
<a name="line-3098"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tys</span>
<a name="line-3099"></a>                           <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-3100"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>res</span>
<a name="line-3101"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3102"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substVarBndrUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-3103"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3104"></a>                               <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-3105"></a>                                            <span class='hs-layout'>(</span><span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3106"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>n</span>
<a name="line-3107"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3108"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3109"></a>
<a name="line-3110"></a><a name="substTyVar"></a><span class='hs-definition'>substTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3111"></a><span class='hs-definition'>substTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3112"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-3113"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-3114"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty</span>
<a name="line-3115"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span>
<a name="line-3116"></a>
<a name="line-3117"></a><a name="substTyVars"></a><span class='hs-definition'>substTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-3118"></a><span class='hs-definition'>substTyVars</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varop'>$</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span>
<a name="line-3119"></a>
<a name="line-3120"></a><a name="substTyCoVars"></a><span class='hs-definition'>substTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-3121"></a><span class='hs-definition'>substTyCoVars</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varop'>$</span> <span class='hs-varid'>substTyCoVar</span> <span class='hs-varid'>subst</span>
<a name="line-3122"></a>
<a name="line-3123"></a><a name="substTyCoVar"></a><span class='hs-definition'>substTyCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3124"></a><span class='hs-definition'>substTyCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3125"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3126"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3127"></a>
<a name="line-3128"></a><a name="lookupTyVar"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Type</span>
<a name="line-3129"></a>        <span class='hs-comment'>-- See Note [Extending the TCvSubst]</span>
<a name="line-3130"></a><span class='hs-definition'>lookupTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tenv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3131"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-3132"></a>    <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>tv</span>
<a name="line-3133"></a>
<a name="line-3134"></a><a name="substCo"></a><span class='hs-comment'>-- | Substitute within a 'Coercion'</span>
<a name="line-3135"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-3136"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3137"></a><span class='hs-definition'>substCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-3138"></a><span class='hs-definition'>substCo</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-3139"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-3140"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>co</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-3141"></a>
<a name="line-3142"></a><a name="substCoUnchecked"></a><span class='hs-comment'>-- | Substitute within a 'Coercion' disabling sanity checks.</span>
<a name="line-3143"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-3144"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3145"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-3146"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-3147"></a><span class='hs-definition'>substCoUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-3148"></a><span class='hs-definition'>substCoUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-3149"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-3150"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-3151"></a>
<a name="line-3152"></a><a name="substCos"></a><span class='hs-comment'>-- | Substitute within several 'Coercion's</span>
<a name="line-3153"></a><span class='hs-comment'>-- The substitution has to satisfy the invariants described in</span>
<a name="line-3154"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3155"></a><span class='hs-definition'>substCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-3156"></a><span class='hs-definition'>substCos</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cos</span>
<a name="line-3157"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cos</span>
<a name="line-3158"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkValidSubst</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-3159"></a>
<a name="line-3160"></a><a name="subst_co"></a><span class='hs-definition'>subst_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-3161"></a><span class='hs-definition'>subst_co</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>co</span>
<a name="line-3162"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3163"></a>  <span class='hs-keyword'>where</span>
<a name="line-3164"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3165"></a>    <span class='hs-varid'>go_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_ty</span> <span class='hs-varid'>subst</span>
<a name="line-3166"></a>
<a name="line-3167"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-3168"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-3169"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3170"></a>
<a name="line-3171"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-3172"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3173"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkGReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_mco</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>
<a name="line-3174"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args</span>
<a name="line-3175"></a>                               <span class='hs-keyword'>in</span>  <span class='hs-varid'>args'</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args'</span>
<a name="line-3176"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-3177"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3178"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>substForAllCoBndrUnchecked</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-keyword'>of</span>
<a name="line-3179"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind_co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3180"></a>          <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mkForAllCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>kind_co'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>subst_co</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span>
<a name="line-3181"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-3182"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span>
<a name="line-3183"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-3184"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>mkUnivCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-3185"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_ty</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-3186"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3187"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-3188"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3189"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3190"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInstCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>arg</span>
<a name="line-3191"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3192"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSubCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3193"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cs</span>
<a name="line-3194"></a>                                <span class='hs-keyword'>in</span> <span class='hs-varid'>cs1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>c</span> <span class='hs-varid'>cs1</span>
<a name="line-3195"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_hole</span> <span class='hs-varid'>h</span>
<a name="line-3196"></a>
<a name="line-3197"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>
<a name="line-3198"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>
<a name="line-3199"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>
<a name="line-3200"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-3201"></a>
<a name="line-3202"></a>    <span class='hs-comment'>-- See Note [Substituting in a coercion hole]</span>
<a name="line-3203"></a>    <span class='hs-varid'>go_hole</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoercionHole</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ch_co_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3204"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ch_co_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updateVarType</span> <span class='hs-varid'>go_ty</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>}</span>
<a name="line-3205"></a>
<a name="line-3206"></a><a name="substForAllCoBndr"></a><span class='hs-definition'>substForAllCoBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindCoercion</span>
<a name="line-3207"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-3208"></a><span class='hs-definition'>substForAllCoBndr</span> <span class='hs-varid'>subst</span>
<a name="line-3209"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrUsing</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCo</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-3210"></a>
<a name="line-3211"></a><a name="substForAllCoBndrUnchecked"></a><span class='hs-comment'>-- | Like 'substForAllCoBndr', but disables sanity checks.</span>
<a name="line-3212"></a><span class='hs-comment'>-- The problems that the sanity checks in substCo catch are described in</span>
<a name="line-3213"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3214"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substCoUnchecked to</span>
<a name="line-3215"></a><span class='hs-comment'>-- substCo and remove this function. Please don't use in new code.</span>
<a name="line-3216"></a><span class='hs-definition'>substForAllCoBndrUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindCoercion</span>
<a name="line-3217"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-3218"></a><span class='hs-definition'>substForAllCoBndrUnchecked</span> <span class='hs-varid'>subst</span>
<a name="line-3219"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrUsing</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoUnchecked</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-3220"></a>
<a name="line-3221"></a><a name="substForAllCoBndrUsing"></a><span class='hs-comment'>-- See Note [Sym and ForAllCo]</span>
<a name="line-3222"></a><span class='hs-definition'>substForAllCoBndrUsing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- apply sym to binder?</span>
<a name="line-3223"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- transformation to kind co</span>
<a name="line-3224"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindCoercion</span>
<a name="line-3225"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindCoercion</span><span class='hs-layout'>)</span>
<a name="line-3226"></a><span class='hs-definition'>substForAllCoBndrUsing</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_var</span>
<a name="line-3227"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoTyVarBndrUsing</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_var</span>
<a name="line-3228"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoCoVarBndrUsing</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_var</span>
<a name="line-3229"></a>
<a name="line-3230"></a><a name="substForAllCoTyVarBndrUsing"></a><span class='hs-definition'>substForAllCoTyVarBndrUsing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- apply sym to binder?</span>
<a name="line-3231"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- transformation to kind co</span>
<a name="line-3232"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindCoercion</span>
<a name="line-3233"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindCoercion</span><span class='hs-layout'>)</span>
<a name="line-3234"></a><span class='hs-definition'>substForAllCoTyVarBndrUsing</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-3236"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>cenv</span>
<a name="line-3237"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_kind_co</span> <span class='hs-layout'>)</span>
<a name="line-3238"></a>  <span class='hs-keyword'>where</span>
<a name="line-3239"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>sym</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span>
<a name="line-3240"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sym</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>$</span>
<a name="line-3241"></a>                          <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>`CastTy`</span> <span class='hs-varid'>new_kind_co</span>
<a name="line-3242"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-3243"></a>
<a name="line-3244"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3245"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-3246"></a>
<a name="line-3247"></a>    <span class='hs-varid'>new_kind_co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3248"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3249"></a>
<a name="line-3250"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>new_ki1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>new_kind_co</span>
<a name="line-3251"></a>    <span class='hs-comment'>-- We could do substitution to (tyVarKind old_var). We don't do so because</span>
<a name="line-3252"></a>    <span class='hs-comment'>-- we already substituted new_kind_co, which contains the kind information</span>
<a name="line-3253"></a>    <span class='hs-comment'>-- we want. We don't want to do substitution once more. Also, in most cases,</span>
<a name="line-3254"></a>    <span class='hs-comment'>-- new_kind_co is a Refl, in which case coercionKind is really fast.</span>
<a name="line-3255"></a>
<a name="line-3256"></a>    <span class='hs-varid'>new_var</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-layout'>(</span><span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_ki1</span><span class='hs-layout'>)</span>
<a name="line-3257"></a>
<a name="line-3258"></a><a name="substForAllCoCoVarBndrUsing"></a><span class='hs-definition'>substForAllCoCoVarBndrUsing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- apply sym to binder?</span>
<a name="line-3259"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- transformation to kind co</span>
<a name="line-3260"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>KindCoercion</span>
<a name="line-3261"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>KindCoercion</span><span class='hs-layout'>)</span>
<a name="line-3262"></a><span class='hs-definition'>substForAllCoCoVarBndrUsing</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span>
<a name="line-3263"></a>                            <span class='hs-varid'>old_var</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3264"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-3265"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>new_cenv</span>
<a name="line-3266"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_kind_co</span> <span class='hs-layout'>)</span>
<a name="line-3267"></a>  <span class='hs-keyword'>where</span>
<a name="line-3268"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>sym</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-3269"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-3270"></a>
<a name="line-3271"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfCo</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3272"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-3273"></a>
<a name="line-3274"></a>    <span class='hs-varid'>new_kind_co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3275"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>old_kind_co</span>
<a name="line-3276"></a>
<a name="line-3277"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>h1</span> <span class='hs-varid'>h2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>new_kind_co</span>
<a name="line-3278"></a>
<a name="line-3279"></a>    <span class='hs-varid'>new_var</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_var_type</span>
<a name="line-3280"></a>    <span class='hs-varid'>new_var_type</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sym</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h2</span>
<a name="line-3281"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h1</span>
<a name="line-3282"></a>
<a name="line-3283"></a><a name="substCoVar"></a><span class='hs-definition'>substCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-3284"></a><span class='hs-definition'>substCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv</span>
<a name="line-3285"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-3286"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co</span>
<a name="line-3287"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-3288"></a>
<a name="line-3289"></a><a name="substCoVars"></a><span class='hs-definition'>substCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-3290"></a><span class='hs-definition'>substCoVars</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>substCoVar</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>cvs</span>
<a name="line-3291"></a>
<a name="line-3292"></a><a name="lookupCoVar"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-3293"></a><span class='hs-definition'>lookupCoVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>v</span>
<a name="line-3294"></a>
<a name="line-3295"></a><a name="substTyVarBndr"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-3296"></a><span class='hs-definition'>substTyVarBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndrUsing</span> <span class='hs-varid'>substTy</span>
<a name="line-3297"></a>
<a name="line-3298"></a><a name="substTyVarBndrs"></a><span class='hs-definition'>substTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3299"></a><span class='hs-definition'>substTyVarBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>substTyVarBndr</span>
<a name="line-3300"></a>
<a name="line-3301"></a><a name="substVarBndr"></a><span class='hs-definition'>substVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-3302"></a><span class='hs-definition'>substVarBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substVarBndrUsing</span> <span class='hs-varid'>substTy</span>
<a name="line-3303"></a>
<a name="line-3304"></a><a name="substVarBndrs"></a><span class='hs-definition'>substVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3305"></a><span class='hs-definition'>substVarBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>substVarBndr</span>
<a name="line-3306"></a>
<a name="line-3307"></a><a name="substCoVarBndr"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span>
<a name="line-3308"></a><span class='hs-definition'>substCoVarBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVarBndrUsing</span> <span class='hs-varid'>substTy</span>
<a name="line-3309"></a>
<a name="line-3310"></a><a name="substVarBndrUnchecked"></a><span class='hs-comment'>-- | Like 'substVarBndr', but disables sanity checks.</span>
<a name="line-3311"></a><span class='hs-comment'>-- The problems that the sanity checks in substTy catch are described in</span>
<a name="line-3312"></a><span class='hs-comment'>-- Note [The substitution invariant].</span>
<a name="line-3313"></a><span class='hs-comment'>-- The goal of #11371 is to migrate all the calls of substTyUnchecked to</span>
<a name="line-3314"></a><span class='hs-comment'>-- substTy and remove this function. Please don't use in new code.</span>
<a name="line-3315"></a><span class='hs-definition'>substVarBndrUnchecked</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-3316"></a><span class='hs-definition'>substVarBndrUnchecked</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substVarBndrUsing</span> <span class='hs-varid'>substTyUnchecked</span>
<a name="line-3317"></a>
<a name="line-3318"></a><a name="substVarBndrUsing"></a><span class='hs-definition'>substVarBndrUsing</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-3319"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-3320"></a><span class='hs-definition'>substVarBndrUsing</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-3321"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndrUsing</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-3322"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoVarBndrUsing</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span>
<a name="line-3323"></a>
<a name="line-3324"></a><a name="substTyVarBndrUsing"></a><span class='hs-comment'>-- | Substitute a tyvar in a binding position, returning an</span>
<a name="line-3325"></a><span class='hs-comment'>-- extended subst and a new tyvar.</span>
<a name="line-3326"></a><span class='hs-comment'>-- Use the supplied function to substitute in the kind</span>
<a name="line-3327"></a><span class='hs-definition'>substTyVarBndrUsing</span>
<a name="line-3328"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ Use this to substitute in the kind</span>
<a name="line-3329"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-3330"></a><span class='hs-definition'>substTyVarBndrUsing</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-3331"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-sel'>_no_capture</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>)</span>
<a name="line-3332"></a>    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-3333"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_env</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-3334"></a>  <span class='hs-keyword'>where</span>
<a name="line-3335"></a>    <span class='hs-varid'>new_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span>
<a name="line-3336"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-3337"></a>
<a name="line-3338"></a>    <span class='hs-sel'>_no_capture</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfTypesSet</span> <span class='hs-varid'>tenv</span><span class='hs-layout'>)</span>
<a name="line-3339"></a>    <span class='hs-comment'>-- Assertion check that we are not capturing something in the substitution</span>
<a name="line-3340"></a>
<a name="line-3341"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-3342"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>old_ki</span> <span class='hs-comment'>-- verify that kind is closed</span>
<a name="line-3343"></a>    <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span>
<a name="line-3344"></a>        <span class='hs-comment'>-- no_change means that the new_var is identical in</span>
<a name="line-3345"></a>        <span class='hs-comment'>-- all respects to the old_var (same unique, same kind)</span>
<a name="line-3346"></a>        <span class='hs-comment'>-- See Note [Extending the TCvSubst]</span>
<a name="line-3347"></a>        <span class='hs-comment'>--</span>
<a name="line-3348"></a>        <span class='hs-comment'>-- In that case we don't need to extend the substitution</span>
<a name="line-3349"></a>        <span class='hs-comment'>-- to map old to new.  But instead we must zap any</span>
<a name="line-3350"></a>        <span class='hs-comment'>-- current substitution for the variable. For example:</span>
<a name="line-3351"></a>        <span class='hs-comment'>--      (\x.e) with id_subst = [x |-&gt; e']</span>
<a name="line-3352"></a>        <span class='hs-comment'>-- Here we must simply zap the substitution for x</span>
<a name="line-3353"></a>
<a name="line-3354"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>old_var</span>
<a name="line-3355"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varop'>$</span>
<a name="line-3356"></a>                          <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-3357"></a>        <span class='hs-comment'>-- The uniqAway part makes sure the new variable is not already in scope</span>
<a name="line-3358"></a>
<a name="line-3359"></a><a name="substCoVarBndrUsing"></a><span class='hs-comment'>-- | Substitute a covar in a binding position, returning an</span>
<a name="line-3360"></a><span class='hs-comment'>-- extended subst and a new covar.</span>
<a name="line-3361"></a><span class='hs-comment'>-- Use the supplied function to substitute in the kind</span>
<a name="line-3362"></a><span class='hs-definition'>substCoVarBndrUsing</span>
<a name="line-3363"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-3364"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>)</span>
<a name="line-3365"></a><span class='hs-definition'>substCoVarBndrUsing</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-3366"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-3367"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>in_scope</span> <span class='hs-varop'>`extendInScopeSet`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>new_cenv</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span>
<a name="line-3368"></a>  <span class='hs-keyword'>where</span>
<a name="line-3369"></a>    <span class='hs-varid'>new_co</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_var</span>
<a name="line-3370"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfTypes</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-keyglyph'>]</span>
<a name="line-3371"></a>    <span class='hs-varid'>no_change</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>new_var</span> <span class='hs-varop'>==</span> <span class='hs-varid'>old_var</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>no_kind_change</span>
<a name="line-3372"></a>
<a name="line-3373"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span>
<a name="line-3374"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>new_co</span>
<a name="line-3375"></a>
<a name="line-3376"></a>    <span class='hs-varid'>new_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>subst_old_var</span>
<a name="line-3377"></a>    <span class='hs-varid'>subst_old_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>old_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_var_type</span>
<a name="line-3378"></a>
<a name="line-3379"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>old_var</span>
<a name="line-3380"></a>    <span class='hs-varid'>t1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t1</span>
<a name="line-3381"></a>    <span class='hs-varid'>t2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst_fn</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t2</span>
<a name="line-3382"></a>    <span class='hs-varid'>new_var_type</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoercionType</span> <span class='hs-varid'>role</span> <span class='hs-varid'>t1'</span> <span class='hs-varid'>t2'</span>
<a name="line-3383"></a>                  <span class='hs-comment'>-- It's important to do the substitution for coercions,</span>
<a name="line-3384"></a>                  <span class='hs-comment'>-- because they can have free type variables</span>
<a name="line-3385"></a>
<a name="line-3386"></a><a name="cloneTyVarBndr"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>)</span>
<a name="line-3387"></a><span class='hs-definition'>cloneTyVarBndr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>uniq</span>
<a name="line-3388"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>   <span class='hs-comment'>-- I think it's only called on TyVars</span>
<a name="line-3389"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendInScopeSet</span> <span class='hs-varid'>in_scope</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-3390"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>tv_env</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>cv_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span>
<a name="line-3391"></a>  <span class='hs-keyword'>where</span>
<a name="line-3392"></a>    <span class='hs-varid'>old_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-3393"></a>    <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>old_ki</span> <span class='hs-comment'>-- verify that kind is closed</span>
<a name="line-3394"></a>
<a name="line-3395"></a>    <span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>no_kind_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span>
<a name="line-3396"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>old_ki</span><span class='hs-layout'>)</span>
<a name="line-3397"></a>
<a name="line-3398"></a>    <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>uniq</span>
<a name="line-3399"></a>
<a name="line-3400"></a><a name="cloneTyVarBndrs"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSupply</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3401"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span>     <span class='hs-sel'>_usupply</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-3402"></a><span class='hs-definition'>cloneTyVarBndrs</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-conop'>:</span><span class='hs-varid'>ts</span><span class='hs-layout'>)</span>  <span class='hs-varid'>usupply</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3403"></a>  <span class='hs-keyword'>where</span>
<a name="line-3404"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-layout'>,</span> <span class='hs-varid'>usupply'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>takeUniqFromSupply</span> <span class='hs-varid'>usupply</span>
<a name="line-3405"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span> <span class='hs-layout'>,</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cloneTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>t</span> <span class='hs-varid'>uniq</span>
<a name="line-3406"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst''</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cloneTyVarBndrs</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>usupply'</span>
<a name="line-3407"></a>
<a name="line-3408"></a><span class='hs-comment'>{-
<a name="line-3409"></a>%************************************************************************
<a name="line-3410"></a>%*                                                                      *
<a name="line-3411"></a>                   Pretty-printing types
<a name="line-3412"></a>
<a name="line-3413"></a>       Defined very early because of debug printing in assertions
<a name="line-3414"></a>%*                                                                      *
<a name="line-3415"></a>%************************************************************************
<a name="line-3416"></a>
<a name="line-3417"></a>@pprType@ is the standard @Type@ printer; the overloaded @ppr@ function is
<a name="line-3418"></a>defined to use this.  @pprParendType@ is the same, except it puts
<a name="line-3419"></a>parens around the type, except for the atomic cases.  @pprParendType@
<a name="line-3420"></a>works just by setting the initial context precedence very high.
<a name="line-3421"></a>
<a name="line-3422"></a>Note that any function which pretty-prints a @Type@ first converts the @Type@
<a name="line-3423"></a>to an @IfaceType@. See Note [IfaceType and pretty-printing] in IfaceType.
<a name="line-3424"></a>
<a name="line-3425"></a>See Note [Precedence in types] in BasicTypes.
<a name="line-3426"></a>-}</span>
<a name="line-3427"></a>
<a name="line-3428"></a><span class='hs-comment'>--------------------------------------------------------</span>
<a name="line-3429"></a><span class='hs-comment'>-- When pretty-printing types, we convert to IfaceType,</span>
<a name="line-3430"></a><span class='hs-comment'>--   and pretty-print that.</span>
<a name="line-3431"></a><span class='hs-comment'>-- See Note [Pretty printing via IfaceSyn] in PprTyThing</span>
<a name="line-3432"></a><span class='hs-comment'>--------------------------------------------------------</span>
<a name="line-3433"></a>
<a name="line-3434"></a><a name="pprType"></a><span class='hs-definition'>pprType</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3435"></a><span class='hs-definition'>pprType</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrecType</span> <span class='hs-varid'>topPrec</span>
<a name="line-3436"></a><a name="pprParendType"></a><span class='hs-definition'>pprParendType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrecType</span> <span class='hs-varid'>appPrec</span>
<a name="line-3437"></a>
<a name="line-3438"></a><a name="pprPrecType"></a><span class='hs-definition'>pprPrecType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PprPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3439"></a><span class='hs-definition'>pprPrecType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPrecTypeX</span> <span class='hs-varid'>emptyTidyEnv</span>
<a name="line-3440"></a>
<a name="line-3441"></a><a name="pprPrecTypeX"></a><span class='hs-definition'>pprPrecTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PprPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3442"></a><span class='hs-definition'>pprPrecTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>ty</span>
<a name="line-3443"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>sty</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3444"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>debugStyle</span> <span class='hs-varid'>sty</span>           <span class='hs-comment'>-- Use debugPprType when in</span>
<a name="line-3445"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>ty</span>   <span class='hs-comment'>-- when in debug-style</span>
<a name="line-3446"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>pprPrecIfaceType</span> <span class='hs-varid'>prec</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceTypeStyX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sty</span><span class='hs-layout'>)</span>
<a name="line-3447"></a>
<a name="line-3448"></a><a name="pprTyLit"></a><span class='hs-definition'>pprTyLit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3449"></a><span class='hs-definition'>pprTyLit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceTyLit</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toIfaceTyLit</span>
<a name="line-3450"></a>
<a name="line-3451"></a><a name="pprKind"></a><span class='hs-definition'>pprKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3452"></a><span class='hs-definition'>pprKind</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span>
<a name="line-3453"></a><a name="pprParendKind"></a><span class='hs-definition'>pprParendKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprParendType</span>
<a name="line-3454"></a>
<a name="line-3455"></a><a name="tidyToIfaceTypeStyX"></a><span class='hs-definition'>tidyToIfaceTypeStyX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PprStyle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceType</span>
<a name="line-3456"></a><span class='hs-definition'>tidyToIfaceTypeStyX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sty</span>
<a name="line-3457"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>userStyle</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span>
<a name="line-3458"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTypeX</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-3459"></a>     <span class='hs-comment'>-- in latter case, don't tidy, as we'll be printing uniques.</span>
<a name="line-3460"></a>
<a name="line-3461"></a><a name="tidyToIfaceType"></a><span class='hs-definition'>tidyToIfaceType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceType</span>
<a name="line-3462"></a><span class='hs-definition'>tidyToIfaceType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceTypeX</span> <span class='hs-varid'>emptyTidyEnv</span>
<a name="line-3463"></a>
<a name="line-3464"></a><a name="tidyToIfaceTypeX"></a><span class='hs-definition'>tidyToIfaceTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceType</span>
<a name="line-3465"></a><span class='hs-comment'>-- It's vital to tidy before converting to an IfaceType</span>
<a name="line-3466"></a><span class='hs-comment'>-- or nested binders will become indistinguishable!</span>
<a name="line-3467"></a><span class='hs-comment'>--</span>
<a name="line-3468"></a><span class='hs-comment'>-- Also for the free type variables, tell toIfaceTypeX to</span>
<a name="line-3469"></a><span class='hs-comment'>-- leave them as IfaceFreeTyVar.  This is super-important</span>
<a name="line-3470"></a><span class='hs-comment'>-- for debug printing.</span>
<a name="line-3471"></a><span class='hs-definition'>tidyToIfaceTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceTypeX</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>free_tcvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3472"></a>  <span class='hs-keyword'>where</span>
<a name="line-3473"></a>    <span class='hs-varid'>env'</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-varid'>free_tcvs</span>
<a name="line-3474"></a>    <span class='hs-varid'>free_tcvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyCoVarsOfTypeWellScoped</span> <span class='hs-varid'>ty</span>
<a name="line-3475"></a>
<a name="line-3476"></a><a name="pprCo"></a><span class='hs-comment'>------------</span>
<a name="line-3477"></a><span class='hs-definition'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3478"></a><span class='hs-definition'>pprCo</span>       <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprIfaceCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceCoSty</span> <span class='hs-varid'>co</span> <span class='hs-varid'>sty</span><span class='hs-layout'>)</span>
<a name="line-3479"></a><a name="pprParendCo"></a><span class='hs-definition'>pprParendCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getPprStyle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprParendIfaceCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceCoSty</span> <span class='hs-varid'>co</span> <span class='hs-varid'>sty</span><span class='hs-layout'>)</span>
<a name="line-3480"></a>
<a name="line-3481"></a><a name="tidyToIfaceCoSty"></a><span class='hs-definition'>tidyToIfaceCoSty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PprStyle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceCoercion</span>
<a name="line-3482"></a><span class='hs-definition'>tidyToIfaceCoSty</span> <span class='hs-varid'>co</span> <span class='hs-varid'>sty</span>
<a name="line-3483"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>userStyle</span> <span class='hs-varid'>sty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyToIfaceCo</span> <span class='hs-varid'>co</span>
<a name="line-3484"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceCoercionX</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-3485"></a>     <span class='hs-comment'>-- in latter case, don't tidy, as we'll be printing uniques.</span>
<a name="line-3486"></a>
<a name="line-3487"></a><a name="tidyToIfaceCo"></a><span class='hs-definition'>tidyToIfaceCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IfaceCoercion</span>
<a name="line-3488"></a><span class='hs-comment'>-- It's vital to tidy before converting to an IfaceType</span>
<a name="line-3489"></a><span class='hs-comment'>-- or nested binders will become indistinguishable!</span>
<a name="line-3490"></a><span class='hs-comment'>--</span>
<a name="line-3491"></a><span class='hs-comment'>-- Also for the free type variables, tell toIfaceCoercionX to</span>
<a name="line-3492"></a><span class='hs-comment'>-- leave them as IfaceFreeCoVar.  This is super-important</span>
<a name="line-3493"></a><span class='hs-comment'>-- for debug printing.</span>
<a name="line-3494"></a><span class='hs-definition'>tidyToIfaceCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toIfaceCoercionX</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>free_tcvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3495"></a>  <span class='hs-keyword'>where</span>
<a name="line-3496"></a>    <span class='hs-varid'>env</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyCoVars</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>free_tcvs</span>
<a name="line-3497"></a>    <span class='hs-varid'>free_tcvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scopedSort</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfCoList</span> <span class='hs-varid'>co</span>
<a name="line-3498"></a><a name="pprClassPred"></a><span class='hs-comment'>------------</span>
<a name="line-3499"></a><span class='hs-definition'>pprClassPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Class</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3500"></a><span class='hs-definition'>pprClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTypeApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>classTyCon</span> <span class='hs-varid'>clas</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3501"></a>
<a name="line-3502"></a><a name="pprTheta"></a><span class='hs-comment'>------------</span>
<a name="line-3503"></a><span class='hs-definition'>pprTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3504"></a><span class='hs-definition'>pprTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceContext</span> <span class='hs-varid'>topPrec</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-3505"></a>
<a name="line-3506"></a><a name="pprParendTheta"></a><span class='hs-definition'>pprParendTheta</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3507"></a><span class='hs-definition'>pprParendTheta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceContext</span> <span class='hs-varid'>appPrec</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-3508"></a>
<a name="line-3509"></a><a name="pprThetaArrowTy"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3510"></a><span class='hs-definition'>pprThetaArrowTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceContextArr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-3511"></a>
<a name="line-3512"></a><a name="instance%20Outputable%20Type"></a><span class='hs-comment'>------------------</span>
<a name="line-3513"></a><a name="instance%20Outputable%20Type"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Type</span> <span class='hs-keyword'>where</span>
<a name="line-3514"></a>    <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprType</span> <span class='hs-varid'>ty</span>
<a name="line-3515"></a>
<a name="line-3516"></a><a name="instance%20Outputable%20TyLit"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyLit</span> <span class='hs-keyword'>where</span>
<a name="line-3517"></a>   <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyLit</span>
<a name="line-3518"></a>
<a name="line-3519"></a><a name="pprSigmaType"></a><span class='hs-comment'>------------------</span>
<a name="line-3520"></a><span class='hs-definition'>pprSigmaType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3521"></a><span class='hs-definition'>pprSigmaType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceSigmaType</span> <span class='hs-conid'>ShowForAllWhen</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tidyToIfaceType</span>
<a name="line-3522"></a>
<a name="line-3523"></a><a name="pprForAll"></a><span class='hs-definition'>pprForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3524"></a><span class='hs-definition'>pprForAll</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceForAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceForAllBndr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3525"></a>
<a name="line-3526"></a><a name="pprUserForAll"></a><span class='hs-comment'>-- | Print a user-level forall; see Note [When to print foralls]</span>
<a name="line-3527"></a><span class='hs-definition'>pprUserForAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3528"></a><span class='hs-definition'>pprUserForAll</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUserIfaceForAll</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toIfaceForAllBndr</span>
<a name="line-3529"></a>
<a name="line-3530"></a><a name="pprTCvBndrs"></a><span class='hs-definition'>pprTCvBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVarBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3531"></a><span class='hs-definition'>pprTCvBndrs</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTCvBndr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3532"></a>
<a name="line-3533"></a><a name="pprTCvBndr"></a><span class='hs-definition'>pprTCvBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVarBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3534"></a><span class='hs-definition'>pprTCvBndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varop'>.</span> <span class='hs-varid'>binderVar</span>
<a name="line-3535"></a>
<a name="line-3536"></a><a name="pprTyVars"></a><span class='hs-definition'>pprTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3537"></a><span class='hs-definition'>pprTyVars</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>pprTyVar</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-3538"></a>
<a name="line-3539"></a><a name="pprTyVar"></a><span class='hs-definition'>pprTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3540"></a><span class='hs-comment'>-- Print a type variable binder with its kind (but not if *)</span>
<a name="line-3541"></a><span class='hs-comment'>-- Here we do not go via IfaceType, because the duplication with</span>
<a name="line-3542"></a><span class='hs-comment'>-- pprIfaceTvBndr is minimal, and the loss of uniques etc in</span>
<a name="line-3543"></a><span class='hs-comment'>-- debug printing is disastrous</span>
<a name="line-3544"></a><span class='hs-definition'>pprTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-3545"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isLiftedTypeKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>
<a name="line-3546"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-3547"></a>  <span class='hs-keyword'>where</span>
<a name="line-3548"></a>    <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-3549"></a>
<a name="line-3550"></a><a name="instance%20Outputable%20TyCoBinder"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyword'>where</span>
<a name="line-3551"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"[anon]"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span>
<a name="line-3552"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Required</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-3553"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'@'</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span>
<a name="line-3554"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Inferred</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-3555"></a>
<a name="line-3556"></a><a name="instance%20Outputable%20Coercion"></a><span class='hs-comment'>-----------------</span>
<a name="line-3557"></a><a name="instance%20Outputable%20Coercion"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyword'>where</span> <span class='hs-comment'>-- defined here to avoid orphans</span>
<a name="line-3558"></a>  <span class='hs-varid'>ppr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCo</span>
<a name="line-3559"></a>
<a name="line-3560"></a><a name="debugPprType"></a><span class='hs-definition'>debugPprType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3561"></a><span class='hs-comment'>-- ^ debugPprType is a simple pretty printer that prints a type</span>
<a name="line-3562"></a><span class='hs-comment'>-- without going through IfaceType.  It does not format as prettily</span>
<a name="line-3563"></a><span class='hs-comment'>-- as the normal route, but it's much more direct, and that can</span>
<a name="line-3564"></a><span class='hs-comment'>-- be useful for debugging.  E.g. with -dppr-debug it prints the</span>
<a name="line-3565"></a><span class='hs-comment'>-- kind on type-variable /occurrences/ which the normal route</span>
<a name="line-3566"></a><span class='hs-comment'>-- fundamentally cannot do.</span>
<a name="line-3567"></a><span class='hs-definition'>debugPprType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>topPrec</span> <span class='hs-varid'>ty</span>
<a name="line-3568"></a>
<a name="line-3569"></a><a name="debug_ppr_ty"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PprPrec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3570"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>l</span><span class='hs-layout'>)</span>
<a name="line-3571"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>l</span>
<a name="line-3572"></a>
<a name="line-3573"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3574"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span>  <span class='hs-comment'>-- With -dppr-debug we get (tv :: kind)</span>
<a name="line-3575"></a>
<a name="line-3576"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-varid'>prec</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-3577"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>funPrec</span> <span class='hs-varop'>$</span>
<a name="line-3578"></a>    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>funPrec</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>arrow</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span>
<a name="line-3579"></a>
<a name="line-3580"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-varid'>prec</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3581"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span>
<a name="line-3582"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>appPrec</span> <span class='hs-varop'>$</span>
<a name="line-3583"></a>                <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>appPrec</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3584"></a>
<a name="line-3585"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-3586"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>appPrec</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Print parens so we see ((a b) c)</span>
<a name="line-3587"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>appPrec</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- so that we can distinguish</span>
<a name="line-3588"></a>                                    <span class='hs-comment'>-- TyConApp from AppTy</span>
<a name="line-3589"></a>
<a name="line-3590"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-varid'>prec</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3591"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>topPrec</span> <span class='hs-varop'>$</span>
<a name="line-3592"></a>    <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>debug_ppr_ty</span> <span class='hs-varid'>topPrec</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3593"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"|&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3594"></a>
<a name="line-3595"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3596"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CO"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3597"></a>
<a name="line-3598"></a><span class='hs-definition'>debug_ppr_ty</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3599"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span>
<a name="line-3600"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybeParen</span> <span class='hs-varid'>prec</span> <span class='hs-varid'>funPrec</span> <span class='hs-varop'>$</span>
<a name="line-3601"></a>    <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"forall"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>dot</span><span class='hs-layout'>)</span>
<a name="line-3602"></a>         <span class='hs-comment'>-- The (map ppr tvs) will print kind-annotated</span>
<a name="line-3603"></a>         <span class='hs-comment'>-- tvs, because we are (usually) in debug-style</span>
<a name="line-3604"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-3605"></a>  <span class='hs-keyword'>where</span>
<a name="line-3606"></a>    <span class='hs-varid'>split</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ForAllTy</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-3607"></a>             <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>split</span> <span class='hs-varid'>ty'</span>
<a name="line-3608"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>body</span><span class='hs-layout'>)</span>
<a name="line-3609"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3610"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3611"></a>
<a name="line-3612"></a><span class='hs-comment'>{-
<a name="line-3613"></a>Note [When to print foralls]
<a name="line-3614"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3615"></a>Mostly we want to print top-level foralls when (and only when) the user specifies
<a name="line-3616"></a>-fprint-explicit-foralls.  But when kind polymorphism is at work, that suppresses
<a name="line-3617"></a>too much information; see Trac #9018.
<a name="line-3618"></a>
<a name="line-3619"></a>So I'm trying out this rule: print explicit foralls if
<a name="line-3620"></a>  a) User specifies -fprint-explicit-foralls, or
<a name="line-3621"></a>  b) Any of the quantified type variables has a kind
<a name="line-3622"></a>     that mentions a kind variable
<a name="line-3623"></a>
<a name="line-3624"></a>This catches common situations, such as a type siguature
<a name="line-3625"></a>     f :: m a
<a name="line-3626"></a>which means
<a name="line-3627"></a>      f :: forall k. forall (m :: k-&gt;*) (a :: k). m a
<a name="line-3628"></a>We really want to see both the "forall k" and the kind signatures
<a name="line-3629"></a>on m and a.  The latter comes from pprTCvBndr.
<a name="line-3630"></a>
<a name="line-3631"></a>Note [Infix type variables]
<a name="line-3632"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3633"></a>With TypeOperators you can say
<a name="line-3634"></a>
<a name="line-3635"></a>   f :: (a ~&gt; b) -&gt; b
<a name="line-3636"></a>
<a name="line-3637"></a>and the (~&gt;) is considered a type variable.  However, the type
<a name="line-3638"></a>pretty-printer in this module will just see (a ~&gt; b) as
<a name="line-3639"></a>
<a name="line-3640"></a>   App (App (TyVarTy "~&gt;") (TyVarTy "a")) (TyVarTy "b")
<a name="line-3641"></a>
<a name="line-3642"></a>So it'll print the type in prefix form.  To avoid confusion we must
<a name="line-3643"></a>remember to parenthesise the operator, thus
<a name="line-3644"></a>
<a name="line-3645"></a>   (~&gt;) a b -&gt; b
<a name="line-3646"></a>
<a name="line-3647"></a>See Trac #2766.
<a name="line-3648"></a>-}</span>
<a name="line-3649"></a>
<a name="line-3650"></a><a name="pprDataCons"></a><span class='hs-definition'>pprDataCons</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3651"></a><span class='hs-definition'>pprDataCons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sepWithVBars</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprDataConWithArgs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyConDataCons</span>
<a name="line-3652"></a>  <span class='hs-keyword'>where</span>
<a name="line-3653"></a>    <span class='hs-varid'>sepWithVBars</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-3654"></a>    <span class='hs-varid'>sepWithVBars</span> <span class='hs-varid'>docs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-layout'>(</span><span class='hs-varid'>punctuate</span> <span class='hs-layout'>(</span><span class='hs-varid'>space</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>vbar</span><span class='hs-layout'>)</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-3655"></a>
<a name="line-3656"></a><a name="pprDataConWithArgs"></a><span class='hs-definition'>pprDataConWithArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3657"></a><span class='hs-definition'>pprDataConWithArgs</span> <span class='hs-varid'>dc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>forAllDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>thetaDoc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>argsDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-3658"></a>  <span class='hs-keyword'>where</span>
<a name="line-3659"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_univ_tvs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_ex_tvs</span><span class='hs-layout'>,</span> <span class='hs-sel'>_eq_spec</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>,</span> <span class='hs-sel'>_res_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>dc</span>
<a name="line-3660"></a>    <span class='hs-varid'>user_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConUserTyVarBinders</span> <span class='hs-varid'>dc</span>
<a name="line-3661"></a>    <span class='hs-varid'>forAllDoc</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprUserForAll</span> <span class='hs-varid'>user_bndrs</span>
<a name="line-3662"></a>    <span class='hs-varid'>thetaDoc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprThetaArrowTy</span> <span class='hs-varid'>theta</span>
<a name="line-3663"></a>    <span class='hs-varid'>argsDoc</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span>
<a name="line-3664"></a>
<a name="line-3665"></a>
<a name="line-3666"></a><a name="pprTypeApp"></a><span class='hs-definition'>pprTypeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3667"></a><span class='hs-definition'>pprTypeApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-3668"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceTypeApp</span> <span class='hs-varid'>topPrec</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-3669"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTcArgs</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3670"></a>    <span class='hs-comment'>-- TODO: toIfaceTcArgs seems rather wasteful here</span>
<a name="line-3671"></a>
<a name="line-3672"></a><a name="pprWithExplicitKindsWhen"></a><span class='hs-comment'>------------------</span>
<a name="line-3673"></a><span class='hs-comment'>-- | Display all kind information (with @-fprint-explicit-kinds@) when the</span>
<a name="line-3674"></a><span class='hs-comment'>-- provided 'Bool' argument is 'True'.</span>
<a name="line-3675"></a><span class='hs-comment'>-- See @Note [Kind arguments in error messages]@ in "TcErrors".</span>
<a name="line-3676"></a><span class='hs-definition'>pprWithExplicitKindsWhen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3677"></a><span class='hs-definition'>pprWithExplicitKindsWhen</span> <span class='hs-varid'>b</span>
<a name="line-3678"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>updSDocDynFlags</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3679"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>gopt_set</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_PrintExplicitKinds</span>
<a name="line-3680"></a>           <span class='hs-keyword'>else</span> <span class='hs-varid'>dflags</span>
<a name="line-3681"></a>
<a name="line-3682"></a><span class='hs-comment'>{-
<a name="line-3683"></a>%************************************************************************
<a name="line-3684"></a>%*                                                                      *
<a name="line-3685"></a>\subsection{TidyType}
<a name="line-3686"></a>%*                                                                      *
<a name="line-3687"></a>%************************************************************************
<a name="line-3688"></a>-}</span>
<a name="line-3689"></a>
<a name="line-3690"></a><a name="tidyVarBndrs"></a><span class='hs-comment'>-- | This tidies up a type for printing in an error message, or in</span>
<a name="line-3691"></a><span class='hs-comment'>-- an interface file.</span>
<a name="line-3692"></a><span class='hs-comment'>--</span>
<a name="line-3693"></a><span class='hs-comment'>-- It doesn't change the uniques at all, just the print names.</span>
<a name="line-3694"></a><span class='hs-definition'>tidyVarBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3695"></a><span class='hs-definition'>tidyVarBndrs</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>tvs</span>
<a name="line-3696"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>avoidNameClashes</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-3697"></a>
<a name="line-3698"></a><a name="tidyVarBndr"></a><span class='hs-definition'>tidyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-3699"></a><span class='hs-definition'>tidyVarBndr</span> <span class='hs-varid'>tidy_env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>var</span>
<a name="line-3700"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tidyOccName</span> <span class='hs-varid'>occ_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>getHelpfulOccName</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-3701"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>occ'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>occ_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>var'</span><span class='hs-layout'>)</span>
<a name="line-3702"></a>        <span class='hs-keyword'>where</span>
<a name="line-3703"></a>          <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>var</span> <span class='hs-varid'>var'</span>
<a name="line-3704"></a>          <span class='hs-varid'>var'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarType</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarName</span> <span class='hs-varid'>var</span> <span class='hs-varid'>name'</span><span class='hs-layout'>)</span> <span class='hs-varid'>type'</span>
<a name="line-3705"></a>          <span class='hs-varid'>type'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>var</span><span class='hs-layout'>)</span>
<a name="line-3706"></a>          <span class='hs-varid'>name'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyNameOcc</span> <span class='hs-varid'>name</span> <span class='hs-varid'>occ'</span>
<a name="line-3707"></a>          <span class='hs-varid'>name</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varName</span> <span class='hs-varid'>var</span>
<a name="line-3708"></a>
<a name="line-3709"></a><a name="avoidNameClashes"></a><span class='hs-definition'>avoidNameClashes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-3710"></a><span class='hs-comment'>-- Seed the occ_env with clashes among the names, see</span>
<a name="line-3711"></a><span class='hs-comment'>-- Node [Tidying multiple names at once] in OccName</span>
<a name="line-3712"></a><span class='hs-definition'>avoidNameClashes</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-3713"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>avoidClashesOccEnv</span> <span class='hs-varid'>occ_env</span> <span class='hs-varid'>occs</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-3714"></a>  <span class='hs-keyword'>where</span>
<a name="line-3715"></a>    <span class='hs-varid'>occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getHelpfulOccName</span> <span class='hs-varid'>tvs</span>
<a name="line-3716"></a>
<a name="line-3717"></a><a name="getHelpfulOccName"></a><span class='hs-definition'>getHelpfulOccName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>OccName</span>
<a name="line-3718"></a><span class='hs-comment'>-- A TcTyVar with a System Name is probably a</span>
<a name="line-3719"></a><span class='hs-comment'>-- unification variable; when we tidy them we give them a trailing</span>
<a name="line-3720"></a><span class='hs-comment'>-- "0" (or 1 etc) so that they don't take precedence for the</span>
<a name="line-3721"></a><span class='hs-comment'>-- un-modified name. Plus, indicating a unification variable in</span>
<a name="line-3722"></a><span class='hs-comment'>-- this way is a helpful clue for users</span>
<a name="line-3723"></a><span class='hs-definition'>getHelpfulOccName</span> <span class='hs-varid'>tv</span>
<a name="line-3724"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSystemName</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-3725"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>occNameString</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>++</span> <span class='hs-str'>"0"</span><span class='hs-layout'>)</span>
<a name="line-3726"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3727"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span>
<a name="line-3728"></a>  <span class='hs-keyword'>where</span>
<a name="line-3729"></a>   <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varName</span> <span class='hs-varid'>tv</span>
<a name="line-3730"></a>   <span class='hs-varid'>occ</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span>
<a name="line-3731"></a>
<a name="line-3732"></a><a name="tidyTyCoVarBinder"></a><span class='hs-definition'>tidyTyCoVarBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-varid'>vis</span>
<a name="line-3733"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-3734"></a><span class='hs-definition'>tidyTyCoVarBinder</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-3735"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-3736"></a>  <span class='hs-keyword'>where</span>
<a name="line-3737"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyVarBndr</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>tv</span>
<a name="line-3738"></a>
<a name="line-3739"></a><a name="tidyTyCoVarBinders"></a><span class='hs-definition'>tidyTyCoVarBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-varid'>vis</span><span class='hs-keyglyph'>]</span>
<a name="line-3740"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-varid'>vis</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3741"></a><span class='hs-definition'>tidyTyCoVarBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyCoVarBinder</span>
<a name="line-3742"></a>
<a name="line-3743"></a><a name="tidyFreeTyCoVars"></a><span class='hs-comment'>---------------</span>
<a name="line-3744"></a><span class='hs-definition'>tidyFreeTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-3745"></a><span class='hs-comment'>-- ^ Add the free 'TyVar's to the env in tidy form,</span>
<a name="line-3746"></a><span class='hs-comment'>-- so that we can tidy the type they are free in</span>
<a name="line-3747"></a><span class='hs-definition'>tidyFreeTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>full_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvars</span>
<a name="line-3748"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-layout'>(</span><span class='hs-varid'>full_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvars</span><span class='hs-layout'>)</span>
<a name="line-3749"></a>
<a name="line-3750"></a><a name="tidyOpenTyCoVars"></a><span class='hs-comment'>---------------</span>
<a name="line-3751"></a><span class='hs-definition'>tidyOpenTyCoVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3752"></a><span class='hs-definition'>tidyOpenTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyOpenTyCoVar</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tyvars</span>
<a name="line-3753"></a>
<a name="line-3754"></a><a name="tidyOpenTyCoVar"></a><span class='hs-comment'>---------------</span>
<a name="line-3755"></a><span class='hs-definition'>tidyOpenTyCoVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>)</span>
<a name="line-3756"></a><span class='hs-comment'>-- ^ Treat a new 'TyCoVar' as a binder, and give it a fresh tidy name</span>
<a name="line-3757"></a><span class='hs-comment'>-- using the environment if one has not already been allocated. See</span>
<a name="line-3758"></a><span class='hs-comment'>-- also 'tidyVarBndr'</span>
<a name="line-3759"></a><span class='hs-definition'>tidyOpenTyCoVar</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tyvar</span>
<a name="line-3760"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyword'>of</span>
<a name="line-3761"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tyvar'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyvar'</span><span class='hs-layout'>)</span>              <span class='hs-comment'>-- Already substituted</span>
<a name="line-3762"></a>        <span class='hs-conid'>Nothing</span>     <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3763"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>env'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypeList</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3764"></a>          <span class='hs-keyword'>in</span> <span class='hs-varid'>tidyVarBndr</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>tyvar</span>  <span class='hs-comment'>-- Treat it as a binder</span>
<a name="line-3765"></a>
<a name="line-3766"></a><a name="tidyTyCoVarOcc"></a><span class='hs-comment'>---------------</span>
<a name="line-3767"></a><span class='hs-definition'>tidyTyCoVarOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span>
<a name="line-3768"></a><span class='hs-definition'>tidyTyCoVarOcc</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3769"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-3770"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>updateVarType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-3771"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv'</span>
<a name="line-3772"></a>
<a name="line-3773"></a><a name="tidyTypes"></a><span class='hs-comment'>---------------</span>
<a name="line-3774"></a><span class='hs-definition'>tidyTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-3775"></a><span class='hs-definition'>tidyTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-3776"></a>
<a name="line-3777"></a><a name="tidyType"></a><span class='hs-comment'>---------------</span>
<a name="line-3778"></a><span class='hs-definition'>tidyType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3779"></a><span class='hs-definition'>tidyType</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>n</span>
<a name="line-3780"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyTyCoVarOcc</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3781"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-3782"></a>                                    <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>args</span>
<a name="line-3783"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-3784"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-3785"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllTys'</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>tvs'</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env'</span> <span class='hs-varid'>body_ty</span>
<a name="line-3786"></a>  <span class='hs-keyword'>where</span>
<a name="line-3787"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>vis</span><span class='hs-layout'>,</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTys'</span> <span class='hs-varid'>ty</span>
<a name="line-3788"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyVarBndrs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tvs</span>
<a name="line-3789"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3790"></a><span class='hs-definition'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3791"></a>
<a name="line-3792"></a>
<a name="line-3793"></a><a name="mkForAllTys'"></a><span class='hs-comment'>-- The following two functions differ from mkForAllTys and splitForAllTys in that</span>
<a name="line-3794"></a><span class='hs-comment'>-- they expect/preserve the ArgFlag argument. Thes belong to types/Type.hs, but</span>
<a name="line-3795"></a><span class='hs-comment'>-- how should they be named?</span>
<a name="line-3796"></a><span class='hs-definition'>mkForAllTys'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>ArgFlag</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3797"></a><span class='hs-definition'>mkForAllTys'</span> <span class='hs-varid'>tvvs</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>strictMkForAllTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tvvs</span>
<a name="line-3798"></a>  <span class='hs-keyword'>where</span>
<a name="line-3799"></a>    <span class='hs-varid'>strictMkForAllTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>ty</span>
<a name="line-3800"></a>
<a name="line-3801"></a><a name="splitForAllTys'"></a><span class='hs-definition'>splitForAllTys'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ArgFlag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-3802"></a><span class='hs-definition'>splitForAllTys'</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-3803"></a>  <span class='hs-keyword'>where</span>
<a name="line-3804"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>viss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>vis</span><span class='hs-conop'>:</span><span class='hs-varid'>viss</span><span class='hs-layout'>)</span>
<a name="line-3805"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>                          <span class='hs-varid'>tvs</span> <span class='hs-varid'>viss</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>viss</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3806"></a>
<a name="line-3807"></a>
<a name="line-3808"></a><a name="tidyOpenTypes"></a><span class='hs-comment'>---------------</span>
<a name="line-3809"></a><span class='hs-comment'>-- | Grabs the free type variables, tidies them</span>
<a name="line-3810"></a><span class='hs-comment'>-- and then uses 'tidyType' to work over the type itself</span>
<a name="line-3811"></a><span class='hs-definition'>tidyOpenTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-3812"></a><span class='hs-definition'>tidyOpenTypes</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tys</span>
<a name="line-3813"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyTypes</span> <span class='hs-layout'>(</span><span class='hs-varid'>trimmed_occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-3814"></a>  <span class='hs-keyword'>where</span>
<a name="line-3815"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>var_env</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTyCoVars</span> <span class='hs-varid'>env</span> <span class='hs-varop'>$</span>
<a name="line-3816"></a>                                <span class='hs-varid'>tyCoVarsOfTypesWellScoped</span> <span class='hs-varid'>tys</span>
<a name="line-3817"></a>    <span class='hs-varid'>trimmed_occ_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initTidyOccEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span>
<a name="line-3818"></a>      <span class='hs-comment'>-- The idea here was that we restrict the new TidyEnv to the</span>
<a name="line-3819"></a>      <span class='hs-comment'>-- _free_ vars of the types, so that we don't gratuitously rename</span>
<a name="line-3820"></a>      <span class='hs-comment'>-- the _bound_ variables of the types.</span>
<a name="line-3821"></a>
<a name="line-3822"></a><a name="tidyOpenType"></a><span class='hs-comment'>---------------</span>
<a name="line-3823"></a><span class='hs-definition'>tidyOpenType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-3824"></a><span class='hs-definition'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenTypes</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>in</span>
<a name="line-3825"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-3826"></a>
<a name="line-3827"></a><a name="tidyTopType"></a><span class='hs-comment'>---------------</span>
<a name="line-3828"></a><span class='hs-comment'>-- | Calls 'tidyType' on a top-level type (i.e. with an empty tidying environment)</span>
<a name="line-3829"></a><span class='hs-definition'>tidyTopType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-3830"></a><span class='hs-definition'>tidyTopType</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ty</span>
<a name="line-3831"></a>
<a name="line-3832"></a><a name="tidyOpenKind"></a><span class='hs-comment'>---------------</span>
<a name="line-3833"></a><span class='hs-definition'>tidyOpenKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-3834"></a><span class='hs-definition'>tidyOpenKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span>
<a name="line-3835"></a>
<a name="line-3836"></a><a name="tidyKind"></a><span class='hs-definition'>tidyKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-3837"></a><span class='hs-definition'>tidyKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyType</span>
<a name="line-3838"></a>
<a name="line-3839"></a><a name="tidyCo"></a><span class='hs-comment'>----------------</span>
<a name="line-3840"></a><span class='hs-definition'>tidyCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-3841"></a><span class='hs-definition'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-3842"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3843"></a>  <span class='hs-keyword'>where</span>
<a name="line-3844"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-3845"></a>    <span class='hs-varid'>go_mco</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3846"></a>
<a name="line-3847"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-3848"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go_mco</span> <span class='hs-varid'>mco</span>
<a name="line-3849"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-3850"></a>                               <span class='hs-keyword'>in</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-3851"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-3852"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>h</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>envp</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3853"></a>                               <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-varid'>envp</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span>
<a name="line-3854"></a>            <span class='hs-comment'>-- the case above duplicates a bit of work in tidying h and the kind</span>
<a name="line-3855"></a>            <span class='hs-comment'>-- of tv. But the alternative is to use coercionKind, which seems worse.</span>
<a name="line-3856"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-3857"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv</span> <span class='hs-keyword'>of</span>
<a name="line-3858"></a>                                 <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-3859"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-varid'>cv'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv'</span>
<a name="line-3860"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span>
<a name="line-3861"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span>
<a name="line-3862"></a>                               <span class='hs-keyword'>in</span>  <span class='hs-varid'>args</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>args</span>
<a name="line-3863"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varop'>$!</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span>
<a name="line-3864"></a>                                <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>tidyType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t2</span>
<a name="line-3865"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3866"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-3867"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>d</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3868"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3869"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span>
<a name="line-3870"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3871"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubCo</span> <span class='hs-varop'>$!</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-3872"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cos1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-varid'>cos</span>
<a name="line-3873"></a>                               <span class='hs-keyword'>in</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos1</span>
<a name="line-3874"></a>
<a name="line-3875"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnsafeCoerceProv</span>
<a name="line-3876"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3877"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-3878"></a>    <span class='hs-varid'>go_prov</span> <span class='hs-varid'>p</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>p</span>
<a name="line-3879"></a>
<a name="line-3880"></a><a name="tidyCos"></a><span class='hs-definition'>tidyCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-3881"></a><span class='hs-definition'>tidyCos</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCo</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-3882"></a>
<a name="line-3883"></a>
<a name="line-3884"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-3885"></a>*                                                                      *
<a name="line-3886"></a>                   typeSize, coercionSize
<a name="line-3887"></a>*                                                                      *
<a name="line-3888"></a>********************************************************************* -}</span>
<a name="line-3889"></a>
<a name="line-3890"></a><span class='hs-comment'>-- NB: We put typeSize/coercionSize here because they are mutually</span>
<a name="line-3891"></a><span class='hs-comment'>--     recursive, and have the CPR property.  If we have mutual</span>
<a name="line-3892"></a><span class='hs-comment'>--     recursion across a hi-boot file, we don't get the CPR property</span>
<a name="line-3893"></a><span class='hs-comment'>--     and these functions allocate a tremendous amount of rubbish.</span>
<a name="line-3894"></a><span class='hs-comment'>--     It's not critical (because typeSize is really only used in</span>
<a name="line-3895"></a><span class='hs-comment'>--     debug mode, but I tripped over an example (T5642) in which</span>
<a name="line-3896"></a><span class='hs-comment'>--     typeSize was one of the biggest single allocators in all of GHC.</span>
<a name="line-3897"></a><span class='hs-comment'>--     And it's easy to fix, so I did.</span>
<a name="line-3898"></a>
<a name="line-3899"></a><span class='hs-comment'>-- NB: typeSize does not respect `eqType`, in that two types that</span>
<a name="line-3900"></a><span class='hs-comment'>--     are `eqType` may return different sizes. This is OK, because this</span>
<a name="line-3901"></a><span class='hs-comment'>--     function is used only in reporting, not decision-making.</span>
<a name="line-3902"></a>
<a name="line-3903"></a><a name="typeSize"></a><span class='hs-definition'>typeSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-3904"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-3905"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-3906"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-3907"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-3908"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t</span>
<a name="line-3909"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span>
<a name="line-3910"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3911"></a><span class='hs-definition'>typeSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3912"></a>
<a name="line-3913"></a><a name="coercionSize"></a><span class='hs-definition'>coercionSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-3914"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span>
<a name="line-3915"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span>
<a name="line-3916"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3917"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-3918"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>arg</span>
<a name="line-3919"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>h</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>h</span>
<a name="line-3920"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-3921"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-3922"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-3923"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-3924"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>provSize</span> <span class='hs-varid'>p</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>typeSize</span> <span class='hs-varid'>t2</span>
<a name="line-3925"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3926"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co2</span>
<a name="line-3927"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3928"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3929"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>arg</span>
<a name="line-3930"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3931"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3932"></a><span class='hs-definition'>coercionSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>
<a name="line-3933"></a>
<a name="line-3934"></a><a name="provSize"></a><span class='hs-definition'>provSize</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-3935"></a><span class='hs-definition'>provSize</span> <span class='hs-conid'>UnsafeCoerceProv</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
<a name="line-3936"></a><span class='hs-definition'>provSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3937"></a><span class='hs-definition'>provSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>coercionSize</span> <span class='hs-varid'>co</span>
<a name="line-3938"></a><span class='hs-definition'>provSize</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span>
</pre></body>
</html>
